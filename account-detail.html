<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Detail â€” AI Adoption Assessment</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
    }

    /* Back nav */
    .back-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(245, 245, 247, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid #d2d2d7;
      padding: 0.75rem 2rem;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: #0071e3;
      text-decoration: none;
      transition: opacity 0.15s;
    }
    .back-link:hover { opacity: 0.7; }
    .back-link svg { width: 16px; height: 16px; }

    /* Page container */
    .page {
      max-width: 820px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 4rem;
    }

    /* Header */
    .detail-header {
      margin-bottom: 2.5rem;
    }
    .account-name {
      font-size: 2rem;
      font-weight: 700;
      color: #1d1d1f;
      letter-spacing: -0.025em;
      margin-bottom: 1rem;
    }
    .meta-row {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.75rem;
      border-radius: 100px;
      font-size: 0.78rem;
      font-weight: 500;
      background: #e8e8ed;
      color: #48484a;
    }
    .meta-pill.accent {
      background: #0071e3;
      color: #fff;
    }

    /* Section cards */
    .section-card {
      background: #fff;
      border: 1px solid #d2d2d7;
      border-radius: 16px;
      padding: 1.75rem 2rem;
      margin-bottom: 1.25rem;
    }
    .section-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #86868b;
      margin-bottom: 1.25rem;
    }
    .section-icon {
      margin-right: 0.4rem;
    }

    /* Field rows */
    .field {
      margin-bottom: 1rem;
    }
    .field:last-child { margin-bottom: 0; }
    .field-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.3rem;
    }
    .field-value {
      font-size: 0.95rem;
      color: #1d1d1f;
      font-weight: 400;
    }
    .field-value.empty {
      color: #aeaeb2;
      font-style: italic;
    }

    /* Tags */
    .tags {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-block;
      padding: 0.25rem 0.65rem;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      background: #f2f2f7;
      color: #3a3a3c;
    }
    .tag.need {
      background: #fff3cd;
      color: #856404;
    }
    .tag.doing {
      background: #d1fae5;
      color: #065f46;
    }

    /* Maturity badges */
    .maturity-badge {
      display: inline-block;
      padding: 0.3rem 0.85rem;
      border-radius: 100px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .maturity-not-started { background: #f3f4f6; color: #6b7280; }
    .maturity-exploring { background: #dbeafe; color: #1d4ed8; }
    .maturity-piloting { background: #fef3c7; color: #92400e; }
    .maturity-scaling { background: #d1fae5; color: #065f46; }
    .maturity-optimizing { background: #ede9fe; color: #5b21b6; }
    .maturity-dont-know { background: #f3f4f6; color: #9ca3af; }

    /* Role grid */
    .role-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .role-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.8rem;
      border-radius: 10px;
      font-size: 0.82rem;
      font-weight: 500;
      background: #f2f2f7;
      color: #3a3a3c;
    }

    /* Matrix table */
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      margin-top: 0.5rem;
    }
    .matrix-table th {
      font-weight: 600;
      color: #86868b;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 0.5rem 0.6rem;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    .matrix-table th:first-child {
      text-align: left;
    }
    .matrix-table td {
      padding: 0.55rem 0.6rem;
      border-bottom: 1px solid #f2f2f7;
      text-align: center;
      color: #1d1d1f;
    }
    .matrix-table td:first-child {
      text-align: left;
      font-weight: 500;
    }
    .matrix-table .check { color: #34c759; font-size: 1rem; }
    .matrix-table .dash { color: #d2d2d7; }

    /* Use case category */
    .usecase-cat {
      margin-bottom: 1.25rem;
    }
    .usecase-cat:last-child { margin-bottom: 0; }
    .usecase-cat-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 0.5rem;
    }
    .usecase-columns {
      display: flex;
      gap: 1.5rem;
    }
    .usecase-col {
      flex: 1;
    }
    .usecase-col-label {
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #86868b;
      margin-bottom: 0.35rem;
    }

    /* Workflow maturity list */
    .wfm-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid #f2f2f7;
    }
    .wfm-item:last-child { border-bottom: none; }
    .wfm-role {
      font-weight: 500;
      font-size: 0.9rem;
    }
    .wfm-stage {
      font-size: 0.82rem;
      color: #86868b;
      font-weight: 500;
    }

    /* Ranked list */
    .ranked-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0;
    }
    .rank-badge {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #0071e3;
      color: #fff;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .rank-badge.secondary {
      background: #86868b;
    }

    /* Notes */
    .notes-block {
      margin-top: 1rem;
      padding: 0.85rem 1rem;
      background: #f9f9fb;
      border-radius: 10px;
      border-left: 3px solid #d2d2d7;
    }
    .notes-label {
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #86868b;
      margin-bottom: 0.25rem;
    }
    .notes-text {
      font-size: 0.88rem;
      color: #48484a;
      white-space: pre-wrap;
    }

    /* Divider */
    .field-divider {
      height: 1px;
      background: #f2f2f7;
      margin: 1rem 0;
    }

    /* Loading / Error states */
    .loading-state, .error-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #86868b;
      font-size: 1rem;
    }
    .error-state { color: #ff3b30; }

    /* Responsive */
    @media (max-width: 640px) {
      .page { padding: 1.5rem 1rem 3rem; }
      .section-card { padding: 1.25rem 1.25rem; }
      .account-name { font-size: 1.6rem; }
      .usecase-columns { flex-direction: column; gap: 0.75rem; }
      .matrix-table { font-size: 0.72rem; }
      .matrix-table th, .matrix-table td { padding: 0.4rem; }
    }
  </style>
</head>
<body>

  <div class="back-bar">
    <a href="dashboard.html" class="back-link">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M10.354 3.354a.5.5 0 0 0-.708-.708l-5 5a.5.5 0 0 0 0 .708l5 5a.5.5 0 0 0 .708-.708L5.707 8l4.647-4.646z"/></svg>
      Dashboard
    </a>
  </div>

  <div class="page" id="pageContent">
    <div class="loading-state" id="loadingState">Loading survey data...</div>
  </div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LABEL CONSTANTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const ACCOUNT_TYPE_LABELS = {
    'enterprise': 'Enterprise',
    'key-account': 'Key Account',
    'enterprise-key': 'Enterprise + Key Account',
    'other': 'Other'
  };

  const OWNERSHIP_LABELS = {
    staff: 'Staff Augmentation',
    project: 'Project Ownership',
    program: 'Program Ownership',
    outcome: 'Business Outcome'
  };

  const PAYMENT_LABELS = {
    us: 'We Are/Will',
    customer: 'Customer Is/Will',
    mix: 'It Is a Mix',
    tbd: 'To Be Determined'
  };

  const COMPLIANCE_LABELS = {
    hipaa: 'HIPAA', gdpr: 'GDPR', sox: 'SOX', 'pci-dss': 'PCI-DSS',
    fedramp: 'FedRAMP', soc2: 'SOC 2', ccpa: 'CCPA', iso27001: 'ISO 27001'
  };

  const MATURITY_LABELS = {
    'not-started': 'Not Started', 'exploring': 'Exploring', 'piloting': 'Piloting',
    'scaling': 'Scaling', 'optimizing': 'Optimizing', 'dont-know': "Don't Know"
  };

  const USAGE_LABELS = {
    'dont-know': "I Don't Know", 'not-using': 'Not Using AI',
    'off-the-shelf': 'Off-the-Shelf Tools', 'business-apps': 'AI in Business Apps',
    'custom-solutions': 'Custom AI Solutions', 'business-processes': 'Process Automation',
    'customer-facing': 'Customer-Facing AI'
  };

  const PRIORITY_LABELS = {
    'not-priority': 'Not a Priority', low: 'Low', medium: 'Medium', high: 'High', 'dont-know': "I Don't Know"
  };

  const GOVERNANCE_LABELS = {
    none: 'No Governance', informal: 'Informal', developing: 'Developing',
    established: 'Established', 'dont-know': "I Don't Know"
  };

  const CHALLENGE_LABELS = {
    'unclear-roi': 'Unclear ROI', skills: 'Skills Gap', data: 'Data Issues',
    security: 'Security/Compliance', budget: 'Budget/Buy-in', infrastructure: 'Infrastructure',
    'dont-know': "I Don't Know"
  };

  const APPROVED_TOOL_LABELS = {
    'github-copilot': 'GitHub Copilot', chatgpt: 'ChatGPT / OpenAI',
    claude: 'Claude / Anthropic', gemini: 'Gemini / Google', cursor: 'Cursor',
    'amazon-q-kiro': 'Amazon Q / Kiro', 'ms-copilot': 'Microsoft Copilot',
    'atlassian-rovo': 'Atlassian Rovo'
  };

  const ROLE_LABELS = {
    pm: { name: 'Project Managers / Scrum Masters', icon: 'ğŸ“‹' },
    ba: { name: 'Business Analysts / Product Managers', icon: 'ğŸ“Š' },
    arch: { name: 'Solutions Architects', icon: 'ğŸ—ï¸' },
    swe: { name: 'Software Engineers', icon: 'ğŸ’»' },
    qa: { name: 'Manual QA', icon: 'ğŸ”' },
    qaa: { name: 'QA Automation Engineers', icon: 'ğŸ¤–' },
    data: { name: 'Data Engineers / Scientists', icon: 'ğŸ“ˆ' },
    devops: { name: 'DevOps Engineers', icon: 'âš™ï¸' },
    ux: { name: 'UI/UX Designers', icon: 'ğŸ¨' }
  };
  const ROLE_ORDER = ['pm', 'ba', 'arch', 'swe', 'qa', 'qaa', 'data', 'devops', 'ux'];

  const TOOL_CATEGORIES = [
    { id: 'cloud', name: 'Cloud Platforms', icon: 'â˜ï¸', tools: {
      aws: 'Amazon Web Services (AWS)', gcp: 'Google Cloud Platform (GCP)',
      azure: 'Microsoft Azure', onprem: 'On-Premises'
    }},
    { id: 'ai', name: 'AI Tools', icon: 'ğŸ§ ', tools: {
      copilot: 'GitHub Copilot', chatgpt: 'ChatGPT / OpenAI', claude: 'Claude (Anthropic)',
      claudecode: 'Claude Code', cursor: 'Cursor', windsurf: 'Windsurf',
      gemini: 'Gemini (Google)', amazonq: 'Amazon Q / Kiro', mscopilot: 'Microsoft Copilot',
      intellij: 'IntelliJ AI', rovo: 'Atlassian Rovo', v0: 'v0 (Vercel)',
      bolt: 'Bolt.new', lovable: 'Lovable', perplexity: 'Perplexity'
    }},
    { id: 'collab', name: 'Collaboration Tools', icon: 'ğŸ¤', tools: {
      slack: 'Slack', teams: 'Microsoft Teams', jira: 'Jira', confluence: 'Confluence',
      notion: 'Notion', azuredevops: 'Azure DevOps', githubissues: 'GitHub Issues',
      googleworkspace: 'Google Workspace', sharepoint: 'SharePoint'
    }},
    { id: 'testmgmt', name: 'Test Management', icon: 'âœ…', tools: {
      testrail: 'TestRail', zephyr: 'Zephyr'
    }},
    { id: 'scm', name: 'Source Control', icon: 'ğŸ“¦', tools: {
      github: 'GitHub', gitlab: 'GitLab', bitbucket: 'Bitbucket', azurerepos: 'Azure Repos'
    }},
    { id: 'cicd', name: 'CI/CD', icon: 'ğŸš€', tools: {
      githubactions: 'GitHub Actions', jenkins: 'Jenkins', gitlabci: 'GitLab CI',
      circleci: 'CircleCI', azurepipelines: 'Azure Pipelines', argocd: 'ArgoCD'
    }},
    { id: 'design', name: 'Design Tools', icon: 'ğŸ¨', tools: {
      figma: 'Figma', miro: 'Miro'
    }}
  ];

  const USECASE_CATEGORIES = [
    { id: 'code-dev', name: 'Code Development', icon: 'ğŸ’»', items: {
      'code-completion': 'Code completion and suggestions',
      'code-generation': 'Generate code from natural language',
      'code-refactoring': 'Code refactoring and optimization',
      'code-review': 'Automated code review assistance',
      'debugging': 'Debugging and error resolution',
      'code-explanation': 'Code explanation and documentation'
    }},
    { id: 'documentation', name: 'Documentation', icon: 'ğŸ“„', items: {
      'api-docs': 'API documentation generation',
      'readme-generation': 'README and setup guides',
      'technical-specs': 'Technical specification writing',
      'inline-comments': 'Code comments and docstrings',
      'release-notes': 'Release notes generation'
    }},
    { id: 'requirements', name: 'Requirements & Analysis', icon: 'ğŸ“Š', items: {
      'user-stories': 'User story creation and refinement',
      'requirements-analysis': 'Requirements gap analysis',
      'acceptance-criteria': 'Acceptance criteria generation',
      'impact-analysis': 'Impact analysis for changes',
      'backlog-refinement': 'Backlog grooming assistance'
    }},
    { id: 'pm', name: 'Project Management', icon: 'ğŸ“‹', items: {
      'meeting-summaries': 'Meeting summaries and action items',
      'status-reports': 'Status report generation',
      'risk-identification': 'Risk identification and mitigation',
      'estimation': 'Effort estimation assistance',
      'stakeholder-comms': 'Stakeholder communication drafts'
    }},
    { id: 'design-ux', name: 'Design & UX', icon: 'ğŸ¨', items: {
      'design-feedback': 'Design critique and feedback',
      'copy-writing': 'UI copy and microcopy writing',
      'accessibility': 'Accessibility recommendations',
      'user-research': 'User research analysis',
      'persona-creation': 'Persona and journey mapping'
    }},
    { id: 'data-analytics', name: 'Data & Analytics', icon: 'ğŸ“ˆ', items: {
      'sql-generation': 'SQL query generation',
      'data-transformation': 'Data transformation scripts',
      'data-analysis': 'Data analysis and insights',
      'pipeline-development': 'Data pipeline development',
      'data-quality': 'Data quality checks'
    }}
  ];

  const WFM_STAGES = [
    { num: 'Stage 0', title: 'No AI Usage' },
    { num: 'Stage 1', title: 'Individual AI Usage' },
    { num: 'Stage 2', title: 'Team AI Practices' },
    { num: 'Stage 3', title: 'AI-Chained Tasks' },
    { num: 'Stage 4', title: 'Event-Triggered AI' },
    { num: 'Stage 5', title: 'Semi-Agentic AI' }
  ];

  const LIMITING_FACTOR_LABELS = {
    time: 'Lack of time / competing priorities',
    knowledge: 'Lack of knowledge or practical skills',
    'unclear-value': 'Unclear value or relevant use cases',
    client: 'Client or stakeholder not ready or supportive',
    access: 'Lack of access to tools, data, budget, or clear governance',
    other: 'Other'
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function getSelected(obj) {
    if (!obj) return [];
    return Object.entries(obj)
      .filter(([k, v]) => !k.startsWith('_') && k !== 'custom' && k !== 'visible' && k !== 'dont-know' && k !== 'not-applicable' && v?.selected)
      .map(([k]) => k);
  }

  function renderTags(items, className) {
    if (!items || items.length === 0) return '<span class="field-value empty">None</span>';
    return '<div class="tags">' + items.map(t => `<span class="tag ${className || ''}">${escapeHtml(t)}</span>`).join('') + '</div>';
  }

  function renderNotes(notesObj, key) {
    const text = notesObj?.[key];
    if (!text || !text.trim()) return '';
    return `<div class="notes-block">
      <div class="notes-label">Notes</div>
      <div class="notes-text">${escapeHtml(text)}</div>
    </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATABASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const IDB_NAME = 'AISurveyDashboard';
  const IDB_STORE = 'database';
  const IDB_KEY = 'sqliteDb';

  function openIDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = () => { req.result.createObjectStore(IDB_STORE); };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function loadFromIndexedDB() {
    try {
      const idb = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = idb.transaction(IDB_STORE, 'readonly');
        const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
        req.onsuccess = () => resolve(req.result ? new Uint8Array(req.result) : null);
        req.onerror = () => reject(req.error);
      });
    } catch { return null; }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderDetail(survey) {
    const d = survey.data;
    const notes = d.notes || {};
    let html = '';

    // â”€â”€ Header â”€â”€
    const typeLabel = ACCOUNT_TYPE_LABELS[survey.account_type] || survey.account_type || 'Other';
    const exportDate = new Date(survey.exported_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

    html += `<div class="detail-header">
      <h1 class="account-name">${escapeHtml(survey.account_name)}</h1>
      <div class="meta-row">
        <span class="meta-pill accent">${escapeHtml(typeLabel)}</span>
        <span class="meta-pill">Q${survey.quarter} ${survey.year}</span>
        ${survey.delivery_manager ? `<span class="meta-pill">${escapeHtml(survey.delivery_manager)}</span>` : ''}
        <span class="meta-pill">${exportDate}</span>
      </div>
    </div>`;

    // â”€â”€ 1. Engagement Model â”€â”€
    html += `<div class="section-card">
      <div class="section-title"><span class="section-icon">ğŸ¤</span>Engagement Model</div>`;

    const ownership = d.engagement?.ownership;
    const selectedOwnership = ownership ? Object.entries(ownership)
      .filter(([k, v]) => !k.startsWith('_') && v?.selected)
      .map(([k]) => OWNERSHIP_LABELS[k] || k) : [];
    html += `<div class="field">
      <div class="field-label">Ownership</div>
      <div class="field-value">${selectedOwnership.length > 0 ? renderTags(selectedOwnership) : '<span class="field-value empty">Not specified</span>'}</div>
    </div>`;

    const payment = d.engagement?.aiToolPayment?.value;
    html += `<div class="field">
      <div class="field-label">AI Tool Payment</div>
      <div class="field-value">${payment ? (PAYMENT_LABELS[payment] || payment) : '<span class="field-value empty">Not specified</span>'}</div>
    </div>`;

    const compliance = d.engagement?.compliance;
    const selectedCompliance = compliance ? Object.entries(compliance)
      .filter(([k, v]) => !k.startsWith('_') && k !== 'custom' && v?.selected)
      .map(([k]) => COMPLIANCE_LABELS[k] || k) : [];
    const customCompliance = (compliance?.custom || []).filter(c => c.selected).map(c => c.name);
    const allCompliance = [...selectedCompliance, ...customCompliance];
    html += `<div class="field">
      <div class="field-label">Compliance</div>
      <div class="field-value">${allCompliance.length > 0 ? renderTags(allCompliance) : '<span class="field-value empty">None specified</span>'}</div>
    </div>`;

    html += renderNotes(notes, 'engagement');
    html += '</div>';

    // â”€â”€ 2. Client AI Adoption â”€â”€
    html += `<div class="section-card">
      <div class="section-title"><span class="section-icon">ğŸ¢</span>Client AI Adoption â€” As-Is State</div>`;

    const maturity = d.clientAILandscape?.maturity?.value;
    const maturityLabel = maturity ? (MATURITY_LABELS[maturity] || maturity) : null;
    const maturityClass = maturity ? `maturity-${maturity}` : '';
    html += `<div class="field">
      <div class="field-label">AI Maturity</div>
      <div class="field-value">${maturityLabel ? `<span class="maturity-badge ${maturityClass}">${maturityLabel}</span>` : '<span class="field-value empty">Not assessed</span>'}</div>
    </div>`;

    const usage = d.clientAILandscape?.usage;
    const selectedUsage = usage ? Object.entries(usage)
      .filter(([k, v]) => !k.startsWith('_') && v?.selected && k !== 'not-using')
      .map(([k]) => USAGE_LABELS[k] || k) : [];
    const isNotUsing = usage?.['not-using']?.selected;
    html += `<div class="field">
      <div class="field-label">Current AI Usage</div>
      <div class="field-value">${isNotUsing ? 'Not Using AI' : (selectedUsage.length > 0 ? renderTags(selectedUsage) : '<span class="field-value empty">Not specified</span>')}</div>
    </div>`;

    const priority = d.clientAILandscape?.priority?.value;
    html += `<div class="field">
      <div class="field-label">Strategic Priority</div>
      <div class="field-value">${priority ? (PRIORITY_LABELS[priority] || priority) : '<span class="field-value empty">Not specified</span>'}</div>
    </div>`;

    const governance = d.clientAILandscape?.governance?.value;
    html += `<div class="field">
      <div class="field-label">AI Governance</div>
      <div class="field-value">${governance ? (GOVERNANCE_LABELS[governance] || governance) : '<span class="field-value empty">Not specified</span>'}</div>
    </div>`;

    const challenges = d.clientAILandscape?.challenges;
    if (challenges) {
      const ranked = Object.entries(challenges)
        .filter(([k, v]) => !k.startsWith('_') && v?.rank)
        .sort((a, b) => a[1].rank - b[1].rank);
      if (ranked.length > 0) {
        html += `<div class="field">
          <div class="field-label">Top Challenges</div>`;
        ranked.forEach(([k, v], i) => {
          html += `<div class="ranked-item">
            <span class="rank-badge ${i > 0 ? 'secondary' : ''}">${v.rank}</span>
            <span>${escapeHtml(CHALLENGE_LABELS[k] || k)}</span>
          </div>`;
        });
        html += '</div>';
      }
    }

    const approved = d.clientAILandscape?.approvedToolsList;
    if (approved) {
      const approvedValue = approved.value;
      let approvedText = approvedValue === 'yes' ? 'Yes' : approvedValue === 'no' ? 'No' : approvedValue === 'dont-know' ? "I Don't Know" : null;
      if (approvedText) {
        html += `<div class="field"><div class="field-label">Approved AI Tools List</div>`;
        if (approvedValue === 'yes' && approved.tools) {
          const tools = Object.entries(approved.tools)
            .filter(([k, v]) => !k.startsWith('_') && k !== 'custom' && v?.selected)
            .map(([k]) => APPROVED_TOOL_LABELS[k] || k);
          const customApproved = (approved.tools.custom || []).filter(t => t.selected).map(t => t.name);
          const allApproved = [...tools, ...customApproved];
          html += `<div class="field-value">${allApproved.length > 0 ? renderTags(allApproved) : 'Yes (no tools specified)'}</div>`;
        } else {
          html += `<div class="field-value">${approvedText}</div>`;
        }
        html += '</div>';
      }
    }

    html += renderNotes(notes, 'clientAILandscape');
    html += '</div>';

    // â”€â”€ 3. Team Roles â”€â”€
    html += `<div class="section-card">
      <div class="section-title"><span class="section-icon">ğŸ‘¥</span>Team Roles</div>`;

    const roles = d.teamRoles?.roles;
    const selectedRoles = roles ? Object.entries(roles)
      .filter(([k, v]) => !k.startsWith('_') && v?.selected)
      .map(([k]) => k) : [];
    const orderedRoles = ROLE_ORDER.filter(r => selectedRoles.includes(r));
    if (orderedRoles.length > 0) {
      html += `<div class="field"><div class="field-label">Team Composition</div>
        <div class="role-grid">${orderedRoles.map(r => {
          const rl = ROLE_LABELS[r];
          return `<span class="role-tag">${rl?.icon || ''} ${escapeHtml(rl?.name || r)}</span>`;
        }).join('')}</div></div>`;
    } else {
      html += `<div class="field"><div class="field-label">Team Composition</div><div class="field-value empty">No roles selected</div></div>`;
    }

    const champion = d.teamRoles?.aiChampion;
    if (champion) {
      html += '<div class="field-divider"></div>';
      html += `<div class="field"><div class="field-label">AI Champion</div>`;
      if (champion.value === 'yes') {
        const names = champion.champions || [];
        html += `<div class="field-value">Yes${names.length > 0 ? ' â€” ' + names.map(n => escapeHtml(n)).join(', ') : ''}</div>`;
      } else if (champion.value === 'no') {
        const future = champion.futureChampions || [];
        html += `<div class="field-value">No${future.length > 0 ? '<br><span style="color:#86868b;font-size:0.85rem;">Future nominations: ' + future.map(n => escapeHtml(n)).join(', ') + '</span>' : ''}</div>`;
      } else {
        html += '<div class="field-value empty">Not specified</div>';
      }
      html += '</div>';
    }

    const stories = d.teamRoles?.successStories;
    if (stories?.value === 'yes' && stories.stories?.length > 0) {
      html += `<div class="field"><div class="field-label">AI Success Stories</div>
        <ul style="margin:0;padding-left:1.25rem;color:#1d1d1f;font-size:0.9rem;">
          ${stories.stories.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
        </ul></div>`;
    }

    html += renderNotes(notes, 'teamRoles');
    html += '</div>';

    // â”€â”€ 4. Tools & Infrastructure â”€â”€
    html += `<div class="section-card">
      <div class="section-title"><span class="section-icon">ğŸ› ï¸</span>Tools & Infrastructure</div>`;

    let hasAnyTools = false;
    TOOL_CATEGORIES.forEach(cat => {
      const catData = d.toolsAndInfrastructure?.[cat.id];
      if (!catData) return;
      const selected = Object.entries(catData)
        .filter(([k, v]) => !k.startsWith('_') && k !== 'custom' && k !== 'visible' && k !== 'dont-know' && k !== 'not-applicable' && v?.selected)
        .map(([k]) => cat.tools[k] || k);
      const customItems = (catData.custom || []).filter(t => t.selected).map(t => t.name);
      const all = [...selected, ...customItems];
      if (all.length > 0) {
        hasAnyTools = true;
        html += `<div class="field">
          <div class="field-label">${cat.icon} ${escapeHtml(cat.name)}</div>
          ${renderTags(all)}
        </div>`;
      }
    });

    if (!hasAnyTools) {
      html += '<div class="field-value empty">No tools selected</div>';
    }

    html += renderNotes(notes, 'tools');
    html += '</div>';

    // â”€â”€ 5. Role-Tool Matrix â”€â”€
    const matrix = d.roleToolMatrix;
    const aiCat = TOOL_CATEGORIES.find(c => c.id === 'ai');
    if (matrix && orderedRoles.length > 0 && aiCat) {
      // Find which AI tools are actually used by at least one role
      const usedAITools = Object.keys(aiCat.tools).filter(toolId => {
        return orderedRoles.some(roleId => matrix[`${roleId}:${toolId}`]);
      });
      // Also check custom AI tools from toolsAndInfrastructure
      const customAI = (d.toolsAndInfrastructure?.ai?.custom || []).filter(t => t.selected);
      const customUsed = customAI.filter(t => orderedRoles.some(r => matrix[`${r}:${t.id}`]));

      const allUsedTools = [...usedAITools, ...customUsed.map(t => t.id)];

      if (allUsedTools.length > 0) {
        html += `<div class="section-card">
          <div class="section-title"><span class="section-icon">ğŸ”—</span>Who Uses Which AI Tools</div>
          <table class="matrix-table">
            <thead><tr><th>Role</th>`;
        allUsedTools.forEach(toolId => {
          const label = aiCat.tools[toolId] || customUsed.find(t => t.id === toolId)?.name || toolId;
          html += `<th>${escapeHtml(label)}</th>`;
        });
        html += '</tr></thead><tbody>';

        orderedRoles.forEach(roleId => {
          const rl = ROLE_LABELS[roleId];
          html += `<tr><td>${rl?.icon || ''} ${escapeHtml(rl?.name || roleId)}</td>`;
          allUsedTools.forEach(toolId => {
            const checked = matrix[`${roleId}:${toolId}`];
            html += `<td>${checked ? '<span class="check">&#10003;</span>' : '<span class="dash">â€”</span>'}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table>';
        html += renderNotes(notes, 'roleToolMatrix');
        html += '</div>';
      }
    }

    // â”€â”€ 6. AI Use Case Needs â”€â”€
    const useCases = d.useCases;
    if (useCases) {
      let useCaseHtml = '';
      let hasUseCases = false;

      USECASE_CATEGORIES.forEach(cat => {
        const catData = useCases[cat.id];
        if (!catData) return;

        const needItems = [];
        const doingItems = [];

        Object.entries(catData).forEach(([k, v]) => {
          if (k.startsWith('_') || k === 'custom') return;
          if (v?.status === 'need') needItems.push(cat.items[k] || k);
          if (v?.status === 'doing') doingItems.push(cat.items[k] || k);
        });

        // Custom items
        (catData.custom || []).forEach(c => {
          if (c.status === 'need') needItems.push(c.label || c.id);
          if (c.status === 'doing') doingItems.push(c.label || c.id);
        });

        if (needItems.length > 0 || doingItems.length > 0) {
          hasUseCases = true;
          useCaseHtml += `<div class="usecase-cat">
            <div class="usecase-cat-name">${cat.icon} ${escapeHtml(cat.name)}</div>
            <div class="usecase-columns">`;
          if (needItems.length > 0) {
            useCaseHtml += `<div class="usecase-col">
              <div class="usecase-col-label">Need</div>
              ${renderTags(needItems, 'need')}
            </div>`;
          }
          if (doingItems.length > 0) {
            useCaseHtml += `<div class="usecase-col">
              <div class="usecase-col-label">Already Doing</div>
              ${renderTags(doingItems, 'doing')}
            </div>`;
          }
          useCaseHtml += '</div></div>';
        }
      });

      if (hasUseCases) {
        html += `<div class="section-card">
          <div class="section-title"><span class="section-icon">ğŸ“‹</span>AI Use Case Needs</div>
          ${useCaseHtml}
          ${renderNotes(notes, 'useCases')}
        </div>`;
      }
    }

    // â”€â”€ 7. AI Workflow Maturity â”€â”€
    const wfm = d.workflowMaturity;
    if (wfm) {
      const assessed = ROLE_ORDER.filter(r => {
        const entry = wfm[r];
        return entry && entry.stage !== null && entry.stage !== undefined;
      });
      if (assessed.length > 0) {
        html += `<div class="section-card">
          <div class="section-title"><span class="section-icon">ğŸ¤–</span>AI Workflow Maturity</div>`;
        assessed.forEach(roleId => {
          const stage = wfm[roleId].stage;
          const stageInfo = WFM_STAGES[stage];
          const rl = ROLE_LABELS[roleId];
          html += `<div class="wfm-item">
            <span class="wfm-role">${rl?.icon || ''} ${escapeHtml(rl?.name || roleId)}</span>
            <span class="wfm-stage">${stageInfo ? `${stageInfo.num} â€” ${stageInfo.title}` : `Stage ${stage}`}</span>
          </div>`;
        });
        html += renderNotes(notes, 'workflowMaturity');
        html += '</div>';
      }
    }

    // â”€â”€ 8. Limiting Factors â”€â”€
    const lf = d.limitingFactors;
    if (lf) {
      const ranked = Object.entries(lf)
        .filter(([k, v]) => !k.startsWith('_') && v?.rank)
        .sort((a, b) => a[1].rank - b[1].rank);
      if (ranked.length > 0) {
        html += `<div class="section-card">
          <div class="section-title"><span class="section-icon">ğŸš§</span>Limiting Factors</div>`;
        ranked.forEach(([k, v], i) => {
          let label = LIMITING_FACTOR_LABELS[k] || k;
          if (k === 'other' && v.text) label = v.text;
          html += `<div class="ranked-item">
            <span class="rank-badge ${i > 0 ? 'secondary' : ''}">${v.rank}</span>
            <span>${escapeHtml(label)}</span>
          </div>`;
        });
        html += renderNotes(notes, 'limitingFactors');
        html += '</div>';
      }
    }

    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function init() {
    const page = document.getElementById('pageContent');
    const loading = document.getElementById('loadingState');

    const params = new URLSearchParams(window.location.search);
    const surveyId = parseInt(params.get('id'));

    if (!surveyId) {
      loading.className = 'error-state';
      loading.textContent = 'No survey ID provided. Return to the dashboard.';
      return;
    }

    try {
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
      });

      const savedData = await loadFromIndexedDB();
      if (!savedData) {
        loading.className = 'error-state';
        loading.textContent = 'No database found. Please upload surveys from the dashboard first.';
        return;
      }

      const db = new SQL.Database(savedData);
      const result = db.exec(
        'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager FROM surveys WHERE id = ?',
        [surveyId]
      );

      if (result.length === 0 || result[0].values.length === 0) {
        loading.className = 'error-state';
        loading.textContent = 'Survey not found. It may have been deleted.';
        return;
      }

      const row = result[0].values[0];
      const survey = {
        id: row[0],
        account_name: row[1],
        exported_at: row[2],
        year: row[3],
        quarter: row[4],
        schema_version: row[5],
        data: JSON.parse(row[6]),
        account_type: row[7] || 'other',
        delivery_manager: row[8] || ''
      };

      // Update page title
      document.title = `${survey.account_name} â€” AI Adoption Assessment`;

      // Render
      loading.remove();
      page.innerHTML = renderDetail(survey);

    } catch (e) {
      console.error(e);
      loading.className = 'error-state';
      loading.textContent = 'Failed to load survey data. Please try again.';
    }
  }

  init();
</script>
</body>
</html>
