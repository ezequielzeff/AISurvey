<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Adoption Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f3f4f6;
      color: #1f2937;
      min-height: 100vh;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .dashboard-header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1.25rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-back {
      font-size: 0.85rem;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
    }
    .header-back:hover { text-decoration: underline; }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .filter-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #6b7280;
    }
    .filter-select {
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1f2937;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .filter-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .header-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }
    .btn-primary:hover { background: #4338ca; }
    .btn-secondary {
      background: #fff;
      color: #374151;
      border: 1.5px solid #e5e7eb;
    }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
    .btn-danger {
      background: none;
      color: #ef4444;
      border: none;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
    }
    .btn-danger:hover { background: #fef2f2; }
    .btn-icon {
      background: none;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      color: #6b7280;
      border-radius: 6px;
    }
    .btn-icon:hover { background: #f3f4f6; color: #1f2937; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACTIONS DROPDOWN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .actions-wrapper {
      position: relative;
      margin-left: auto;
    }
    .actions-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.15s;
    }
    .actions-toggle:hover { border-color: #d1d5db; color: #374151; }
    .actions-toggle:focus,
    .actions-toggle.open {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      color: #374151;
    }
    .actions-toggle .gear-icon { font-size: 1rem; }
    .actions-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 200;
      min-width: 200px;
      padding: 0.4rem 0;
    }
    .actions-menu.open { display: block; }
    .actions-menu-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.55rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #374151;
      background: none;
      border: none;
      cursor: pointer;
      transition: background 0.1s;
      text-align: left;
      white-space: nowrap;
    }
    .actions-menu-item:hover { background: #f3f4f6; }
    .actions-menu-item .item-icon {
      font-size: 1rem;
      width: 1.25rem;
      text-align: center;
      flex-shrink: 0;
    }
    .actions-menu-item.danger { color: #ef4444; }
    .actions-menu-item.danger:hover { background: #fef2f2; }
    .actions-menu-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 0.3rem 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SDLC AI COVERAGE MAP
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sdlc-phase-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }
    .sdlc-phase-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.3rem;
    }
    .sdlc-phase-label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #1f2937;
    }
    .sdlc-phase-stats {
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .sdlc-phase-stats .doing { color: #16a34a; }
    .sdlc-phase-stats .need { color: #d97706; }
    .sdlc-phase-stats .separator { color: #9ca3af; margin: 0 0.2rem; }
    .sdlc-bar-track {
      display: flex;
      width: 100%;
      height: 28px;
      border-radius: 6px;
      overflow: hidden;
      background: #e5e7eb;
    }
    .sdlc-bar-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
      transition: width 0.4s ease;
      overflow: hidden;
      white-space: nowrap;
    }
    .sdlc-bar-doing { background: #22c55e; }
    .sdlc-bar-need { background: #f59e0b; }
    .sdlc-bar-notusing {
      background: #e5e7eb;
      color: #6b7280;
    }
    .sdlc-phase-block {
      margin-bottom: 1rem;
      cursor: pointer;
      padding: 0.5rem 0.6rem;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .sdlc-phase-block:hover {
      background: #f9fafb;
    }
    .sdlc-phase-block:last-child {
      margin-bottom: 0;
    }
    /* SDLC Phase Modal */
    .sdlc-modal-item {
      margin-bottom: 0.85rem;
    }
    .sdlc-modal-item:last-child {
      margin-bottom: 0;
    }
    .sdlc-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.25rem;
    }
    .sdlc-modal-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #1f2937;
    }
    .sdlc-modal-pcts {
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .sdlc-modal-pcts .doing { color: #16a34a; }
    .sdlc-modal-pcts .need { color: #d97706; }
    .sdlc-modal-pcts .not-using { color: #9ca3af; }
    .sdlc-modal-pcts .separator { color: #d1d5db; margin: 0 0.15rem; }
    .sdlc-modal-bar {
      display: flex;
      width: 100%;
      height: 22px;
      border-radius: 5px;
      overflow: hidden;
      background: #e5e7eb;
    }
    .sdlc-modal-bar .sdlc-bar-segment {
      height: 100%;
      font-size: 0.7rem;
    }
    .sdlc-legend {
      display: flex;
      gap: 1.5rem;
      margin-top: 1.25rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }
    .sdlc-legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }
    .sdlc-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .sdlc-key-insight {
      margin-top: 0.75rem;
      padding: 0.65rem 0.85rem;
      background: #eff6ff;
      border-radius: 8px;
      font-size: 0.82rem;
      color: #1e40af;
      line-height: 1.4;
    }
    .sdlc-key-insight strong {
      color: #1e3a8a;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .dashboard-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem 2rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SUMMARY CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .summary-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .summary-card-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    .summary-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1f2937;
    }
    .summary-card-label {
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 500;
    }
    /* AI Usage card â€” comparison indicator */
    .summary-card-comparison {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.15rem;
    }
    .summary-card-comparison.up { color: #10b981; }
    .summary-card-comparison.down { color: #ef4444; }
    .summary-card-comparison.neutral { color: #6b7280; }
    .summary-card-comparison .arrow { font-size: 0.75rem; }
    /* Inline period picker */
    .summary-card-period-picker { margin-top: 0.35rem; }
    .summary-card-period-picker select {
      padding: 0.2rem 0.4rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.75rem;
      color: #6b7280;
      background: #f9fafb;
      cursor: pointer;
      outline: none;
    }
    .summary-card-period-picker select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WIDGET CARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .widget-section {
      margin-bottom: 2rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.25rem;
    }
    .widget-section-title {
      font-size: 1.15rem;
      font-weight: 800;
      color: #1e3a5f;
      margin-bottom: 1rem;
      padding: 0.6rem 0.75rem;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .widget-section-title:hover {
      color: #4f46e5;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    }
    .section-chevron {
      font-size: 1.2rem;
      transition: transform 0.2s ease;
      color: #6366f1;
    }
    .widget-section.collapsed .section-chevron {
      transform: rotate(-90deg);
    }
    .widget-section.collapsed .widget-section-content {
      display: none;
    }
    .widget-section.collapsed .widget-section-title {
      margin-bottom: 0;
    }
    .widget-section-summary {
      display: none;
      padding: 0.75rem 0;
      gap: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.85rem;
      color: #374151;
    }
    .widget-section.collapsed .widget-section-summary {
      display: flex;
    }
    .section-summary-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .section-summary-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .section-summary-value {
      font-weight: 700;
      color: #1e3a5f;
    }
    .section-summary-divider {
      width: 1px;
      height: 1.2rem;
      background: #e5e7eb;
    }
    .section-summary-challenges {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-summary-mini-bar {
      width: 120px;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #ef4444 0%, #f97316 16%, #eab308 33%, #eab308 50%, #4ade80 72%, #22c55e 100%);
      position: relative;
      margin-top: 0.3rem;
    }
    .section-summary-mini-marker {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #1f2937;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .section-summary-challenge-pill {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      color: #0369a1;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .widget-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 1.75rem;
      margin-bottom: 1.5rem;
    }
    .widget-header {
      margin-bottom: 1.25rem;
    }
    .widget-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .widget-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }
    .widget-question {
      font-size: 0.9rem;
      color: #4b5563;
      font-style: italic;
      margin-top: 0.75rem;
      padding: 0.6rem 0.85rem;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 3px solid #4f46e5;
    }

    /* Stage Callout */
    .stage-callout {
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      display: inline-flex;
      flex-direction: column;
      gap: 0.15rem;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      z-index: 10;
      transition: left 0.5s ease;
    }
    .stage-callout-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6366f1;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .stage-callout-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #312e81;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .stage-callout-desc {
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Stage Pipeline */
    .stage-pipeline {
      display: flex;
      align-items: stretch;
      justify-content: center;
      gap: 0;
      margin: 1.5rem 0 1rem;
    }
    .stage-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.85rem 0.75rem;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      max-width: 160px;
      min-width: 100px;
      text-align: center;
      position: relative;
      background: #fff;
    }
    .stage-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      z-index: 2;
    }
    .stage-card.active {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 2;
    }
    .stage-card-icon {
      font-size: 1.5rem;
      margin-bottom: 0.35rem;
    }
    .stage-card-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #374151;
      line-height: 1.2;
      margin-bottom: 0.25rem;
    }
    .stage-card-pct {
      font-size: 1.1rem;
      font-weight: 800;
      color: #1f2937;
    }
    .stage-card-count {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.1rem;
    }
    .stage-connector {
      display: flex;
      align-items: center;
      color: #d1d5db;
      font-size: 1.1rem;
      padding: 0 0.15rem;
      flex-shrink: 0;
    }

    /* Gradient Progress Bar */
    .progress-section {
      margin: 1rem 0 1.5rem;
      padding: 0 0.5rem;
    }
    .progress-bar-wrapper {
      position: relative;
      padding-top: 5rem;
    }
    .progress-gradient-bar {
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(to right, #ef4444 0%, #f97316 16%, #eab308 33%, #eab308 50%, #4ade80 72%, #22c55e 100%);
      position: relative;
      margin: 0.75rem 0 0.4rem;
    }
    .progress-marker {
      position: absolute;
      bottom: 100%;
      transform: translateX(-50%);
      transition: left 0.5s ease;
      font-size: 1rem;
      line-height: 1;
      color: #1f2937;
      margin-bottom: -2px;
    }
    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #9ca3af;
    }


    /* Limiting Factors Chart */
    .lf-chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }
    .ai-tools-chart-container {
      position: relative;
      width: 100%;
      height: 420px;
    }
    .ai-challenges-chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }

    /* Widget Legend */
    .widget-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.25rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Widget Footer (filter controls) */
    .widget-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }
    .filter-active-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      border: 1px solid #c7d2fe;
    }
    .filter-clear-btn {
      background: none;
      border: 1px solid #d1d5db;
      color: #6b7280;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-clear-btn:hover {
      background: #f9fafb;
      color: #374151;
      border-color: #9ca3af;
    }
    .filter-clear-x {
      cursor: pointer;
      font-weight: 700;
      margin-left: 0.2rem;
      font-size: 0.9rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHARTS GRID (kept for future widgets)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .chart-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
    }
    .chart-card-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    .chart-container {
      position: relative;
      width: 100%;
      min-height: 250px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SURVEYS TABLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .surveys-section {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .surveys-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .surveys-section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
    }
    .surveys-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .surveys-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
      color: #6b7280;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .surveys-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 1.5rem;
    }
    .surveys-table th.sortable:hover { color: #374151; background: #f3f4f6; }
    .surveys-table th.sortable::after {
      content: ' â‡…';
      font-size: 0.7rem;
      opacity: 0.35;
      position: absolute;
      right: 0.4rem;
      top: 50%;
      transform: translateY(-50%);
    }
    .surveys-table th.sort-asc::after { content: ' â–²'; opacity: 0.8; color: #4f46e5; }
    .surveys-table th.sort-desc::after { content: ' â–¼'; opacity: 0.8; color: #4f46e5; }
    .surveys-table th input[type="checkbox"],
    .surveys-table td input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: #4f46e5;
    }
    .surveys-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f3f4f6;
      color: #374151;
    }
    .surveys-table tbody tr:hover td {
      background: #eef2ff;
    }
    .surveys-table tbody tr {
      transition: background 0.15s;
    }
    .surveys-table .actions {
      display: flex;
      gap: 0.25rem;
    }
    .maturity-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    /* Account Type Badges */
    .account-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .account-type-enterprise { background: #dbeafe; color: #1d4ed8; }
    .account-type-key-account { background: #fef3c7; color: #92400e; }
    .account-type-enterprise-key { background: #d1fae5; color: #065f46; }
    .account-type-other { background: #f3f4f6; color: #6b7280; }

    /* Inline Account Type Select */
    .account-type-select {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .account-type-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .dm-input {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      outline: none;
      width: 120px;
      box-sizing: border-box;
    }
    .dm-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    .dm-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .maturity-not-started { background: #f3f4f6; color: #6b7280; }
    .maturity-exploring { background: #dbeafe; color: #1d4ed8; }
    .maturity-piloting { background: #fef3c7; color: #92400e; }
    .maturity-scaling { background: #d1fae5; color: #065f46; }
    .maturity-optimizing { background: #ede9fe; color: #5b21b6; }
    .maturity-dont-know { background: #fef2f2; color: #f87171; }

    /* More info link */
    .more-info-link {
      font-size: 0.85rem;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .more-info-link:hover {
      text-decoration: underline;
      color: #4338ca;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MATURITY INFO MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .info-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .info-modal-overlay.open {
      display: flex;
    }
    .info-modal {
      background: #fff;
      border-radius: 16px;
      max-width: 720px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .info-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .info-modal-close:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .info-modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .info-modal-stage {
      margin-bottom: 1.5rem;
    }
    .info-modal-stage:last-child {
      margin-bottom: 0;
    }
    .info-modal-stage h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #4f46e5;
      margin: 0 0 0.5rem;
    }
    .info-modal-stage p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }
    .info-modal-summary {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }
    .info-modal-summary h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 0.5rem;
    }
    .info-modal-summary p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACCOUNT MATURITY COMPARISON MATRIX
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .comparison-table-wrapper {
      overflow-x: auto;
    }
    .comparison-matrix {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .comparison-matrix thead th {
      background: #1e3a5f;
      color: #fff;
      padding: 0.6rem 0.5rem;
      text-align: center;
      font-weight: 700;
      font-size: 0.78rem;
      white-space: nowrap;
      border: 1px solid #2d4a6f;
    }
    .comparison-account-col {
      text-align: left !important;
      min-width: 180px;
    }
    .comparison-matrix tbody td {
      padding: 0.4rem 0.5rem;
      border: 1px solid #e5e7eb;
      vertical-align: middle;
    }
    .comparison-matrix tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .comparison-matrix tbody tr:hover {
      background: #eef2ff;
    }
    .comparison-matrix .account-name-cell {
      font-weight: 600;
      color: #1f2937;
      white-space: nowrap;
    }
    .comparison-matrix .stage-fill {
      height: 22px;
      border-radius: 3px;
    }
    .comparison-matrix .account-link-icon {
      color: #6b7280;
      font-size: 0.8rem;
      margin-left: 0.35rem;
      text-decoration: none;
    }
    .comparison-matrix .account-link-icon:hover {
      color: #4f46e5;
    }
    .comparison-matrix .stage-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.8);
      display: inline-block;
      vertical-align: middle;
      margin: 4px auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UPLOAD MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .modal-close:hover { background: #f3f4f6; color: #1f2937; }
    .modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .drop-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafbfc;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: #4f46e5;
      background: #eef2ff;
    }
    .drop-zone-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .drop-zone-text { font-size: 0.95rem; color: #6b7280; }
    .drop-zone-hint { font-size: 0.8rem; color: #9ca3af; margin-top: 0.25rem; }
    .upload-results {
      margin-top: 1.25rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .upload-result-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.85rem;
    }
    .upload-result-item:last-child { border-bottom: none; }
    .upload-result-icon { flex-shrink: 0; }
    .upload-result-text { color: #374151; }
    .upload-result-error { color: #ef4444; }
    .upload-result-warning { color: #f59e0b; }
    .upload-result-success { color: #10b981; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EMPTY STATE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    .empty-state-text {
      font-size: 0.95rem;
      color: #6b7280;
      margin-bottom: 1.5rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .loading-overlay {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4rem;
      flex-direction: column;
      gap: 1rem;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #4f46e5;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: #6b7280; font-size: 0.9rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MULTI-SELECT DROPDOWN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .multi-select {
      position: relative;
      display: inline-block;
    }
    .multi-select-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1f2937;
      background: #fff;
      cursor: pointer;
      outline: none;
      min-width: 120px;
    }
    .multi-select-btn:hover { border-color: #d1d5db; }
    .multi-select-btn:focus, .multi-select-btn.open {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .multi-select-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-select-arrow {
      font-size: 0.7rem;
      color: #6b7280;
      flex-shrink: 0;
    }
    .multi-select-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 200;
      min-width: 200px;
      padding: 0.4rem 0;
    }
    .multi-select-menu.open { display: block; }
    .multi-select-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.85rem;
      font-size: 0.85rem;
      color: #374151;
      cursor: pointer;
      transition: background 0.1s;
    }
    .multi-select-item:hover { background: #f3f4f6; }
    .multi-select-item input[type="checkbox"] {
      accent-color: #4f46e5;
      width: 15px;
      height: 15px;
      cursor: pointer;
    }
    .multi-select-actions {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0.85rem;
      border-top: 1px solid #f3f4f6;
      margin-top: 0.25rem;
    }
    .multi-select-actions button {
      background: none;
      border: none;
      color: #4f46e5;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.15rem 0;
    }
    .multi-select-actions button:hover { text-decoration: underline; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WORKFLOW MATURITY JOURNEY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .wfm-section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #374151;
      margin: 1.25rem 0 1rem;
    }
    .wfm-journey {
      display: flex;
      align-items: stretch;
      justify-content: center;
      gap: 0;
      position: relative;
      margin: 0.5rem 0 1rem;
    }
    .wfm-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 0.6rem;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      max-width: 150px;
      min-width: 90px;
      text-align: center;
      position: relative;
      background: #fff;
    }
    .wfm-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      z-index: 2;
    }
    .wfm-card.active {
      transform: translateY(-3px);
      z-index: 2;
    }
    .wfm-card-badge {
      font-size: 0.6rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-bottom: 0.25rem;
      letter-spacing: 0.03em;
    }
    .wfm-card-title {
      font-size: 0.72rem;
      font-weight: 700;
      color: #374151;
      line-height: 1.2;
      margin-bottom: 0.2rem;
    }
    .wfm-card-pct {
      font-size: 1.1rem;
      font-weight: 800;
    }
    .wfm-card-count {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.1rem;
      margin-bottom: 0.2rem;
    }
    .wfm-card-sub {
      font-size: 0.62rem;
      color: #9ca3af;
      line-height: 1.2;
    }
    .wfm-info-icon {
      cursor: pointer;
      font-size: 0.85rem;
      opacity: 0.7;
      transition: opacity 0.15s;
    }
    .wfm-info-icon:hover {
      opacity: 1;
    }
    .wfm-gradient-bar {
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(to right, #ef4444 0%, #f97316 20%, #eab308 40%, #eab308 55%, #4ade80 75%, #22c55e 100%);
      position: relative;
      margin: 0.75rem 0 0.4rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
      .dashboard-content { padding: 1rem; }
      .dashboard-header { padding: 1rem; }
      .header-top { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .header-controls { width: 100%; }
      .actions-wrapper { margin-left: 0; }
      .actions-menu { right: auto; left: 0; }
      .stage-pipeline { flex-wrap: wrap; gap: 0.5rem; }
      .stage-connector { display: none; }
      .stage-card { min-width: 80px; }
      .wfm-journey { flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
      .wfm-journey .stage-connector { display: none; }
      .wfm-card { min-width: 80px; }
    }
    @media (max-width: 600px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
      .surveys-table { font-size: 0.8rem; }
      .surveys-table th, .surveys-table td { padding: 0.5rem; }
      .widget-card { padding: 1.25rem; }
      .stage-card { padding: 0.6rem 0.5rem; }
      .stage-card-icon { font-size: 1.2rem; }
      .wfm-card { padding: 0.6rem 0.5rem; }
    }

  </style>
</head>
<body>

  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-top">
      <div class="header-title">AI Adoption Dashboard</div>
      <a href="index.html" class="header-back">Back to Survey Tool</a>
    </div>
    <div class="header-controls">
      <div class="filter-group">
        <span class="filter-label">Year:</span>
        <select class="filter-select" id="filterYear"></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Quarter:</span>
        <select class="filter-select" id="filterQuarter">
          <option value="all">All</option>
          <option value="1">Q1</option>
          <option value="2">Q2</option>
          <option value="3">Q3</option>
          <option value="4">Q4</option>
        </select>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Type:</span>
        <div class="multi-select" id="filterAccountType">
          <button class="multi-select-btn" onclick="toggleAccountTypeMenu()" type="button">
            <span class="multi-select-text" id="accountTypeLabel">All Types</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="accountTypeMenu">
            <label class="multi-select-item">
              <input type="checkbox" value="enterprise" checked onchange="onAccountTypeChange()"> Enterprise
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="key-account" checked onchange="onAccountTypeChange()"> Key Account
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="enterprise-key" checked onchange="onAccountTypeChange()"> Enterprise + Key
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="other" checked onchange="onAccountTypeChange()"> Other
            </label>
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllAccountTypes()">Select All</button>
              <button type="button" onclick="clearAccountTypes()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Engagement:</span>
        <div class="multi-select" id="filterEngagementType">
          <button class="multi-select-btn" onclick="toggleEngagementTypeMenu()" type="button">
            <span class="multi-select-text" id="engagementTypeLabel">All Types</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="engagementTypeMenu">
            <label class="multi-select-item">
              <input type="checkbox" value="staff" checked onchange="onEngagementTypeChange()"> Staff Augmentation
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="project" checked onchange="onEngagementTypeChange()"> Project Ownership
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="program" checked onchange="onEngagementTypeChange()"> Program Ownership
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="outcome" checked onchange="onEngagementTypeChange()"> Business Outcome
            </label>
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllEngagementTypes()">Select All</button>
              <button type="button" onclick="clearEngagementTypes()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Accounts:</span>
        <div class="multi-select" id="filterAccounts">
          <button class="multi-select-btn" onclick="toggleAccountsMenu()" type="button">
            <span class="multi-select-text" id="accountsLabel">All Accounts</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="accountsMenu" style="max-height:300px;overflow-y:auto;">
            <!-- Dynamically populated by populateAccountsFilter() -->
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllAccountsFromMenu()">Select All</button>
              <button type="button" onclick="clearAllAccountsFromMenu()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">DM:</span>
        <div class="multi-select" id="filterDM">
          <button class="multi-select-btn" onclick="toggleDMMenu()" type="button">
            <span class="multi-select-text" id="dmLabel">All DMs</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="dmMenu" style="max-height:300px;overflow-y:auto;">
            <!-- Dynamically populated by populateDMFilter() -->
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllDMsFromMenu()">Select All</button>
              <button type="button" onclick="clearAllDMsFromMenu()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Actions dropdown -->
      <div class="actions-wrapper">
        <button class="actions-toggle" id="actionsToggle" type="button" title="Data & upload actions">
          <span class="gear-icon">&#9881;</span> Actions <span style="font-size:0.7rem;color:#9ca3af;">&#9662;</span>
        </button>
        <div class="actions-menu" id="actionsMenu">
          <button class="actions-menu-item" id="uploadBtn" type="button">
            <span class="item-icon">&#128228;</span> Upload Survey
          </button>
          <button class="actions-menu-item" id="exportSurveysBtn" type="button">
            <span class="item-icon">&#128196;</span> Export Surveys
          </button>
          <div class="actions-menu-divider"></div>
          <button class="actions-menu-item" id="exportDbBtn" type="button">
            <span class="item-icon">&#128190;</span> Backup Database
          </button>
          <label class="actions-menu-item" style="cursor:pointer;">
            <span class="item-icon">&#128259;</span> Restore Database
            <input type="file" id="importDbInput" accept=".sqlite,.db" style="display:none;">
          </label>
          <div class="actions-menu-divider"></div>
          <button class="actions-menu-item danger" id="clearDbBtn" type="button">
            <span class="item-icon">&#128465;</span> Clear Database
          </button>
        </div>
      </div>
    </div>
    <div class="header-subtitle" id="headerSubtitle">Loading...</div>
  </header>

  <!-- Loading State -->
  <div id="loadingState" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing database...</div>
  </div>

  <!-- Main Content (hidden until loaded) -->
  <div id="mainContent" class="dashboard-content" style="display:none;">

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">ğŸ“Š</div>
      <div class="empty-state-title">No surveys uploaded yet</div>
      <div class="empty-state-text">Upload survey JSON or ZIP files to see aggregated analytics across all your AI adoption assessments.</div>
      <button class="btn btn-primary" onclick="openUploadModal()">Upload Your First Survey</button>
    </div>

    <!-- Dashboard Content (hidden when empty) -->
    <div id="dashboardContent" style="display:none;">

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-card-icon">ğŸ“‹</div>
          <div class="summary-card-value" id="totalSurveys">0</div>
          <div class="summary-card-label">Surveys</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">ğŸ¤–</div>
          <div class="summary-card-value" id="aiUsagePct">--</div>
          <div class="summary-card-label">AI Usage (%)</div>
          <div class="summary-card-comparison neutral" id="aiUsageComparison"></div>
          <div class="summary-card-period-picker">
            <select id="aiUsageCompPeriod" title="Compare against">
              <option value="prev-quarter">vs Previous Quarter</option>
              <option value="same-quarter-last-year">vs Same Quarter Last Year</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Section: Client AI Landscape -->
      <div class="widget-section">
        <div class="widget-section-title" onclick="toggleSection(this)">
          <span>Client AI Landscape</span>
          <span class="section-chevron">&#9662;</span>
        </div>
        <div class="widget-section-summary" id="sectionSummaryLandscape">
          <!-- Populated by JS -->
        </div>
        <div class="widget-section-content">

      <!-- Widget: Clients AI Adoption Stage -->
      <div class="widget-card" id="adoptionStageWidget">
        <div class="widget-header">
          <div class="widget-title">Clients AI Adoption Stage</div>
          <div class="widget-subtitle">Portfolio-wide adoption maturity</div>
          <div class="widget-question">At what stage are clients in their AI adoption journey? <a href="#" class="more-info-link" onclick="event.preventDefault();openMaturityInfoModal();">More info</a></div>
        </div>

        <!-- Stage Pipeline -->
        <div class="stage-pipeline" id="stagePipeline">
          <!-- Populated by JS -->
        </div>

        <!-- Gradient Progress Bar with Callout -->
        <div class="progress-section">
          <div class="progress-bar-wrapper">
            <div class="stage-callout" id="stageCallout" onclick="openStageDescriptionModal()" style="cursor:pointer;left:50%;" title="Click for stage description">
              <div class="stage-callout-label">Average Portfolio Stage</div>
              <div class="stage-callout-value" id="stageCalloutValue">--</div>
              <div class="stage-callout-desc">Median stage across all accounts</div>
            </div>
            <div class="progress-gradient-bar">
              <div class="progress-marker" id="progressMarker" style="left:50%;">&#9650;</div>
            </div>
          </div>
          <div class="progress-labels">
            <span>Less Mature</span>
            <span>More Mature</span>
          </div>
        </div>

        <!-- Legend -->
        <div class="widget-legend" id="widgetLegend">
          <!-- Populated by JS -->
        </div>

        <!-- Filter Footer (shown when any filter active) -->
        <div class="widget-footer" id="widgetFooter" style="display:none;">
          <div id="activeFilterTags" style="display:flex;gap:0.5rem;flex-wrap:wrap;"></div>
          <button class="filter-clear-btn" onclick="clearAllFilters()">Clear All Filters</button>
        </div>
      </div>

      <!-- Widget: AI Challenges -->
      <div class="widget-card" id="aiChallengesWidget">
        <div class="widget-header">
          <div class="widget-title">AI Challenges</div>
          <div class="widget-subtitle">Top challenges clients face in AI adoption</div>
          <div class="widget-question">What are the biggest AI challenges reported by clients?</div>
        </div>
        <div class="ai-challenges-chart-container">
          <canvas id="chartAiChallenges"></canvas>
        </div>
        <div class="widget-legend" id="aiChallengesLegend"></div>
      </div>

        </div> <!-- end widget-section-content -->
      </div> <!-- end Client AI Landscape section -->

      <!-- Section: Account AI Landscape -->
      <div class="widget-section">
        <div class="widget-section-title" onclick="toggleSection(this)">
          <span>Account AI Landscape</span>
          <span class="section-chevron">&#9662;</span>
        </div>
        <div class="widget-section-summary" id="sectionSummaryAccount">
          <!-- Populated by JS -->
        </div>
        <div class="widget-section-content">

      <!-- Widget: Account AI Agentic Workflow -->
      <div class="widget-card" id="workflowMaturityWidget">
        <div class="widget-header">
          <div class="widget-title">Account AI Agentic Workflow <a href="#" class="more-info-link" onclick="event.preventDefault();openAccountComparisonModal();" style="font-size:0.8rem;margin-left:0.5rem;">See accounts comparison</a></div>
          <div class="widget-subtitle">Account distribution across AI workflow maturity stages</div>
        </div>

        <div class="wfm-section-title">Maturity Journey Distribution</div>

        <!-- Journey visualization -->
        <div class="wfm-journey" id="wfmJourney">
          <!-- Populated by JS -->
        </div>

        <!-- Gradient bar with Callout -->
        <div class="progress-section" id="wfmProgressSection" style="margin-left:0;">
          <div class="progress-bar-wrapper">
            <div class="stage-callout" id="wfmCallout" onclick="openWfmStageDescriptionModal()" style="cursor:pointer;left:50%;" title="Click for stage description">
              <div class="stage-callout-label">Portfolio Average Maturity <span class="wfm-info-icon" onclick="event.stopPropagation();openWfmInfoModal();" title="How is this calculated?">â„¹ï¸</span></div>
              <div class="stage-callout-value" id="wfmAvgValue">--</div>
              <div class="stage-callout-desc" id="wfmAvgDesc">Average stage across all accounts</div>
            </div>
            <div class="wfm-gradient-bar">
              <div class="progress-marker" id="wfmProgressMarker" style="left:50%;">&#9650;</div>
            </div>
          </div>
          <div class="progress-labels">
            <span>â† Starting Point</span>
            <span>Maturity Goal â†’</span>
          </div>
        </div>
      </div>

      <!-- Widget: Limiting Factors -->
      <div class="widget-card" id="limitingFactorsWidget">
        <div class="widget-header">
          <div class="widget-title">Limiting Factors</div>
          <div class="widget-subtitle">What holds teams back from adopting AI</div>
          <div class="widget-question">Which factors are most frequently limiting AI adoption across the portfolio?</div>
        </div>
        <div class="lf-chart-container">
          <canvas id="chartLimitingFactors"></canvas>
        </div>
        <div class="widget-legend" id="lfLegend"></div>
      </div>

      <!-- Widget: AI Tools Usage -->
      <div class="widget-card" id="aiToolsWidget">
        <div class="widget-header">
          <div class="widget-title">AI Tools Usage</div>
          <div class="widget-subtitle">Which AI tools are teams using across the portfolio</div>
          <div class="widget-question">What AI tools are being used by delivery teams?</div>
        </div>
        <div class="ai-tools-chart-container">
          <canvas id="chartAiTools"></canvas>
        </div>
        <div class="widget-legend" id="aiToolsLegend"></div>
      </div>

      <!-- Widget: SDLC AI Coverage Map -->
      <div class="widget-card" id="sdlcCoverageWidget">
        <div class="widget-header">
          <div class="widget-title">SDLC AI Coverage Map</div>
          <div class="widget-subtitle">AI adoption across software delivery lifecycle phases</div>
          <div class="widget-question">Click on each phase to see detailed use case breakdown</div>
        </div>
        <div id="sdlcCoverageContent">
          <!-- Populated by JS -->
        </div>
        <div class="sdlc-legend">
          <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#22c55e;"></span> Doing</span>
          <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#f59e0b;"></span> Need but not Doing</span>
          <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#e5e7eb;"></span> Not Using</span>
        </div>
        <div class="sdlc-key-insight" id="sdlcKeyInsight"></div>
      </div>

        </div> <!-- end widget-section-content -->
      </div> <!-- end Account AI Landscape section -->

      <!-- Section: Surveys -->
      <div class="widget-section">
        <div class="widget-section-title" onclick="toggleSection(this)">
          <span>Surveys</span>
          <span class="section-chevron">&#9662;</span>
        </div>
        <div class="widget-section-summary" id="sectionSummarySurveys">
          <!-- Populated by JS -->
        </div>
        <div class="widget-section-content">

      <div class="surveys-section">
        <table class="surveys-table">
          <thead>
            <tr>
              <th style="width:40px;text-align:center;padding:0.5rem;">
                <input type="checkbox" id="selectAllTableAccounts" title="Select all / Clear all" onchange="onSelectAllAccountsToggle(this.checked)">
              </th>
              <th class="sortable sort-asc" data-sort="account">Account</th>
              <th class="sortable" data-sort="type">Type</th>
              <th class="sortable" data-sort="maturity">Client AI Maturity</th>
              <th class="sortable" data-sort="wfm">Account AI Agentic Workflow</th>
              <th class="sortable" data-sort="dm">Delivery Manager</th>
              <th class="sortable" data-sort="quarter">Quarter</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="surveysTableBody"></tbody>
        </table>
      </div>

        </div> <!-- end widget-section-content -->
      </div> <!-- end Surveys section -->
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal">
      <button class="modal-close" onclick="closeUploadModal()" title="Close">&times;</button>
      <h2>Upload Survey Files</h2>
      <div style="display:flex;gap:1rem;margin-bottom:1.25rem;align-items:end;flex-wrap:wrap;">
        <div style="flex:1;min-width:120px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Year</label>
          <select class="filter-select" id="uploadYear" style="width:100%;"></select>
        </div>
        <div style="flex:1;min-width:120px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Quarter</label>
          <select class="filter-select" id="uploadQuarter" style="width:100%;">
            <option value="1">Q1 (Jan-Mar)</option>
            <option value="2">Q2 (Apr-Jun)</option>
            <option value="3">Q3 (Jul-Sep)</option>
            <option value="4">Q4 (Oct-Dec)</option>
          </select>
        </div>
        <div style="flex:1;min-width:150px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Account Type</label>
          <select class="filter-select" id="uploadAccountType" style="width:100%;">
            <option value="enterprise">Enterprise</option>
            <option value="key-account">Key Account</option>
            <option value="enterprise-key">Enterprise + Key Account</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Delivery Manager</label>
          <input type="text" class="filter-select" id="uploadDeliveryManager" placeholder="e.g. John Smith" style="width:100%;box-sizing:border-box;">
        </div>
      </div>
      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">ğŸ“</div>
        <div class="drop-zone-text">Drag & drop JSON or ZIP files here</div>
        <div class="drop-zone-hint">or click to browse</div>
        <input type="file" id="fileInput" accept=".json,.zip" multiple style="display:none;">
      </div>
      <div class="upload-results" id="uploadResults"></div>
    </div>
  </div>

  <!-- Maturity Info Modal -->
  <div class="info-modal-overlay" id="maturityInfoModal">
    <div class="info-modal">
      <button class="info-modal-close" onclick="closeMaturityInfoModal()" title="Close">&times;</button>
      <h2>AI Adoption Journey â€” Stage Descriptions</h2>

      <div class="info-modal-stage">
        <h3>ğŸš« Not Started â€” "AI is not on the agenda"</h3>
        <p>At this stage, AI is essentially absent from the account's strategy. There are no initiatives, no owners, and no clear awareness of where AI could add value. If AI is mentioned, it's usually abstract or perceived as something for "big tech companies," not something actionable for them. Decisions are driven by existing processes and tools, and there is often uncertainty or skepticism around AI's relevance, cost, or risk.</p>
      </div>

      <div class="info-modal-stage">
        <h3>ğŸ” Exploring â€” "We are trying to understand AI"</h3>
        <p>Here the account has curiosity, but not commitment. AI is being researched, discussed, or experimented with informally â€” maybe through demos, workshops, vendor conversations, or isolated experiments by motivated individuals. There is no production usage, no clear ROI expectations, and no governance. Learning is the goal, not outcomes. This stage is about sense-making, not delivery.</p>
      </div>

      <div class="info-modal-stage">
        <h3>ğŸ§ª Piloting â€” "We are testing if AI actually works for us"</h3>
        <p>This is a key inflection point. The account is running concrete POCs tied to real problems (often in limited scopes like SDLC, support, or analytics). There is some budget, some sponsorship, and early success criteria â€” but AI is still treated as an experiment. Results are evaluated cautiously, risks are contained, and decisions about scaling are pending. AI exists, but it's not yet trusted or systemic.</p>
      </div>

      <div class="info-modal-stage">
        <h3>ğŸ“ˆ Scaling â€” "AI is becoming part of how we operate"</h3>
        <p>Now AI has proven value. Successful pilots are expanded across teams, functions, or products. Investment increases, governance starts to matter, and repeatability becomes important. The account begins to standardize tools, define ownership, train people, and integrate AI into workflows. The focus shifts from "does this work?" to "how do we roll this out safely and consistently?"</p>
      </div>

      <div class="info-modal-stage">
        <h3>âš¡ Optimizing â€” "AI is embedded and continuously improved"</h3>
        <p>At this stage, AI is no longer a project â€” it's infrastructure. AI is embedded into core processes and products, measured with KPIs, and continuously refined. The account actively optimizes models, workflows, and cost/value tradeoffs. People are trained by default, governance is mature, and AI decisions are part of normal business planning. The question is no longer whether to use AI, but how to do it better.</p>
      </div>

      <div class="info-modal-summary">
        <h3>The big difference across stages</h3>
        <p>Early stages are about learning and reducing uncertainty. Middle stages are about proving value and managing risk. Later stages are about institutionalizing and optimizing impact.</p>
      </div>
    </div>
  </div>

  <!-- Stage Description Modal (single stage) -->
  <div class="info-modal-overlay" id="stageDescriptionModal">
    <div class="info-modal" style="max-width:560px;">
      <button class="info-modal-close" onclick="closeStageDescriptionModal()" title="Close">&times;</button>
      <div id="stageDescriptionContent"></div>
    </div>
  </div>

  <div class="info-modal-overlay" id="wfmInfoModal">
    <div class="info-modal" style="max-width:620px;">
      <button class="info-modal-close" onclick="closeWfmInfoModal()" title="Close">&times;</button>
      <h2>How is Portfolio Average Maturity Calculated?</h2>
      <div class="info-modal-stage">
        <h3>Step 1 â€” Per-Account Stage</h3>
        <p>For each account (survey), we look at the workflow maturity stage assigned to each role (PM, BA, Architects, Software Engineers, QA, QA Automation, Data Engineers, DevOps, UI/UX). Roles with no stage assigned are excluded. The remaining stages (0â€“5) are averaged and rounded to the nearest integer to produce a single account-level stage.</p>
      </div>
      <div class="info-modal-stage">
        <h3>Step 2 â€” Portfolio Average</h3>
        <p>The portfolio average is the arithmetic mean of all account-level stages. It is displayed with one decimal point on a 0â€“5 scale, where 0 = No AI Usage and 5 = Semi-Agentic AI.</p>
      </div>
      <div class="info-modal-summary">
        <h3>Stage Reference</h3>
        <p><strong>Stage 0</strong> â€” No AI Usage Â· <strong>Stage 1</strong> â€” Individual AI Â· <strong>Stage 2</strong> â€” Team Practices Â· <strong>Stage 3</strong> â€” AI-Chained Â· <strong>Stage 4</strong> â€” Event-Triggered Â· <strong>Stage 5</strong> â€” Semi-Agentic</p>
      </div>
    </div>
  </div>

  <!-- Account Maturity Comparison Modal -->
  <div class="info-modal-overlay" id="accountComparisonModal">
    <div class="info-modal" style="max-width:1100px;">
      <button class="info-modal-close" onclick="closeAccountComparisonModal()" title="Close">&times;</button>
      <h2>Account Maturity Comparison</h2>
      <div class="comparison-table-wrapper">
        <table class="comparison-matrix">
          <thead>
            <tr>
              <th class="comparison-account-col">Account</th>
              <th>No AI</th>
              <th>Individual</th>
              <th>Team</th>
              <th>AI-Chained</th>
              <th>Event-Triggered</th>
              <th>Semi-Agentic</th>
            </tr>
          </thead>
          <tbody id="comparisonMatrixBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: SDLC Phase Use Case Breakdown -->
  <div class="info-modal-overlay" id="sdlcPhaseModal">
    <div class="info-modal" style="max-width:700px;">
      <button class="info-modal-close" onclick="closeSdlcPhaseModal()" title="Close">&times;</button>
      <h2 id="sdlcPhaseModalTitle"></h2>
      <div id="sdlcPhaseModalContent"></div>
    </div>
  </div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SCHEMA DEFINITIONS (mirrors index.html)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const SCHEMA_SEED = [
    // Engagement â€” Ownership
    { section: 'engagement', subsection: 'ownership', option_id: 'staff', option_label: 'Staff Augmentation', option_type: 'multi-select', display_order: 1 },
    { section: 'engagement', subsection: 'ownership', option_id: 'project', option_label: 'Project Ownership', option_type: 'multi-select', display_order: 2 },
    { section: 'engagement', subsection: 'ownership', option_id: 'program', option_label: 'Program Ownership', option_type: 'multi-select', display_order: 3 },
    { section: 'engagement', subsection: 'ownership', option_id: 'outcome', option_label: 'Business Outcome', option_type: 'multi-select', display_order: 4 },

    // Engagement â€” Payment
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'us', option_label: 'We Are/Will', option_type: 'single-select', display_order: 1 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'customer', option_label: 'Customer Is/Will', option_type: 'single-select', display_order: 2 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'mix', option_label: 'It Is a Mix', option_type: 'single-select', display_order: 3 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'tbd', option_label: 'To Be Determined', option_type: 'single-select', display_order: 4 },

    // Engagement â€” Compliance
    { section: 'engagement', subsection: 'compliance', option_id: 'hipaa', option_label: 'HIPAA', option_type: 'multi-select', display_order: 1 },
    { section: 'engagement', subsection: 'compliance', option_id: 'gdpr', option_label: 'GDPR', option_type: 'multi-select', display_order: 2 },
    { section: 'engagement', subsection: 'compliance', option_id: 'sox', option_label: 'SOX', option_type: 'multi-select', display_order: 3 },
    { section: 'engagement', subsection: 'compliance', option_id: 'pci-dss', option_label: 'PCI-DSS', option_type: 'multi-select', display_order: 4 },
    { section: 'engagement', subsection: 'compliance', option_id: 'fedramp', option_label: 'FedRAMP', option_type: 'multi-select', display_order: 5 },
    { section: 'engagement', subsection: 'compliance', option_id: 'soc2', option_label: 'SOC 2', option_type: 'multi-select', display_order: 6 },
    { section: 'engagement', subsection: 'compliance', option_id: 'ccpa', option_label: 'CCPA', option_type: 'multi-select', display_order: 7 },
    { section: 'engagement', subsection: 'compliance', option_id: 'iso27001', option_label: 'ISO 27001', option_type: 'multi-select', display_order: 8 },

    // Account AI Landscape â€” Maturity
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'not-started', option_label: 'Not Started', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'exploring', option_label: 'Exploring', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'piloting', option_label: 'Piloting', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'scaling', option_label: 'Scaling', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'optimizing', option_label: 'Optimizing', option_type: 'single-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 6 },

    // Account AI Landscape â€” Usage
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'multi-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'not-using', option_label: 'Not Using AI', option_type: 'multi-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'off-the-shelf', option_label: 'Off-the-Shelf Tools', option_type: 'multi-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'business-apps', option_label: 'AI in Business Apps', option_type: 'multi-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'custom-solutions', option_label: 'Custom AI Solutions', option_type: 'multi-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'business-processes', option_label: 'Process Automation', option_type: 'multi-select', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'customer-facing', option_label: 'Customer-Facing AI', option_type: 'multi-select', display_order: 7 },

    // Account AI Landscape â€” Priority
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'not-priority', option_label: 'Not a Priority', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'low', option_label: 'Low Priority', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'medium', option_label: 'Medium Priority', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'high', option_label: 'High Priority', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 5 },

    // Account AI Landscape â€” Governance
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'none', option_label: 'No Governance', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'informal', option_label: 'Informal', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'developing', option_label: 'Developing', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'established', option_label: 'Established', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 5 },

    // Account AI Landscape â€” Challenges
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'unclear-roi', option_label: 'Unclear ROI', option_type: 'ranked', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'skills', option_label: 'Skills Gap', option_type: 'ranked', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'data', option_label: 'Data Issues', option_type: 'ranked', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'security', option_label: 'Security/Compliance', option_type: 'ranked', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'budget', option_label: 'Budget/Buy-in', option_type: 'ranked', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'infrastructure', option_label: 'Infrastructure', option_type: 'ranked', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'ranked', display_order: 7 },

    // Account AI Landscape â€” Approved Tools
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'github-copilot', option_label: 'GitHub Copilot', option_type: 'multi-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'chatgpt', option_label: 'ChatGPT / OpenAI', option_type: 'multi-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'claude', option_label: 'Claude / Anthropic', option_type: 'multi-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'gemini', option_label: 'Gemini / Google', option_type: 'multi-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'cursor', option_label: 'Cursor', option_type: 'multi-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'amazon-q-kiro', option_label: 'Amazon Q / Kiro', option_type: 'multi-select', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'ms-copilot', option_label: 'Microsoft Copilot', option_type: 'multi-select', display_order: 7 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'atlassian-rovo', option_label: 'Atlassian Rovo', option_type: 'multi-select', display_order: 8 },

    // Team Roles
    { section: 'teamRoles', subsection: 'roles', option_id: 'pm', option_label: 'Project Managers / Scrum Masters', option_type: 'multi-select', display_order: 1 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'ba', option_label: 'Business Analysts / Product Managers', option_type: 'multi-select', display_order: 2 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'arch', option_label: 'Solutions Architects', option_type: 'multi-select', display_order: 3 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'swe', option_label: 'Software Engineers', option_type: 'multi-select', display_order: 4 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'qa', option_label: 'Manual QA', option_type: 'multi-select', display_order: 5 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'qaa', option_label: 'QA Automation Engineers', option_type: 'multi-select', display_order: 6 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'data', option_label: 'Data Engineers / Scientists', option_type: 'multi-select', display_order: 7 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'devops', option_label: 'DevOps Engineers', option_type: 'multi-select', display_order: 8 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'ux', option_label: 'UI/UX Designers', option_type: 'multi-select', display_order: 9 },

    // Tools â€” AI
    { section: 'tools', subsection: 'ai', option_id: 'copilot', option_label: 'GitHub Copilot', option_type: 'multi-select', display_order: 1 },
    { section: 'tools', subsection: 'ai', option_id: 'chatgpt', option_label: 'ChatGPT / OpenAI', option_type: 'multi-select', display_order: 2 },
    { section: 'tools', subsection: 'ai', option_id: 'claude', option_label: 'Claude (Anthropic)', option_type: 'multi-select', display_order: 3 },
    { section: 'tools', subsection: 'ai', option_id: 'claudecode', option_label: 'Claude Code', option_type: 'multi-select', display_order: 4 },
    { section: 'tools', subsection: 'ai', option_id: 'cursor', option_label: 'Cursor', option_type: 'multi-select', display_order: 5 },
    { section: 'tools', subsection: 'ai', option_id: 'windsurf', option_label: 'Windsurf', option_type: 'multi-select', display_order: 6 },
    { section: 'tools', subsection: 'ai', option_id: 'gemini', option_label: 'Gemini (Google)', option_type: 'multi-select', display_order: 7 },
    { section: 'tools', subsection: 'ai', option_id: 'amazonq', option_label: 'Amazon Q / Kiro', option_type: 'multi-select', display_order: 8 },
    { section: 'tools', subsection: 'ai', option_id: 'mscopilot', option_label: 'Microsoft Copilot', option_type: 'multi-select', display_order: 9 },
    { section: 'tools', subsection: 'ai', option_id: 'intellij', option_label: 'IntelliJ AI', option_type: 'multi-select', display_order: 10 },
    { section: 'tools', subsection: 'ai', option_id: 'rovo', option_label: 'Atlassian Rovo', option_type: 'multi-select', display_order: 11 },
    { section: 'tools', subsection: 'ai', option_id: 'v0', option_label: 'v0 (Vercel)', option_type: 'multi-select', display_order: 12 },
    { section: 'tools', subsection: 'ai', option_id: 'bolt', option_label: 'Bolt.new', option_type: 'multi-select', display_order: 13 },
    { section: 'tools', subsection: 'ai', option_id: 'lovable', option_label: 'Lovable', option_type: 'multi-select', display_order: 14 },
    { section: 'tools', subsection: 'ai', option_id: 'perplexity', option_label: 'Perplexity', option_type: 'multi-select', display_order: 15 },

    // Tools â€” Cloud
    { section: 'tools', subsection: 'cloud', option_id: 'aws', option_label: 'Amazon Web Services (AWS)', option_type: 'multi-select', display_order: 1 },
    { section: 'tools', subsection: 'cloud', option_id: 'gcp', option_label: 'Google Cloud Platform (GCP)', option_type: 'multi-select', display_order: 2 },
    { section: 'tools', subsection: 'cloud', option_id: 'azure', option_label: 'Microsoft Azure', option_type: 'multi-select', display_order: 3 },
    { section: 'tools', subsection: 'cloud', option_id: 'onprem', option_label: 'On-Premises', option_type: 'multi-select', display_order: 4 },

    // Use Cases â€” Code Development
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-completion', option_label: 'Code completion and suggestions', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-generation', option_label: 'Generate code from natural language', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-refactoring', option_label: 'Code refactoring and optimization', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-review', option_label: 'Automated code review assistance', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'debugging', option_label: 'Debugging and error resolution', option_type: 'tri-state', display_order: 5 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-explanation', option_label: 'Code explanation and documentation', option_type: 'tri-state', display_order: 6 },

    // Use Cases â€” Documentation
    { section: 'useCases', subsection: 'documentation', option_id: 'api-docs', option_label: 'API documentation generation', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'documentation', option_id: 'readme-generation', option_label: 'README and setup guides', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'documentation', option_id: 'technical-specs', option_label: 'Technical specification writing', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'documentation', option_id: 'inline-comments', option_label: 'Code comments and docstrings', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'documentation', option_id: 'release-notes', option_label: 'Release notes generation', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Requirements
    { section: 'useCases', subsection: 'requirements', option_id: 'user-stories', option_label: 'User story creation and refinement', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'requirements', option_id: 'requirements-analysis', option_label: 'Requirements gap analysis', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'requirements', option_id: 'acceptance-criteria', option_label: 'Acceptance criteria generation', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'requirements', option_id: 'impact-analysis', option_label: 'Impact analysis for changes', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'requirements', option_id: 'backlog-refinement', option_label: 'Backlog grooming assistance', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Project Management
    { section: 'useCases', subsection: 'pm', option_id: 'meeting-summaries', option_label: 'Meeting summaries and action items', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'pm', option_id: 'status-reports', option_label: 'Status report generation', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'pm', option_id: 'risk-identification', option_label: 'Risk identification and mitigation', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'pm', option_id: 'estimation', option_label: 'Effort estimation assistance', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'pm', option_id: 'stakeholder-comms', option_label: 'Stakeholder communication drafts', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Design & UX
    { section: 'useCases', subsection: 'design-ux', option_id: 'design-feedback', option_label: 'Design critique and feedback', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'copy-writing', option_label: 'UI copy and microcopy writing', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'accessibility', option_label: 'Accessibility recommendations', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'user-research', option_label: 'User research analysis', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'persona-creation', option_label: 'Persona and journey mapping', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Data & Analytics
    { section: 'useCases', subsection: 'data-analytics', option_id: 'sql-generation', option_label: 'SQL query generation', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-transformation', option_label: 'Data transformation scripts', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-analysis', option_label: 'Data analysis and insights', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'pipeline-development', option_label: 'Data pipeline development', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-quality', option_label: 'Data quality checks', option_type: 'tri-state', display_order: 5 },

    // Workflow Maturity Stages
    { section: 'workflowMaturity', subsection: 'stages', option_id: '0', option_label: 'Stage 0 - No AI Usage', option_type: 'stage', display_order: 0 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '1', option_label: 'Stage 1 - Individual AI Usage', option_type: 'stage', display_order: 1 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '2', option_label: 'Stage 2 - Team AI Practices', option_type: 'stage', display_order: 2 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '3', option_label: 'Stage 3 - AI-Chained Tasks', option_type: 'stage', display_order: 3 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '4', option_label: 'Stage 4 - Event-Triggered AI', option_type: 'stage', display_order: 4 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '5', option_label: 'Stage 5 - Semi-Agentic AI', option_type: 'stage', display_order: 5 },

    // Limiting Factors
    { section: 'limitingFactors', subsection: 'factors', option_id: 'time', option_label: 'Lack of time / competing priorities', option_type: 'ranked', display_order: 1 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'knowledge', option_label: 'Lack of knowledge or practical skills', option_type: 'ranked', display_order: 2 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'unclear-value', option_label: 'Unclear value or relevant use cases', option_type: 'ranked', display_order: 3 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'client', option_label: 'Client or stakeholder not ready or supportive', option_type: 'ranked', display_order: 4 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'access', option_label: 'Lack of access to tools, data, budget, or clear governance', option_type: 'ranked', display_order: 5 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'other', option_label: 'Other', option_type: 'ranked', display_order: 6 },
  ];

  // Label lookups for display
  const MATURITY_LABELS = { 'not-started': 'Not Started', 'exploring': 'Exploring', 'piloting': 'Piloting', 'scaling': 'Scaling', 'optimizing': 'Optimizing', 'dont-know': "Don't Know" };
  const MATURITY_ORDER = ['dont-know', 'not-started', 'exploring', 'piloting', 'scaling', 'optimizing'];
  const MATURITY_STAGES = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing']; // without dont-know
  const MATURITY_COLORS = {
    'not-started': '#f87171',
    'exploring': '#fbbf24',
    'piloting': '#4ade80',
    'scaling': '#4ade80',
    'optimizing': '#22c55e',
    'dont-know': '#f87171'
  };
  const MATURITY_ICONS = {
    'not-started': 'ğŸš«',
    'exploring': 'ğŸ”',
    'piloting': 'ğŸ§ª',
    'scaling': 'ğŸ“ˆ',
    'optimizing': 'âš¡',
    'dont-know': 'â“'
  };
  const MATURITY_DESCRIPTIONS = {
    'not-started': {
      title: 'ğŸš« Not Started â€” "AI is not on the agenda"',
      desc: 'At this stage, AI is essentially absent from the account\'s strategy. There are no initiatives, no owners, and no clear awareness of where AI could add value. If AI is mentioned, it\'s usually abstract or perceived as something for "big tech companies," not something actionable for them. Decisions are driven by existing processes and tools, and there is often uncertainty or skepticism around AI\'s relevance, cost, or risk.'
    },
    'exploring': {
      title: 'ğŸ” Exploring â€” "We are trying to understand AI"',
      desc: 'Here the account has curiosity, but not commitment. AI is being researched, discussed, or experimented with informally â€” maybe through demos, workshops, vendor conversations, or isolated experiments by motivated individuals. There is no production usage, no clear ROI expectations, and no governance. Learning is the goal, not outcomes. This stage is about sense-making, not delivery.'
    },
    'piloting': {
      title: 'ğŸ§ª Piloting â€” "We are testing if AI actually works for us"',
      desc: 'This is a key inflection point. The account is running concrete POCs tied to real problems (often in limited scopes like SDLC, support, or analytics). There is some budget, some sponsorship, and early success criteria â€” but AI is still treated as an experiment. Results are evaluated cautiously, risks are contained, and decisions about scaling are pending. AI exists, but it\'s not yet trusted or systemic.'
    },
    'scaling': {
      title: 'ğŸ“ˆ Scaling â€” "AI is becoming part of how we operate"',
      desc: 'Now AI has proven value. Successful pilots are expanded across teams, functions, or products. Investment increases, governance starts to matter, and repeatability becomes important. The account begins to standardize tools, define ownership, train people, and integrate AI into workflows. The focus shifts from "does this work?" to "how do we roll this out safely and consistently?"'
    },
    'optimizing': {
      title: 'âš¡ Optimizing â€” "AI is embedded and continuously improved"',
      desc: 'At this stage, AI is no longer a project â€” it\'s infrastructure. AI is embedded into core processes and products, measured with KPIs, and continuously refined. The account actively optimizes models, workflows, and cost/value tradeoffs. People are trained by default, governance is mature, and AI decisions are part of normal business planning. The question is no longer whether to use AI, but how to do it better.'
    }
  };
  const GOVERNANCE_LABELS = { 'none': 'No Governance', 'informal': 'Informal', 'developing': 'Developing', 'established': 'Established', 'dont-know': "Don't Know" };
  const GOVERNANCE_ORDER = ['none', 'informal', 'developing', 'established', 'dont-know'];

  // Limiting Factors
  const LIMITING_FACTOR_LABELS = {
    time: 'Lack of time',
    knowledge: 'Lack of knowledge',
    'unclear-value': 'Unclear value',
    client: 'Client not ready',
    access: 'Lack of access',
    other: 'Other'
  };
  const LIMITING_FACTOR_ORDER = ['time', 'knowledge', 'unclear-value', 'client', 'access', 'other'];
  const LF_COLORS = { primary: '#4f46e5', secondary: '#93c5fd' };

  // AI Challenges (from clientAILandscape.challenges)
  const AI_CHALLENGE_LABELS = {
    'unclear-roi': 'Unclear ROI', 'skills': 'Skills Gap', 'data': 'Data Issues',
    'security': 'Security/Compliance', 'budget': 'Budget/Buy-in',
    'infrastructure': 'Infrastructure', 'dont-know': "Don't Know"
  };
  const AI_CHALLENGE_ORDER = ['unclear-roi', 'skills', 'data', 'security', 'budget', 'infrastructure', 'dont-know'];
  const AI_CHALLENGE_COLORS = { primary: '#0ea5e9', secondary: '#bae6fd' };

  // AI Tools (from survey Step 4: toolsAndInfrastructure.ai)
  const AI_TOOL_LABELS = {
    copilot: 'GitHub Copilot', chatgpt: 'ChatGPT / OpenAI', claude: 'Claude (Anthropic)',
    claudecode: 'Claude Code', cursor: 'Cursor', windsurf: 'Windsurf',
    gemini: 'Gemini (Google)', amazonq: 'Amazon Q / Kiro', mscopilot: 'Microsoft Copilot',
    intellij: 'IntelliJ AI', rovo: 'Atlassian Rovo', v0: 'v0 (Vercel)',
    bolt: 'Bolt.new', lovable: 'Lovable', perplexity: 'Perplexity'
  };
  const AI_TOOL_ORDER = Object.keys(AI_TOOL_LABELS);
  const AI_TOOL_COLOR = '#6366f1';

  const ROLE_LABELS = {
    pm: 'PM / Scrum', ba: 'BA / PM', arch: 'Architects', swe: 'Software Eng.',
    qa: 'Manual QA', qaa: 'QA Automation', data: 'Data Eng.', devops: 'DevOps', ux: 'UI/UX'
  };
  const ROLE_ORDER = ['pm', 'ba', 'arch', 'swe', 'qa', 'qaa', 'data', 'devops', 'ux'];

  // Workflow Maturity Stages
  const WFM_STAGES = [0, 1, 2, 3, 4, 5];
  const WFM_LABELS = {
    0: 'No AI Usage', 1: 'Individual AI', 2: 'Team Practices',
    3: 'AI-Chained', 4: 'Event-Triggered', 5: 'Semi-Agentic'
  };
  const WFM_SUBTITLES = {
    0: 'Work done entirely manually', 1: 'AI used by individuals only',
    2: 'Shared, manual AI usage', 3: 'Multi-step AI workflows',
    4: 'Automated AI integration', 5: 'AI recommends, humans decide'
  };
  const WFM_COLORS = {
    0: '#f87171', 1: '#fbbf24', 2: '#fbbf24',
    3: '#4ade80', 4: '#4ade80', 5: '#22c55e'
  };
  const WFM_DESCRIPTIONS = {
    0: { title: 'Stage 0 â€” No AI Usage', desc: 'AI is not used in delivery workflows. Tools may be blocked or discouraged, no AI policy or guidance exists, and any usage is unofficial "shadow AI." Leadership has not discussed AI adoption.' },
    1: { title: 'Stage 1 â€” Individual AI Usage', desc: 'AI is used by individuals only. Tool usage varies widely across team members with no shared standards. Outputs differ by person and knowledge is not reusable. Each person experiments independently.' },
    2: { title: 'Stage 2 â€” Team AI Practices', desc: 'Shared, manual AI usage at team level. The team maintains prompt libraries, references AI in ceremonies, produces repeatable outputs, and includes AI practices in onboarding. Usage is consistent but still manually triggered.' },
    3: { title: 'Stage 3 â€” AI-Chained Tasks', desc: 'Sequential AI steps from one intent. Multiple prompts are chained together for complex tasks using documented, reused workflows. Scripts or templates standardize interactions and work items follow predictable AI-assisted flows.' },
    4: { title: 'Stage 4 â€” Event-Triggered AI', desc: 'AI reacts automatically to SDLC events. Bots post comments to collaboration tools, integrations exist with project management and CI/CD pipelines, AI tasks execute without manual triggering, reducing repetitive interactions.' },
    5: { title: 'Stage 5 â€” Semi-Agentic AI', desc: 'AI recommends, humans decide. Dashboards display AI-generated insights and metrics, AI provides confidence and risk scores, regular recommendation reports are produced, and human review/approval gates exist before AI actions take effect.' }
  };

  // Account Types
  const ACCOUNT_TYPES = [
    { id: 'enterprise', label: 'Enterprise' },
    { id: 'key-account', label: 'Key Account' },
    { id: 'enterprise-key', label: 'Enterprise + Key Account' },
    { id: 'other', label: 'Other' },
  ];
  const ACCOUNT_TYPE_LABELS = {};
  ACCOUNT_TYPES.forEach(t => ACCOUNT_TYPE_LABELS[t.id] = t.label);

  // Engagement Types (Ownership)
  const ENGAGEMENT_TYPES = [
    { id: 'staff', label: 'Staff Augmentation' },
    { id: 'project', label: 'Project Ownership' },
    { id: 'program', label: 'Program Ownership' },
    { id: 'outcome', label: 'Business Outcome' },
  ];
  const ENGAGEMENT_TYPE_LABELS = {};
  ENGAGEMENT_TYPES.forEach(t => ENGAGEMENT_TYPE_LABELS[t.id] = t.label);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GLOBAL FILTER STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let activeMaturityFilter = null; // null = all, or a stage id like 'exploring'
  let selectedAccounts = new Set();  // empty = all, Set of account name strings
  let selectedDeliveryManagers = new Set(); // empty = all, Set of DM name strings
  let activeLimitingFactorFilter = null; // null = all, or a factor key like 'time'
  let activeAiToolFilter = null; // null = all, or a tool key like 'copilot' or '_custom'
  let activeAiChallengeFilter = null; // null = all, or a challenge key like 'skills'
  let activeWfmStageFilter = null; // null = all, or a stage number (0-5)
  let currentMedianStage = null; // current median stage key for stage description modal
  let currentStagePosition = 0.5; // 0-1 position for adoption stage progress bar
  let currentWfmStage = null; // current WFM average stage number for description modal
  let currentWfmPosition = 0.5; // 0-1 position for WFM progress bar
  let tableSortColumn = 'account'; // default sort column
  let tableSortDirection = 'asc';  // 'asc' or 'desc'

  function setMaturityFilter(stage) {
    activeMaturityFilter = (activeMaturityFilter === stage) ? null : stage;
    refreshDashboard();
  }

  function clearMaturityFilter() {
    activeMaturityFilter = null;
    refreshDashboard();
  }

  function toggleAccountSelection(accountName) {
    if (selectedAccounts.has(accountName)) {
      selectedAccounts.delete(accountName);
    } else {
      selectedAccounts.add(accountName);
    }
    refreshDashboard();
  }

  function clearAccountFilter() {
    selectedAccounts.clear();
    refreshDashboard();
  }

  function selectAllVisibleAccounts() {
    const surveys = getAllFilteredSurveys();
    surveys.forEach(s => selectedAccounts.add(s.account_name));
    refreshDashboard();
  }

  function onSelectAllAccountsToggle(checked) {
    if (checked) {
      selectAllVisibleAccounts();
    } else {
      clearAccountFilter();
    }
  }

  // Actions dropdown toggle
  function toggleActionsMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');

    const menu = document.getElementById('actionsMenu');
    const btn = document.getElementById('actionsToggle');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  // Accounts dropdown helpers
  function toggleAccountsMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('accountsMenu');
    const btn = document.querySelector('#filterAccounts .multi-select-btn');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  function updateAccountsLabel() {
    const label = document.getElementById('accountsLabel');
    if (selectedAccounts.size === 0) {
      label.textContent = 'All Accounts';
    } else if (selectedAccounts.size === 1) {
      label.textContent = [...selectedAccounts][0];
    } else {
      label.textContent = `${selectedAccounts.size} accounts`;
    }
  }

  function onAccountSelectionChange() {
    const checkboxes = document.querySelectorAll('#accountsMenu input[type="checkbox"]');
    selectedAccounts.clear();
    checkboxes.forEach(cb => { if (cb.checked) selectedAccounts.add(cb.value); });
    refreshDashboard();
  }

  function selectAllAccountsFromMenu() {
    document.querySelectorAll('#accountsMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onAccountSelectionChange();
  }

  function clearAllAccountsFromMenu() {
    document.querySelectorAll('#accountsMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onAccountSelectionChange();
  }

  function populateAccountsFilter() {
    const menu = document.getElementById('accountsMenu');
    if (!menu) return;
    menu.querySelectorAll('.multi-select-item').forEach(el => el.remove());

    const allSurveys = getAllFilteredSurveys();
    const names = [...new Set(allSurveys.map(s => s.account_name))].sort();

    const actionsDiv = menu.querySelector('.multi-select-actions');
    names.forEach(name => {
      const label = document.createElement('label');
      label.className = 'multi-select-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = name;
      cb.checked = selectedAccounts.has(name);
      cb.addEventListener('change', () => onAccountSelectionChange());
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + name));
      menu.insertBefore(label, actionsDiv);
    });

    updateAccountsLabel();
  }

  // Delivery Manager dropdown helpers
  function toggleDMMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('dmMenu');
    const btn = document.querySelector('#filterDM .multi-select-btn');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  function updateDMLabel() {
    const label = document.getElementById('dmLabel');
    if (selectedDeliveryManagers.size === 0) {
      label.textContent = 'All DMs';
    } else if (selectedDeliveryManagers.size === 1) {
      label.textContent = [...selectedDeliveryManagers][0];
    } else {
      label.textContent = `${selectedDeliveryManagers.size} DMs`;
    }
  }

  function onDMSelectionChange() {
    const checkboxes = document.querySelectorAll('#dmMenu input[type="checkbox"]');
    selectedDeliveryManagers.clear();
    checkboxes.forEach(cb => { if (cb.checked) selectedDeliveryManagers.add(cb.value); });
    refreshDashboard();
  }

  function selectAllDMsFromMenu() {
    document.querySelectorAll('#dmMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onDMSelectionChange();
  }

  function clearAllDMsFromMenu() {
    document.querySelectorAll('#dmMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onDMSelectionChange();
  }

  function clearDMFilter() {
    selectedDeliveryManagers.clear();
    refreshDashboard();
  }

  function populateDMFilter() {
    const menu = document.getElementById('dmMenu');
    if (!menu) return;
    menu.querySelectorAll('.multi-select-item').forEach(el => el.remove());

    const allSurveys = getAllFilteredSurveys();
    const dms = [...new Set(allSurveys.map(s => s.delivery_manager).filter(dm => dm && dm.trim()))].sort();

    const actionsDiv = menu.querySelector('.multi-select-actions');
    dms.forEach(dm => {
      const label = document.createElement('label');
      label.className = 'multi-select-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = dm;
      cb.checked = selectedDeliveryManagers.has(dm);
      cb.addEventListener('change', () => onDMSelectionChange());
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + dm));
      menu.insertBefore(label, actionsDiv);
    });

    updateDMLabel();
  }

  function setLimitingFactorFilter(factor) {
    activeLimitingFactorFilter = (activeLimitingFactorFilter === factor) ? null : factor;
    refreshDashboard();
  }

  function clearLimitingFactorFilter() {
    activeLimitingFactorFilter = null;
    refreshDashboard();
  }

  function setWfmStageFilter(stage) {
    activeWfmStageFilter = (activeWfmStageFilter === stage) ? null : stage;
    refreshDashboard();
  }

  function clearWfmStageFilter() {
    activeWfmStageFilter = null;
    refreshDashboard();
  }

  function setAiToolFilter(toolKey) {
    activeAiToolFilter = (activeAiToolFilter === toolKey) ? null : toolKey;
    refreshDashboard();
  }

  function clearAiToolFilter() {
    activeAiToolFilter = null;
    refreshDashboard();
  }

  function setAiChallengeFilter(key) {
    activeAiChallengeFilter = (activeAiChallengeFilter === key) ? null : key;
    refreshDashboard();
  }

  function clearAiChallengeFilter() {
    activeAiChallengeFilter = null;
    refreshDashboard();
  }

  function clearAllFilters() {
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    activeLimitingFactorFilter = null;
    activeAiToolFilter = null;
    activeAiChallengeFilter = null;
    activeWfmStageFilter = null;
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COLLAPSIBLE SECTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function toggleSection(titleEl) {
    const section = titleEl.closest('.widget-section');
    section.classList.toggle('collapsed');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACCOUNT TYPE MULTI-SELECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function toggleAccountTypeMenu() {
    // Close other menus if open
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('accountTypeMenu');
    const btn = document.querySelector('#filterAccountType .multi-select-btn');
    const isOpen = menu.classList.contains('open');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
    if (!isOpen) btn.focus();
  }

  function updateAccountTypeLabel() {
    const selected = getSelectedAccountTypes();
    const label = document.getElementById('accountTypeLabel');
    if (selected.length === 0) {
      label.textContent = 'None';
    } else if (selected.length === ACCOUNT_TYPES.length) {
      label.textContent = 'All Types';
    } else if (selected.length === 1) {
      label.textContent = ACCOUNT_TYPE_LABELS[selected[0]];
    } else {
      label.textContent = `${selected.length} types`;
    }
  }

  function onAccountTypeChange() {
    updateAccountTypeLabel();
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    refreshDashboard();
  }

  function selectAllAccountTypes() {
    document.querySelectorAll('#accountTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onAccountTypeChange();
  }

  function clearAccountTypes() {
    document.querySelectorAll('#accountTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onAccountTypeChange();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ENGAGEMENT TYPE MULTI-SELECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function toggleEngagementTypeMenu() {
    // Close other menus if open
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('engagementTypeMenu');
    const btn = document.querySelector('#filterEngagementType .multi-select-btn');
    const isOpen = menu.classList.contains('open');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
    if (!isOpen) btn.focus();
  }

  function updateEngagementTypeLabel() {
    const selected = getSelectedEngagementTypes();
    const label = document.getElementById('engagementTypeLabel');
    if (selected.length === 0) {
      label.textContent = 'None';
    } else if (selected.length === ENGAGEMENT_TYPES.length) {
      label.textContent = 'All Types';
    } else if (selected.length === 1) {
      label.textContent = ENGAGEMENT_TYPE_LABELS[selected[0]];
    } else {
      label.textContent = `${selected.length} types`;
    }
  }

  function onEngagementTypeChange() {
    updateEngagementTypeLabel();
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    refreshDashboard();
  }

  function selectAllEngagementTypes() {
    document.querySelectorAll('#engagementTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onEngagementTypeChange();
  }

  function clearEngagementTypes() {
    document.querySelectorAll('#engagementTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onEngagementTypeChange();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATABASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let db = null;
  const IDB_NAME = 'AISurveyDashboard';
  const IDB_STORE = 'database';
  const IDB_KEY = 'sqliteDb';

  async function initDatabase() {
    const SQL = await initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
    });

    // Try to load from IndexedDB
    const savedData = await loadFromIndexedDB();
    if (savedData) {
      db = new SQL.Database(savedData);
      // Run migrations for existing databases
      createTables();
    } else {
      db = new SQL.Database();
      createTables();
      seedSchemaOptions();
      await saveToIndexedDB();
    }
  }

  function createTables() {
    db.run(`
      CREATE TABLE IF NOT EXISTS surveys (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        account_name TEXT NOT NULL,
        exported_at TEXT NOT NULL,
        year INTEGER NOT NULL,
        quarter INTEGER NOT NULL,
        schema_version TEXT NOT NULL,
        raw_json TEXT NOT NULL,
        uploaded_at TEXT NOT NULL DEFAULT (datetime('now')),
        account_type TEXT NOT NULL DEFAULT 'other',
        delivery_manager TEXT NOT NULL DEFAULT '',
        UNIQUE(account_name, exported_at)
      )
    `);
    // Migration: add account_type to existing databases that lack the column
    try {
      db.run("ALTER TABLE surveys ADD COLUMN account_type TEXT NOT NULL DEFAULT 'other'");
    } catch (e) {
      // Column already exists â€” ignore
    }
    // Migration: add delivery_manager to existing databases that lack the column
    try {
      db.run("ALTER TABLE surveys ADD COLUMN delivery_manager TEXT NOT NULL DEFAULT ''");
    } catch (e) {
      // Column already exists â€” ignore
    }
    db.run(`
      CREATE TABLE IF NOT EXISTS schema_options (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        section TEXT NOT NULL,
        subsection TEXT NOT NULL,
        option_id TEXT NOT NULL,
        option_label TEXT NOT NULL,
        option_type TEXT NOT NULL,
        display_order INTEGER DEFAULT 0,
        UNIQUE(section, subsection, option_id)
      )
    `);
  }

  function seedSchemaOptions() {
    const stmt = db.prepare('INSERT OR IGNORE INTO schema_options (section, subsection, option_id, option_label, option_type, display_order) VALUES (?, ?, ?, ?, ?, ?)');
    SCHEMA_SEED.forEach(s => {
      stmt.run([s.section, s.subsection, s.option_id, s.option_label, s.option_type, s.display_order]);
    });
    stmt.free();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IndexedDB Persistence
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openIDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = () => {
        req.result.createObjectStore(IDB_STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function saveToIndexedDB() {
    const data = db.export();
    const idb = await openIDB();
    return new Promise((resolve, reject) => {
      const tx = idb.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).put(data, IDB_KEY);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function loadFromIndexedDB() {
    try {
      const idb = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = idb.transaction(IDB_STORE, 'readonly');
        const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
        req.onsuccess = () => resolve(req.result ? new Uint8Array(req.result) : null);
        req.onerror = () => reject(req.error);
      });
    } catch { return null; }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MATURITY INFO MODAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openMaturityInfoModal() {
    document.getElementById('maturityInfoModal').classList.add('open');
  }
  function closeMaturityInfoModal() {
    document.getElementById('maturityInfoModal').classList.remove('open');
  }

  function openStageDescriptionModal() {
    if (!currentMedianStage) return;
    const info = MATURITY_DESCRIPTIONS[currentMedianStage];
    if (!info) return;
    document.getElementById('stageDescriptionContent').innerHTML = `
      <h2 style="margin-top:0;font-size:1.25rem;">${info.title}</h2>
      <p style="color:#444;font-size:0.97rem;line-height:1.7;">${info.desc}</p>`;
    document.getElementById('stageDescriptionModal').classList.add('open');
  }

  function closeStageDescriptionModal() {
    document.getElementById('stageDescriptionModal').classList.remove('open');
  }

  function openWfmInfoModal() {
    document.getElementById('wfmInfoModal').classList.add('open');
  }
  function closeWfmInfoModal() {
    document.getElementById('wfmInfoModal').classList.remove('open');
  }

  function openWfmStageDescriptionModal() {
    if (currentWfmStage === null) return;
    const info = WFM_DESCRIPTIONS[currentWfmStage];
    if (!info) return;
    document.getElementById('stageDescriptionContent').innerHTML = `
      <h2 style="margin-top:0;font-size:1.25rem;">${info.title}</h2>
      <p style="color:#444;font-size:0.97rem;line-height:1.7;">${info.desc}</p>`;
    document.getElementById('stageDescriptionModal').classList.add('open');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACCOUNT MATURITY COMPARISON MODAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openAccountComparisonModal() {
    const surveys = getFilteredSurveys();

    // Build per-account data: name, id, raw avg, rounded stage
    const accountRows = [];
    surveys.forEach(s => {
      const avg = getWfmAverage(s);
      if (avg < 0) return; // skip accounts with no WFM data
      accountRows.push({
        name: s.account_name,
        id: s.id,
        avg: avg,
        rounded: Math.round(avg)
      });
    });

    // Sort alphabetically by account name
    accountRows.sort((a, b) => a.name.localeCompare(b.name));

    // Color palette matching screenshot: light fills with stronger color at the reached stage
    const FILL_COLORS = {
      0: '#e5e7eb', // Gray
      1: '#fecdd3', // Light pink/red
      2: '#fde68a', // Light amber
      3: '#fde68a', // Light amber
      4: '#bbf7d0', // Light green
      5: '#86efac'  // Medium green
    };
    const MARKER_COLORS = {
      0: '#9ca3af', // Gray
      1: '#f87171', // Red
      2: '#fbbf24', // Amber
      3: '#f59e0b', // Darker amber
      4: '#4ade80', // Green
      5: '#22c55e'  // Dark green
    };

    const tbody = document.getElementById('comparisonMatrixBody');

    if (accountRows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#6b7280;">No accounts with workflow maturity data match the current filters.</td></tr>';
    } else {
      tbody.innerHTML = accountRows.map(account => {
        const linkIcon = account.id
          ? `<a href="account-detail.html?id=${account.id}" class="account-link-icon" title="View account details" onclick="event.stopPropagation();">â†—</a>`
          : '';

        const cells = WFM_STAGES.map(stageIdx => {
          if (stageIdx <= account.rounded) {
            if (stageIdx === account.rounded) {
              // The reached stage: full color fill with marker
              return `<td style="text-align:center;">
                <div class="stage-fill" style="background:${FILL_COLORS[stageIdx]};display:flex;align-items:center;justify-content:center;">
                  <span class="stage-marker" style="background:${MARKER_COLORS[stageIdx]};"></span>
                </div>
              </td>`;
            } else {
              // Stages below the reached stage: light color fill
              return `<td><div class="stage-fill" style="background:${FILL_COLORS[stageIdx]};"></div></td>`;
            }
          } else {
            // Stages beyond the reached stage: empty
            return '<td></td>';
          }
        }).join('');

        return `<tr>
          <td class="account-name-cell">${escapeHtml(account.name)}${linkIcon}</td>
          ${cells}
        </tr>`;
      }).join('');
    }

    document.getElementById('accountComparisonModal').classList.add('open');
  }

  function closeAccountComparisonModal() {
    document.getElementById('accountComparisonModal').classList.remove('open');
  }

  function openSdlcPhaseModal(phaseKey) {
    const phase = SDLC_PHASES.find(p => p.key === phaseKey);
    if (!phase) return;

    document.getElementById('sdlcPhaseModalTitle').textContent = `${phase.label} â€” Use Case Breakdown`;

    // Get use case labels from SCHEMA_SEED
    const useCaseOptions = SCHEMA_SEED
      .filter(s => s.section === 'useCases' && s.subsection === phaseKey)
      .sort((a, b) => a.display_order - b.display_order);

    // Get currently filtered surveys
    const surveys = getFilteredSurveys();

    // Calculate per-use-case stats
    const items = useCaseOptions.map(opt => {
      let doing = 0, need = 0, total = 0;
      surveys.forEach(s => {
        const item = s.data?.useCases?.[phaseKey]?.[opt.option_id];
        if (item === undefined) return;
        total++;
        if (item?.status === 'doing') doing++;
        else if (item?.status === 'need') need++;
      });
      const notUsing = total - doing - need;
      const doingPct = total > 0 ? Math.round((doing / total) * 100) : 0;
      const needPct = total > 0 ? Math.round((need / total) * 100) : 0;
      const notUsingPct = total > 0 ? 100 - doingPct - needPct : 0;
      return { label: opt.option_label, doingPct, needPct, notUsingPct };
    });

    // Sort by "Doing" descending
    items.sort((a, b) => b.doingPct - a.doingPct);

    // Build HTML
    let html = '';
    items.forEach(item => {
      const doingLabel = item.doingPct >= 12 ? `${item.doingPct}%` : '';
      const needLabel = item.needPct >= 12 ? `${item.needPct}%` : '';
      const notUsingLabel = item.notUsingPct >= 12 ? `${item.notUsingPct}%` : '';

      html += `
        <div class="sdlc-modal-item">
          <div class="sdlc-modal-header">
            <span class="sdlc-modal-label">${escapeHtml(item.label)}</span>
            <span class="sdlc-modal-pcts">
              <span class="doing">${item.doingPct}%</span>
              <span class="separator">|</span>
              <span class="need">${item.needPct}%</span>
              <span class="separator">|</span>
              <span class="not-using">${item.notUsingPct}%</span>
            </span>
          </div>
          <div class="sdlc-modal-bar">
            ${item.doingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-doing" style="width:${item.doingPct}%">${doingLabel}</div>` : ''}
            ${item.needPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-need" style="width:${item.needPct}%">${needLabel}</div>` : ''}
            ${item.notUsingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-notusing" style="width:${item.notUsingPct}%">${notUsingLabel}</div>` : ''}
          </div>
        </div>`;
    });

    // Add legend
    html += `
      <div class="sdlc-legend" style="margin-top:1.25rem;">
        <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#22c55e;"></span> Doing</span>
        <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#f59e0b;"></span> Need but not Doing</span>
        <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#e5e7eb;"></span> Not Using</span>
      </div>`;

    if (surveys.length > 0) {
      html += `<div style="margin-top:0.75rem;font-size:0.75rem;color:#9ca3af;">Based on ${surveys.length} survey${surveys.length !== 1 ? 's' : ''}</div>`;
    }

    document.getElementById('sdlcPhaseModalContent').innerHTML = html;
    document.getElementById('sdlcPhaseModal').classList.add('open');
  }

  function closeSdlcPhaseModal() {
    document.getElementById('sdlcPhaseModal').classList.remove('open');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UPLOAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openUploadModal() {
    document.getElementById('uploadModal').classList.add('open');
    document.getElementById('uploadResults').innerHTML = '';
    // Pre-populate year/quarter with current values
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentQuarter = Math.ceil((now.getMonth() + 1) / 3);
    const yearSelect = document.getElementById('uploadYear');
    yearSelect.innerHTML = '';
    for (let y = currentYear + 1; y >= currentYear - 3; y--) {
      yearSelect.innerHTML += `<option value="${y}"${y === currentYear ? ' selected' : ''}>${y}</option>`;
    }
    document.getElementById('uploadQuarter').value = String(currentQuarter);
    document.getElementById('uploadDeliveryManager').value = '';
  }
  function closeUploadModal() {
    document.getElementById('uploadModal').classList.remove('open');
  }

  function validateSurveyJSON(data) {
    const errors = [];
    if (!data.schemaVersion) errors.push('Missing schemaVersion');
    if (!data.accountName) errors.push('Missing accountName');
    if (!data.exportedAt) errors.push('Missing exportedAt');
    else if (isNaN(new Date(data.exportedAt).getTime())) errors.push('Invalid exportedAt date');
    return errors;
  }

  async function processFile(file, year, quarter, accountType, deliveryManager) {
    const result = { filename: file.name, status: '', message: '' };

    try {
      let jsonText = null;

      if (file.name.endsWith('.zip')) {
        const zip = await JSZip.loadAsync(file);
        const jsonFile = Object.keys(zip.files).find(name => name.endsWith('.json'));
        if (!jsonFile) {
          result.status = 'error';
          result.message = 'No JSON file found inside ZIP';
          return result;
        }
        jsonText = await zip.files[jsonFile].async('text');
      } else if (file.name.endsWith('.json')) {
        jsonText = await file.text();
      } else {
        result.status = 'error';
        result.message = 'Unsupported file type (use .json or .zip)';
        return result;
      }

      const data = JSON.parse(jsonText);
      const errors = validateSurveyJSON(data);
      if (errors.length > 0) {
        result.status = 'error';
        result.message = errors.join(', ');
        return result;
      }

      // Check for duplicate
      const existing = db.exec('SELECT id FROM surveys WHERE account_name = ? AND exported_at = ?', [data.accountName, data.exportedAt]);
      if (existing.length > 0 && existing[0].values.length > 0) {
        // Replace existing
        db.run('DELETE FROM surveys WHERE account_name = ? AND exported_at = ?', [data.accountName, data.exportedAt]);
        result.status = 'warning';
        result.message = `Replaced existing survey for "${data.accountName}" -> ${year} Q${quarter}`;
      } else {
        result.status = 'success';
        result.message = `Imported "${data.accountName}" -> ${year} Q${quarter}`;
      }

      db.run(
        'INSERT INTO surveys (account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
        [data.accountName, data.exportedAt, year, quarter, data.schemaVersion, jsonText, accountType, deliveryManager]
      );

    } catch (e) {
      result.status = 'error';
      result.message = `Parse error: ${e.message}`;
    }

    return result;
  }

  async function handleFiles(files) {
    const year = parseInt(document.getElementById('uploadYear').value);
    const quarter = parseInt(document.getElementById('uploadQuarter').value);
    const accountType = document.getElementById('uploadAccountType').value;
    const deliveryManager = document.getElementById('uploadDeliveryManager').value.trim();
    const resultsDiv = document.getElementById('uploadResults');
    resultsDiv.innerHTML = '<div style="color:#6b7280;font-size:0.85rem;padding:0.5rem 0;">Processing...</div>';

    const results = [];
    for (const file of files) {
      results.push(await processFile(file, year, quarter, accountType, deliveryManager));
    }

    await saveToIndexedDB();

    // Display results
    resultsDiv.innerHTML = results.map(r => {
      const icon = r.status === 'success' ? 'âœ…' : r.status === 'warning' ? 'âš ï¸' : 'âŒ';
      const cls = r.status === 'success' ? 'upload-result-success' : r.status === 'warning' ? 'upload-result-warning' : 'upload-result-error';
      return `<div class="upload-result-item">
        <span class="upload-result-icon">${icon}</span>
        <span class="upload-result-text ${cls}"><strong>${r.filename}</strong> - ${r.message}</span>
      </div>`;
    }).join('');

    // Refresh dashboard
    populateFilters();
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FILTERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function populateFilters() {
    const yearSelect = document.getElementById('filterYear');
    const rows = db.exec('SELECT DISTINCT year FROM surveys ORDER BY year DESC');
    const years = rows.length > 0 ? rows[0].values.map(r => r[0]) : [];

    const currentVal = yearSelect.value;
    yearSelect.innerHTML = '<option value="all">All Years</option>';
    years.forEach(y => {
      yearSelect.innerHTML += `<option value="${y}"${y == currentVal ? ' selected' : ''}>${y}</option>`;
    });
    if (currentVal && currentVal !== 'all' && years.includes(parseInt(currentVal))) {
      yearSelect.value = currentVal;
    }

    populateComparisonPeriodOptions();
    populateAccountsFilter();
    populateDMFilter();
  }

  function getSelectedAccountTypes() {
    const checkboxes = document.querySelectorAll('#accountTypeMenu input[type="checkbox"]');
    const selected = [];
    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
    return selected;
  }

  function getSelectedEngagementTypes() {
    const checkboxes = document.querySelectorAll('#engagementTypeMenu input[type="checkbox"]');
    const selected = [];
    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
    return selected;
  }

  function getFilteredSurveys() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const selectedTypes = getSelectedAccountTypes();

    // No types selected = no results
    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager FROM surveys WHERE 1=1';
    const params = [];
    if (year !== 'all') { sql += ' AND year = ?'; params.push(parseInt(year)); }
    if (quarter !== 'all') { sql += ' AND quarter = ?'; params.push(parseInt(quarter)); }
    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    let surveys = result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || ''
    }));

    // Apply engagement type filter (structural filter on JSON data)
    const selectedEngagementTypes = getSelectedEngagementTypes();
    if (selectedEngagementTypes.length === 0) return [];
    if (selectedEngagementTypes.length < ENGAGEMENT_TYPES.length) {
      surveys = surveys.filter(s => {
        const ownership = s.data?.engagement?.ownership;
        if (!ownership) return false;
        return selectedEngagementTypes.some(type => ownership[type]?.selected === true);
      });
    }

    // Apply maturity filter (post-query JS filter)
    if (activeMaturityFilter) {
      surveys = surveys.filter(s =>
        s.data?.clientAILandscape?.maturity?.value === activeMaturityFilter
      );
    }

    // Apply account filter (multi-select)
    if (selectedAccounts.size > 0) {
      surveys = surveys.filter(s => selectedAccounts.has(s.account_name));
    }

    // Apply delivery manager filter (multi-select)
    if (selectedDeliveryManagers.size > 0) {
      surveys = surveys.filter(s => selectedDeliveryManagers.has(s.delivery_manager));
    }

    // Apply limiting factor filter
    if (activeLimitingFactorFilter) {
      surveys = surveys.filter(s => {
        const lf = s.data?.limitingFactors?.[activeLimitingFactorFilter];
        return lf && (lf.rank === 1 || lf.rank === 2);
      });
    }

    // Apply workflow maturity stage filter
    if (activeWfmStageFilter !== null) {
      surveys = surveys.filter(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return false;
        const stages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') stages.push(st);
        });
        if (stages.length === 0) return false;
        const avg = stages.reduce((a, b) => a + b, 0) / stages.length;
        return Math.round(avg) === activeWfmStageFilter;
      });
    }

    // Apply AI tool filter
    if (activeAiToolFilter) {
      surveys = surveys.filter(s => {
        const aiTools = s.data?.toolsAndInfrastructure?.ai;
        if (!aiTools) return false;
        if (activeAiToolFilter === '_custom') {
          return Array.isArray(aiTools.custom) && aiTools.custom.length > 0;
        }
        return aiTools[activeAiToolFilter]?.selected === true;
      });
    }

    // Apply AI challenge filter
    if (activeAiChallengeFilter) {
      surveys = surveys.filter(s => {
        const ch = s.data?.clientAILandscape?.challenges?.[activeAiChallengeFilter];
        return ch && (ch.rank === 1 || ch.rank === 2);
      });
    }

    return surveys;
  }

  // Get all surveys for year/quarter/type (ignoring maturity/account name filters) for the widget itself
  function getAllFilteredSurveys() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const selectedTypes = getSelectedAccountTypes();

    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager FROM surveys WHERE 1=1';
    const params = [];
    if (year !== 'all') { sql += ' AND year = ?'; params.push(parseInt(year)); }
    if (quarter !== 'all') { sql += ' AND quarter = ?'; params.push(parseInt(quarter)); }
    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    let surveys = result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || ''
    }));

    // Apply engagement type filter (structural filter on JSON data)
    const selectedEngagementTypes = getSelectedEngagementTypes();
    if (selectedEngagementTypes.length === 0) return [];
    if (selectedEngagementTypes.length < ENGAGEMENT_TYPES.length) {
      surveys = surveys.filter(s => {
        const ownership = s.data?.engagement?.ownership;
        if (!ownership) return false;
        return selectedEngagementTypes.some(type => ownership[type]?.selected === true);
      });
    }

    return surveys;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DASHBOARD RENDERING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let charts = {};

  function refreshDashboard() {
    const surveys = getFilteredSurveys();
    const allSurveys = getAllFilteredSurveys(); // for the widget (unfiltered by maturity)
    const totalAll = db.exec('SELECT COUNT(*) FROM surveys');
    const totalCount = totalAll.length > 0 ? totalAll[0].values[0][0] : 0;

    // Update subtitle
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    let filterDesc = '';
    if (year !== 'all') filterDesc += year;
    if (quarter !== 'all') filterDesc += (filterDesc ? ' ' : '') + 'Q' + quarter;

    let subtitleText = '';
    if (surveys.length > 0) {
      subtitleText = `Showing ${surveys.length} survey${surveys.length !== 1 ? 's' : ''}${filterDesc ? ' for ' + filterDesc : ''}`;
    } else if (totalCount > 0) {
      subtitleText = 'No surveys match the selected filters';
    } else {
      subtitleText = 'No surveys uploaded yet';
    }

    const subtitleEl = document.getElementById('headerSubtitle');
    let filterTags = '';
    if (activeMaturityFilter) {
      filterTags += ` <span class="filter-active-tag">Stage: ${MATURITY_LABELS[activeMaturityFilter]} <span class="filter-clear-x" onclick="clearMaturityFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (selectedAccounts.size > 0) {
      const accountLabel = selectedAccounts.size === 1 ? escapeHtml([...selectedAccounts][0]) : `${selectedAccounts.size} accounts`;
      filterTags += ` <span class="filter-active-tag">Account: ${accountLabel} <span class="filter-clear-x" onclick="clearAccountFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (selectedDeliveryManagers.size > 0) {
      const dmLabel = selectedDeliveryManagers.size === 1 ? escapeHtml([...selectedDeliveryManagers][0]) : `${selectedDeliveryManagers.size} DMs`;
      filterTags += ` <span class="filter-active-tag">DM: ${dmLabel} <span class="filter-clear-x" onclick="clearDMFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeLimitingFactorFilter) {
      filterTags += ` <span class="filter-active-tag">Factor: ${LIMITING_FACTOR_LABELS[activeLimitingFactorFilter]} <span class="filter-clear-x" onclick="clearLimitingFactorFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeWfmStageFilter !== null) {
      filterTags += ` <span class="filter-active-tag">WFM: Stage ${activeWfmStageFilter} - ${WFM_LABELS[activeWfmStageFilter]} <span class="filter-clear-x" onclick="clearWfmStageFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAiToolFilter) {
      const toolLabel = activeAiToolFilter === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[activeAiToolFilter] || activeAiToolFilter);
      filterTags += ` <span class="filter-active-tag">Tool: ${toolLabel} <span class="filter-clear-x" onclick="clearAiToolFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAiChallengeFilter) {
      filterTags += ` <span class="filter-active-tag">Challenge: ${AI_CHALLENGE_LABELS[activeAiChallengeFilter] || activeAiChallengeFilter} <span class="filter-clear-x" onclick="clearAiChallengeFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (filterTags) {
      subtitleEl.innerHTML = `${subtitleText}${filterTags}`;
    } else {
      subtitleEl.textContent = subtitleText;
    }

    // Show/hide states
    document.getElementById('emptyState').style.display = totalCount === 0 ? 'block' : 'none';
    document.getElementById('dashboardContent').style.display = totalCount > 0 ? 'block' : 'none';

    if (totalCount === 0) return;

    // Summary cards (show count of filtered surveys)
    updateSummaryCards(surveys);

    // Adoption Stage Widget â€” percentages reflect active filters
    renderAdoptionStageWidget(surveys);

    // Account AI Agentic Workflow â€” callout reflects filters, circles show all with dimming
    renderWorkflowMaturityWidget(surveys, allSurveys);

    // Limiting Factors Widget â€” shows all factors (dimmed/highlighted via filter state)
    renderLimitingFactorsWidget(allSurveys);

    // AI Challenges Widget â€” shows all challenges (dimmed/highlighted via filter state)
    renderAiChallengesWidget(allSurveys);

    // Collapsed section summary (must run after renderAdoptionStageWidget sets currentMedianStage)
    updateSectionSummary(allSurveys);

    // AI Tools Usage Widget â€” shows all tools (dimmed/highlighted via filter state)
    renderAiToolsWidget(allSurveys);
    renderSdlcCoverageWidget(surveys);

    // Collapsed account section summary (must run after renderWorkflowMaturityWidget sets currentWfmStage)
    updateAccountSectionSummary(allSurveys);

    // Surveys table â€” filtered by active filters
    renderSurveysTable(surveys);

    // Sync accounts and DM dropdowns with current data
    populateAccountsFilter();
    populateDMFilter();

    // Collapsed surveys section summary
    updateSurveysSectionSummary(surveys);
  }

  function updateSummaryCards(surveys) {
    document.getElementById('totalSurveys').textContent = surveys.length;

    // --- AI Usage % ---
    const pctEl = document.getElementById('aiUsagePct');
    const compEl = document.getElementById('aiUsageComparison');

    const currentPct = calculateAiUsagePercent(surveys);
    pctEl.textContent = currentPct !== null ? currentPct + '%' : '--';

    // Comparison
    const compPeriod = getComparisonPeriod();
    if (compPeriod && currentPct !== null) {
      const compSurveys = fetchComparisonSurveys(compPeriod.year, compPeriod.quarter);
      const prevPct = calculateAiUsagePercent(compSurveys);

      if (prevPct !== null) {
        const delta = currentPct - prevPct;
        const absDelta = Math.abs(delta);
        const sel = document.getElementById('aiUsageCompPeriod');
        const periodLabel = sel.selectedOptions[0]?.textContent || '';
        const periodShort = periodLabel.replace(/^vs\s*/i, '');

        if (delta > 0) {
          compEl.className = 'summary-card-comparison up';
          compEl.innerHTML = `<span class="arrow">&#9650;</span> +${absDelta} pp vs ${periodShort}`;
        } else if (delta < 0) {
          compEl.className = 'summary-card-comparison down';
          compEl.innerHTML = `<span class="arrow">&#9660;</span> -${absDelta} pp vs ${periodShort}`;
        } else {
          compEl.className = 'summary-card-comparison neutral';
          compEl.innerHTML = `No change vs ${periodShort}`;
        }
      } else {
        compEl.className = 'summary-card-comparison neutral';
        compEl.innerHTML = 'No comparison data';
      }
    } else {
      compEl.className = 'summary-card-comparison neutral';
      const yr = document.getElementById('filterYear').value;
      const qr = document.getElementById('filterQuarter').value;
      compEl.innerHTML = (yr === 'all' || qr === 'all')
        ? 'Select a specific period to compare'
        : 'No comparison data';
    }
  }

  function calculateAiUsagePercent(surveys) {
    if (surveys.length === 0) return null;
    const EXCLUDED_KEYS = ['dont-know', 'not-applicable', 'custom', '_meta'];
    let usesAiCount = 0;

    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;

      const hasNamedTool = Object.keys(aiTools).some(key =>
        !EXCLUDED_KEYS.includes(key) && aiTools[key]?.selected === true
      );
      const hasCustomTool = Array.isArray(aiTools.custom) && aiTools.custom.length > 0;

      if (hasNamedTool || hasCustomTool) usesAiCount++;
    });

    return Math.round((usesAiCount / surveys.length) * 100);
  }

  function fetchComparisonSurveys(compYear, compQuarter) {
    const selectedTypes = getSelectedAccountTypes();
    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager FROM surveys WHERE year = ? AND quarter = ?';
    const params = [compYear, compQuarter];

    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    let surveys = result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || ''
    }));

    // Apply engagement type filter (structural)
    const selectedEngagementTypes = getSelectedEngagementTypes();
    if (selectedEngagementTypes.length === 0) return [];
    if (selectedEngagementTypes.length < ENGAGEMENT_TYPES.length) {
      surveys = surveys.filter(s => {
        const ownership = s.data?.engagement?.ownership;
        if (!ownership) return false;
        return selectedEngagementTypes.some(type => ownership[type]?.selected === true);
      });
    }

    return surveys;
  }

  function getComparisonPeriod() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const mode = document.getElementById('aiUsageCompPeriod').value;

    if (year === 'all' || quarter === 'all') return null;

    const y = parseInt(year);
    const q = parseInt(quarter);

    if (mode === 'prev-quarter') {
      return q === 1 ? { year: y - 1, quarter: 4 } : { year: y, quarter: q - 1 };
    }
    if (mode === 'same-quarter-last-year') {
      return { year: y - 1, quarter: q };
    }
    // Specific year-quarter format: "YYYY-Q"
    if (mode.includes('-')) {
      const parts = mode.split('-');
      return { year: parseInt(parts[0]), quarter: parseInt(parts[1]) };
    }
    return null;
  }

  function populateComparisonPeriodOptions() {
    const select = document.getElementById('aiUsageCompPeriod');
    const currentVal = select.value;

    // Keep the two preset options, remove dynamically added ones
    while (select.options.length > 2) {
      select.remove(2);
    }

    // Query available year+quarter combinations
    const rows = db.exec('SELECT DISTINCT year, quarter FROM surveys ORDER BY year DESC, quarter DESC');
    if (rows.length > 0 && rows[0].values.length > 0) {
      const separator = document.createElement('option');
      separator.disabled = true;
      separator.textContent = '\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500';
      select.appendChild(separator);

      rows[0].values.forEach(([y, q]) => {
        const opt = document.createElement('option');
        opt.value = `${y}-${q}`;
        opt.textContent = `vs ${y} Q${q}`;
        select.appendChild(opt);
      });
    }

    // Restore previous selection if still valid
    if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
      select.value = currentVal;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHART HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const CHART_COLORS = {
    primary: '#4f46e5',
    primaryLight: 'rgba(79, 70, 229, 0.7)',
    secondary: '#06b6d4',
    secondaryLight: 'rgba(6, 182, 212, 0.7)',
    success: '#10b981',
    warning: '#f59e0b',
    danger: '#ef4444',
    gray: '#9ca3af',
    palette: ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1']
  };

  function destroyChart(id) {
    if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    // Also check if Chart.js has a chart on this canvas (safety net)
    const canvas = document.getElementById(id);
    if (canvas) {
      const existing = Chart.getChart(canvas);
      if (existing) existing.destroy();
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ADOPTION STAGE WIDGET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderAdoptionStageWidget(surveys) {
    // Count all maturity values including dont-know
    const counts = {};
    MATURITY_ORDER.forEach(k => counts[k] = 0);
    let totalAll = 0;
    let totalKnown = 0; // excludes dont-know (for weighted average)

    surveys.forEach(s => {
      const val = s.data?.clientAILandscape?.maturity?.value;
      if (val && MATURITY_ORDER.includes(val)) {
        counts[val]++;
        totalAll++;
        if (val !== 'dont-know') totalKnown++;
      }
    });

    // Calculate percentages over total (including dont-know)
    const pcts = {};
    MATURITY_ORDER.forEach(k => {
      pcts[k] = totalAll > 0 ? Math.round((counts[k] / totalAll) * 100) : 0;
    });

    // Calculate median stage index (excluding dont-know)
    const knownIndices = [];
    MATURITY_STAGES.forEach((k, i) => {
      for (let n = 0; n < counts[k]; n++) knownIndices.push(i);
    });
    let medianIndex = -1;
    if (knownIndices.length > 0) {
      const mid = Math.floor(knownIndices.length / 2);
      medianIndex = knownIndices.length % 2 === 1
        ? knownIndices[mid]
        : (knownIndices[mid - 1] + knownIndices[mid]) / 2;
    }
    const avgPosition = totalKnown > 0 ? medianIndex / (MATURITY_STAGES.length - 1) : 0.5;
    const avgStage = totalKnown > 0 ? MATURITY_STAGES[Math.round(medianIndex)] : null;
    currentMedianStage = avgStage;
    currentStagePosition = avgPosition;

    // Update callout
    const calloutValue = document.getElementById('stageCalloutValue');
    if (avgStage) {
      calloutValue.innerHTML = `${MATURITY_ICONS[avgStage]} ${MATURITY_LABELS[avgStage]}`;
    } else {
      calloutValue.textContent = '--';
    }

    // Render stage pipeline (all stages including dont-know)
    const pipeline = document.getElementById('stagePipeline');
    pipeline.innerHTML = MATURITY_ORDER.map((stage, i) => {
      const isActive = activeMaturityFilter === stage;
      const isDimmed = activeMaturityFilter && !isActive;
      const borderColor = isActive ? MATURITY_COLORS[stage] : '#e5e7eb';
      const bgColor = isActive ? (MATURITY_COLORS[stage] + '15') : '#fff';
      const shadowColor = isActive ? (MATURITY_COLORS[stage] + '40') : 'transparent';
      const dimStyle = isDimmed ? 'opacity:0.35;' : '';
      const connector = i < MATURITY_ORDER.length - 1
        ? '<div class="stage-connector">&#9654;</div>'
        : '';
      return `<div class="stage-card ${isActive ? 'active' : ''}"
                   onclick="setMaturityFilter('${stage}')"
                   style="${dimStyle}border-color:${borderColor};background:${bgColor};${isActive ? 'box-shadow:0 0 0 3px ' + shadowColor + ', 0 6px 20px rgba(0,0,0,0.12);' : ''}"
                   title="Click to filter by ${MATURITY_LABELS[stage]}">
        <div class="stage-card-icon">${MATURITY_ICONS[stage]}</div>
        <div class="stage-card-label">${MATURITY_LABELS[stage]}</div>
        <div class="stage-card-pct" style="color:${MATURITY_COLORS[stage]};">${pcts[stage]}%</div>
        <div class="stage-card-count">${counts[stage]} account${counts[stage] !== 1 ? 's' : ''}</div>
      </div>${connector}`;
    }).join('');

    // Update progress bar marker + callout position
    const marker = document.getElementById('progressMarker');
    const callout = document.getElementById('stageCallout');
    const progressBar = document.querySelector('.progress-gradient-bar');
    const pipelineEl = document.getElementById('stagePipeline');
    const stageCards = pipelineEl.querySelectorAll('.stage-card');
    const barRect = progressBar ? progressBar.getBoundingClientRect() : null;

    function setAdoptionMarkerPos(pct) {
      marker.style.left = pct + '%';
      callout.style.left = pct + '%';
    }

    // Hide marker+callout when no surveys have maturity data
    if (totalAll === 0) {
      marker.style.display = 'none';
      callout.style.display = 'none';
    } else if (barRect && stageCards.length > 0) {
      marker.style.display = '';
      callout.style.display = '';
      if (activeMaturityFilter) {
        const filterIdx = MATURITY_ORDER.indexOf(activeMaturityFilter);
        if (filterIdx >= 0 && filterIdx < stageCards.length) {
          const cardRect = stageCards[filterIdx].getBoundingClientRect();
          const cardCenter = cardRect.left + cardRect.width / 2;
          const markerPct = Math.max(2, Math.min(98, ((cardCenter - barRect.left) / barRect.width) * 100));
          setAdoptionMarkerPos(markerPct);
        }
      } else {
        const dontKnowIdx = MATURITY_ORDER.indexOf('dont-know');
        const firstRealIdx = dontKnowIdx === 0 ? 1 : 0;
        const lastRealIdx = dontKnowIdx === MATURITY_ORDER.length - 1 ? MATURITY_ORDER.length - 2 : MATURITY_ORDER.length - 1;
        if (stageCards.length > lastRealIdx) {
          const firstRealCard = stageCards[firstRealIdx];
          const lastRealCard = stageCards[lastRealIdx];
          const startPct = ((firstRealCard.getBoundingClientRect().left + firstRealCard.offsetWidth / 2) - barRect.left) / barRect.width * 100;
          const endPct = ((lastRealCard.getBoundingClientRect().left + lastRealCard.offsetWidth / 2) - barRect.left) / barRect.width * 100;
          const markerPct = Math.max(2, Math.min(98, startPct + avgPosition * (endPct - startPct)));
          setAdoptionMarkerPos(markerPct);
        } else {
          const markerPct = Math.max(5, Math.min(95, avgPosition * 100));
          setAdoptionMarkerPos(markerPct);
        }
      }
    } else {
      marker.style.display = 'none';
      callout.style.display = 'none';
    }

    // Render legend (all stages including dont-know)
    const legend = document.getElementById('widgetLegend');
    legend.innerHTML = MATURITY_ORDER.map(stage =>
      `<div class="legend-item">
        <div class="legend-dot" style="background:${MATURITY_COLORS[stage]};"></div>
        <span>${MATURITY_LABELS[stage]}</span>
      </div>`
    ).join('');

    // Show/hide filter footer
    const footer = document.getElementById('widgetFooter');
    const hasAnyFilter = activeMaturityFilter || selectedAccounts.size > 0 || selectedDeliveryManagers.size > 0 || activeLimitingFactorFilter || activeAiToolFilter || activeAiChallengeFilter || activeWfmStageFilter !== null;
    if (hasAnyFilter) {
      footer.style.display = 'flex';
      let tags = '';
      if (activeMaturityFilter) {
        tags += `<span class="filter-active-tag">Stage: ${MATURITY_LABELS[activeMaturityFilter]} <span class="filter-clear-x" onclick="clearMaturityFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (selectedAccounts.size > 0) {
        const accountLabel = selectedAccounts.size === 1 ? escapeHtml([...selectedAccounts][0]) : `${selectedAccounts.size} accounts`;
        tags += `<span class="filter-active-tag">Account: ${accountLabel} <span class="filter-clear-x" onclick="clearAccountFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (selectedDeliveryManagers.size > 0) {
        const dmLabel = selectedDeliveryManagers.size === 1 ? escapeHtml([...selectedDeliveryManagers][0]) : `${selectedDeliveryManagers.size} DMs`;
        tags += `<span class="filter-active-tag">DM: ${dmLabel} <span class="filter-clear-x" onclick="clearDMFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeLimitingFactorFilter) {
        tags += `<span class="filter-active-tag">Factor: ${LIMITING_FACTOR_LABELS[activeLimitingFactorFilter]} <span class="filter-clear-x" onclick="clearLimitingFactorFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeWfmStageFilter !== null) {
        tags += `<span class="filter-active-tag">WFM: Stage ${activeWfmStageFilter} - ${WFM_LABELS[activeWfmStageFilter]} <span class="filter-clear-x" onclick="clearWfmStageFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAiToolFilter) {
        const toolLabel = activeAiToolFilter === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[activeAiToolFilter] || activeAiToolFilter);
        tags += `<span class="filter-active-tag">Tool: ${toolLabel} <span class="filter-clear-x" onclick="clearAiToolFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAiChallengeFilter) {
        tags += `<span class="filter-active-tag">Challenge: ${AI_CHALLENGE_LABELS[activeAiChallengeFilter] || activeAiChallengeFilter} <span class="filter-clear-x" onclick="clearAiChallengeFilter()" title="Clear filter">&times;</span></span>`;
      }
      document.getElementById('activeFilterTags').innerHTML = tags;
    } else {
      footer.style.display = 'none';
    }
  }

  function renderWorkflowMaturityWidget(filteredSurveys, allSurveys) {
    // Helper: compute per-account WFM stages from a survey set
    function computeAccountStages(surveyList) {
      const stages = [];
      surveyList.forEach(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return;
        const roleStages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
        });
        if (roleStages.length === 0) return;
        const avg = roleStages.reduce((a, b) => a + b, 0) / roleStages.length;
        stages.push(Math.round(avg));
      });
      return stages;
    }

    // 1a. Compute from ALL surveys (for circles / distribution)
    const allAccountStages = computeAccountStages(allSurveys);
    const allCounts = {};
    WFM_STAGES.forEach(s => allCounts[s] = 0);
    allAccountStages.forEach(s => { if (allCounts[s] !== undefined) allCounts[s]++; });
    const allTotal = allAccountStages.length;

    // 1b. Compute from FILTERED surveys (for callout / marker / hybrid circles)
    const filteredAccountStages = computeAccountStages(filteredSurveys);
    const filteredCounts = {};
    WFM_STAGES.forEach(s => filteredCounts[s] = 0);
    filteredAccountStages.forEach(s => { if (filteredCounts[s] !== undefined) filteredCounts[s]++; });
    const filteredTotal = filteredAccountStages.length;
    const filteredAvg = filteredTotal > 0
      ? (filteredAccountStages.reduce((a, b) => a + b, 0) / filteredTotal)
      : 0;

    // 2. Percentages â€” always use filtered data for percentages
    const pcts = {};
    WFM_STAGES.forEach(s => {
      pcts[s] = filteredTotal > 0 ? Math.round((filteredCounts[s] / filteredTotal) * 100) : 0;
    });

    // 3. Update callout â€” reflects FILTERED data, show stage name and score
    const avgEl = document.getElementById('wfmAvgValue');
    const avgDescEl = document.getElementById('wfmAvgDesc');
    const roundedStage = Math.round(filteredAvg);
    currentWfmStage = filteredTotal > 0 ? roundedStage : null;
    currentWfmPosition = filteredTotal > 0 ? filteredAvg / 5 : 0.5;
    if (filteredTotal > 0) {
      avgEl.textContent = `Stage ${roundedStage} â€” ${WFM_LABELS[roundedStage]}`;
      avgDescEl.textContent = `Score: ${filteredAvg.toFixed(1)} / 5.0 Â· Average across ${filteredTotal} account${filteredTotal !== 1 ? 's' : ''}`;
    } else {
      avgEl.textContent = '--';
      avgDescEl.textContent = 'No accounts match current filters';
    }

    // 6. Render journey cards (always use filtered data for %, hybrid label for WFM filter)
    const journey = document.getElementById('wfmJourney');
    journey.innerHTML = WFM_STAGES.map((stage, i) => {
      const pct = pcts[stage];
      const count = filteredCounts[stage];
      const countLabel = activeWfmStageFilter !== null
        ? `${count} of ${allCounts[stage]} total`
        : `${count} account${count !== 1 ? 's' : ''}`;
      const color = WFM_COLORS[stage];
      const isActive = activeWfmStageFilter === stage;
      const isDimmed = activeWfmStageFilter !== null && !isActive;
      const borderColor = isActive ? color : '#e5e7eb';
      const bgColor = isActive ? (color + '15') : '#fff';
      const dimStyle = isDimmed ? 'opacity:0.35;' : '';
      const shadowStyle = isActive ? `box-shadow:0 0 0 3px ${color}40, 0 6px 20px rgba(0,0,0,0.12);` : '';
      const badgeBg = pct > 0 ? (color + '30') : '#f3f4f6';
      const badgeColor = isDimmed ? '#9ca3af' : (pct > 0 ? '#374151' : '#9ca3af');
      const pctColor = isDimmed ? '#9ca3af' : color;
      const labelWeight = isActive ? 'font-weight:800;' : '';
      const connector = i < WFM_STAGES.length - 1
        ? '<div class="stage-connector">&#9654;</div>'
        : '';

      return `<div class="wfm-card ${isActive ? 'active' : ''}"
                   onclick="setWfmStageFilter(${stage})"
                   style="${dimStyle}border-color:${borderColor};background:${bgColor};${shadowStyle}"
                   title="Click to filter by Stage ${stage}">
        <div class="wfm-card-badge" style="background:${badgeBg};color:${badgeColor};">Stage ${stage}</div>
        <div class="wfm-card-title" style="${labelWeight}">${WFM_LABELS[stage]}</div>
        <div class="wfm-card-pct" style="color:${pctColor};">${pct}%</div>
        <div class="wfm-card-count">${countLabel}</div>
        <div class="wfm-card-sub">${WFM_SUBTITLES[stage]}</div>
      </div>${connector}`;
    }).join('');

    // 7. Position progress bar marker + callout â€” snap to card center when filter active
    const wfmMarker = document.getElementById('wfmProgressMarker');
    const wfmCallout = document.getElementById('wfmCallout');
    const wfmBar = document.querySelector('.wfm-gradient-bar');
    const wfmCards = journey.querySelectorAll('.wfm-card');
    const wfmBarRect = wfmBar ? wfmBar.getBoundingClientRect() : null;

    function setWfmMarkerPos(pct) {
      wfmMarker.style.left = pct + '%';
      wfmCallout.style.left = pct + '%';
    }

    if (filteredTotal === 0) {
      wfmMarker.style.display = 'none';
      wfmCallout.style.display = 'none';
    } else if (wfmBarRect && wfmCards.length > 0) {
      wfmMarker.style.display = '';
      wfmCallout.style.display = '';
      if (activeWfmStageFilter !== null && activeWfmStageFilter < wfmCards.length) {
        const cardEl = wfmCards[activeWfmStageFilter];
        const cardRect = cardEl.getBoundingClientRect();
        const cardCenter = cardRect.left + cardRect.width / 2;
        const markerPct = Math.max(2, Math.min(98, ((cardCenter - wfmBarRect.left) / wfmBarRect.width) * 100));
        setWfmMarkerPos(markerPct);
      } else {
        const firstCard = wfmCards[0];
        const lastCard = wfmCards[wfmCards.length - 1];
        const startX = firstCard.getBoundingClientRect().left + firstCard.offsetWidth / 2;
        const endX = lastCard.getBoundingClientRect().left + lastCard.offsetWidth / 2;
        const avgPosition = filteredAvg / 5;
        const markerX = startX + avgPosition * (endX - startX);
        const markerPct = Math.max(2, Math.min(98, ((markerX - wfmBarRect.left) / wfmBarRect.width) * 100));
        setWfmMarkerPos(markerPct);
      }
    } else {
      wfmMarker.style.display = 'none';
      wfmCallout.style.display = 'none';
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LIMITING FACTORS WIDGET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderLimitingFactorsWidget(surveys) {
    destroyChart('chartLimitingFactors');

    // Count how many times each factor is selected (rank 1 or rank 2)
    const counts = {};
    LIMITING_FACTOR_ORDER.forEach(k => counts[k] = 0);

    const totalSurveys = surveys.length;

    surveys.forEach(s => {
      const lf = s.data?.limitingFactors;
      if (!lf) return;
      Object.entries(lf).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) counts[k]++;
      });
    });

    // Sort factors by mentions descending
    const sorted = [...LIMITING_FACTOR_ORDER].sort((a, b) => counts[b] - counts[a]);

    // Calculate percentages
    const pcts = {};
    sorted.forEach(k => {
      pcts[k] = totalSurveys > 0 ? Math.round((counts[k] / totalSurveys) * 100) : 0;
    });

    const labels = sorted.map(k => LIMITING_FACTOR_LABELS[k] || k);

    // Per-bar colors: dim bars not matching the active filter
    const bgColors = sorted.map(k => {
      if (activeLimitingFactorFilter && activeLimitingFactorFilter !== k) return LF_COLORS.primary + '30';
      return LF_COLORS.primary;
    });
    const yTickColors = sorted.map(k => {
      if (activeLimitingFactorFilter && activeLimitingFactorFilter !== k) return '#d1d5db';
      if (activeLimitingFactorFilter === k) return '#1f2937';
      return '#374151';
    });

    const ctx = document.getElementById('chartLimitingFactors').getContext('2d');
    charts['chartLimitingFactors'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Mentions',
          data: sorted.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const factorKey = sorted[context.dataIndex];
                return `${context.raw}% (${counts[factorKey]} of ${totalSurveys})`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = sorted[context.index];
                const isActive = activeLimitingFactorFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const factorKey = sorted[elements[0].index];
            setLimitingFactorFilter(factorKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const legend = document.getElementById('lfLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${LF_COLORS.primary};"></div>
        <span>% of accounts reporting this factor</span>
      </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COLLAPSED SECTION SUMMARY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function updateSectionSummary(surveys) {
    const el = document.getElementById('sectionSummaryLandscape');
    if (!el) return;

    // Average Portfolio Stage (reuse currentMedianStage set by renderAdoptionStageWidget)
    const stageHtml = currentMedianStage
      ? `${MATURITY_ICONS[currentMedianStage]} ${MATURITY_LABELS[currentMedianStage]}`
      : '--';

    // Top 3 AI Challenges
    const chCounts = {};
    AI_CHALLENGE_ORDER.forEach(k => chCounts[k] = 0);
    surveys.forEach(s => {
      const ch = s.data?.clientAILandscape?.challenges;
      if (!ch) return;
      Object.entries(ch).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) chCounts[k]++;
      });
    });
    const topChallenges = [...AI_CHALLENGE_ORDER]
      .sort((a, b) => chCounts[b] - chCounts[a])
      .filter(k => chCounts[k] > 0)
      .slice(0, 3);

    const totalSurveys = surveys.length;
    const challengePills = topChallenges.map(k => {
      const pct = totalSurveys > 0 ? Math.round((chCounts[k] / totalSurveys) * 100) : 0;
      return `<span class="section-summary-challenge-pill">${AI_CHALLENGE_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    const stageMarkerPct = Math.max(4, Math.min(96, currentStagePosition * 100));
    const miniBarHtml = currentMedianStage
      ? `<div class="section-summary-mini-bar"><div class="section-summary-mini-marker" style="left:${stageMarkerPct}%"></div></div>`
      : '';

    el.innerHTML = `
      <div class="section-summary-item" style="flex-direction:column;align-items:flex-start;">
        <div style="display:flex;align-items:center;gap:0.4rem;">
          <span class="section-summary-label">Avg Stage:</span>
          <span class="section-summary-value">${stageHtml}</span>
        </div>
        ${miniBarHtml}
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Top Challenges:</span>
        <div class="section-summary-challenges">${challengePills}</div>
      </div>`;
  }

  function updateAccountSectionSummary(surveys) {
    const el = document.getElementById('sectionSummaryAccount');
    if (!el) return;

    // Portfolio Average Maturity (reuse currentWfmStage set by renderWorkflowMaturityWidget)
    const maturityHtml = currentWfmStage !== null
      ? `Stage ${currentWfmStage} â€” ${WFM_LABELS[currentWfmStage]}`
      : '--';

    // Top 3 Limiting Factors
    const lfCounts = {};
    LIMITING_FACTOR_ORDER.forEach(k => lfCounts[k] = 0);
    surveys.forEach(s => {
      const lf = s.data?.limitingFactors;
      if (!lf) return;
      Object.entries(lf).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) lfCounts[k]++;
      });
    });
    const topFactors = [...LIMITING_FACTOR_ORDER]
      .sort((a, b) => lfCounts[b] - lfCounts[a])
      .filter(k => lfCounts[k] > 0)
      .slice(0, 3);
    const totalSurveysAcct = surveys.length;
    const factorPills = topFactors.map(k => {
      const pct = totalSurveysAcct > 0 ? Math.round((lfCounts[k] / totalSurveysAcct) * 100) : 0;
      return `<span class="section-summary-challenge-pill">${LIMITING_FACTOR_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    // Top 3 AI Tools
    const toolCounts = {};
    AI_TOOL_ORDER.forEach(k => toolCounts[k] = 0);
    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;
      AI_TOOL_ORDER.forEach(k => {
        if (aiTools[k]?.selected === true) toolCounts[k]++;
      });
    });
    const topTools = [...AI_TOOL_ORDER]
      .sort((a, b) => toolCounts[b] - toolCounts[a])
      .filter(k => toolCounts[k] > 0)
      .slice(0, 3);
    const toolPills = topTools.map(k => {
      const c = toolCounts[k];
      const pct = totalSurveysAcct > 0 ? Math.round((c / totalSurveysAcct) * 100) : 0;
      return `<span class="section-summary-challenge-pill" style="background:#eef2ff;border-color:#c7d2fe;color:#4338ca;">${AI_TOOL_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    const wfmMarkerPct = Math.max(4, Math.min(96, currentWfmPosition * 100));
    const wfmMiniBarHtml = currentWfmStage !== null
      ? `<div class="section-summary-mini-bar"><div class="section-summary-mini-marker" style="left:${wfmMarkerPct}%"></div></div>`
      : '';

    // SDLC top "Doing" phases
    const sdlcSummary = SDLC_PHASES.map(phase => {
      let doing = 0, total = 0;
      surveys.forEach(s => {
        const section = s.data?.useCases?.[phase.key];
        if (!section) return;
        Object.values(section).forEach(item => {
          total++;
          if (item?.status === 'doing') doing++;
        });
      });
      return { label: phase.label, pct: total > 0 ? Math.round((doing / total) * 100) : 0 };
    }).sort((a, b) => b.pct - a.pct).slice(0, 3);
    const sdlcPills = sdlcSummary.filter(p => p.pct > 0).map(p =>
      `<span class="section-summary-challenge-pill" style="background:#ecfdf5;border-color:#a7f3d0;color:#047857;">${p.label} ${p.pct}%</span>`
    ).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    el.innerHTML = `
      <div class="section-summary-item" style="flex-direction:column;align-items:flex-start;">
        <div style="display:flex;align-items:center;gap:0.4rem;">
          <span class="section-summary-label">Avg Maturity:</span>
          <span class="section-summary-value">${maturityHtml}</span>
        </div>
        ${wfmMiniBarHtml}
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Top Factors:</span>
        <div class="section-summary-challenges">${factorPills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Top Tools:</span>
        <div class="section-summary-challenges">${toolPills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">SDLC Doing:</span>
        <div class="section-summary-challenges">${sdlcPills}</div>
      </div>`;
  }

  function updateSurveysSectionSummary(surveys) {
    const el = document.getElementById('sectionSummarySurveys');
    if (!el) return;

    el.innerHTML = `
      <div class="section-summary-item">
        <span class="section-summary-label">Surveys:</span>
        <span class="section-summary-value">${surveys.length}</span>
      </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AI CHALLENGES WIDGET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderAiChallengesWidget(surveys) {
    destroyChart('chartAiChallenges');

    // Count how many times each challenge is selected (rank 1 or rank 2)
    const counts = {};
    AI_CHALLENGE_ORDER.forEach(k => counts[k] = 0);

    const totalSurveys = surveys.length;

    surveys.forEach(s => {
      const ch = s.data?.clientAILandscape?.challenges;
      if (!ch) return;
      Object.entries(ch).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) counts[k]++;
      });
    });

    // Sort by mentions descending
    const sorted = [...AI_CHALLENGE_ORDER].sort((a, b) => counts[b] - counts[a]);

    const pcts = {};
    sorted.forEach(k => {
      pcts[k] = totalSurveys > 0 ? Math.round((counts[k] / totalSurveys) * 100) : 0;
    });

    const labels = sorted.map(k => AI_CHALLENGE_LABELS[k] || k);

    const bgColors = sorted.map(k => {
      if (activeAiChallengeFilter && activeAiChallengeFilter !== k) return AI_CHALLENGE_COLORS.primary + '30';
      return AI_CHALLENGE_COLORS.primary;
    });
    const yTickColors = sorted.map(k => {
      if (activeAiChallengeFilter && activeAiChallengeFilter !== k) return '#d1d5db';
      if (activeAiChallengeFilter === k) return '#1f2937';
      return '#374151';
    });

    const ctx = document.getElementById('chartAiChallenges').getContext('2d');
    charts['chartAiChallenges'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Mentions',
          data: sorted.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const challengeKey = sorted[context.dataIndex];
                return `${context.raw}% (${counts[challengeKey]} of ${totalSurveys})`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = sorted[context.index];
                const isActive = activeAiChallengeFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const challengeKey = sorted[elements[0].index];
            setAiChallengeFilter(challengeKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const legend = document.getElementById('aiChallengesLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${AI_CHALLENGE_COLORS.primary};"></div>
        <span>% of accounts reporting this challenge</span>
      </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AI TOOLS USAGE WIDGET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderAiToolsWidget(surveys) {
    destroyChart('chartAiTools');

    const totalSurveys = surveys.length;
    const EXCLUDED_KEYS = ['dont-know', 'not-applicable', 'custom', '_meta'];

    // Count how many surveys have each named tool selected
    const toolCounts = {};
    AI_TOOL_ORDER.forEach(k => toolCounts[k] = 0);
    let customCount = 0;

    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;
      AI_TOOL_ORDER.forEach(toolKey => {
        if (aiTools[toolKey]?.selected === true) toolCounts[toolKey]++;
      });
      if (Array.isArray(aiTools.custom) && aiTools.custom.length > 0) customCount++;
    });

    // Build sorted list of tools with count > 0, plus custom if any
    const toolKeys = AI_TOOL_ORDER.filter(k => toolCounts[k] > 0);
    if (customCount > 0) toolKeys.push('_custom');

    // Sort by count descending
    toolKeys.sort((a, b) => {
      const ca = a === '_custom' ? customCount : toolCounts[a];
      const cb = b === '_custom' ? customCount : toolCounts[b];
      return cb - ca;
    });

    // Calculate percentages
    const pcts = {};
    const counts = {};
    toolKeys.forEach(k => {
      const c = k === '_custom' ? customCount : toolCounts[k];
      counts[k] = c;
      pcts[k] = totalSurveys > 0 ? Math.round((c / totalSurveys) * 100) : 0;
    });

    const labels = toolKeys.map(k => k === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[k] || k));

    // Per-bar colors: dim bars not matching the active filter
    const bgColors = toolKeys.map(k => {
      if (activeAiToolFilter && activeAiToolFilter !== k) return AI_TOOL_COLOR + '30';
      return AI_TOOL_COLOR;
    });
    const yTickColors = toolKeys.map(k => {
      if (activeAiToolFilter && activeAiToolFilter !== k) return '#d1d5db';
      if (activeAiToolFilter === k) return '#1f2937';
      return '#374151';
    });

    // Adjust chart height dynamically based on number of tools
    const chartContainer = document.querySelector('.ai-tools-chart-container');
    const barCount = toolKeys.length || 1;
    chartContainer.style.height = Math.max(180, barCount * 32 + 40) + 'px';

    const ctx = document.getElementById('chartAiTools').getContext('2d');
    charts['chartAiTools'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Usage',
          data: toolKeys.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const toolKey = toolKeys[context.dataIndex];
                const count = counts[toolKey];
                return `${context.raw}% (${count} of ${totalSurveys} accounts)`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = toolKeys[context.index];
                const isActive = activeAiToolFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const toolKey = toolKeys[elements[0].index];
            setAiToolFilter(toolKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const legend = document.getElementById('aiToolsLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${AI_TOOL_COLOR};"></div>
        <span>% of accounts using this tool</span>
      </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SDLC AI COVERAGE MAP
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const SDLC_PHASES = [
    { key: 'requirements', label: 'Requirements' },
    { key: 'code-dev', label: 'Development' },
    { key: 'documentation', label: 'Documentation' },
    { key: 'pm', label: 'PM' },
    { key: 'design-ux', label: 'Design & UX' },
    { key: 'data-analytics', label: 'Data & Analytics' }
  ];

  function renderSdlcCoverageWidget(surveys) {
    const container = document.getElementById('sdlcCoverageContent');
    const insightEl = document.getElementById('sdlcKeyInsight');
    if (!container) return;

    if (surveys.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No survey data available</div>';
      insightEl.style.display = 'none';
      return;
    }

    // Aggregate data per phase
    const phaseData = SDLC_PHASES.map(phase => {
      let doing = 0, need = 0, total = 0;

      surveys.forEach(s => {
        const section = s.data?.useCases?.[phase.key];
        if (!section) return;
        Object.values(section).forEach(item => {
          const status = item?.status;
          total++;
          if (status === 'doing') doing++;
          else if (status === 'need') need++;
        });
      });

      const notUsing = total - doing - need;
      const doingPct = total > 0 ? Math.round((doing / total) * 100) : 0;
      const needPct = total > 0 ? Math.round((need / total) * 100) : 0;
      const notUsingPct = total > 0 ? 100 - doingPct - needPct : 0;

      return { ...phase, doing, need, notUsing, total, doingPct, needPct, notUsingPct };
    });

    // Render bars
    let html = '';
    phaseData.forEach(p => {
      const doingLabel = p.doingPct >= 10 ? `${p.doingPct}%` : '';
      const needLabel = p.needPct >= 10 ? `${p.needPct}%` : '';
      const notUsingLabel = p.notUsingPct >= 10 ? `${p.notUsingPct}%` : '';

      html += `
        <div class="sdlc-phase-block" onclick="openSdlcPhaseModal('${p.key}')" title="Click for use case breakdown">
          <div class="sdlc-phase-header">
            <span class="sdlc-phase-label">${escapeHtml(p.label)}</span>
            <span class="sdlc-phase-stats">
              <span class="doing">${p.doingPct}% Doing</span>
              <span class="separator">|</span>
              <span class="need">${p.needPct}% Need</span>
            </span>
          </div>
          <div class="sdlc-bar-track">
            ${p.doingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-doing" style="width:${p.doingPct}%">${doingLabel}</div>` : ''}
            ${p.needPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-need" style="width:${p.needPct}%">${needLabel}</div>` : ''}
            ${p.notUsingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-notusing" style="width:${p.notUsingPct}%">${notUsingLabel}</div>` : ''}
          </div>
        </div>`;
    });
    container.innerHTML = html;

    // Key insight: find phases with highest "need" percentage
    const sortedByNeed = [...phaseData].sort((a, b) => b.needPct - a.needPct);
    const topNeed = sortedByNeed.filter(p => p.needPct > 0).slice(0, 2);
    if (topNeed.length > 0 && topNeed[0].needPct >= 10) {
      const phaseNames = topNeed.map(p => p.label).join(' & ');
      insightEl.innerHTML = `<strong>Key Insight:</strong> High "Need" in ${escapeHtml(phaseNames)} signals strategic blind spots â€” teams see value but lack enablement`;
      insightEl.style.display = '';
    } else if (phaseData.some(p => p.doingPct >= 50)) {
      const topDoing = [...phaseData].sort((a, b) => b.doingPct - a.doingPct)[0];
      insightEl.innerHTML = `<strong>Key Insight:</strong> ${escapeHtml(topDoing.label)} leads AI adoption at ${topDoing.doingPct}% â€” consider extending its practices to other phases`;
      insightEl.style.display = '';
    } else {
      insightEl.style.display = 'none';
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SURVEYS TABLE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getWfmAverage(s) {
    const wfm = s.data?.workflowMaturity;
    if (!wfm) return -1;
    const stages = [];
    ROLE_ORDER.forEach(role => {
      const st = wfm[role]?.stage;
      if (st !== null && st !== undefined && typeof st === 'number') stages.push(st);
    });
    return stages.length > 0 ? stages.reduce((a, b) => a + b, 0) / stages.length : -1;
  }

  function sortSurveys(surveys) {
    const sorted = [...surveys];
    const dir = tableSortDirection === 'asc' ? 1 : -1;

    sorted.sort((a, b) => {
      let va, vb;
      switch (tableSortColumn) {
        case 'account':
          return dir * (a.account_name || '').localeCompare(b.account_name || '');
        case 'type':
          return dir * (a.account_type || '').localeCompare(b.account_type || '');
        case 'maturity':
          va = MATURITY_ORDER.indexOf(a.data?.clientAILandscape?.maturity?.value);
          vb = MATURITY_ORDER.indexOf(b.data?.clientAILandscape?.maturity?.value);
          if (va === -1) va = 999;
          if (vb === -1) vb = 999;
          return dir * (va - vb);
        case 'wfm':
          va = getWfmAverage(a);
          vb = getWfmAverage(b);
          if (va === -1) va = dir > 0 ? 999 : -999;
          if (vb === -1) vb = dir > 0 ? 999 : -999;
          return dir * (va - vb);
        case 'dm':
          return dir * (a.delivery_manager || '').localeCompare(b.delivery_manager || '');
        case 'quarter':
          va = (a.year || 0) * 10 + (a.quarter || 0);
          vb = (b.year || 0) * 10 + (b.quarter || 0);
          return dir * (va - vb);
        default:
          return 0;
      }
    });
    return sorted;
  }

  function onSortColumn(column) {
    if (tableSortColumn === column) {
      tableSortDirection = tableSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      tableSortColumn = column;
      tableSortDirection = 'asc';
    }
    renderSurveysTable(getFilteredSurveys());
  }

  function renderSurveysTable(surveys) {
    const tbody = document.getElementById('surveysTableBody');
    if (surveys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:2rem;">No surveys match the selected filters</td></tr>';
      return;
    }

    // Sort surveys before rendering
    const sorted = sortSurveys(surveys);

    // Update header sort indicators
    document.querySelectorAll('.surveys-table th.sortable').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
      if (th.dataset.sort === tableSortColumn) {
        th.classList.add(tableSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    });

    tbody.innerHTML = sorted.map(s => {
      const maturity = s.data?.clientAILandscape?.maturity?.value || '-';
      const maturityLabel = MATURITY_LABELS[maturity] || maturity;
      const maturityClass = maturity !== '-' ? `maturity-${maturity}` : '';

      const isSelected = selectedAccounts.has(s.account_name);
      const rowStyle = isSelected ? 'background:#eef2ff;' : '';
      const escapedName = escapeHtml(s.account_name).replace(/'/g, "\\'");

      const accountType = s.account_type || 'other';
      const typeOptions = ACCOUNT_TYPES.map(t =>
        `<option value="${t.id}"${t.id === accountType ? ' selected' : ''}>${t.label}</option>`
      ).join('');

      const dmValue = escapeHtml(s.delivery_manager || '');

      // Compute WFM stage for this account (same logic as widget)
      let wfmCell = '-';
      const wfm = s.data?.workflowMaturity;
      if (wfm) {
        const roleStages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
        });
        if (roleStages.length > 0) {
          const avg = roleStages.reduce((a, b) => a + b, 0) / roleStages.length;
          const rounded = Math.round(avg);
          const label = WFM_LABELS[rounded] || `Stage ${rounded}`;
          wfmCell = `<span class="maturity-badge">${label} (${avg.toFixed(1)})</span>`;
        }
      }

      return `<tr style="${rowStyle}cursor:pointer;" onclick="window.location.href='account-detail.html?id=${s.id}'" title="Click to view ${escapeHtml(s.account_name)} details">
        <td style="text-align:center;width:40px;" onclick="event.stopPropagation();">
          <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleAccountSelection('${escapedName}')" title="Select ${escapeHtml(s.account_name)}">
        </td>
        <td><strong style="${isSelected ? 'color:#4f46e5;' : ''}">${escapeHtml(s.account_name)}</strong></td>
        <td onclick="event.stopPropagation();">
          <select class="account-type-select" onchange="updateAccountType(${s.id}, this.value)" title="Change account type">
            ${typeOptions}
          </select>
        </td>
        <td><span class="maturity-badge ${maturityClass}">${maturityLabel}</span></td>
        <td>${wfmCell}</td>
        <td onclick="event.stopPropagation();">
          <input type="text" class="dm-input" value="${dmValue}" placeholder="â€”"
            onchange="updateDeliveryManager(${s.id}, this.value.trim())"
            title="Edit delivery manager">
        </td>
        <td>Q${s.quarter} ${s.year}</td>
        <td class="actions" onclick="event.stopPropagation();">
          <button class="btn-icon" title="Download JSON" onclick="downloadSurvey(${s.id})">ğŸ“¥</button>
          <button class="btn-icon" title="Delete survey" onclick="deleteSurvey(${s.id}, '${escapedName}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join('');

    // Sync "select all" checkbox in table header
    const selectAllCb = document.getElementById('selectAllTableAccounts');
    if (selectAllCb) {
      const visibleNames = new Set(sorted.map(s => s.account_name));
      const allSelected = visibleNames.size > 0 && [...visibleNames].every(n => selectedAccounts.has(n));
      const someSelected = [...visibleNames].some(n => selectedAccounts.has(n));
      selectAllCb.checked = allSelected;
      selectAllCb.indeterminate = someSelected && !allSelected;
    }
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function downloadSurvey(id) {
    const result = db.exec('SELECT account_name, raw_json FROM surveys WHERE id = ?', [id]);
    if (result.length === 0) return;
    const name = result[0].values[0][0];
    const json = result[0].values[0][1];
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${name.replace(/[^a-zA-Z0-9_-]/g, '_')}_survey.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportAllSurveys() {
    const result = db.exec('SELECT account_name, exported_at, year, quarter, raw_json FROM surveys ORDER BY account_name, year, quarter');
    if (result.length === 0 || result[0].values.length === 0) {
      alert('No surveys to export.');
      return;
    }
    const surveys = result[0].values.map(row => ({
      account_name: row[0],
      exported_at: row[1],
      year: row[2],
      quarter: row[3],
      data: JSON.parse(row[4])
    }));
    const json = JSON.stringify(surveys, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-surveys-export-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function updateAccountType(id, newType) {
    db.run('UPDATE surveys SET account_type = ? WHERE id = ?', [newType, id]);
    await saveToIndexedDB();
    // No full refresh needed â€” the dropdown already shows the new value
  }

  async function updateDeliveryManager(id, newDM) {
    db.run('UPDATE surveys SET delivery_manager = ? WHERE id = ?', [newDM, id]);
    await saveToIndexedDB();
  }

  async function deleteSurvey(id, name) {
    if (!confirm(`Delete the survey for "${name}"? This cannot be undone.`)) return;
    db.run('DELETE FROM surveys WHERE id = ?', [id]);
    await saveToIndexedDB();
    populateFilters();
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATABASE EXPORT / IMPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function exportDatabase() {
    const data = db.export();
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-survey-dashboard-backup-${new Date().toISOString().slice(0, 10)}.sqlite`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function importDatabase(file) {
    try {
      const buffer = await file.arrayBuffer();
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
      });
      const newDb = new SQL.Database(new Uint8Array(buffer));
      // Verify it has the expected tables
      const tables = newDb.exec("SELECT name FROM sqlite_master WHERE type='table'");
      const tableNames = tables.length > 0 ? tables[0].values.map(r => r[0]) : [];
      if (!tableNames.includes('surveys')) {
        alert('Invalid backup file: missing "surveys" table.');
        newDb.close();
        return;
      }
      if (db) db.close();
      db = newDb;
      await saveToIndexedDB();
      populateFilters();
      refreshDashboard();
      alert('Database restored successfully!');
    } catch (e) {
      alert('Error restoring database: ' + e.message);
    }
  }

  async function clearDatabase() {
    const countResult = db.exec('SELECT COUNT(*) FROM surveys');
    const count = countResult.length > 0 ? countResult[0].values[0][0] : 0;
    if (count === 0) {
      alert('The database is already empty.');
      return;
    }
    if (!confirm(`This will permanently delete all ${count} survey${count !== 1 ? 's' : ''} from the database.\n\nThis action cannot be undone. Consider creating a backup first.\n\nAre you sure?`)) return;
    db.run('DELETE FROM surveys');
    await saveToIndexedDB();
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    populateFilters();
    refreshDashboard();
  }


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EVENT LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function setupEventListeners() {
    // Upload button
    document.getElementById('uploadBtn').addEventListener('click', openUploadModal);

    // Modal overlay close
    document.getElementById('uploadModal').addEventListener('click', e => {
      if (e.target === document.getElementById('uploadModal')) closeUploadModal();
    });
    document.getElementById('maturityInfoModal').addEventListener('click', e => {
      if (e.target === document.getElementById('maturityInfoModal')) closeMaturityInfoModal();
    });
    document.getElementById('stageDescriptionModal').addEventListener('click', e => {
      if (e.target === document.getElementById('stageDescriptionModal')) closeStageDescriptionModal();
    });
    document.getElementById('wfmInfoModal').addEventListener('click', e => {
      if (e.target === document.getElementById('wfmInfoModal')) closeWfmInfoModal();
    });
    document.getElementById('sdlcPhaseModal').addEventListener('click', e => {
      if (e.target === document.getElementById('sdlcPhaseModal')) closeSdlcPhaseModal();
    });

    // Escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeUploadModal();
        closeMaturityInfoModal();
        closeStageDescriptionModal();
        closeWfmInfoModal();
        closeSdlcPhaseModal();
      }
    });

    // Drop zone
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => {
      if (e.target.files.length > 0) handleFiles(e.target.files);
      e.target.value = '';
    });

    // Filters
    document.getElementById('filterYear').addEventListener('change', () => {
      activeMaturityFilter = null;
      selectedAccounts.clear();
      selectedDeliveryManagers.clear();
      refreshDashboard();
    });
    document.getElementById('filterQuarter').addEventListener('change', () => {
      activeMaturityFilter = null;
      selectedAccounts.clear();
      selectedDeliveryManagers.clear();
      refreshDashboard();
    });
    document.getElementById('aiUsageCompPeriod').addEventListener('change', () => {
      updateSummaryCards(getFilteredSurveys());
    });
    // Table column sorting
    document.querySelectorAll('.surveys-table th.sortable').forEach(th => {
      th.addEventListener('click', () => onSortColumn(th.dataset.sort));
    });
    // Close account type menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('accountTypeMenu');
      const container = document.getElementById('filterAccountType');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
      }
    });
    // Close engagement type menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('engagementTypeMenu');
      const container = document.getElementById('filterEngagementType');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
      }
    });

    // Close accounts menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('accountsMenu');
      const container = document.getElementById('filterAccounts');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
      }
    });
    // Close DM menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('dmMenu');
      const container = document.getElementById('filterDM');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
      }
    });

    // Actions dropdown toggle
    document.getElementById('actionsToggle').addEventListener('click', toggleActionsMenu);
    // Close actions menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('actionsMenu');
      const container = document.querySelector('.actions-wrapper');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.getElementById('actionsToggle')?.classList.remove('open');
      }
    });
    // Auto-close actions menu after any action item is clicked
    document.querySelectorAll('.actions-menu-item').forEach(item => {
      item.addEventListener('click', () => {
        document.getElementById('actionsMenu')?.classList.remove('open');
        document.getElementById('actionsToggle')?.classList.remove('open');
      });
    });

    // Database export/import/clear
    document.getElementById('exportDbBtn').addEventListener('click', exportDatabase);
    document.getElementById('exportSurveysBtn').addEventListener('click', exportAllSurveys);
    document.getElementById('importDbInput').addEventListener('change', e => {
      if (e.target.files.length > 0) importDatabase(e.target.files[0]);
      e.target.value = '';
    });
    document.getElementById('clearDbBtn').addEventListener('click', clearDatabase);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init() {
    try {
      await initDatabase();
      setupEventListeners();
      populateFilters();

      // Hide loading, show content
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      refreshDashboard();
    } catch (e) {
      document.getElementById('loadingState').innerHTML = `
        <div style="color:#ef4444;text-align:center;padding:2rem;">
          <div style="font-size:2rem;margin-bottom:1rem;">&#9888;&#65039;</div>
          <div style="font-weight:600;margin-bottom:0.5rem;">Failed to initialize database</div>
          <div style="font-size:0.85rem;color:#6b7280;">${e.message}</div>
        </div>`;
      console.error('Init error:', e);
    }
  }

  init();
</script>
</body>
</html>
