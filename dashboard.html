<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Adoption Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f3f4f6;
      color: #1f2937;
      min-height: 100vh;
    }

    /* ═══════════════════════════════════════════
       HEADER
       ═══════════════════════════════════════════ */
    .dashboard-header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1.25rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-back {
      font-size: 0.85rem;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
    }
    .header-back:hover { text-decoration: underline; }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .filter-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #6b7280;
    }
    .filter-select {
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1f2937;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .filter-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .header-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* ═══════════════════════════════════════════
       BUTTONS
       ═══════════════════════════════════════════ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }
    .btn-primary:hover { background: #4338ca; }
    .btn-secondary {
      background: #fff;
      color: #374151;
      border: 1.5px solid #e5e7eb;
    }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
    .btn-danger {
      background: none;
      color: #ef4444;
      border: none;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
    }
    .btn-danger:hover { background: #fef2f2; }
    .btn-icon {
      background: none;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      color: #6b7280;
      border-radius: 6px;
    }
    .btn-icon:hover { background: #f3f4f6; color: #1f2937; }

    /* ═══════════════════════════════════════════
       ACTIONS DROPDOWN
       ═══════════════════════════════════════════ */
    .actions-wrapper {
      position: relative;
      margin-left: auto;
    }
    .actions-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.15s;
    }
    .actions-toggle:hover { border-color: #d1d5db; color: #374151; }
    .actions-toggle:focus,
    .actions-toggle.open {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      color: #374151;
    }
    .actions-toggle .gear-icon { font-size: 1rem; }
    .actions-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 200;
      min-width: 200px;
      padding: 0.4rem 0;
    }
    .actions-menu.open { display: block; }
    .actions-menu-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.55rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #374151;
      background: none;
      border: none;
      cursor: pointer;
      transition: background 0.1s;
      text-align: left;
      white-space: nowrap;
    }
    .actions-menu-item:hover { background: #f3f4f6; }
    .actions-menu-item .item-icon {
      font-size: 1rem;
      width: 1.25rem;
      text-align: center;
      flex-shrink: 0;
    }
    .actions-menu-item.danger { color: #ef4444; }
    .actions-menu-item.danger:hover { background: #fef2f2; }
    .actions-menu-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 0.3rem 0;
    }

    /* ═══════════════════════════════════════════
       SDLC AI COVERAGE MAP
       ═══════════════════════════════════════════ */
    .sdlc-phase-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }
    .sdlc-phase-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.3rem;
    }
    .sdlc-phase-label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #1f2937;
    }
    .sdlc-phase-stats {
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .sdlc-phase-stats .doing { color: #16a34a; }
    .sdlc-phase-stats .need { color: #d97706; }
    .sdlc-phase-stats .separator { color: #9ca3af; margin: 0 0.2rem; }
    .sdlc-bar-track {
      display: flex;
      width: 100%;
      height: 28px;
      border-radius: 6px;
      overflow: hidden;
      background: #e5e7eb;
    }
    .sdlc-bar-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
      transition: width 0.4s ease;
      overflow: hidden;
      white-space: nowrap;
    }
    .sdlc-bar-doing { background: #22c55e; }
    .sdlc-bar-need { background: #f59e0b; }
    .sdlc-bar-notusing {
      background: #e5e7eb;
      color: #6b7280;
    }
    .sdlc-phase-block {
      margin-bottom: 1rem;
      cursor: pointer;
      padding: 0.5rem 0.6rem;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .sdlc-phase-block:hover {
      background: #f9fafb;
    }
    .sdlc-phase-block:last-child {
      margin-bottom: 0;
    }
    /* SDLC Phase Modal */
    .sdlc-modal-item {
      margin-bottom: 0.85rem;
    }
    .sdlc-modal-item:last-child {
      margin-bottom: 0;
    }
    .sdlc-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.25rem;
    }
    .sdlc-modal-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #1f2937;
    }
    .sdlc-modal-pcts {
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .sdlc-modal-pcts .doing { color: #16a34a; }
    .sdlc-modal-pcts .need { color: #d97706; }
    .sdlc-modal-pcts .not-using { color: #9ca3af; }
    .sdlc-modal-pcts .separator { color: #d1d5db; margin: 0 0.15rem; }
    .sdlc-modal-bar {
      display: flex;
      width: 100%;
      height: 22px;
      border-radius: 5px;
      overflow: hidden;
      background: #e5e7eb;
    }
    .sdlc-modal-bar .sdlc-bar-segment {
      height: 100%;
      font-size: 0.7rem;
    }
    .sdlc-legend {
      display: flex;
      gap: 1.5rem;
      margin-top: 1.25rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }
    .sdlc-legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }
    .sdlc-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .sdlc-key-insight {
      margin-top: 0.75rem;
      padding: 0.65rem 0.85rem;
      background: #eff6ff;
      border-radius: 8px;
      font-size: 0.82rem;
      color: #1e40af;
      line-height: 1.4;
    }
    .sdlc-key-insight strong {
      color: #1e3a8a;
    }

    /* ═══════════════════════════════════════════
       MAIN CONTENT
       ═══════════════════════════════════════════ */
    .dashboard-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem 2rem;
    }

    /* ═══════════════════════════════════════════
       WIDGET CARD
       ═══════════════════════════════════════════ */
    .widget-section {
      margin-bottom: 2rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.25rem;
    }
    .widget-section-title {
      font-size: 1.15rem;
      font-weight: 800;
      color: #1e3a5f;
      margin-bottom: 1rem;
      padding: 0.6rem 0.75rem;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .widget-section-title:hover {
      color: #4f46e5;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    }
    .section-chevron {
      font-size: 1.1rem;
      transition: transform 0.2s ease, background 0.2s ease;
      color: #4f46e5;
      background: rgba(79, 70, 229, 0.1);
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .widget-section-title:hover .section-chevron {
      background: rgba(79, 70, 229, 0.2);
    }
    .widget-section.collapsed .section-chevron {
      transform: rotate(-90deg);
    }
    .widget-section.collapsed .widget-section-content {
      display: none;
    }
    .widget-section.collapsed .widget-section-title {
      margin-bottom: 0;
    }
    .widget-section-summary {
      display: none;
      padding: 0.75rem 0;
      gap: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.85rem;
      color: #374151;
    }
    .widget-section.collapsed .widget-section-summary {
      display: flex;
    }
    .section-summary-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .section-summary-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .section-summary-value {
      font-weight: 700;
      color: #1e3a5f;
    }
    .section-summary-divider {
      width: 1px;
      height: 1.2rem;
      background: #e5e7eb;
    }
    .section-summary-challenges {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-summary-mini-bar {
      width: 120px;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #ef4444 0%, #f97316 16%, #eab308 33%, #eab308 50%, #4ade80 72%, #22c55e 100%);
      position: relative;
      margin-top: 0.3rem;
    }
    .section-summary-mini-marker {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #1f2937;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .section-summary-challenge-pill {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      color: #0369a1;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* AI Usage Banner (expanded view) */
    .ai-usage-banner {
      display: flex; align-items: center; gap: 1rem;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 12px; padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .ai-usage-banner-value {
      font-size: 2rem; font-weight: 800; color: #4f46e5;
      line-height: 1;
    }
    .ai-usage-banner-label {
      font-size: 0.85rem; font-weight: 600; color: #4338ca;
    }
    .ai-usage-banner-sub {
      font-size: 0.75rem; color: #6366f1; margin-top: 0.1rem;
    }

    /* AI Tool Adoption — unified widget cards */
    .ai-adoption-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    .ai-adoption-card-unified {
      padding: 1rem 1.25rem;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }
    .ai-adoption-card-unified:hover {
      border-color: #818cf8;
    }
    .ai-adoption-card-pct {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1;
    }
    .ai-adoption-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
      margin-top: 0.35rem;
    }
    .ai-adoption-card-detail {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }
    .ai-adoption-card-revenue {
      font-size: 1.1rem;
      font-weight: 700;
      margin-top: 0.5rem;
      line-height: 1.2;
    }
    .ai-adoption-card-revenue-label {
      font-size: 0.7rem;
      color: #94a3b8;
      margin-top: 0.1rem;
    }

    /* AI Usage highlight in collapsed summary */
    .section-summary-ai-usage {
      display: flex; align-items: center; gap: 0.4rem;
      background: #eef2ff; border: 1px solid #c7d2fe;
      border-radius: 8px; padding: 0.2rem 0.6rem;
    }
    .section-summary-ai-usage .section-summary-value {
      font-size: 0.95rem; font-weight: 800; color: #4f46e5;
    }

    .widget-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 1.75rem;
      margin-bottom: 1.5rem;
    }
    .widget-header {
      margin-bottom: 1.25rem;
      cursor: pointer;
      user-select: none;
    }
    .widget-header:hover .widget-title { color: #4f46e5; }
    .widget-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 0.15s ease;
    }
    .widget-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }
    /* Widget-level collapse/expand */
    .widget-chevron {
      font-size: 0.85rem;
      transition: transform 0.2s ease, background 0.2s ease;
      color: #4f46e5;
      background: rgba(79, 70, 229, 0.1);
      width: 22px; height: 22px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 5px;
      flex-shrink: 0;
      margin-left: auto;
    }
    .widget-header:hover .widget-chevron { background: rgba(79, 70, 229, 0.2); }
    .widget-card.widget-collapsed .widget-chevron { transform: rotate(-90deg); }
    .widget-card.widget-collapsed .widget-body { display: none; }
    .widget-card.widget-collapsed .widget-question { display: none; }
    .widget-card.widget-collapsed .widget-header { margin-bottom: 0; }
    .widget-summary {
      display: none;
      padding: 0.4rem 0 0;
      font-size: 0.82rem;
      color: #374151;
      gap: 0.4rem;
      align-items: center;
    }
    .widget-card.widget-collapsed .widget-summary { display: flex; }
    .widget-summary-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .widget-summary-value { font-weight: 700; color: #1e3a5f; }
    .widget-question {
      font-size: 0.9rem;
      color: #4b5563;
      font-style: italic;
      margin-top: 0.75rem;
      padding: 0.6rem 0.85rem;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 3px solid #4f46e5;
    }

    /* Stage Badge (inline with title) */
    .stage-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 8px;
      padding: 0.15rem 0.6rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: #312e81;
      white-space: nowrap;
    }

    /* AI Champion Coverage Widget */
    .champion-summary {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .champion-card {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .champion-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .champion-card.active {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    .champion-card-icon {
      font-size: 1.8rem;
      line-height: 1;
    }
    .champion-card-info {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .champion-card-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
    }
    .champion-card-value {
      font-size: 1.3rem;
      font-weight: 800;
    }
    .champion-card-count {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .champion-bar-container {
      margin: 0.75rem 0;
    }
    .champion-bar {
      height: 10px;
      border-radius: 5px;
      background: #e5e7eb;
      overflow: hidden;
      display: flex;
    }
    .champion-bar-yes {
      background: #22c55e;
      transition: width 0.5s ease;
    }
    .champion-bar-no {
      background: #e5e7eb;
      transition: width 0.5s ease;
    }
    .champion-bar-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.3rem;
    }
    .champion-accounts {
      display: flex;
      gap: 2rem;
      margin-top: 1rem;
      font-size: 0.8rem;
    }
    .champion-accounts-col {
      flex: 1;
      min-width: 0;
    }
    .champion-accounts-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.5rem;
    }
    .champion-account-item {
      padding: 0.3rem 0;
      color: #4b5563;
      border-bottom: 1px solid #f3f4f6;
    }
    .champion-account-item:last-child {
      border-bottom: none;
    }
    .champion-name {
      color: #6366f1;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .revenue-accounts-collapsible {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .revenue-accounts-collapsible.open {
      max-height: 600px;
    }
    .revenue-accounts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .revenue-accounts-title {
      font-weight: 700;
      font-size: 0.82rem;
      margin-bottom: 0.4rem;
    }
    .revenue-account-item {
      font-size: 0.8rem;
      padding: 0.25rem 0;
      color: #4b5563;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .revenue-account-item:last-child {
      border-bottom: none;
    }
    .revenue-account-amount {
      font-weight: 600;
      font-size: 0.75rem;
    }

    /* AI Adoption by Role Heatmap */
    .role-heatmap-wrapper {
      overflow-x: auto;
      margin-top: 0.5rem;
    }
    .role-heatmap {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }
    .role-heatmap thead th {
      background: #1e3a5f;
      color: #fff;
      padding: 0.5rem 0.4rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.75rem;
      border: 1px solid #2d4a6f;
      vertical-align: bottom;
      transition: background 0.15s;
    }
    .role-heatmap thead th:hover:not(.rh-role-header) {
      background: #264b73;
    }
    .role-heatmap thead th .rh-stage-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.68rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 3px;
      white-space: nowrap;
    }
    .role-heatmap thead th .rh-stage-name {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      opacity: 1;
      white-space: nowrap;
      margin-bottom: 2px;
    }
    .role-heatmap thead th .rh-stage-pct {
      display: block;
      font-size: 0.72rem;
      font-weight: 400;
      opacity: 0.8;
      white-space: nowrap;
    }
    .role-heatmap .rh-role-header {
      background: #1e3a5f;
      color: #fff;
      padding: 0.5rem 0.75rem;
      text-align: left;
      min-width: 120px;
      border: 1px solid #2d4a6f;
      vertical-align: middle;
    }
    .role-heatmap .rh-role-abbr {
      font-weight: 700;
      font-size: 0.88rem;
      display: block;
      line-height: 1.2;
    }
    .role-heatmap .rh-role-full {
      font-weight: 400;
      font-size: 0.66rem;
      opacity: 0.75;
      display: block;
      line-height: 1.3;
    }
    .role-heatmap tbody td {
      padding: 0.4rem 0.3rem;
      border: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
      min-width: 80px;
      transition: background 0.2s;
    }
    .role-heatmap tbody tr:hover td:not(.rh-role-header) {
      filter: brightness(0.95);
    }
    .rh-pct-circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.78rem;
      color: #374151;
      border: 2px solid rgba(0,0,0,0.08);
    }
    .rh-pct-zero {
      color: #b0b5be;
      font-weight: 500;
      border-color: transparent;
    }
    .role-heatmap tbody td.rh-clickable {
      cursor: pointer;
    }
    .role-heatmap tbody td.rh-clickable:hover {
      filter: brightness(0.88);
    }

    /* Cell accounts popup */
    .rh-cell-popup {
      display: none;
      position: fixed;
      z-index: 9999;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      padding: 0;
      min-width: 200px;
      max-width: 320px;
      max-height: 340px;
      overflow: hidden;
    }
    .rh-cell-popup.open { display: block; }
    .rh-cell-popup-header {
      background: #1e3a5f;
      color: #fff;
      padding: 0.5rem 0.75rem;
      font-size: 0.78rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .rh-cell-popup-close {
      background: none; border: none; color: #fff; font-size: 1.1rem;
      cursor: pointer; opacity: 0.7; line-height: 1;
    }
    .rh-cell-popup-close:hover { opacity: 1; }
    .rh-cell-popup-body {
      padding: 0.4rem 0;
      max-height: 260px;
      overflow-y: auto;
    }
    .rh-cell-popup-item {
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      color: #374151;
      border-bottom: 1px solid #f3f4f6;
    }
    .rh-cell-popup-item:last-child { border-bottom: none; }
    .rh-cell-popup-empty {
      padding: 0.75rem;
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      font-style: italic;
    }

    .champion-details-toggle {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      color: #6366f1;
      padding: 0.5rem 0;
      user-select: none;
    }
    .champion-details-toggle:hover {
      color: #4338ca;
    }
    .champion-details-toggle .chevron {
      font-size: 0.7rem;
      transition: transform 0.2s ease;
      display: inline-block;
    }
    .champion-details-toggle.expanded .chevron {
      transform: rotate(180deg);
    }
    .champion-accounts-collapsible {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .champion-accounts-collapsible.expanded {
      max-height: 600px;
    }

    /* Stage Pipeline */
    .stage-pipeline {
      display: flex;
      align-items: stretch;
      gap: 0;
      margin: 1.5rem 0 1rem;
    }
    .stage-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.85rem 0.75rem;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 0;
      text-align: center;
      position: relative;
      background: #fff;
    }
    .stage-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      z-index: 2;
    }
    .stage-card.active {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 2;
    }
    .stage-card-icon {
      font-size: 1.5rem;
      margin-bottom: 0.35rem;
    }
    .stage-card-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #374151;
      line-height: 1.2;
      margin-bottom: 0.25rem;
    }
    .stage-card-pct {
      font-size: 1.1rem;
      font-weight: 800;
      color: #1f2937;
    }
    .stage-card-count {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.1rem;
    }
    .stage-connector {
      display: flex;
      align-items: center;
      color: #d1d5db;
      font-size: 1.1rem;
      padding: 0 0.15rem;
      flex-shrink: 0;
    }

    /* Gradient Progress Bar */
    .progress-section {
      margin: 1rem 0 1.5rem;
      padding: 0;
    }
    .progress-gradient-bar {
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(to right, #ef4444 0%, #f97316 16%, #eab308 33%, #eab308 50%, #4ade80 72%, #22c55e 100%);
      position: relative;
      margin: 0.75rem 0 0.4rem;
      overflow: visible;
    }
    .progress-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      transition: left 0.5s ease;
      font-size: 1.1rem;
      line-height: 1;
      color: #1f2937;
    }
    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #9ca3af;
    }


    /* Limiting Factors Chart */
    .lf-chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }
    .ai-tools-chart-container {
      position: relative;
      width: 100%;
      height: 420px;
    }
    .cloud-platforms-chart-container {
      position: relative;
      width: 100%;
      height: 180px;
    }
    .landscape-chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .landscape-chart-row .widget-card {
      margin-bottom: 0;
    }
    .ai-challenges-chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }
    .ai-usage-chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }

    /* Widget Legend */
    .widget-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.25rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Widget Footer (filter controls) */
    .widget-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }
    .filter-active-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      border: 1px solid #c7d2fe;
    }
    .filter-clear-btn {
      background: none;
      border: 1px solid #d1d5db;
      color: #6b7280;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-clear-btn:hover {
      background: #f9fafb;
      color: #374151;
      border-color: #9ca3af;
    }
    .filter-clear-x {
      cursor: pointer;
      font-weight: 700;
      margin-left: 0.2rem;
      font-size: 0.9rem;
    }

    /* ═══════════════════════════════════════════
       CHARTS GRID (kept for future widgets)
       ═══════════════════════════════════════════ */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .chart-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
    }
    .chart-card-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    .chart-container {
      position: relative;
      width: 100%;
      min-height: 250px;
    }

    /* ═══════════════════════════════════════════
       SURVEYS TABLE
       ═══════════════════════════════════════════ */
    .surveys-section {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .surveys-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .surveys-section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
    }
    .surveys-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .surveys-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
      color: #6b7280;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .surveys-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 1.5rem;
    }
    .surveys-table th.sortable:hover { color: #374151; background: #f3f4f6; }
    .surveys-table th.sortable::after {
      content: ' ⇅';
      font-size: 0.7rem;
      opacity: 0.35;
      position: absolute;
      right: 0.4rem;
      top: 50%;
      transform: translateY(-50%);
    }
    .surveys-table th.sort-asc::after { content: ' ▲'; opacity: 0.8; color: #4f46e5; }
    .surveys-table th.sort-desc::after { content: ' ▼'; opacity: 0.8; color: #4f46e5; }
    .surveys-table th input[type="checkbox"],
    .surveys-table td input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: #4f46e5;
    }
    .surveys-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f3f4f6;
      color: #374151;
    }
    .surveys-table tbody tr:hover td {
      background: #eef2ff;
    }
    .surveys-table tbody tr {
      transition: background 0.15s;
    }
    .surveys-table .actions {
      display: flex;
      gap: 0.25rem;
    }
    .maturity-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    /* Account Type Badges */
    .account-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .account-type-enterprise { background: #dbeafe; color: #1d4ed8; }
    .account-type-key-account { background: #fef3c7; color: #92400e; }
    .account-type-enterprise-key { background: #d1fae5; color: #065f46; }
    .account-type-other { background: #f3f4f6; color: #6b7280; }

    /* Inline Account Type Select */
    .account-type-select {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .account-type-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .account-name-input {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid transparent;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #1e293b;
      background: transparent;
      outline: none;
      width: 100%;
      box-sizing: border-box;
    }
    .account-name-input:hover {
      border-color: #e5e7eb;
      background: #fff;
    }
    .account-name-input:focus {
      border-color: #4f46e5;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .dm-input {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      outline: none;
      width: 120px;
      box-sizing: border-box;
    }
    .dm-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    .dm-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .revenue-input {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.82rem;
      color: #1e293b;
      background: transparent;
      transition: border-color 0.15s, box-shadow 0.15s;
      width: 110px;
      box-sizing: border-box;
      text-align: right;
    }
    .revenue-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    .revenue-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .maturity-not-started { background: #f3f4f6; color: #6b7280; }
    .maturity-exploring { background: #dbeafe; color: #1d4ed8; }
    .maturity-piloting { background: #fef3c7; color: #92400e; }
    .maturity-scaling { background: #d1fae5; color: #065f46; }
    .maturity-optimizing { background: #ede9fe; color: #5b21b6; }
    .maturity-dont-know { background: #fef2f2; color: #f87171; }

    /* More info link */
    .more-info-link {
      font-size: 0.85rem;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .more-info-link:hover {
      text-decoration: underline;
      color: #4338ca;
    }

    /* ═══════════════════════════════════════════
       COMPARE GROUPS
       ═══════════════════════════════════════════ */
    .compare-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 0.6rem 1rem;
      background: linear-gradient(135deg, #eef2ff 0%, #ecfdf5 100%);
      border: 1px solid #c7d2fe;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #374151;
    }
    .compare-banner.active { display: flex; }
    .compare-banner .group-a-name { color: #6366f1; font-weight: 700; }
    .compare-banner .group-b-name { color: #10b981; font-weight: 700; }
    .compare-banner button {
      background: none; border: 1px solid #d1d5db; color: #6b7280;
      font-size: 0.78rem; font-weight: 600; padding: 0.25rem 0.7rem;
      border-radius: 16px; cursor: pointer;
    }
    .compare-banner button:hover { background: #f9fafb; color: #374151; border-color: #9ca3af; }

    .compare-modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 1100;
      justify-content: center; align-items: center;
    }
    .compare-modal-overlay.open { display: flex; }
    .compare-modal {
      background: #fff; border-radius: 16px; max-width: 960px; width: 95%;
      max-height: 88vh; overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15); padding: 1.5rem; position: relative;
    }
    .compare-modal h2 {
      font-size: 1.15rem; font-weight: 700; color: #1f2937;
      margin: 0 0 1rem; padding-right: 2rem;
    }
    .compare-modal-close {
      position: absolute; top: 0.75rem; right: 0.75rem;
      background: none; border: none; font-size: 1.4rem;
      cursor: pointer; color: #6b7280; padding: 0.2rem 0.4rem; border-radius: 6px;
    }
    .compare-modal-close:hover { background: #f3f4f6; color: #1f2937; }
    .compare-columns {
      display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;
    }
    .compare-group-col {
      border: 2px solid #e5e7eb; border-radius: 12px; padding: 1rem;
    }
    .compare-group-col.group-a { border-color: #c7d2fe; }
    .compare-group-col.group-b { border-color: #a7f3d0; }
    .compare-group-header {
      display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;
    }
    .compare-group-badge {
      display: inline-block; padding: 0.15rem 0.6rem; border-radius: 12px;
      font-size: 0.75rem; font-weight: 700; color: #fff;
    }
    .compare-group-badge.a { background: #6366f1; }
    .compare-group-badge.b { background: #10b981; }
    .compare-group-name-input {
      border: 1px solid #d1d5db; border-radius: 6px; padding: 0.3rem 0.5rem;
      font-size: 0.85rem; font-weight: 600; color: #374151; width: 140px;
    }
    .compare-group-name-input:focus { outline: none; border-color: #6366f1; }
    .compare-filter-section {
      margin-bottom: 0.75rem;
    }
    .compare-filter-label {
      font-size: 0.75rem; font-weight: 700; color: #6b7280;
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem;
    }
    .compare-filter-list {
      max-height: 130px; overflow-y: auto; border: 1px solid #e5e7eb;
      border-radius: 6px; padding: 0.3rem;
    }
    .compare-filter-list label {
      display: flex; align-items: center; gap: 0.35rem;
      font-size: 0.8rem; color: #374151; padding: 0.15rem 0.25rem;
      cursor: pointer; border-radius: 4px;
    }
    .compare-filter-list label:hover { background: #f9fafb; }
    .compare-filter-list input[type="checkbox"],
    .compare-filter-list input[type="radio"] { margin: 0; accent-color: #6366f1; }
    .compare-filter-actions {
      display: flex; gap: 0.5rem; margin-top: 0.4rem;
    }
    .compare-filter-actions button {
      font-size: 0.72rem; color: #6366f1; background: none; border: none;
      cursor: pointer; font-weight: 600; padding: 0;
    }
    .compare-filter-actions button:hover { text-decoration: underline; }
    .compare-modal-footer {
      display: flex; justify-content: flex-end; gap: 0.75rem;
      padding-top: 1rem; border-top: 1px solid #e5e7eb;
    }
    .compare-modal-footer button {
      padding: 0.45rem 1.2rem; border-radius: 8px; font-size: 0.85rem;
      font-weight: 600; cursor: pointer;
    }
    .compare-btn-cancel {
      background: none; border: 1px solid #d1d5db; color: #6b7280;
    }
    .compare-btn-cancel:hover { background: #f9fafb; }
    .compare-btn-start {
      background: #6366f1; border: none; color: #fff;
    }
    .compare-btn-start:hover { background: #4f46e5; }

    /* Comparison widget dual panels */
    .compare-widget-dual {
      display: flex; gap: 1rem;
    }
    .compare-panel {
      flex: 1; border-left: 3px solid #e5e7eb; padding-left: 0.75rem; min-width: 0;
    }
    .compare-panel.panel-a { border-color: #6366f1; }
    .compare-panel.panel-b { border-color: #10b981; }
    .compare-panel-label {
      font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; margin-bottom: 0.4rem;
    }
    .compare-panel-label.label-a { color: #6366f1; }
    .compare-panel-label.label-b { color: #10b981; }

    /* ═══════════════════════════════════════════
       MATURITY INFO MODAL
       ═══════════════════════════════════════════ */
    .info-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .info-modal-overlay.open {
      display: flex;
    }
    .info-modal {
      background: #fff;
      border-radius: 16px;
      max-width: 720px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .info-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .info-modal-close:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .info-modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .info-modal-stage {
      margin-bottom: 1.5rem;
    }
    .info-modal-stage:last-child {
      margin-bottom: 0;
    }
    .info-modal-stage h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #4f46e5;
      margin: 0 0 0.5rem;
    }
    .info-modal-stage p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }
    .info-modal-summary {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }
    .info-modal-summary h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 0.5rem;
    }
    .info-modal-summary p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }

    /* ═══════════════════════════════════════════
       ACCOUNT MATURITY COMPARISON MATRIX
       ═══════════════════════════════════════════ */
    .comparison-table-wrapper {
      overflow-x: auto;
    }
    .comparison-matrix {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .comparison-matrix thead th {
      background: #1e3a5f;
      color: #fff;
      padding: 0.6rem 0.5rem;
      text-align: center;
      font-weight: 700;
      font-size: 0.78rem;
      white-space: nowrap;
      border: 1px solid #2d4a6f;
    }
    .comparison-account-col {
      text-align: left !important;
      min-width: 180px;
    }
    .comparison-matrix tbody td {
      padding: 0.4rem 0.5rem;
      border: 1px solid #e5e7eb;
      vertical-align: middle;
    }
    .comparison-matrix tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .comparison-matrix tbody tr:hover {
      background: #eef2ff;
    }
    .comparison-matrix .account-name-cell {
      font-weight: 600;
      color: #1f2937;
      white-space: nowrap;
    }
    .comparison-matrix .stage-fill {
      height: 22px;
      border-radius: 3px;
    }
    .comparison-matrix .account-link-icon {
      color: #6b7280;
      font-size: 0.8rem;
      margin-left: 0.35rem;
      text-decoration: none;
    }
    .comparison-matrix .account-link-icon:hover {
      color: #4f46e5;
    }
    .comparison-matrix .stage-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.8);
      display: inline-block;
      vertical-align: middle;
      margin: 4px auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* ═══════════════════════════════════════════
       UPLOAD MODAL
       ═══════════════════════════════════════════ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .modal-close:hover { background: #f3f4f6; color: #1f2937; }
    .modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .drop-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafbfc;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: #4f46e5;
      background: #eef2ff;
    }
    .drop-zone-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .drop-zone-text { font-size: 0.95rem; color: #6b7280; }
    .drop-zone-hint { font-size: 0.8rem; color: #9ca3af; margin-top: 0.25rem; }
    .upload-results {
      margin-top: 1.25rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .upload-result-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.85rem;
    }
    .upload-result-item:last-child { border-bottom: none; }
    .upload-result-icon { flex-shrink: 0; }
    .upload-result-text { color: #374151; }
    .upload-result-error { color: #ef4444; }
    .upload-result-warning { color: #f59e0b; }
    .upload-result-success { color: #10b981; }

    /* ═══════════════════════════════════════════
       EMPTY STATE
       ═══════════════════════════════════════════ */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    .empty-state-text {
      font-size: 0.95rem;
      color: #6b7280;
      margin-bottom: 1.5rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ═══════════════════════════════════════════
       LOADING
       ═══════════════════════════════════════════ */
    .loading-overlay {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4rem;
      flex-direction: column;
      gap: 1rem;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #4f46e5;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: #6b7280; font-size: 0.9rem; }

    /* ═══════════════════════════════════════════
       MULTI-SELECT DROPDOWN
       ═══════════════════════════════════════════ */
    .multi-select {
      position: relative;
      display: inline-block;
    }
    .multi-select-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1f2937;
      background: #fff;
      cursor: pointer;
      outline: none;
      min-width: 120px;
    }
    .multi-select-btn:hover { border-color: #d1d5db; }
    .multi-select-btn:focus, .multi-select-btn.open {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .multi-select-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-select-arrow {
      font-size: 0.7rem;
      color: #6b7280;
      flex-shrink: 0;
    }
    .multi-select-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 200;
      min-width: 200px;
      padding: 0.4rem 0;
    }
    .multi-select-menu.open { display: block; }
    .multi-select-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.85rem;
      font-size: 0.85rem;
      color: #374151;
      cursor: pointer;
      transition: background 0.1s;
    }
    .multi-select-item:hover { background: #f3f4f6; }
    .multi-select-item input[type="checkbox"] {
      accent-color: #4f46e5;
      width: 15px;
      height: 15px;
      cursor: pointer;
    }
    .multi-select-actions {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0.85rem;
      border-top: 1px solid #f3f4f6;
      margin-top: 0.25rem;
    }
    .multi-select-actions button {
      background: none;
      border: none;
      color: #4f46e5;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.15rem 0;
    }
    .multi-select-actions button:hover { text-decoration: underline; }

    /* ═══════════════════════════════════════════
       WORKFLOW MATURITY JOURNEY
       ═══════════════════════════════════════════ */
    .wfm-section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #374151;
      margin: 1.25rem 0 1rem;
    }
    .wfm-journey {
      display: flex;
      align-items: stretch;
      gap: 0;
      position: relative;
      margin: 0.5rem 0 1rem;
    }
    .wfm-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 0.6rem;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 0;
      text-align: center;
      position: relative;
      background: #fff;
    }
    .wfm-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      z-index: 2;
    }
    .wfm-card.active {
      transform: translateY(-3px);
      z-index: 2;
    }
    .wfm-card-badge {
      font-size: 0.6rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-bottom: 0.25rem;
      letter-spacing: 0.03em;
    }
    .wfm-card-title {
      font-size: 0.72rem;
      font-weight: 700;
      color: #374151;
      line-height: 1.2;
      margin-bottom: 0.2rem;
    }
    .wfm-card-pct {
      font-size: 1.1rem;
      font-weight: 800;
    }
    .wfm-card-count {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.1rem;
      margin-bottom: 0.2rem;
    }
    .wfm-card-sub {
      font-size: 0.62rem;
      color: #9ca3af;
      line-height: 1.2;
    }
    .wfm-info-icon {
      cursor: pointer;
      font-size: 0.85rem;
      opacity: 0.7;
      transition: opacity 0.15s;
    }
    .wfm-info-icon:hover {
      opacity: 1;
    }
    .wfm-gradient-bar {
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(to right, #ef4444 0%, #f97316 20%, #eab308 40%, #eab308 55%, #4ade80 75%, #22c55e 100%);
      position: relative;
      margin: 0.75rem 0 0.4rem;
      overflow: visible;
    }

    /* ═══════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════ */
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
      .landscape-chart-row { grid-template-columns: 1fr; }
      .ai-adoption-cards { grid-template-columns: 1fr; }
      .dashboard-content { padding: 1rem; }
      .dashboard-header { padding: 1rem; }
      .header-top { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .header-controls { width: 100%; }
      .actions-wrapper { margin-left: 0; }
      .actions-menu { right: auto; left: 0; }
      .stage-pipeline { flex-wrap: wrap; gap: 0.5rem; }
      .stage-connector { display: none; }
      .stage-card { min-width: 80px; }
      .wfm-journey { flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
      .wfm-journey .stage-connector { display: none; }
      .wfm-card { min-width: 80px; }
    }
    @media (max-width: 600px) {
      .surveys-table { font-size: 0.8rem; }
      .surveys-table th, .surveys-table td { padding: 0.5rem; }
      .widget-card { padding: 1.25rem; }
      .stage-card { padding: 0.6rem 0.5rem; }
      .stage-card-icon { font-size: 1.2rem; }
      .wfm-card { padding: 0.6rem 0.5rem; }
    }

    /* ═══════════════════════════════════════════
       PRINT / PDF EXPORT STYLES
       ═══════════════════════════════════════════ */
    @media print {
      /* Hide interactive UI chrome */
      .dashboard-header .header-controls,
      .filter-bar,
      .actions-wrapper,
      .ai-chat-fab,
      .ai-chat-overlay,
      .ai-chat-panel,
      .widget-footer,
      .section-chevron,
      .widget-chevron,
      .widget-section-summary,
      .widget-summary,
      .more-info-link,
      .filter-active-tag,
      .filter-clear-btn,
      .surveys-table .actions,
      .info-modal-overlay,
      #comparisonBanner,
      #emptyState,
      #loadingState { display: none !important; }

      /* Expand all collapsed sections and widgets */
      .widget-section .widget-section-content { display: block !important; }
      .widget-section-title { cursor: default; pointer-events: none; }
      .widget-card .widget-body { display: block !important; }
      .widget-header { cursor: default; pointer-events: none; }

      /* Stack 2-column grid layouts for print */
      .landscape-chart-row { display: block !important; }
      .landscape-chart-row .widget-card { margin-bottom: 1rem; }

      /* Page layout */
      body, html { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .dashboard-content { max-width: 100%; padding: 0; }
      .dashboard-header { box-shadow: none; border-bottom: 2px solid #e5e7eb; padding: 0.75rem 1rem; }

      /* Widget cards */
      .widget-card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #e5e7eb;
        margin-bottom: 1rem;
        page-break-inside: avoid;
      }

      /* Section breaks */
      .widget-section { break-before: auto; margin-bottom: 0; }
      .widget-section + .widget-section { break-before: page; }

      /* Pipeline cards — keep colors */
      .stage-card, .wfm-card { cursor: default; }
      .stage-card:hover, .wfm-card:hover { transform: none !important; box-shadow: none !important; }
      .progress-gradient-bar, .wfm-gradient-bar { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      /* Chart images (inserted by exportDashboardPDF) */
      .print-chart-img { max-width: 100%; height: auto; break-inside: avoid; page-break-inside: avoid; }

      /* Table */
      .surveys-table { font-size: 9pt; }
      .surveys-table th, .surveys-table td { padding: 4px 8px; }
      .surveys-table tr { page-break-inside: avoid; }
      .surveys-table .row-dimmed { opacity: 1 !important; }

      /* Ensure text is readable */
      * { color-adjust: exact; }
      a { text-decoration: none !important; color: inherit !important; }
    }

    /* ═══════════════════════════════════════════
       AI CHAT PANEL
       ═══════════════════════════════════════════ */
    .ai-chat-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.3); z-index: 1050;
    }
    .ai-chat-overlay.open { display: block; }

    .ai-chat-panel {
      position: fixed; top: 0; right: 0; bottom: 0; width: 420px;
      background: #fff; box-shadow: -4px 0 24px rgba(0,0,0,0.12);
      z-index: 1100; display: flex; flex-direction: column;
      transform: translateX(100%); transition: transform 0.3s ease;
    }
    .ai-chat-panel.open { transform: translateX(0); }

    .ai-chat-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.75rem 1.25rem; border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    .ai-chat-panel-header .btn-icon {
      background: none; border: none; font-size: 1.1rem; cursor: pointer;
      color: #6b7280; padding: 0.25rem 0.4rem; border-radius: 6px;
    }
    .ai-chat-panel-header .btn-icon:hover { background: #f3f4f6; color: #1f2937; }

    .ai-chat-settings {
      display: none; padding: 0.75rem 1.25rem;
      background: #f9fafb; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;
    }
    .ai-chat-settings.open { display: block; }
    .ai-chat-settings label {
      display: block; font-size: 0.72rem; font-weight: 700; color: #6b7280;
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.15rem;
    }
    .ai-chat-settings select,
    .ai-chat-settings input[type="password"] {
      width: 100%; padding: 0.35rem 0.5rem; border: 1px solid #d1d5db;
      border-radius: 6px; font-size: 0.85rem; color: #374151;
      margin-bottom: 0.6rem; font-family: inherit;
    }
    .ai-chat-settings select:focus,
    .ai-chat-settings input:focus { outline: none; border-color: #6366f1; }

    .ai-chat-provider-bar {
      display: flex; align-items: center; gap: 0.4rem;
      padding: 0.4rem 1.25rem; border-bottom: 1px solid #f3f4f6;
      font-size: 0.75rem; color: #6b7280; flex-shrink: 0;
    }

    .ai-chat-messages {
      flex: 1; overflow-y: auto; padding: 1rem 1.25rem;
    }

    .ai-chat-welcome {
      text-align: center; padding: 1.5rem 0 1rem;
    }

    .ai-quick-chip {
      display: inline-block; border: 1px solid #e5e7eb; border-radius: 20px;
      padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer;
      background: #fff; color: #4f46e5; transition: all 0.15s;
      font-family: inherit; margin: 0.2rem;
    }
    .ai-quick-chip:hover { background: #eef2ff; border-color: #c7d2fe; }

    .ai-chat-message {
      margin-bottom: 0.75rem; max-width: 92%;
      font-size: 0.88rem; line-height: 1.6;
    }
    .ai-chat-message.user {
      margin-left: auto; background: #eef2ff; color: #1e1b4b;
      padding: 0.6rem 0.9rem; border-radius: 14px 14px 4px 14px;
    }
    .ai-chat-message.assistant {
      margin-right: auto; background: #fff; border: 1px solid #e5e7eb;
      padding: 0.6rem 0.9rem; border-radius: 14px 14px 14px 4px;
    }
    .ai-chat-message.error {
      margin-right: auto; background: #fef2f2; border: 1px solid #fecaca;
      padding: 0.6rem 0.9rem; border-radius: 14px 14px 14px 4px;
    }

    .ai-chat-message .markdown-content p { margin: 0.3rem 0; }
    .ai-chat-message .markdown-content strong { font-weight: 700; }
    .ai-chat-message .markdown-content ul,
    .ai-chat-message .markdown-content ol { margin: 0.3rem 0; padding-left: 1.25rem; }
    .ai-chat-message .markdown-content li { margin-bottom: 0.15rem; }
    .ai-chat-message .markdown-content code {
      background: #f3f4f6; padding: 0.1rem 0.3rem; border-radius: 4px;
      font-size: 0.84em; font-family: 'SF Mono', 'Consolas', monospace;
    }
    .ai-chat-message .markdown-content h3 {
      font-size: 0.95rem; font-weight: 700; margin: 0.75rem 0 0.25rem; color: #1f2937;
    }
    .ai-chat-message .markdown-content h4 {
      font-size: 0.9rem; font-weight: 700; margin: 0.6rem 0 0.2rem; color: #374151;
    }

    .ai-chat-loading {
      display: flex; gap: 5px; padding: 0.75rem 1rem; align-items: center;
    }
    .ai-dot {
      width: 8px; height: 8px; background: #9ca3af; border-radius: 50%;
      animation: aiDotPulse 1.4s ease-in-out infinite;
    }
    .ai-dot:nth-child(2) { animation-delay: 0.2s; }
    .ai-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes aiDotPulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    .ai-chat-input-area {
      padding: 0.75rem 1.25rem; border-top: 1px solid #e5e7eb;
      background: #fff; flex-shrink: 0;
    }
    .ai-chat-input-area textarea {
      flex: 1; resize: none; border: 1.5px solid #e5e7eb; border-radius: 10px;
      padding: 0.55rem 0.75rem; font-size: 0.88rem; font-family: inherit;
      min-height: 42px; max-height: 120px; width: 100%; box-sizing: border-box;
      color: #1f2937;
    }
    .ai-chat-input-area textarea:focus { outline: none; border-color: #6366f1; }
    .ai-chat-input-area textarea::placeholder { color: #9ca3af; }
    .ai-chat-send-btn {
      background: #4f46e5; color: #fff; border: none; border-radius: 10px;
      padding: 0.5rem 0.75rem; cursor: pointer; font-size: 1rem;
      flex-shrink: 0; transition: background 0.15s;
    }
    .ai-chat-send-btn:hover { background: #4338ca; }
    .ai-chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .ai-save-keys-btn {
      width: 100%; padding: 0.4rem; border-radius: 8px; font-size: 0.82rem;
      font-weight: 600; cursor: pointer; background: #4f46e5; color: #fff;
      border: none; font-family: inherit;
    }
    .ai-save-keys-btn:hover { background: #4338ca; }

    /* Claude.ai CTA Button */
    .ai-claude-cta-btn {
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      width: 100%; padding: 0.75rem 1rem; border-radius: 10px;
      font-size: 0.92rem; font-weight: 700; cursor: pointer;
      background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff;
      border: none; font-family: inherit; transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    .ai-claude-cta-btn:hover {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.45);
      transform: translateY(-1px);
    }
    .ai-claude-cta-btn:active { transform: translateY(0); }

    /* API Toggle Link */
    .ai-api-toggle-link {
      display: block; text-align: center; font-size: 0.78rem; color: #6b7280;
      cursor: pointer; margin-top: 0.75rem; padding: 0.25rem;
      border: none; background: none; font-family: inherit;
      text-decoration: underline; text-decoration-color: transparent;
      transition: all 0.15s;
    }
    .ai-api-toggle-link:hover { color: #4f46e5; text-decoration-color: #4f46e5; }

    /* Toast Notification */
    .ai-toast {
      position: fixed; bottom: 5rem; right: 2rem;
      background: #1f2937; color: #fff;
      padding: 0.75rem 1.25rem; border-radius: 10px;
      font-size: 0.85rem; font-weight: 500;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 1200; opacity: 0; transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none; max-width: 340px;
    }
    .ai-toast.show { opacity: 1; transform: translateY(0); }

    /* Welcome Divider */
    .ai-welcome-divider {
      display: flex; align-items: center; gap: 0.75rem;
      margin: 1rem 0; font-size: 0.75rem; color: #9ca3af;
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .ai-welcome-divider::before,
    .ai-welcome-divider::after {
      content: ''; flex: 1; height: 1px; background: #e5e7eb;
    }

    /* API Section (collapsible) */
    .ai-api-section { display: none; text-align: center; padding-top: 0.5rem; }
    .ai-api-section.open { display: block; }

    /* Claude Instructions Panel */
    .ai-claude-instructions {
      background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 10px;
      padding: 0.75rem 1rem; margin-top: 0.75rem;
      font-size: 0.82rem; color: #3730a3; line-height: 1.6;
    }
    .ai-claude-instructions strong { font-weight: 700; }
    .ai-claude-instructions ol { margin: 0.4rem 0 0; padding-left: 1.25rem; }
    .ai-claude-instructions li { margin-bottom: 0.25rem; }

    /* AI Floating Action Button */
    .ai-fab {
      position: fixed; bottom: 2rem; right: 2rem;
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: #fff; border: none; font-size: 1.5rem;
      cursor: pointer; box-shadow: 0 4px 16px rgba(99,102,241,0.4);
      z-index: 1040; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
    }
    .ai-fab:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 24px rgba(99,102,241,0.5);
    }
    .ai-fab.hidden { display: none; }

    @media (max-width: 900px) {
      .ai-chat-panel { width: 100%; }
      .ai-fab { bottom: 1rem; right: 1rem; width: 48px; height: 48px; font-size: 1.3rem; }
    }

  </style>
</head>
<body>

  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-top">
      <div class="header-title">AI Adoption Dashboard</div>
      <a href="index.html" class="header-back">Back to Survey Tool</a>
    </div>
    <div class="header-controls">
      <div class="filter-group">
        <span class="filter-label">Year:</span>
        <select class="filter-select" id="filterYear"></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Quarter:</span>
        <select class="filter-select" id="filterQuarter">
          <option value="all">All</option>
          <option value="1">Q1</option>
          <option value="2">Q2</option>
          <option value="3">Q3</option>
          <option value="4">Q4</option>
        </select>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Type:</span>
        <div class="multi-select" id="filterAccountType">
          <button class="multi-select-btn" onclick="toggleAccountTypeMenu()" type="button">
            <span class="multi-select-text" id="accountTypeLabel">All Types</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="accountTypeMenu">
            <label class="multi-select-item">
              <input type="checkbox" value="enterprise" checked onchange="onAccountTypeChange()"> Enterprise
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="key-account" checked onchange="onAccountTypeChange()"> Key Account
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="enterprise-key" checked onchange="onAccountTypeChange()"> Enterprise + Key
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="other" checked onchange="onAccountTypeChange()"> Other
            </label>
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllAccountTypes()">Select All</button>
              <button type="button" onclick="clearAccountTypes()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Engagement:</span>
        <div class="multi-select" id="filterEngagementType">
          <button class="multi-select-btn" onclick="toggleEngagementTypeMenu()" type="button">
            <span class="multi-select-text" id="engagementTypeLabel">All Types</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="engagementTypeMenu">
            <label class="multi-select-item">
              <input type="checkbox" value="staff" checked onchange="onEngagementTypeChange()"> Staff Augmentation
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="project" checked onchange="onEngagementTypeChange()"> Project Ownership
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="program" checked onchange="onEngagementTypeChange()"> Program Ownership
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="outcome" checked onchange="onEngagementTypeChange()"> Business Outcome
            </label>
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllEngagementTypes()">Select All</button>
              <button type="button" onclick="clearEngagementTypes()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Accounts:</span>
        <div class="multi-select" id="filterAccounts">
          <button class="multi-select-btn" onclick="toggleAccountsMenu()" type="button">
            <span class="multi-select-text" id="accountsLabel">All Accounts</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="accountsMenu" style="max-height:300px;overflow-y:auto;">
            <!-- Dynamically populated by populateAccountsFilter() -->
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllAccountsFromMenu()">Select All</button>
              <button type="button" onclick="clearAllAccountsFromMenu()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">DM:</span>
        <div class="multi-select" id="filterDM">
          <button class="multi-select-btn" onclick="toggleDMMenu()" type="button">
            <span class="multi-select-text" id="dmLabel">All DMs</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="dmMenu" style="max-height:300px;overflow-y:auto;">
            <!-- Dynamically populated by populateDMFilter() -->
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllDMsFromMenu()">Select All</button>
              <button type="button" onclick="clearAllDMsFromMenu()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Cloud:</span>
        <div class="multi-select" id="filterCloudPlatforms">
          <button class="multi-select-btn" onclick="toggleCloudPlatformsMenu()" type="button">
            <span class="multi-select-text" id="cloudPlatformsLabel">All Platforms</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="cloudPlatformsMenu">
            <label class="multi-select-item">
              <input type="checkbox" value="aws" checked onchange="onCloudPlatformChange()"> AWS
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="gcp" checked onchange="onCloudPlatformChange()"> GCP
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="azure" checked onchange="onCloudPlatformChange()"> Azure
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="onprem" checked onchange="onCloudPlatformChange()"> On-Premises
            </label>
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllCloudPlatforms()">Select All</button>
              <button type="button" onclick="clearAllCloudPlatformsCb()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <span class="filter-label">AI Adoption:</span>
        <select class="filter-select" id="filterAiAdoption" onchange="onAiAdoptionFilterChange()">
          <option value="all">All</option>
          <option value="using">Using AI Tools</option>
          <option value="not-using">Not Using AI Tools</option>
        </select>
      </div>
      <button class="filter-clear-btn" onclick="clearAllFilters()" title="Clear all interactive filters" style="margin-left:0.5rem;">✕ Clear Filters</button>
      <button class="filter-clear-btn" onclick="openCompareModal()" title="Compare two groups of accounts" style="margin-left:0.5rem;">⚖ Compare</button>

      <!-- Actions dropdown -->
      <div class="actions-wrapper">
        <button class="actions-toggle" id="actionsToggle" type="button" title="Data & upload actions">
          <span class="gear-icon">&#9881;</span> Actions <span style="font-size:0.7rem;color:#9ca3af;">&#9662;</span>
        </button>
        <div class="actions-menu" id="actionsMenu">
          <button class="actions-menu-item" id="uploadBtn" type="button">
            <span class="item-icon">&#128228;</span> Upload Survey
          </button>
          <button class="actions-menu-item" id="exportSurveysBtn" type="button">
            <span class="item-icon">&#128196;</span> Export Surveys
          </button>
          <button class="actions-menu-item" id="exportPdfBtn" type="button">
            <span class="item-icon">&#128248;</span> Export as PDF
          </button>
          <div class="actions-menu-divider"></div>
          <button class="actions-menu-item" id="exportDbBtn" type="button">
            <span class="item-icon">&#128190;</span> Backup Database
          </button>
          <label class="actions-menu-item" style="cursor:pointer;">
            <span class="item-icon">&#128259;</span> Restore Database
            <input type="file" id="importDbInput" accept=".sqlite,.db" style="display:none;">
          </label>
          <div class="actions-menu-divider"></div>
          <button class="actions-menu-item danger" id="clearDbBtn" type="button">
            <span class="item-icon">&#128465;</span> Clear Database
          </button>
        </div>
      </div>
    </div>
    <div class="header-subtitle" id="headerSubtitle">Loading...</div>
  </header>

  <!-- AI Floating Action Button -->
  <button class="ai-fab" id="aiFab" onclick="toggleAiChatPanel()" title="AI Insights">💬</button>

  <!-- AI Chat Panel Overlay -->
  <div class="ai-chat-overlay" id="aiChatOverlay" onclick="closeAiChatPanel()"></div>

  <!-- AI Chat Panel -->
  <div class="ai-chat-panel" id="aiChatPanel">
    <!-- Panel Header -->
    <div class="ai-chat-panel-header">
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <span style="font-size:1.1rem;">💬</span>
        <span style="font-weight:700;font-size:1rem;color:#1f2937;">AI Insights</span>
      </div>
      <div style="display:flex;align-items:center;gap:0.3rem;">
        <button class="btn-icon" onclick="toggleAiChatSettings()" title="API key settings (for in-panel chat)">⚙</button>
        <button class="btn-icon" onclick="clearAiChat()" title="Clear chat history">🗑</button>
        <button class="btn-icon" onclick="closeAiChatPanel()" title="Close panel" style="font-size:1.3rem;">&times;</button>
      </div>
    </div>

    <!-- Settings (collapsible) -->
    <div class="ai-chat-settings" id="aiChatSettings">
      <label>Provider</label>
      <select id="aiProvider" onchange="onAiProviderChange()">
        <option value="openai">OpenAI</option>
        <option value="anthropic">Anthropic</option>
      </select>
      <label>Model</label>
      <select id="aiModel" onchange="onAiModelChange()"></select>
      <label>OpenAI API Key</label>
      <input type="password" id="openaiApiKey" placeholder="sk-...">
      <label>Anthropic API Key</label>
      <input type="password" id="anthropicApiKey" placeholder="sk-ant-...">
      <button class="ai-save-keys-btn" onclick="saveAiKeys()">Save Keys</button>
      <div id="aiKeyStatus" style="font-size:0.75rem;color:#6b7280;margin-top:0.4rem;text-align:center;"></div>
    </div>

    <!-- Provider/Model bar (always visible) -->
    <div class="ai-chat-provider-bar">
      <span id="aiProviderLabel">OpenAI</span>
      <span style="color:#d1d5db;">/</span>
      <span id="aiModelLabel">GPT-4o</span>
      <span style="margin-left:auto;" id="aiKeyIndicator">🔒 No key</span>
    </div>

    <!-- Messages -->
    <div class="ai-chat-messages" id="aiChatMessages">
      <div id="aiQuickPrompts">
        <div class="ai-chat-welcome">
          <div style="font-size:1.5rem;margin-bottom:0.5rem;">💬</div>
          <div style="font-weight:600;color:#1f2937;margin-bottom:0.25rem;">Ask about your data</div>
          <div style="font-size:0.85rem;color:#6b7280;margin-bottom:1rem;">Get AI-powered insights from your filtered survey data.</div>
        </div>

        <!-- Primary CTA: Copy data context -->
        <div style="padding:0 0.5rem;">
          <button class="ai-claude-cta-btn" onclick="copyDataContext()">
            <span>📋</span> Copy Data Context
          </button>
          <div style="font-size:0.75rem;color:#6b7280;margin-top:0.5rem;text-align:center;line-height:1.5;">
            Paste into any AI assistant:
            <strong style="color:#374151;">Claude</strong>,
            <strong style="color:#374151;">ChatGPT</strong>,
            <strong style="color:#374151;">Gemini</strong>,
            <strong style="color:#374151;">Copilot</strong>, or others
          </div>
          <div style="display:flex;align-items:flex-start;gap:0.4rem;margin-top:0.6rem;font-size:0.75rem;color:#92400e;line-height:1.5;">
            <span style="flex-shrink:0;">⚠️</span>
            <span>The copied context includes <strong>account names</strong> and survey details. Be mindful of where you paste it — avoid sharing on public or unauthorized platforms.</span>
          </div>
          <div id="aiCopyInstructions" class="ai-claude-instructions" style="display:none;">
            <strong>Context copied to clipboard!</strong>
            <ol>
              <li>Open your preferred AI assistant (Claude, ChatGPT, Gemini, etc.)</li>
              <li>Paste (Ctrl+V) the context as your first message</li>
              <li>Then ask any question about your survey data</li>
            </ol>
          </div>
        </div>

        <!-- Divider -->
        <div class="ai-welcome-divider">or</div>

        <!-- Secondary: API-based in-panel chat -->
        <div style="text-align:center;">
          <button class="ai-api-toggle-link" onclick="toggleApiSection()">Advanced: Use API Key for in-panel chat</button>
          <div id="aiApiSection" class="ai-api-section">
            <div style="font-size:0.8rem;color:#6b7280;margin-bottom:0.75rem;">Chat directly in this panel using your own API key.</div>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">Summarize the current AI adoption landscape</button>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">Which accounts need the most attention?</button>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">What are the key barriers to AI adoption?</button>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">Compare adoption stages across account types</button>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">Recommend next steps for scaling AI</button>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">Which roles have the lowest AI workflow maturity?</button>
            <button class="ai-quick-chip" onclick="sendQuickPrompt(this)">What SDLC phases have the most AI coverage gaps?</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="ai-chat-input-area">
      <div style="display:flex;gap:0.5rem;align-items:flex-end;">
        <textarea id="aiChatInput" rows="1" placeholder="Ask about your survey data..."
                  onkeydown="handleAiChatKeydown(event)"
                  oninput="autoResizeAiInput(this)"></textarea>
        <button class="ai-chat-send-btn" id="aiChatSendBtn" onclick="sendAiMessage()" title="Send message">▶</button>
      </div>
    </div>
  </div>

  <!-- AI Toast Notification -->
  <div class="ai-toast" id="aiToast"></div>

  <!-- Loading State -->
  <div id="loadingState" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing database...</div>
  </div>

  <!-- Main Content (hidden until loaded) -->
  <div id="mainContent" class="dashboard-content" style="display:none;">

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">📊</div>
      <div class="empty-state-title">No surveys uploaded yet</div>
      <div class="empty-state-text">Upload survey JSON or ZIP files to see aggregated analytics across all your AI adoption assessments.</div>
      <button class="btn btn-primary" onclick="openUploadModal()">Upload Your First Survey</button>
    </div>

    <!-- Dashboard Content (hidden when empty) -->
    <div id="dashboardContent" style="display:none;">

      <!-- Comparison Banner -->
      <div id="comparisonBanner" class="compare-banner">
        <span>⚖ Comparing: <span class="group-a-name" id="compareNameA">Group A</span> vs <span class="group-b-name" id="compareNameB">Group B</span></span>
        <button onclick="openCompareModal()">✎ Edit Groups</button>
        <button onclick="exitComparison()">✕ Exit Comparison</button>
      </div>

      <!-- Section: Client AI Landscape -->
      <div class="widget-section collapsed">
        <div class="widget-section-title" onclick="toggleSection(this)">
          <span>Client AI Landscape</span>
          <span class="section-chevron">&#9662;</span>
        </div>
        <div class="widget-section-summary" id="sectionSummaryLandscape">
          <!-- Populated by JS -->
        </div>
        <div class="widget-section-content">

      <!-- Widget: Clients AI Adoption Stage -->
      <div class="widget-card" id="adoptionStageWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">Clients AI Adoption Stage <span class="stage-badge" id="stageCalloutValue" onclick="event.stopPropagation();openStageDescriptionModal()" style="cursor:pointer;" title="Click for stage description">--</span> <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">Portfolio-wide adoption maturity</div>
          <div class="widget-summary" id="adoptionStageSummary"></div>
          <div class="widget-question">At what stage are clients in their AI adoption journey? <a href="#" class="more-info-link" onclick="event.stopPropagation();event.preventDefault();openMaturityInfoModal();">More info</a></div>
        </div>
        <div class="widget-body">

        <!-- Stage Pipeline -->
        <div class="stage-pipeline" id="stagePipeline">
          <!-- Populated by JS -->
        </div>

        <!-- Gradient Progress Bar -->
        <div class="progress-section">
          <div class="progress-gradient-bar">
            <div class="progress-marker" id="progressMarker" style="left:50%;">&#9650;</div>
          </div>
          <div class="progress-labels">
            <span>Less Mature</span>
            <span>More Mature</span>
          </div>
        </div>

        <!-- Legend -->
        <div class="widget-legend" id="widgetLegend">
          <!-- Populated by JS -->
        </div>

        <!-- Filter Footer (shown when any filter active) -->
        <div class="widget-footer" id="widgetFooter" style="display:none;">
          <div id="activeFilterTags" style="display:flex;gap:0.5rem;flex-wrap:wrap;"></div>
          <button class="filter-clear-btn" onclick="clearAllFilters()">Clear All Filters</button>
        </div>
        </div>
      </div>

      <!-- 2-column row: AI Usage (left) + AI Challenges (right) -->
      <div class="landscape-chart-row">
        <!-- Widget: AI Usage -->
        <div class="widget-card" id="aiUsageWidget">
          <div class="widget-header" onclick="toggleWidget(this)">
            <div class="widget-title">Current AI Usage <span class="widget-chevron">&#9662;</span></div>
            <div class="widget-subtitle">How clients are currently using AI</div>
            <div class="widget-summary" id="aiUsageSummary"></div>
            <div class="widget-question">How is the client currently using AI? <a href="#" class="more-info-link" onclick="event.stopPropagation();event.preventDefault();openAiUsageInfoModal();">More info</a></div>
          </div>
          <div class="widget-body">
          <div class="ai-usage-chart-container">
            <canvas id="chartAiUsage"></canvas>
          </div>
          <div class="widget-legend" id="aiUsageLegend"></div>
          </div>
        </div>

        <!-- Widget: AI Challenges -->
        <div class="widget-card" id="aiChallengesWidget">
          <div class="widget-header" onclick="toggleWidget(this)">
            <div class="widget-title">AI Challenges <span class="widget-chevron">&#9662;</span></div>
            <div class="widget-subtitle">Top challenges clients face in AI adoption</div>
            <div class="widget-summary" id="aiChallengesSummary"></div>
            <div class="widget-question">What are the biggest AI challenges reported by clients?</div>
          </div>
          <div class="widget-body">
          <div class="ai-challenges-chart-container">
            <canvas id="chartAiChallenges"></canvas>
          </div>
          <div class="widget-legend" id="aiChallengesLegend"></div>
          </div>
        </div>
      </div>

        </div> <!-- end widget-section-content -->
      </div> <!-- end Client AI Landscape section -->

      <!-- Section: Account AI Landscape -->
      <div class="widget-section collapsed">
        <div class="widget-section-title" onclick="toggleSection(this)">
          <span>Account AI Landscape</span>
          <span class="section-chevron">&#9662;</span>
        </div>
        <div class="widget-section-summary" id="sectionSummaryAccount">
          <!-- Populated by JS -->
        </div>
        <div class="widget-section-content">

      <!-- Unified AI Tool Adoption Widget -->
      <div class="widget-card" id="aiAdoptionWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">AI Tool Adoption <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">Account AI tool adoption with associated service revenue</div>
          <div class="widget-summary" id="aiAdoptionSummary"></div>
        </div>
        <div class="widget-body">
        <div id="aiAdoptionContent"><!-- Populated by JS --></div>
        </div>
      </div>

      <!-- Widget: Account AI Agentic Workflow -->
      <div class="widget-card" id="workflowMaturityWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">Account AI Agentic Workflow <span class="stage-badge" id="wfmAvgValue" onclick="event.stopPropagation();openWfmStageDescriptionModal()" style="cursor:pointer;" title="Click for stage description">--</span> <a href="#" class="more-info-link" onclick="event.stopPropagation();event.preventDefault();openAccountComparisonModal();" style="font-size:0.8rem;margin-left:0.5rem;">See accounts comparison</a> <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">Account distribution across AI workflow maturity stages</div>
          <div class="widget-summary" id="workflowMaturitySummary"></div>
        </div>
        <div class="widget-body">

        <div class="wfm-section-title">Maturity Journey Distribution</div>

        <!-- Journey visualization -->
        <div class="wfm-journey" id="wfmJourney">
          <!-- Populated by JS -->
        </div>

        <!-- Gradient bar -->
        <div class="progress-section" id="wfmProgressSection" style="margin-left:0;">
          <div class="wfm-gradient-bar">
            <div class="progress-marker" id="wfmProgressMarker" style="left:50%;">&#9650;</div>
          </div>
          <div class="progress-labels">
            <span>← Starting Point</span>
            <span>Maturity Goal →</span>
          </div>
        </div>
        </div>
      </div>

      <!-- Widget: AI Adoption by Role -->
      <div class="widget-card" id="aiAdoptionByRoleWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">AI Adoption by Role <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">Distribution of workflow maturity stages across roles</div>
          <div class="widget-summary" id="aiAdoptionByRoleSummary"></div>
        </div>
        <div class="widget-body">
        <div class="role-heatmap-wrapper">
          <div id="aiAdoptionByRoleContent"><!-- Populated by JS --></div>
        </div>
        </div>
      </div>

      <!-- Widget: AI Tools by Role -->
      <div class="widget-card" id="roleToolMatrixWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">AI Tools by Role <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">AI Tools utilization per roles that are working with AI</div>
          <div class="widget-summary" id="roleToolMatrixSummary"></div>
          <div class="widget-question">Who uses which AI tools?</div>
        </div>
        <div class="widget-body">
        <div class="role-heatmap-wrapper">
          <div id="roleToolMatrixContent"><!-- Populated by JS --></div>
        </div>
        </div>
      </div>

      <!-- Widget: SDLC AI Coverage Map -->
      <div class="widget-card" id="sdlcCoverageWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">SDLC AI Coverage Map <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">AI adoption across software delivery lifecycle phases</div>
          <div class="widget-summary" id="sdlcCoverageSummary"></div>
          <div class="widget-question">Click on each phase to see detailed use case breakdown</div>
        </div>
        <div class="widget-body">
        <div id="sdlcCoverageContent">
          <!-- Populated by JS -->
        </div>
        <div class="sdlc-legend">
          <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#22c55e;"></span> Doing</span>
          <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#f59e0b;"></span> Need but not Doing</span>
          <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#e5e7eb;"></span> Not Using</span>
        </div>
        <div class="sdlc-key-insight" id="sdlcKeyInsight"></div>
        </div>
      </div>

      <!-- Widget: Limiting Factors -->
      <div class="widget-card" id="limitingFactorsWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">Limiting Factors <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">What holds teams back from adopting AI</div>
          <div class="widget-summary" id="limitingFactorsSummary"></div>
          <div class="widget-question">Which factors are most frequently limiting AI adoption across the portfolio?</div>
        </div>
        <div class="widget-body">
        <div class="lf-chart-container">
          <canvas id="chartLimitingFactors"></canvas>
        </div>
        <div class="widget-legend" id="lfLegend"></div>
        </div>
      </div>

      <!-- 2-column row: AI Tools Usage (left) + Cloud Platforms (right) -->
      <div class="landscape-chart-row">
        <!-- Widget: AI Tools Usage -->
        <div class="widget-card" id="aiToolsWidget">
          <div class="widget-header" onclick="toggleWidget(this)">
            <div class="widget-title">AI Tools Usage <span class="widget-chevron">&#9662;</span></div>
            <div class="widget-subtitle">Which AI tools are teams using across the portfolio</div>
            <div class="widget-summary" id="aiToolsSummary"></div>
            <div class="widget-question">What AI tools are being used by delivery teams?</div>
          </div>
          <div class="widget-body">
          <div class="ai-tools-chart-container">
            <canvas id="chartAiTools"></canvas>
          </div>
          <div class="widget-legend" id="aiToolsLegend"></div>
          </div>
        </div>

        <!-- Widget: Cloud Platforms -->
        <div class="widget-card" id="cloudPlatformsWidget">
          <div class="widget-header" onclick="toggleWidget(this)">
            <div class="widget-title">Cloud Platforms <span class="widget-chevron">&#9662;</span></div>
            <div class="widget-subtitle">Cloud infrastructure used across the portfolio</div>
            <div class="widget-summary" id="cloudPlatformsSummary"></div>
          </div>
          <div class="widget-body">
          <div class="cloud-platforms-chart-container">
            <canvas id="chartCloudPlatforms"></canvas>
          </div>
          <div class="widget-legend" id="cloudPlatformsLegend"></div>
          </div>
        </div>
      </div>

      <!-- Subsection: Capability & Enablement Readiness -->
      <div class="wfm-section-title" style="margin-top:1.5rem;">Capability &amp; Enablement Readiness</div>

      <!-- Widget: AI Champion Coverage -->
      <div class="widget-card" id="aiChampionWidget">
        <div class="widget-header" onclick="toggleWidget(this)">
          <div class="widget-title">AI Champion Coverage <span class="widget-chevron">&#9662;</span></div>
          <div class="widget-subtitle">Accounts with a designated AI adoption champion</div>
          <div class="widget-summary" id="aiChampionSummary"></div>
        </div>
        <div class="widget-body">
        <div id="aiChampionContent">
          <!-- Populated by JS -->
        </div>
        </div>
      </div>

        </div> <!-- end widget-section-content -->
      </div> <!-- end Account AI Landscape section -->

      <!-- Section: Surveys -->
      <div class="widget-section collapsed">
        <div class="widget-section-title" onclick="toggleSection(this)">
          <span>Surveys</span>
          <span class="section-chevron">&#9662;</span>
        </div>
        <div class="widget-section-summary" id="sectionSummarySurveys">
          <!-- Populated by JS -->
        </div>
        <div class="widget-section-content">

      <div class="surveys-section">
        <table class="surveys-table">
          <thead>
            <tr>
              <th style="width:40px;text-align:center;padding:0.5rem;">
                <input type="checkbox" id="selectAllTableAccounts" title="Select all / Clear all" onchange="onSelectAllAccountsToggle(this.checked)">
              </th>
              <th class="sortable sort-asc" data-sort="account">Account</th>
              <th class="sortable" data-sort="type">Type</th>
              <th class="sortable" data-sort="maturity">Client AI Maturity</th>
              <th class="sortable" data-sort="wfm">Account AI Agentic Workflow</th>
              <th class="sortable" data-sort="dm">Delivery Manager</th>
              <th class="sortable" data-sort="revenue">Forecasted Revenue</th>
              <th class="sortable" data-sort="quarter">Quarter</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="surveysTableBody"></tbody>
        </table>
      </div>

        </div> <!-- end widget-section-content -->
      </div> <!-- end Surveys section -->
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal">
      <button class="modal-close" onclick="closeUploadModal()" title="Close">&times;</button>
      <h2>Upload Survey Files</h2>
      <div style="display:flex;gap:1rem;margin-bottom:1.25rem;align-items:end;flex-wrap:wrap;">
        <div style="flex:1;min-width:120px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Year</label>
          <select class="filter-select" id="uploadYear" style="width:100%;"></select>
        </div>
        <div style="flex:1;min-width:120px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Quarter</label>
          <select class="filter-select" id="uploadQuarter" style="width:100%;">
            <option value="1">Q1 (Jan-Mar)</option>
            <option value="2">Q2 (Apr-Jun)</option>
            <option value="3">Q3 (Jul-Sep)</option>
            <option value="4">Q4 (Oct-Dec)</option>
          </select>
        </div>
        <div style="flex:1;min-width:150px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Account Type</label>
          <select class="filter-select" id="uploadAccountType" style="width:100%;">
            <option value="enterprise">Enterprise</option>
            <option value="key-account">Key Account</option>
            <option value="enterprise-key">Enterprise + Key Account</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Delivery Manager</label>
          <input type="text" class="filter-select" id="uploadDeliveryManager" placeholder="e.g. John Smith" style="width:100%;box-sizing:border-box;">
        </div>
      </div>
      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">📁</div>
        <div class="drop-zone-text">Drag & drop JSON or ZIP files here</div>
        <div class="drop-zone-hint">or click to browse</div>
        <input type="file" id="fileInput" accept=".json,.zip" multiple style="display:none;">
      </div>
      <div class="upload-results" id="uploadResults"></div>
    </div>
  </div>

  <!-- Maturity Info Modal -->
  <div class="info-modal-overlay" id="maturityInfoModal">
    <div class="info-modal">
      <button class="info-modal-close" onclick="closeMaturityInfoModal()" title="Close">&times;</button>
      <h2>AI Adoption Journey — Stage Descriptions</h2>

      <div class="info-modal-stage">
        <h3>🚫 Not Started — "AI is not on the agenda"</h3>
        <p>At this stage, AI is essentially absent from the account's strategy. There are no initiatives, no owners, and no clear awareness of where AI could add value. If AI is mentioned, it's usually abstract or perceived as something for "big tech companies," not something actionable for them. Decisions are driven by existing processes and tools, and there is often uncertainty or skepticism around AI's relevance, cost, or risk.</p>
      </div>

      <div class="info-modal-stage">
        <h3>🔍 Exploring — "We are trying to understand AI"</h3>
        <p>Here the account has curiosity, but not commitment. AI is being researched, discussed, or experimented with informally — maybe through demos, workshops, vendor conversations, or isolated experiments by motivated individuals. There is no production usage, no clear ROI expectations, and no governance. Learning is the goal, not outcomes. This stage is about sense-making, not delivery.</p>
      </div>

      <div class="info-modal-stage">
        <h3>🧪 Piloting — "We are testing if AI actually works for us"</h3>
        <p>This is a key inflection point. The account is running concrete POCs tied to real problems (often in limited scopes like SDLC, support, or analytics). There is some budget, some sponsorship, and early success criteria — but AI is still treated as an experiment. Results are evaluated cautiously, risks are contained, and decisions about scaling are pending. AI exists, but it's not yet trusted or systemic.</p>
      </div>

      <div class="info-modal-stage">
        <h3>📈 Scaling — "AI is becoming part of how we operate"</h3>
        <p>Now AI has proven value. Successful pilots are expanded across teams, functions, or products. Investment increases, governance starts to matter, and repeatability becomes important. The account begins to standardize tools, define ownership, train people, and integrate AI into workflows. The focus shifts from "does this work?" to "how do we roll this out safely and consistently?"</p>
      </div>

      <div class="info-modal-stage">
        <h3>⚡ Optimizing — "AI is embedded and continuously improved"</h3>
        <p>At this stage, AI is no longer a project — it's infrastructure. AI is embedded into core processes and products, measured with KPIs, and continuously refined. The account actively optimizes models, workflows, and cost/value tradeoffs. People are trained by default, governance is mature, and AI decisions are part of normal business planning. The question is no longer whether to use AI, but how to do it better.</p>
      </div>

      <div class="info-modal-summary">
        <h3>The big difference across stages</h3>
        <p>Early stages are about learning and reducing uncertainty. Middle stages are about proving value and managing risk. Later stages are about institutionalizing and optimizing impact.</p>
      </div>
    </div>
  </div>

  <!-- Stage Description Modal (single stage) -->
  <div class="info-modal-overlay" id="stageDescriptionModal">
    <div class="info-modal" style="max-width:560px;">
      <button class="info-modal-close" onclick="closeStageDescriptionModal()" title="Close">&times;</button>
      <div id="stageDescriptionContent"></div>
    </div>
  </div>

  <div class="info-modal-overlay" id="aiUsageInfoModal">
    <div class="info-modal" style="max-width:660px;">
      <button class="info-modal-close" onclick="closeAiUsageInfoModal()" title="Close">&times;</button>
      <h2 style="margin-top:0;">Current AI Usage — Categories &amp; Examples</h2>
      <p style="color:#6b7280;font-size:0.9rem;margin-bottom:1.5rem;">This widget captures how the client is currently leveraging AI across their organization. Multiple categories can apply to the same account.</p>
      <div id="aiUsageInfoContent"></div>
    </div>
  </div>

  <div class="info-modal-overlay" id="wfmInfoModal">
    <div class="info-modal" style="max-width:620px;">
      <button class="info-modal-close" onclick="closeWfmInfoModal()" title="Close">&times;</button>
      <h2>How is Portfolio Average Maturity Calculated?</h2>
      <div class="info-modal-stage">
        <h3>Step 1 — Per-Account Stage</h3>
        <p>For each account (survey), we look at the workflow maturity stage assigned to each role (PM, BA, Architects, Software Engineers, QA, QA Automation, Data Engineers, DevOps, UI/UX). Roles with no stage assigned are excluded. The remaining stages (0–5) are averaged and rounded to the nearest integer to produce a single account-level stage.</p>
      </div>
      <div class="info-modal-stage">
        <h3>Step 2 — Portfolio Average</h3>
        <p>The portfolio average is the arithmetic mean of all account-level stages. It is displayed with one decimal point on a 0–5 scale, where 0 = No AI Usage and 5 = Semi-Agentic AI.</p>
      </div>
      <div class="info-modal-summary">
        <h3>Stage Reference</h3>
        <p><strong>Stage 0</strong> — No AI Usage · <strong>Stage 1</strong> — Individual AI · <strong>Stage 2</strong> — Team Practices · <strong>Stage 3</strong> — AI-Chained · <strong>Stage 4</strong> — Event-Triggered · <strong>Stage 5</strong> — Semi-Agentic</p>
      </div>
    </div>
  </div>

  <!-- Account Maturity Comparison Modal -->
  <div class="info-modal-overlay" id="accountComparisonModal">
    <div class="info-modal" style="max-width:1100px;">
      <button class="info-modal-close" onclick="closeAccountComparisonModal()" title="Close">&times;</button>
      <h2>Account Maturity Comparison</h2>
      <div class="comparison-table-wrapper">
        <table class="comparison-matrix">
          <thead>
            <tr>
              <th class="comparison-account-col">Account</th>
              <th>No AI</th>
              <th>Individual</th>
              <th>Team</th>
              <th>AI-Chained</th>
              <th>Event-Triggered</th>
              <th>Semi-Agentic</th>
            </tr>
          </thead>
          <tbody id="comparisonMatrixBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: SDLC Phase Use Case Breakdown -->
  <div class="info-modal-overlay" id="sdlcPhaseModal">
    <div class="info-modal" style="max-width:700px;">
      <button class="info-modal-close" onclick="closeSdlcPhaseModal()" title="Close">&times;</button>
      <h2 id="sdlcPhaseModalTitle"></h2>
      <div id="sdlcPhaseModalContent"></div>
    </div>
  </div>

  <!-- Compare Groups Modal -->
  <div class="compare-modal-overlay" id="compareModal">
    <div class="compare-modal">
      <button class="compare-modal-close" onclick="closeCompareModal()" title="Close">&times;</button>
      <h2>⚖ Compare Two Groups</h2>
      <p style="font-size:0.85rem;color:#6b7280;margin:-0.5rem 0 1rem;">Define two groups of accounts using filters, then compare them across all dashboard widgets.</p>

      <div class="compare-columns">
        <!-- Group A -->
        <div class="compare-group-col group-a">
          <div class="compare-group-header">
            <span class="compare-group-badge a">A</span>
            <input type="text" class="compare-group-name-input" id="compareGroupAName" value="Group A" placeholder="Group name">
            <div style="margin-left:auto;">
              <button style="font-size:0.7rem;color:#6366f1;background:none;border:none;cursor:pointer;font-weight:600;" onclick="copyCurrentFiltersToGroup('A')" title="Copy current dashboard filters">📋 Copy Current</button>
              <button style="font-size:0.7rem;color:#ef4444;background:none;border:none;cursor:pointer;font-weight:600;margin-left:0.3rem;" onclick="clearCompareGroupFilters('A')">✕ Clear</button>
            </div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Accounts</div>
            <div class="compare-filter-list" id="compareAccountsA"></div>
            <div class="compare-filter-actions">
              <button onclick="compareSelectAll('compareAccountsA')">Select All</button>
              <button onclick="compareClearAll('compareAccountsA')">Clear All</button>
            </div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Delivery Manager</div>
            <div class="compare-filter-list" id="compareDMsA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Adoption Stage</div>
            <div class="compare-filter-list" id="compareMaturityA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">WFM Stage</div>
            <div class="compare-filter-list" id="compareWfmA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">AI Champion</div>
            <div class="compare-filter-list" id="compareChampionA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">AI Tool Adoption</div>
            <div class="compare-filter-list" id="compareAiAdoptionA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Account Type</div>
            <div class="compare-filter-list" id="compareAccountTypeA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Engagement Type</div>
            <div class="compare-filter-list" id="compareEngagementA"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Cloud Platforms</div>
            <div class="compare-filter-list" id="compareCloudA"></div>
          </div>
        </div>

        <!-- Group B -->
        <div class="compare-group-col group-b">
          <div class="compare-group-header">
            <span class="compare-group-badge b">B</span>
            <input type="text" class="compare-group-name-input" id="compareGroupBName" value="Group B" placeholder="Group name">
            <div style="margin-left:auto;">
              <button style="font-size:0.7rem;color:#10b981;background:none;border:none;cursor:pointer;font-weight:600;" onclick="copyCurrentFiltersToGroup('B')" title="Copy current dashboard filters">📋 Copy Current</button>
              <button style="font-size:0.7rem;color:#ef4444;background:none;border:none;cursor:pointer;font-weight:600;margin-left:0.3rem;" onclick="clearCompareGroupFilters('B')">✕ Clear</button>
            </div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Accounts</div>
            <div class="compare-filter-list" id="compareAccountsB"></div>
            <div class="compare-filter-actions">
              <button onclick="compareSelectAll('compareAccountsB')">Select All</button>
              <button onclick="compareClearAll('compareAccountsB')">Clear All</button>
            </div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Delivery Manager</div>
            <div class="compare-filter-list" id="compareDMsB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Adoption Stage</div>
            <div class="compare-filter-list" id="compareMaturityB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">WFM Stage</div>
            <div class="compare-filter-list" id="compareWfmB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">AI Champion</div>
            <div class="compare-filter-list" id="compareChampionB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">AI Tool Adoption</div>
            <div class="compare-filter-list" id="compareAiAdoptionB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Account Type</div>
            <div class="compare-filter-list" id="compareAccountTypeB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Engagement Type</div>
            <div class="compare-filter-list" id="compareEngagementB"></div>
          </div>
          <div class="compare-filter-section">
            <div class="compare-filter-label">Cloud Platforms</div>
            <div class="compare-filter-list" id="compareCloudB"></div>
          </div>
        </div>
      </div>

      <div class="compare-modal-footer">
        <button class="compare-btn-cancel" onclick="closeCompareModal()">Cancel</button>
        <button class="compare-btn-start" onclick="startComparison()">⚖ Compare Groups</button>
      </div>
    </div>
  </div>

<script>
  // ═══════════════════════════════════════════
  // SCHEMA DEFINITIONS (mirrors index.html)
  // ═══════════════════════════════════════════

  const SCHEMA_SEED = [
    // Engagement — Ownership
    { section: 'engagement', subsection: 'ownership', option_id: 'staff', option_label: 'Staff Augmentation', option_type: 'multi-select', display_order: 1 },
    { section: 'engagement', subsection: 'ownership', option_id: 'project', option_label: 'Project Ownership', option_type: 'multi-select', display_order: 2 },
    { section: 'engagement', subsection: 'ownership', option_id: 'program', option_label: 'Program Ownership', option_type: 'multi-select', display_order: 3 },
    { section: 'engagement', subsection: 'ownership', option_id: 'outcome', option_label: 'Business Outcome', option_type: 'multi-select', display_order: 4 },

    // Engagement — Payment
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'us', option_label: 'We Are/Will', option_type: 'single-select', display_order: 1 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'customer', option_label: 'Customer Is/Will', option_type: 'single-select', display_order: 2 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'mix', option_label: 'It Is a Mix', option_type: 'single-select', display_order: 3 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'tbd', option_label: 'To Be Determined', option_type: 'single-select', display_order: 4 },

    // Engagement — Compliance
    { section: 'engagement', subsection: 'compliance', option_id: 'hipaa', option_label: 'HIPAA', option_type: 'multi-select', display_order: 1 },
    { section: 'engagement', subsection: 'compliance', option_id: 'gdpr', option_label: 'GDPR', option_type: 'multi-select', display_order: 2 },
    { section: 'engagement', subsection: 'compliance', option_id: 'sox', option_label: 'SOX', option_type: 'multi-select', display_order: 3 },
    { section: 'engagement', subsection: 'compliance', option_id: 'pci-dss', option_label: 'PCI-DSS', option_type: 'multi-select', display_order: 4 },
    { section: 'engagement', subsection: 'compliance', option_id: 'fedramp', option_label: 'FedRAMP', option_type: 'multi-select', display_order: 5 },
    { section: 'engagement', subsection: 'compliance', option_id: 'soc2', option_label: 'SOC 2', option_type: 'multi-select', display_order: 6 },
    { section: 'engagement', subsection: 'compliance', option_id: 'ccpa', option_label: 'CCPA', option_type: 'multi-select', display_order: 7 },
    { section: 'engagement', subsection: 'compliance', option_id: 'iso27001', option_label: 'ISO 27001', option_type: 'multi-select', display_order: 8 },

    // Account AI Landscape — Maturity
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'not-started', option_label: 'Not Started', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'exploring', option_label: 'Exploring', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'piloting', option_label: 'Piloting', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'scaling', option_label: 'Scaling', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'optimizing', option_label: 'Optimizing', option_type: 'single-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 6 },

    // Account AI Landscape — Usage
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'multi-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'not-using', option_label: 'Not Using AI', option_type: 'multi-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'off-the-shelf', option_label: 'Off-the-Shelf Tools', option_type: 'multi-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'business-apps', option_label: 'AI in Business Apps', option_type: 'multi-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'custom-solutions', option_label: 'Custom AI Solutions', option_type: 'multi-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'business-processes', option_label: 'Process Automation', option_type: 'multi-select', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'customer-facing', option_label: 'Customer-Facing AI', option_type: 'multi-select', display_order: 7 },

    // Account AI Landscape — Priority
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'not-priority', option_label: 'Not a Priority', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'low', option_label: 'Low Priority', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'medium', option_label: 'Medium Priority', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'high', option_label: 'High Priority', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 5 },

    // Account AI Landscape — Governance
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'none', option_label: 'No Governance', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'informal', option_label: 'Informal', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'developing', option_label: 'Developing', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'established', option_label: 'Established', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 5 },

    // Account AI Landscape — Challenges
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'unclear-roi', option_label: 'Unclear ROI', option_type: 'ranked', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'skills', option_label: 'Skills Gap', option_type: 'ranked', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'data', option_label: 'Data Issues', option_type: 'ranked', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'security', option_label: 'Security/Compliance', option_type: 'ranked', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'budget', option_label: 'Budget/Buy-in', option_type: 'ranked', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'infrastructure', option_label: 'Infrastructure', option_type: 'ranked', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'ranked', display_order: 7 },

    // Account AI Landscape — Approved Tools
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'github-copilot', option_label: 'GitHub Copilot', option_type: 'multi-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'chatgpt', option_label: 'ChatGPT / OpenAI', option_type: 'multi-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'claude', option_label: 'Claude / Anthropic', option_type: 'multi-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'gemini', option_label: 'Gemini / Google', option_type: 'multi-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'cursor', option_label: 'Cursor', option_type: 'multi-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'amazon-q-kiro', option_label: 'Amazon Q / Kiro', option_type: 'multi-select', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'ms-copilot', option_label: 'Microsoft Copilot', option_type: 'multi-select', display_order: 7 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'atlassian-rovo', option_label: 'Atlassian Rovo', option_type: 'multi-select', display_order: 8 },

    // Team Roles
    { section: 'teamRoles', subsection: 'roles', option_id: 'pm', option_label: 'Project Managers / Scrum Masters', option_type: 'multi-select', display_order: 1 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'ba', option_label: 'Business Analysts / Product Managers', option_type: 'multi-select', display_order: 2 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'arch', option_label: 'Solutions Architects', option_type: 'multi-select', display_order: 3 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'swe', option_label: 'Software Engineers', option_type: 'multi-select', display_order: 4 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'qa', option_label: 'Manual QA', option_type: 'multi-select', display_order: 5 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'qaa', option_label: 'QA Automation Engineers', option_type: 'multi-select', display_order: 6 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'data', option_label: 'Data Engineers / Scientists', option_type: 'multi-select', display_order: 7 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'devops', option_label: 'DevOps Engineers', option_type: 'multi-select', display_order: 8 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'ux', option_label: 'UI/UX Designers', option_type: 'multi-select', display_order: 9 },

    // Tools — AI
    { section: 'tools', subsection: 'ai', option_id: 'copilot', option_label: 'GitHub Copilot', option_type: 'multi-select', display_order: 1 },
    { section: 'tools', subsection: 'ai', option_id: 'chatgpt', option_label: 'ChatGPT / OpenAI', option_type: 'multi-select', display_order: 2 },
    { section: 'tools', subsection: 'ai', option_id: 'claude', option_label: 'Claude (Anthropic)', option_type: 'multi-select', display_order: 3 },
    { section: 'tools', subsection: 'ai', option_id: 'claudecode', option_label: 'Claude Code', option_type: 'multi-select', display_order: 4 },
    { section: 'tools', subsection: 'ai', option_id: 'cursor', option_label: 'Cursor', option_type: 'multi-select', display_order: 5 },
    { section: 'tools', subsection: 'ai', option_id: 'windsurf', option_label: 'Windsurf', option_type: 'multi-select', display_order: 6 },
    { section: 'tools', subsection: 'ai', option_id: 'gemini', option_label: 'Gemini (Google)', option_type: 'multi-select', display_order: 7 },
    { section: 'tools', subsection: 'ai', option_id: 'amazonq', option_label: 'Amazon Q / Kiro', option_type: 'multi-select', display_order: 8 },
    { section: 'tools', subsection: 'ai', option_id: 'mscopilot', option_label: 'Microsoft Copilot', option_type: 'multi-select', display_order: 9 },
    { section: 'tools', subsection: 'ai', option_id: 'intellij', option_label: 'IntelliJ AI', option_type: 'multi-select', display_order: 10 },
    { section: 'tools', subsection: 'ai', option_id: 'rovo', option_label: 'Atlassian Rovo', option_type: 'multi-select', display_order: 11 },
    { section: 'tools', subsection: 'ai', option_id: 'v0', option_label: 'v0 (Vercel)', option_type: 'multi-select', display_order: 12 },
    { section: 'tools', subsection: 'ai', option_id: 'bolt', option_label: 'Bolt.new', option_type: 'multi-select', display_order: 13 },
    { section: 'tools', subsection: 'ai', option_id: 'lovable', option_label: 'Lovable', option_type: 'multi-select', display_order: 14 },
    { section: 'tools', subsection: 'ai', option_id: 'perplexity', option_label: 'Perplexity', option_type: 'multi-select', display_order: 15 },

    // Tools — Cloud
    { section: 'tools', subsection: 'cloud', option_id: 'aws', option_label: 'Amazon Web Services (AWS)', option_type: 'multi-select', display_order: 1 },
    { section: 'tools', subsection: 'cloud', option_id: 'gcp', option_label: 'Google Cloud Platform (GCP)', option_type: 'multi-select', display_order: 2 },
    { section: 'tools', subsection: 'cloud', option_id: 'azure', option_label: 'Microsoft Azure', option_type: 'multi-select', display_order: 3 },
    { section: 'tools', subsection: 'cloud', option_id: 'onprem', option_label: 'On-Premises', option_type: 'multi-select', display_order: 4 },

    // Use Cases — Code Development
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-completion', option_label: 'Code completion and suggestions', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-generation', option_label: 'Generate code from natural language', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-refactoring', option_label: 'Code refactoring and optimization', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-review', option_label: 'Automated code review assistance', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'debugging', option_label: 'Debugging and error resolution', option_type: 'tri-state', display_order: 5 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-explanation', option_label: 'Code explanation and documentation', option_type: 'tri-state', display_order: 6 },

    // Use Cases — Documentation
    { section: 'useCases', subsection: 'documentation', option_id: 'api-docs', option_label: 'API documentation generation', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'documentation', option_id: 'readme-generation', option_label: 'README and setup guides', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'documentation', option_id: 'technical-specs', option_label: 'Technical specification writing', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'documentation', option_id: 'inline-comments', option_label: 'Code comments and docstrings', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'documentation', option_id: 'release-notes', option_label: 'Release notes generation', option_type: 'tri-state', display_order: 5 },

    // Use Cases — Requirements
    { section: 'useCases', subsection: 'requirements', option_id: 'user-stories', option_label: 'User story creation and refinement', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'requirements', option_id: 'requirements-analysis', option_label: 'Requirements gap analysis', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'requirements', option_id: 'acceptance-criteria', option_label: 'Acceptance criteria generation', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'requirements', option_id: 'impact-analysis', option_label: 'Impact analysis for changes', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'requirements', option_id: 'backlog-refinement', option_label: 'Backlog grooming assistance', option_type: 'tri-state', display_order: 5 },

    // Use Cases — Project Management
    { section: 'useCases', subsection: 'pm', option_id: 'meeting-summaries', option_label: 'Meeting summaries and action items', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'pm', option_id: 'status-reports', option_label: 'Status report generation', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'pm', option_id: 'risk-identification', option_label: 'Risk identification and mitigation', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'pm', option_id: 'estimation', option_label: 'Effort estimation assistance', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'pm', option_id: 'stakeholder-comms', option_label: 'Stakeholder communication drafts', option_type: 'tri-state', display_order: 5 },

    // Use Cases — Design & UX
    { section: 'useCases', subsection: 'design-ux', option_id: 'design-feedback', option_label: 'Design critique and feedback', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'copy-writing', option_label: 'UI copy and microcopy writing', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'accessibility', option_label: 'Accessibility recommendations', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'user-research', option_label: 'User research analysis', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'persona-creation', option_label: 'Persona and journey mapping', option_type: 'tri-state', display_order: 5 },

    // Use Cases — Data & Analytics
    { section: 'useCases', subsection: 'data-analytics', option_id: 'sql-generation', option_label: 'SQL query generation', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-transformation', option_label: 'Data transformation scripts', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-analysis', option_label: 'Data analysis and insights', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'pipeline-development', option_label: 'Data pipeline development', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-quality', option_label: 'Data quality checks', option_type: 'tri-state', display_order: 5 },

    // Workflow Maturity Stages
    { section: 'workflowMaturity', subsection: 'stages', option_id: '0', option_label: 'Stage 0 - No AI Usage', option_type: 'stage', display_order: 0 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '1', option_label: 'Stage 1 - Individual AI Usage', option_type: 'stage', display_order: 1 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '2', option_label: 'Stage 2 - Team AI Practices', option_type: 'stage', display_order: 2 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '3', option_label: 'Stage 3 - AI-Chained Tasks', option_type: 'stage', display_order: 3 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '4', option_label: 'Stage 4 - Event-Triggered AI', option_type: 'stage', display_order: 4 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '5', option_label: 'Stage 5 - Semi-Agentic AI', option_type: 'stage', display_order: 5 },

    // Limiting Factors
    { section: 'limitingFactors', subsection: 'factors', option_id: 'time', option_label: 'Lack of time / competing priorities', option_type: 'ranked', display_order: 1 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'knowledge', option_label: 'Lack of knowledge or practical skills', option_type: 'ranked', display_order: 2 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'unclear-value', option_label: 'Unclear value or relevant use cases', option_type: 'ranked', display_order: 3 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'client', option_label: 'Client or stakeholder not ready or supportive', option_type: 'ranked', display_order: 4 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'access', option_label: 'Lack of access to tools, data, budget, or clear governance', option_type: 'ranked', display_order: 5 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'other', option_label: 'Other', option_type: 'ranked', display_order: 6 },
  ];

  // Label lookups for display
  const MATURITY_LABELS = { 'not-started': 'Not Started', 'exploring': 'Exploring', 'piloting': 'Piloting', 'scaling': 'Scaling', 'optimizing': 'Optimizing', 'dont-know': "Don't Know" };
  const MATURITY_ORDER = ['dont-know', 'not-started', 'exploring', 'piloting', 'scaling', 'optimizing'];
  const MATURITY_STAGES = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing']; // without dont-know
  const MATURITY_COLORS = {
    'not-started': '#f87171',
    'exploring': '#fbbf24',
    'piloting': '#4ade80',
    'scaling': '#4ade80',
    'optimizing': '#22c55e',
    'dont-know': '#f87171'
  };
  const MATURITY_ICONS = {
    'not-started': '🚫',
    'exploring': '🔍',
    'piloting': '🧪',
    'scaling': '📈',
    'optimizing': '⚡',
    'dont-know': '❓'
  };
  const MATURITY_DESCRIPTIONS = {
    'not-started': {
      title: '🚫 Not Started — "AI is not on the agenda"',
      desc: 'At this stage, AI is essentially absent from the account\'s strategy. There are no initiatives, no owners, and no clear awareness of where AI could add value. If AI is mentioned, it\'s usually abstract or perceived as something for "big tech companies," not something actionable for them. Decisions are driven by existing processes and tools, and there is often uncertainty or skepticism around AI\'s relevance, cost, or risk.'
    },
    'exploring': {
      title: '🔍 Exploring — "We are trying to understand AI"',
      desc: 'Here the account has curiosity, but not commitment. AI is being researched, discussed, or experimented with informally — maybe through demos, workshops, vendor conversations, or isolated experiments by motivated individuals. There is no production usage, no clear ROI expectations, and no governance. Learning is the goal, not outcomes. This stage is about sense-making, not delivery.'
    },
    'piloting': {
      title: '🧪 Piloting — "We are testing if AI actually works for us"',
      desc: 'This is a key inflection point. The account is running concrete POCs tied to real problems (often in limited scopes like SDLC, support, or analytics). There is some budget, some sponsorship, and early success criteria — but AI is still treated as an experiment. Results are evaluated cautiously, risks are contained, and decisions about scaling are pending. AI exists, but it\'s not yet trusted or systemic.'
    },
    'scaling': {
      title: '📈 Scaling — "AI is becoming part of how we operate"',
      desc: 'Now AI has proven value. Successful pilots are expanded across teams, functions, or products. Investment increases, governance starts to matter, and repeatability becomes important. The account begins to standardize tools, define ownership, train people, and integrate AI into workflows. The focus shifts from "does this work?" to "how do we roll this out safely and consistently?"'
    },
    'optimizing': {
      title: '⚡ Optimizing — "AI is embedded and continuously improved"',
      desc: 'At this stage, AI is no longer a project — it\'s infrastructure. AI is embedded into core processes and products, measured with KPIs, and continuously refined. The account actively optimizes models, workflows, and cost/value tradeoffs. People are trained by default, governance is mature, and AI decisions are part of normal business planning. The question is no longer whether to use AI, but how to do it better.'
    }
  };
  const GOVERNANCE_LABELS = { 'none': 'No Governance', 'informal': 'Informal', 'developing': 'Developing', 'established': 'Established', 'dont-know': "Don't Know" };
  const GOVERNANCE_ORDER = ['none', 'informal', 'developing', 'established', 'dont-know'];

  // Limiting Factors
  const LIMITING_FACTOR_LABELS = {
    time: 'Lack of time',
    knowledge: 'Lack of knowledge',
    'unclear-value': 'Unclear value',
    client: 'Client not ready',
    access: 'Lack of access',
    other: 'Other'
  };
  const LIMITING_FACTOR_ORDER = ['time', 'knowledge', 'unclear-value', 'client', 'access', 'other'];
  const LF_COLORS = { primary: '#4f46e5', secondary: '#93c5fd' };

  // AI Challenges (from clientAILandscape.challenges)
  const AI_CHALLENGE_LABELS = {
    'unclear-roi': 'Unclear ROI', 'skills': 'Skills Gap', 'data': 'Data Issues',
    'security': 'Security/Compliance', 'budget': 'Budget/Buy-in',
    'infrastructure': 'Infrastructure', 'dont-know': "Don't Know"
  };
  const AI_CHALLENGE_ORDER = ['unclear-roi', 'skills', 'data', 'security', 'budget', 'infrastructure', 'dont-know'];
  const AI_CHALLENGE_COLORS = { primary: '#0ea5e9', secondary: '#bae6fd' };

  // AI Usage (from clientAILandscape.usage)
  const AI_USAGE_LABELS = {
    'dont-know': "Don't Know", 'not-using': 'Not Using AI', 'off-the-shelf': 'Off-the-Shelf Tools',
    'business-apps': 'AI in Business Apps', 'custom-solutions': 'Custom AI Solutions',
    'business-processes': 'Process Automation', 'customer-facing': 'Customer-Facing AI'
  };
  const AI_USAGE_ORDER = ['dont-know', 'not-using', 'off-the-shelf', 'business-apps', 'custom-solutions', 'business-processes', 'customer-facing'];
  const AI_USAGE_COLOR = '#8b5cf6'; // violet-500
  const AI_USAGE_ICONS = {
    'dont-know': '❓', 'not-using': '🚫', 'off-the-shelf': '🛒', 'business-apps': '💼',
    'custom-solutions': '🔧', 'business-processes': '⚙️', 'customer-facing': '🤝'
  };
  const AI_USAGE_DESCRIPTIONS = {
    'dont-know': {
      title: "❓ Don't Know",
      desc: 'The delivery manager is not aware of whether or how the client is using AI. This may indicate a lack of visibility into client operations or that AI has not been discussed.',
      examples: ['AI usage has not come up in client conversations', 'Client stakeholders have not shared their AI strategy', 'No information available about internal tools or initiatives']
    },
    'not-using': {
      title: '🚫 Not Using AI',
      desc: 'The client is not leveraging AI in any meaningful capacity. This could be due to organizational readiness, regulatory constraints, or simply not having explored the possibility yet.',
      examples: ['All workflows are fully manual with no AI augmentation', 'Client has explicitly stated they are not pursuing AI', 'No AI tools, integrations, or pilots in use anywhere in the organization']
    },
    'off-the-shelf': {
      title: '🛒 Off-the-Shelf Tools',
      desc: 'The client uses commercially available, ready-made AI tools without significant customization. These are typically SaaS products with built-in AI capabilities that require minimal technical setup.',
      examples: ['ChatGPT, Claude, or Gemini for content drafting and research', 'GitHub Copilot or Cursor for code assistance', 'Grammarly, Jasper, or similar AI writing tools', 'AI-powered design tools like Midjourney or DALL-E']
    },
    'business-apps': {
      title: '💼 AI in Business Apps',
      desc: 'The client uses AI features embedded within their existing business software platforms. These are AI capabilities that come built into enterprise tools they already use, rather than standalone AI products.',
      examples: ['Salesforce Einstein for lead scoring and sales predictions', 'Microsoft 365 Copilot across Word, Excel, PowerPoint, Teams', 'HubSpot AI for marketing automation and content suggestions', 'ServiceNow AI for IT service management and ticket routing', 'Atlassian Intelligence in Jira and Confluence']
    },
    'custom-solutions': {
      title: '🔧 Custom AI Solutions',
      desc: 'The client has built or commissioned bespoke AI models, pipelines, or applications tailored to their specific business needs. This indicates a higher level of AI maturity and investment.',
      examples: ['Custom ML models trained on proprietary data for demand forecasting', 'In-house RAG (Retrieval-Augmented Generation) systems over internal knowledge bases', 'Purpose-built NLP pipelines for document classification or extraction', 'Custom recommendation engines for products or content', 'Proprietary computer vision systems for quality inspection']
    },
    'business-processes': {
      title: '⚙️ Process Automation',
      desc: 'The client uses AI to automate repetitive business processes and workflows, reducing manual effort and improving consistency. AI is integrated into operational flows rather than used as a standalone tool.',
      examples: ['AI-powered invoice processing and accounts payable automation', 'Automated contract review and clause extraction', 'Intelligent document processing for onboarding or compliance', 'AI-driven workflow orchestration (e.g., auto-routing, approvals)', 'Automated report generation and data reconciliation']
    },
    'customer-facing': {
      title: '🤝 Customer-Facing AI',
      desc: 'The client deploys AI in products or services that directly interact with their end customers. This is the most visible form of AI usage and typically requires the highest quality and reliability standards.',
      examples: ['AI chatbots or virtual assistants for customer support', 'Personalized product or content recommendations on their platform', 'AI-powered search and discovery features', 'Dynamic pricing or offer optimization', 'Voice assistants or conversational interfaces in their products']
    }
  };

  // AI Tools (from survey Step 4: toolsAndInfrastructure.ai)
  const AI_TOOL_LABELS = {
    copilot: 'GitHub Copilot', chatgpt: 'ChatGPT / OpenAI', claude: 'Claude (Anthropic)',
    claudecode: 'Claude Code', cursor: 'Cursor', windsurf: 'Windsurf',
    gemini: 'Gemini (Google)', amazonq: 'Amazon Q / Kiro', mscopilot: 'Microsoft Copilot',
    intellij: 'IntelliJ AI', rovo: 'Atlassian Rovo', v0: 'v0 (Vercel)',
    bolt: 'Bolt.new', lovable: 'Lovable', perplexity: 'Perplexity'
  };
  const AI_TOOL_ORDER = Object.keys(AI_TOOL_LABELS);
  const AI_TOOL_COLOR = '#6366f1';

  // Cloud Platforms (from survey Step 4: toolsAndInfrastructure.cloud)
  const CLOUD_PLATFORM_LABELS = {
    aws: 'AWS', gcp: 'GCP', azure: 'Azure', onprem: 'On-Premises'
  };
  const CLOUD_PLATFORM_ORDER = Object.keys(CLOUD_PLATFORM_LABELS);
  const CLOUD_PLATFORM_COLOR = '#0ea5e9';

  const ROLE_LABELS = {
    pm: 'PM / Scrum', ba: 'BA / PM', arch: 'Architects', swe: 'Software Eng.',
    qa: 'Manual QA', qaa: 'QA Automation', data: 'Data Eng.', devops: 'DevOps', ux: 'UI/UX'
  };
  const ROLE_ORDER = ['pm', 'ba', 'arch', 'swe', 'qa', 'qaa', 'data', 'devops', 'ux'];
  const ROLE_FULL_NAMES = {
    pm: 'Project Manager', ba: 'Business Analyst', arch: 'Solutions Architect',
    swe: 'Developer', qa: 'QA Manual', qaa: 'QA Automation',
    data: 'Data Engineer', devops: 'DevOps', ux: 'UI/UX Designer'
  };

  // Workflow Maturity Stages
  const WFM_STAGES = [0, 1, 2, 3, 4, 5];
  const WFM_LABELS = {
    0: 'No AI Usage', 1: 'Individual AI', 2: 'Team Practices',
    3: 'AI-Chained', 4: 'Event-Triggered', 5: 'Semi-Agentic'
  };
  const WFM_SUBTITLES = {
    0: 'Work done entirely manually', 1: 'AI used by individuals only',
    2: 'Shared, manual AI usage', 3: 'Multi-step AI workflows',
    4: 'Automated AI integration', 5: 'AI recommends, humans decide'
  };
  const WFM_COLORS = {
    0: '#f87171', 1: '#fbbf24', 2: '#fbbf24',
    3: '#4ade80', 4: '#4ade80', 5: '#22c55e'
  };
  const WFM_DESCRIPTIONS = {
    0: { title: 'Stage 0 — No AI Usage', desc: 'AI is not used in delivery workflows. Tools may be blocked or discouraged, no AI policy or guidance exists, and any usage is unofficial "shadow AI." Leadership has not discussed AI adoption.' },
    1: { title: 'Stage 1 — Individual AI Usage', desc: 'AI is used by individuals only. Tool usage varies widely across team members with no shared standards. Outputs differ by person and knowledge is not reusable. Each person experiments independently.' },
    2: { title: 'Stage 2 — Team AI Practices', desc: 'Shared, manual AI usage at team level. The team maintains prompt libraries, references AI in ceremonies, produces repeatable outputs, and includes AI practices in onboarding. Usage is consistent but still manually triggered.' },
    3: { title: 'Stage 3 — AI-Chained Tasks', desc: 'Sequential AI steps from one intent. Multiple prompts are chained together for complex tasks using documented, reused workflows. Scripts or templates standardize interactions and work items follow predictable AI-assisted flows.' },
    4: { title: 'Stage 4 — Event-Triggered AI', desc: 'AI reacts automatically to SDLC events. Bots post comments to collaboration tools, integrations exist with project management and CI/CD pipelines, AI tasks execute without manual triggering, reducing repetitive interactions.' },
    5: { title: 'Stage 5 — Semi-Agentic AI', desc: 'AI recommends, humans decide. Dashboards display AI-generated insights and metrics, AI provides confidence and risk scores, regular recommendation reports are produced, and human review/approval gates exist before AI actions take effect.' }
  };
  const WFM_SIGNALS = [
    ['AI tools blocked or discouraged', 'No AI policy or guidance', '"Shadow AI" usage only', 'No leadership discussion about AI'],
    ['Tool usage varies widely', 'No shared standards', 'Outputs differ by person', 'Knowledge not reusable'],
    ['Prompt libraries', 'AI referenced in ceremonies', 'Repeatable outputs', 'Onboarding includes AI practices'],
    ['Prompt chains', 'Reused workflows', 'Scripts or templates', 'Consistent flow across tickets'],
    ['Bots posting comments', 'Jira / GitHub / CI integrations', 'Background AI execution', 'Reduced manual triggering'],
    ['Dashboards with AI insights', 'Confidence / risk scores', 'Recommendation reports', 'Humans approve actions']
  ];
  const WFM_SIGNALS_EXPANDED = [
    ['AI tools are explicitly prohibited or strongly discouraged by policy', 'No formal AI policy exists or guidelines have been communicated', 'Team members use AI tools privately without management knowledge', 'Leadership has not discussed or acknowledged AI adoption needs'],
    ['Different team members use AI tools in inconsistent ways', 'No agreed-upon standards for prompts or workflows', 'Same task produces different quality outputs depending on who does it', 'Learnings and techniques are not shared or documented'],
    ['Team maintains shared libraries of effective prompts', 'AI capabilities and limitations discussed in team ceremonies', 'Outputs follow consistent patterns and quality standards', 'New team members are taught AI practices as part of onboarding'],
    ['Multiple prompts are chained together for complex tasks', 'Documented workflows that multiple team members follow', 'Scripts or templates standardize common AI interactions', 'Work items follow predictable AI-assisted flows'],
    ['AI systems post updates directly to collaboration tools', 'Integrations with project management and CI/CD pipelines', 'AI tasks execute without manual triggering', 'Less time spent on repetitive manual AI interactions'],
    ['Visual dashboards showing AI-generated insights and metrics', 'AI provides confidence scores and risk assessments', 'Regular reports with AI-generated recommendations', 'Human review and approval gates before AI actions take effect']
  ];

  // Account Types
  const ACCOUNT_TYPES = [
    { id: 'enterprise', label: 'Enterprise' },
    { id: 'key-account', label: 'Key Account' },
    { id: 'enterprise-key', label: 'Enterprise + Key Account' },
    { id: 'other', label: 'Other' },
  ];
  const ACCOUNT_TYPE_LABELS = {};
  ACCOUNT_TYPES.forEach(t => ACCOUNT_TYPE_LABELS[t.id] = t.label);

  // Engagement Types (Ownership)
  const ENGAGEMENT_TYPES = [
    { id: 'staff', label: 'Staff Augmentation' },
    { id: 'project', label: 'Project Ownership' },
    { id: 'program', label: 'Program Ownership' },
    { id: 'outcome', label: 'Business Outcome' },
  ];
  const ENGAGEMENT_TYPE_LABELS = {};
  ENGAGEMENT_TYPES.forEach(t => ENGAGEMENT_TYPE_LABELS[t.id] = t.label);

  // ═══════════════════════════════════════════
  // GLOBAL FILTER STATE
  // ═══════════════════════════════════════════
  let activeMaturityFilter = null; // null = all, or a stage id like 'exploring'
  let selectedAccounts = new Set();  // empty = all, Set of account name strings
  let selectedDeliveryManagers = new Set(); // empty = all, Set of DM name strings
  let activeLimitingFactorFilter = null; // null = all, or a factor key like 'time'
  let activeAiToolFilter = null; // null = all, or a tool key like 'copilot' or '_custom'
  let activeAiChallengeFilter = null; // null = all, or a challenge key like 'skills'
  let activeAiUsageFilter = null; // null = all, or a usage key like 'off-the-shelf'
  let activeCloudPlatformFilter = null; // null = all, or a platform key like 'aws'
  let activeWfmStageFilter = null; // null = all, or a stage number (0-5)
  let activeAiAdoptionFilter = 'all'; // 'all', 'using', 'not-using'
  let currentMedianStage = null; // current median stage key for stage description modal
  let currentStagePosition = 0.5; // 0-1 position for adoption stage progress bar
  let currentWfmStage = null; // current WFM average stage number for description modal
  let currentWfmPosition = 0.5; // 0-1 position for WFM progress bar
  let tableSortColumn = 'account'; // default sort column
  let tableSortDirection = 'asc';  // 'asc' or 'desc'

  // ── AI Chat State ──
  let aiChatOpen = false;
  let aiChatHistory = [];  // { role: 'user'|'assistant', content: string }
  let aiChatLoading = false;

  const AI_PROVIDERS = {
    openai: {
      label: 'OpenAI',
      models: [
        { id: 'gpt-4o', label: 'GPT-4o' },
        { id: 'gpt-4o-mini', label: 'GPT-4o Mini' },
        { id: 'gpt-4.1', label: 'GPT-4.1' },
        { id: 'gpt-4.1-mini', label: 'GPT-4.1 Mini' }
      ],
      keyStorageKey: 'ai_dashboard_openai_key',
      endpoint: 'https://api.openai.com/v1/chat/completions'
    },
    anthropic: {
      label: 'Anthropic',
      models: [
        { id: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
        { id: 'claude-haiku-35-20241022', label: 'Claude Haiku 3.5' }
      ],
      keyStorageKey: 'ai_dashboard_anthropic_key',
      endpoint: 'https://api.anthropic.com/v1/messages'
    }
  };

  // ── Comparison Mode State ──
  let comparisonMode = false;
  const COMPARE_COLOR_A = '#6366f1'; // Indigo
  const COMPARE_COLOR_B = '#10b981'; // Emerald
  let groupA = { name: 'Group A', filters: { maturity: null, accounts: new Set(), deliveryManagers: new Set(), limitingFactor: null, aiTool: null, aiChallenge: null, wfmStage: null, champion: null, accountTypes: new Set(), engagementTypes: new Set(), cloudPlatforms: new Set() } };
  let groupB = { name: 'Group B', filters: { maturity: null, accounts: new Set(), deliveryManagers: new Set(), limitingFactor: null, aiTool: null, aiChallenge: null, wfmStage: null, champion: null, accountTypes: new Set(), engagementTypes: new Set(), cloudPlatforms: new Set() } };

  function setMaturityFilter(stage) {
    activeMaturityFilter = (activeMaturityFilter === stage) ? null : stage;
    refreshDashboard();
  }

  function clearMaturityFilter() {
    activeMaturityFilter = null;
    refreshDashboard();
  }

  function toggleAccountSelection(accountName) {
    if (selectedAccounts.has(accountName)) {
      selectedAccounts.delete(accountName);
    } else {
      selectedAccounts.add(accountName);
    }
    refreshDashboard();
  }

  function clearAccountFilter() {
    selectedAccounts.clear();
    refreshDashboard();
  }

  function selectAllVisibleAccounts() {
    const surveys = getAllFilteredSurveys();
    surveys.forEach(s => selectedAccounts.add(s.account_name));
    refreshDashboard();
  }

  function onSelectAllAccountsToggle(checked) {
    if (checked) {
      selectAllVisibleAccounts();
    } else {
      clearAccountFilter();
    }
  }

  // Actions dropdown toggle
  function toggleActionsMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('cloudPlatformsMenu')?.classList.remove('open');
    document.querySelector('#filterCloudPlatforms .multi-select-btn')?.classList.remove('open');

    const menu = document.getElementById('actionsMenu');
    const btn = document.getElementById('actionsToggle');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  // Accounts dropdown helpers
  function toggleAccountsMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('cloudPlatformsMenu')?.classList.remove('open');
    document.querySelector('#filterCloudPlatforms .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('accountsMenu');
    const btn = document.querySelector('#filterAccounts .multi-select-btn');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  function updateAccountsLabel() {
    const label = document.getElementById('accountsLabel');
    if (selectedAccounts.size === 0) {
      label.textContent = 'All Accounts';
    } else if (selectedAccounts.size === 1) {
      label.textContent = [...selectedAccounts][0];
    } else {
      label.textContent = `${selectedAccounts.size} accounts`;
    }
  }

  function onAccountSelectionChange() {
    const checkboxes = document.querySelectorAll('#accountsMenu input[type="checkbox"]');
    selectedAccounts.clear();
    checkboxes.forEach(cb => { if (cb.checked) selectedAccounts.add(cb.value); });
    refreshDashboard();
  }

  function selectAllAccountsFromMenu() {
    document.querySelectorAll('#accountsMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onAccountSelectionChange();
  }

  function clearAllAccountsFromMenu() {
    document.querySelectorAll('#accountsMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onAccountSelectionChange();
  }

  function populateAccountsFilter() {
    const menu = document.getElementById('accountsMenu');
    if (!menu) return;
    menu.querySelectorAll('.multi-select-item').forEach(el => el.remove());

    const allSurveys = getAllFilteredSurveys();
    const names = [...new Set(allSurveys.map(s => s.account_name))].sort();

    const actionsDiv = menu.querySelector('.multi-select-actions');
    names.forEach(name => {
      const label = document.createElement('label');
      label.className = 'multi-select-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = name;
      cb.checked = selectedAccounts.has(name);
      cb.addEventListener('change', () => onAccountSelectionChange());
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + name));
      menu.insertBefore(label, actionsDiv);
    });

    updateAccountsLabel();
  }

  // Delivery Manager dropdown helpers
  function toggleDMMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');
    document.getElementById('cloudPlatformsMenu')?.classList.remove('open');
    document.querySelector('#filterCloudPlatforms .multi-select-btn')?.classList.remove('open');

    const menu = document.getElementById('dmMenu');
    const btn = document.querySelector('#filterDM .multi-select-btn');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  function updateDMLabel() {
    const label = document.getElementById('dmLabel');
    if (selectedDeliveryManagers.size === 0) {
      label.textContent = 'All DMs';
    } else if (selectedDeliveryManagers.size === 1) {
      label.textContent = [...selectedDeliveryManagers][0];
    } else {
      label.textContent = `${selectedDeliveryManagers.size} DMs`;
    }
  }

  function onDMSelectionChange() {
    const checkboxes = document.querySelectorAll('#dmMenu input[type="checkbox"]');
    selectedDeliveryManagers.clear();
    checkboxes.forEach(cb => { if (cb.checked) selectedDeliveryManagers.add(cb.value); });
    refreshDashboard();
  }

  function selectAllDMsFromMenu() {
    document.querySelectorAll('#dmMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onDMSelectionChange();
  }

  function clearAllDMsFromMenu() {
    document.querySelectorAll('#dmMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onDMSelectionChange();
  }

  function clearDMFilter() {
    selectedDeliveryManagers.clear();
    refreshDashboard();
  }

  function populateDMFilter() {
    const menu = document.getElementById('dmMenu');
    if (!menu) return;
    menu.querySelectorAll('.multi-select-item').forEach(el => el.remove());

    const allSurveys = getAllFilteredSurveys();
    const dms = [...new Set(allSurveys.map(s => s.delivery_manager).filter(dm => dm && dm.trim()))].sort();

    const actionsDiv = menu.querySelector('.multi-select-actions');
    dms.forEach(dm => {
      const label = document.createElement('label');
      label.className = 'multi-select-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = dm;
      cb.checked = selectedDeliveryManagers.has(dm);
      cb.addEventListener('change', () => onDMSelectionChange());
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + dm));
      menu.insertBefore(label, actionsDiv);
    });

    updateDMLabel();
  }

  function setLimitingFactorFilter(factor) {
    activeLimitingFactorFilter = (activeLimitingFactorFilter === factor) ? null : factor;
    refreshDashboard();
  }

  function clearLimitingFactorFilter() {
    activeLimitingFactorFilter = null;
    refreshDashboard();
  }

  function setWfmStageFilter(stage) {
    activeWfmStageFilter = (activeWfmStageFilter === stage) ? null : stage;
    refreshDashboard();
  }

  function clearWfmStageFilter() {
    activeWfmStageFilter = null;
    refreshDashboard();
  }

  function setAiToolFilter(toolKey) {
    activeAiToolFilter = (activeAiToolFilter === toolKey) ? null : toolKey;
    refreshDashboard();
  }

  function clearAiToolFilter() {
    activeAiToolFilter = null;
    refreshDashboard();
  }

  function setAiChallengeFilter(key) {
    activeAiChallengeFilter = (activeAiChallengeFilter === key) ? null : key;
    refreshDashboard();
  }

  function clearAiChallengeFilter() {
    activeAiChallengeFilter = null;
    refreshDashboard();
  }

  function setAiUsageFilter(key) {
    activeAiUsageFilter = (activeAiUsageFilter === key) ? null : key;
    refreshDashboard();
  }
  function clearAiUsageFilter() {
    activeAiUsageFilter = null;
    refreshDashboard();
  }

  function setCloudPlatformFilter(key) {
    const checkboxes = document.querySelectorAll('#cloudPlatformsMenu input[type="checkbox"]');
    const currentSelected = getSelectedCloudPlatforms();
    const isSingleActive = currentSelected.length === 1 && currentSelected[0] === key;

    if (isSingleActive) {
      // Toggle off — restore all platforms
      checkboxes.forEach(cb => cb.checked = true);
    } else {
      // Select only the clicked platform
      checkboxes.forEach(cb => cb.checked = (cb.value === key));
    }
    updateCloudPlatformsLabel();
    activeCloudPlatformFilter = null;
    refreshDashboard();
  }
  function clearCloudPlatformFilter() {
    document.querySelectorAll('#cloudPlatformsMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateCloudPlatformsLabel();
    activeCloudPlatformFilter = null;
    refreshDashboard();
  }

  // Cloud Platforms top-bar multi-select dropdown
  function toggleCloudPlatformsMenu() {
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('cloudPlatformsMenu');
    const btn = document.querySelector('#filterCloudPlatforms .multi-select-btn');
    const isOpen = menu.classList.contains('open');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
    if (!isOpen) btn.focus();
  }

  function getSelectedCloudPlatforms() {
    const checkboxes = document.querySelectorAll('#cloudPlatformsMenu input[type="checkbox"]');
    const selected = [];
    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
    return selected;
  }

  function onCloudPlatformChange() {
    updateCloudPlatformsLabel();
    refreshDashboard();
  }

  function updateCloudPlatformsLabel() {
    const selected = getSelectedCloudPlatforms();
    const label = document.getElementById('cloudPlatformsLabel');
    if (!label) return;
    if (selected.length === CLOUD_PLATFORM_ORDER.length || selected.length === 0) {
      label.textContent = 'All Platforms';
    } else if (selected.length === 1) {
      label.textContent = CLOUD_PLATFORM_LABELS[selected[0]] || selected[0];
    } else {
      label.textContent = `${selected.length} Platforms`;
    }
  }

  function selectAllCloudPlatforms() {
    document.querySelectorAll('#cloudPlatformsMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onCloudPlatformChange();
  }

  function clearAllCloudPlatformsCb() {
    document.querySelectorAll('#cloudPlatformsMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onCloudPlatformChange();
  }

  function resetCloudPlatformCheckboxes() {
    document.querySelectorAll('#cloudPlatformsMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateCloudPlatformsLabel();
  }

  // ── AI Tool Adoption filter helpers ──
  const AI_ADOPTION_EXCLUDED_KEYS = ['dont-know', 'not-applicable', 'custom', '_meta'];

  function surveyHasAiTools(s) {
    const aiTools = s.data?.toolsAndInfrastructure?.ai;
    if (!aiTools) return false;
    const hasNamedTool = Object.keys(aiTools).some(key =>
      !AI_ADOPTION_EXCLUDED_KEYS.includes(key) && aiTools[key]?.selected === true
    );
    const hasCustomTool = Array.isArray(aiTools.custom) && aiTools.custom.length > 0;
    return hasNamedTool || hasCustomTool;
  }

  function onAiAdoptionFilterChange() {
    activeAiAdoptionFilter = document.getElementById('filterAiAdoption').value;
    refreshDashboard();
  }

  function clearAiAdoptionFilter() {
    activeAiAdoptionFilter = 'all';
    document.getElementById('filterAiAdoption').value = 'all';
    refreshDashboard();
  }

  function clearAllFilters() {
    if (comparisonMode) { exitComparison(); return; }
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    activeLimitingFactorFilter = null;
    activeAiToolFilter = null;
    activeAiChallengeFilter = null;
    activeAiUsageFilter = null;
    activeCloudPlatformFilter = null;
    activeWfmStageFilter = null;
    activeChampionFilter = null;
    activeAiAdoptionFilter = 'all';
    document.getElementById('filterAiAdoption').value = 'all';
    resetCloudPlatformCheckboxes();
    refreshDashboard();
  }

  // ═══════════════════════════════════════════
  // COMPARE GROUPS — MODAL & STATE
  // ═══════════════════════════════════════════
  function openCompareModal() {
    const surveys = getAllFilteredSurveys();
    // Collect unique accounts and DMs
    const accounts = [...new Set(surveys.map(s => s.account_name))].sort();
    const dms = [...new Set(surveys.map(s => s.delivery_manager).filter(Boolean))].sort();

    ['A', 'B'].forEach(side => {
      const g = side === 'A' ? groupA : groupB;
      // Accounts checklist
      const acctEl = document.getElementById('compareAccounts' + side);
      acctEl.innerHTML = accounts.map(a =>
        `<label><input type="checkbox" value="${escapeHtml(a)}" ${g.filters.accounts.has(a) ? 'checked' : ''}> ${escapeHtml(a)}</label>`
      ).join('');

      // DM checklist
      const dmEl = document.getElementById('compareDMs' + side);
      dmEl.innerHTML = dms.map(d =>
        `<label><input type="checkbox" value="${escapeHtml(d)}" ${g.filters.deliveryManagers.has(d) ? 'checked' : ''}> ${escapeHtml(d)}</label>`
      ).join('');

      // Maturity radio buttons
      const matEl = document.getElementById('compareMaturity' + side);
      const maturityStages = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing'];
      matEl.innerHTML = `<label><input type="radio" name="compareMaturity${side}" value="" ${!g.filters.maturity ? 'checked' : ''}> All</label>` +
        maturityStages.map(k =>
          `<label><input type="radio" name="compareMaturity${side}" value="${k}" ${g.filters.maturity === k ? 'checked' : ''}> ${MATURITY_ICONS[k]} ${MATURITY_LABELS[k]}</label>`
        ).join('');

      // WFM radio buttons
      const wfmEl = document.getElementById('compareWfm' + side);
      wfmEl.innerHTML = `<label><input type="radio" name="compareWfm${side}" value="" ${g.filters.wfmStage === null ? 'checked' : ''}> All</label>` +
        WFM_STAGES.map(n =>
          `<label><input type="radio" name="compareWfm${side}" value="${n}" ${g.filters.wfmStage === n ? 'checked' : ''}> Stage ${n} — ${WFM_LABELS[n]}</label>`
        ).join('');

      // Champion radio buttons
      const champEl = document.getElementById('compareChampion' + side);
      champEl.innerHTML = `<label><input type="radio" name="compareChampion${side}" value="" ${!g.filters.champion ? 'checked' : ''}> All</label>` +
        `<label><input type="radio" name="compareChampion${side}" value="yes" ${g.filters.champion === 'yes' ? 'checked' : ''}> ✅ Yes</label>` +
        `<label><input type="radio" name="compareChampion${side}" value="no" ${g.filters.champion === 'no' ? 'checked' : ''}> ❌ No</label>`;

      // AI Adoption radio buttons
      const aiAdoptEl = document.getElementById('compareAiAdoption' + side);
      const aiAdoptVal = g.filters.aiAdoption || 'all';
      aiAdoptEl.innerHTML = `<label><input type="radio" name="compareAiAdoption${side}" value="all" ${aiAdoptVal === 'all' ? 'checked' : ''}> All</label>` +
        `<label><input type="radio" name="compareAiAdoption${side}" value="using" ${aiAdoptVal === 'using' ? 'checked' : ''}> ✅ Using AI Tools</label>` +
        `<label><input type="radio" name="compareAiAdoption${side}" value="not-using" ${aiAdoptVal === 'not-using' ? 'checked' : ''}> ❌ Not Using AI Tools</label>`;

      // Account Type checkboxes
      const acctTypeEl = document.getElementById('compareAccountType' + side);
      acctTypeEl.innerHTML = ACCOUNT_TYPES.map(t =>
        `<label><input type="checkbox" value="${t.id}" ${g.filters.accountTypes.has(t.id) ? 'checked' : ''}> ${t.label}</label>`
      ).join('');

      // Engagement Type checkboxes
      const engEl = document.getElementById('compareEngagement' + side);
      engEl.innerHTML = ENGAGEMENT_TYPES.map(t =>
        `<label><input type="checkbox" value="${t.id}" ${g.filters.engagementTypes.has(t.id) ? 'checked' : ''}> ${t.label}</label>`
      ).join('');

      // Cloud Platforms checkboxes
      const cloudEl = document.getElementById('compareCloud' + side);
      cloudEl.innerHTML = CLOUD_PLATFORM_ORDER.map(k =>
        `<label><input type="checkbox" value="${k}" ${g.filters.cloudPlatforms.has(k) ? 'checked' : ''}> ${CLOUD_PLATFORM_LABELS[k]}</label>`
      ).join('');

      // Restore name
      document.getElementById('compareGroup' + side + 'Name').value = g.name;
    });

    document.getElementById('compareModal').classList.add('open');
  }

  function closeCompareModal() {
    document.getElementById('compareModal').classList.remove('open');
  }

  function captureGroupFilters(side) {
    const filters = {
      maturity: null, accounts: new Set(), deliveryManagers: new Set(),
      limitingFactor: null, aiTool: null, aiChallenge: null,
      wfmStage: null, champion: null, aiAdoption: 'all',
      accountTypes: new Set(), engagementTypes: new Set(), cloudPlatforms: new Set()
    };

    // Accounts
    document.querySelectorAll(`#compareAccounts${side} input[type="checkbox"]:checked`).forEach(cb => {
      filters.accounts.add(cb.value);
    });

    // DMs
    document.querySelectorAll(`#compareDMs${side} input[type="checkbox"]:checked`).forEach(cb => {
      filters.deliveryManagers.add(cb.value);
    });

    // Maturity
    const matVal = document.querySelector(`input[name="compareMaturity${side}"]:checked`)?.value;
    filters.maturity = matVal || null;

    // WFM Stage
    const wfmVal = document.querySelector(`input[name="compareWfm${side}"]:checked`)?.value;
    filters.wfmStage = wfmVal !== '' && wfmVal !== undefined ? parseInt(wfmVal) : null;

    // Champion
    const champVal = document.querySelector(`input[name="compareChampion${side}"]:checked`)?.value;
    filters.champion = champVal || null;

    // AI Adoption
    const aiAdoptVal = document.querySelector(`input[name="compareAiAdoption${side}"]:checked`)?.value;
    filters.aiAdoption = aiAdoptVal || 'all';

    // Account Types
    document.querySelectorAll(`#compareAccountType${side} input[type="checkbox"]:checked`).forEach(cb => {
      filters.accountTypes.add(cb.value);
    });

    // Engagement Types
    document.querySelectorAll(`#compareEngagement${side} input[type="checkbox"]:checked`).forEach(cb => {
      filters.engagementTypes.add(cb.value);
    });

    // Cloud Platforms
    document.querySelectorAll(`#compareCloud${side} input[type="checkbox"]:checked`).forEach(cb => {
      filters.cloudPlatforms.add(cb.value);
    });

    return filters;
  }

  function copyCurrentFiltersToGroup(side) {
    const g = side === 'A' ? groupA : groupB;
    // Copy current global filters
    g.filters.maturity = activeMaturityFilter;
    g.filters.accounts = new Set(selectedAccounts);
    g.filters.deliveryManagers = new Set(selectedDeliveryManagers);
    g.filters.limitingFactor = activeLimitingFactorFilter;
    g.filters.aiTool = activeAiToolFilter;
    g.filters.aiChallenge = activeAiChallengeFilter;
    g.filters.wfmStage = activeWfmStageFilter;
    g.filters.champion = activeChampionFilter;
    g.filters.aiAdoption = activeAiAdoptionFilter;
    g.filters.accountTypes = new Set(getSelectedAccountTypes());
    g.filters.engagementTypes = new Set(getSelectedEngagementTypes());
    g.filters.cloudPlatforms = new Set(getSelectedCloudPlatforms());
    // Re-open modal to refresh checkboxes
    openCompareModal();
  }

  function clearCompareGroupFilters(side) {
    const g = side === 'A' ? groupA : groupB;
    g.filters = { maturity: null, accounts: new Set(), deliveryManagers: new Set(), limitingFactor: null, aiTool: null, aiChallenge: null, wfmStage: null, champion: null, aiAdoption: 'all', accountTypes: new Set(), engagementTypes: new Set(), cloudPlatforms: new Set() };
    openCompareModal();
  }

  function compareSelectAll(containerId) {
    document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => cb.checked = true);
  }

  function compareClearAll(containerId) {
    document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => cb.checked = false);
  }

  function startComparison() {
    // Capture filters from modal
    groupA.name = document.getElementById('compareGroupAName').value || 'Group A';
    groupB.name = document.getElementById('compareGroupBName').value || 'Group B';
    groupA.filters = captureGroupFilters('A');
    groupB.filters = captureGroupFilters('B');

    comparisonMode = true;
    closeCompareModal();
    refreshDashboard();
  }

  function exitComparison() {
    comparisonMode = false;
    document.getElementById('comparisonBanner').classList.remove('active');
    refreshDashboard();
  }

  function getFilteredSurveysForGroup(groupFilters) {
    let surveys = getAllFilteredSurveys(); // base dataset (year/quarter/type/engagement only)

    // Maturity filter
    if (groupFilters.maturity) {
      surveys = surveys.filter(s => s.data?.clientAILandscape?.maturity?.value === groupFilters.maturity);
    }

    // Account filter
    if (groupFilters.accounts.size > 0) {
      surveys = surveys.filter(s => groupFilters.accounts.has(s.account_name));
    }

    // DM filter
    if (groupFilters.deliveryManagers.size > 0) {
      surveys = surveys.filter(s => groupFilters.deliveryManagers.has(s.delivery_manager));
    }

    // Limiting factor filter
    if (groupFilters.limitingFactor) {
      surveys = surveys.filter(s => {
        const lf = s.data?.limitingFactors?.[groupFilters.limitingFactor];
        return lf && (lf.rank === 1 || lf.rank === 2);
      });
    }

    // WFM stage filter
    if (groupFilters.wfmStage !== null) {
      surveys = surveys.filter(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return false;
        const stages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') stages.push(st);
        });
        if (stages.length === 0) return false;
        const avg = stages.reduce((a, b) => a + b, 0) / stages.length;
        return Math.round(avg) === groupFilters.wfmStage;
      });
    }

    // AI tool filter
    if (groupFilters.aiTool) {
      surveys = surveys.filter(s => {
        const aiTools = s.data?.toolsAndInfrastructure?.ai;
        if (!aiTools) return false;
        if (groupFilters.aiTool === '_custom') return Array.isArray(aiTools.custom) && aiTools.custom.length > 0;
        return aiTools[groupFilters.aiTool]?.selected === true;
      });
    }

    // AI challenge filter
    if (groupFilters.aiChallenge) {
      surveys = surveys.filter(s => {
        const ch = s.data?.clientAILandscape?.challenges?.[groupFilters.aiChallenge];
        return ch && (ch.rank === 1 || ch.rank === 2);
      });
    }

    // Champion filter
    if (groupFilters.champion) {
      surveys = surveys.filter(s => {
        const val = s.data?.teamRoles?.aiChampion?.value;
        if (groupFilters.champion === 'yes') return val === 'yes';
        return val !== 'yes';
      });
    }

    // Account Type filter
    if (groupFilters.accountTypes && groupFilters.accountTypes.size > 0 && groupFilters.accountTypes.size < ACCOUNT_TYPES.length) {
      surveys = surveys.filter(s => groupFilters.accountTypes.has(s.account_type || 'other'));
    }

    // Engagement Type filter
    if (groupFilters.engagementTypes && groupFilters.engagementTypes.size > 0 && groupFilters.engagementTypes.size < ENGAGEMENT_TYPES.length) {
      surveys = surveys.filter(s => {
        const ownership = s.data?.engagement?.ownership;
        if (!ownership) return false;
        return [...groupFilters.engagementTypes].some(type => ownership[type]?.selected === true);
      });
    }

    // Cloud Platform filter
    if (groupFilters.cloudPlatforms && groupFilters.cloudPlatforms.size > 0 && groupFilters.cloudPlatforms.size < CLOUD_PLATFORM_ORDER.length) {
      surveys = surveys.filter(s => {
        const cloud = s.data?.toolsAndInfrastructure?.cloud;
        if (!cloud) return false;
        return [...groupFilters.cloudPlatforms].some(k => cloud[k]?.selected === true);
      });
    }

    // AI Adoption filter
    if (groupFilters.aiAdoption && groupFilters.aiAdoption !== 'all') {
      surveys = surveys.filter(s => {
        const hasAi = surveyHasAiTools(s);
        return groupFilters.aiAdoption === 'using' ? hasAi : !hasAi;
      });
    }

    return surveys;
  }

  // ═══════════════════════════════════════════
  // COLLAPSIBLE SECTIONS
  // ═══════════════════════════════════════════
  function toggleSection(titleEl) {
    const section = titleEl.closest('.widget-section');
    section.classList.toggle('collapsed');
    const isExpanding = !section.classList.contains('collapsed');

    if (isExpanding) {
      section.offsetHeight; // force reflow
      refreshDashboard();

      // === DIAGNOSTIC: Create a test chart on the first chart canvas ===
      const testCanvas = section.querySelector('canvas');
      if (testCanvas) {
        // Destroy whatever chart is on it
        const existing = Chart.getChart(testCanvas);
        if (existing) existing.destroy();

        console.log('[TEST] Chart.js version:', Chart.version);
        console.log('[TEST] Canvas:', testCanvas.id, 'parent rect:', testCanvas.parentElement.getBoundingClientRect());

        // Try drawing directly on the canvas context FIRST
        const ctx = testCanvas.getContext('2d');
        testCanvas.width = testCanvas.parentElement.clientWidth;
        testCanvas.height = testCanvas.parentElement.clientHeight;
        ctx.fillStyle = 'red';
        ctx.fillRect(0, 0, 200, 200);
        const px1 = ctx.getImageData(100, 100, 1, 1).data;
        console.log('[TEST] Raw canvas fillRect pixel:', Array.from(px1));

        // Clear and try Chart.js
        ctx.clearRect(0, 0, testCanvas.width, testCanvas.height);
        const testChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['A', 'B', 'C'],
            datasets: [{ label: 'Test', data: [10, 20, 30], backgroundColor: ['red', 'green', 'blue'] }]
          },
          options: {
            responsive: false,
            animation: false
          }
        });
        console.log('[TEST] Test chart created, canvas:', testCanvas.width, 'x', testCanvas.height);
        const px2 = ctx.getImageData(Math.floor(testCanvas.width/2), Math.floor(testCanvas.height/2), 1, 1).data;
        console.log('[TEST] After Chart.js (animation:false, responsive:false) pixel:', Array.from(px2), 'blank:', px2[3] === 0);

        // Clean up test chart, re-render real charts
        testChart.destroy();
        refreshDashboard();
      }
    }
  }

  function toggleWidget(headerEl) {
    const card = headerEl.closest('.widget-card');
    card.classList.toggle('widget-collapsed');
    // Chart.js with responsive:true renders canvases as 0×0 inside display:none.
    // When expanding, re-render so charts measure real container dimensions.
    if (!card.classList.contains('widget-collapsed')) {
      const hasCharts = card.querySelector('canvas');
      if (hasCharts) {
        card.offsetHeight; // force reflow
        refreshDashboard();
      }
    }
  }

  // ═══════════════════════════════════════════
  // ACCOUNT TYPE MULTI-SELECT
  // ═══════════════════════════════════════════
  function toggleAccountTypeMenu() {
    // Close other menus if open
    document.getElementById('engagementTypeMenu')?.classList.remove('open');
    document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('cloudPlatformsMenu')?.classList.remove('open');
    document.querySelector('#filterCloudPlatforms .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('accountTypeMenu');
    const btn = document.querySelector('#filterAccountType .multi-select-btn');
    const isOpen = menu.classList.contains('open');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
    if (!isOpen) btn.focus();
  }

  function updateAccountTypeLabel() {
    const selected = getSelectedAccountTypes();
    const label = document.getElementById('accountTypeLabel');
    if (selected.length === 0) {
      label.textContent = 'None';
    } else if (selected.length === ACCOUNT_TYPES.length) {
      label.textContent = 'All Types';
    } else if (selected.length === 1) {
      label.textContent = ACCOUNT_TYPE_LABELS[selected[0]];
    } else {
      label.textContent = `${selected.length} types`;
    }
  }

  function onAccountTypeChange() {
    updateAccountTypeLabel();
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    refreshDashboard();
  }

  function selectAllAccountTypes() {
    document.querySelectorAll('#accountTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onAccountTypeChange();
  }

  function clearAccountTypes() {
    document.querySelectorAll('#accountTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onAccountTypeChange();
  }

  // ═══════════════════════════════════════════
  // ENGAGEMENT TYPE MULTI-SELECT
  // ═══════════════════════════════════════════
  function toggleEngagementTypeMenu() {
    // Close other menus if open
    document.getElementById('accountTypeMenu')?.classList.remove('open');
    document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
    document.getElementById('accountsMenu')?.classList.remove('open');
    document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
    document.getElementById('dmMenu')?.classList.remove('open');
    document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
    document.getElementById('cloudPlatformsMenu')?.classList.remove('open');
    document.querySelector('#filterCloudPlatforms .multi-select-btn')?.classList.remove('open');
    document.getElementById('actionsMenu')?.classList.remove('open');
    document.getElementById('actionsToggle')?.classList.remove('open');

    const menu = document.getElementById('engagementTypeMenu');
    const btn = document.querySelector('#filterEngagementType .multi-select-btn');
    const isOpen = menu.classList.contains('open');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
    if (!isOpen) btn.focus();
  }

  function updateEngagementTypeLabel() {
    const selected = getSelectedEngagementTypes();
    const label = document.getElementById('engagementTypeLabel');
    if (selected.length === 0) {
      label.textContent = 'None';
    } else if (selected.length === ENGAGEMENT_TYPES.length) {
      label.textContent = 'All Types';
    } else if (selected.length === 1) {
      label.textContent = ENGAGEMENT_TYPE_LABELS[selected[0]];
    } else {
      label.textContent = `${selected.length} types`;
    }
  }

  function onEngagementTypeChange() {
    updateEngagementTypeLabel();
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    refreshDashboard();
  }

  function selectAllEngagementTypes() {
    document.querySelectorAll('#engagementTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onEngagementTypeChange();
  }

  function clearEngagementTypes() {
    document.querySelectorAll('#engagementTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onEngagementTypeChange();
  }

  // ═══════════════════════════════════════════
  // DATABASE
  // ═══════════════════════════════════════════
  let db = null;
  const IDB_NAME = 'AISurveyDashboard';
  const IDB_STORE = 'database';
  const IDB_KEY = 'sqliteDb';

  async function initDatabase() {
    const SQL = await initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
    });

    // Try to load from IndexedDB
    const savedData = await loadFromIndexedDB();
    if (savedData) {
      db = new SQL.Database(savedData);
      // Run migrations for existing databases
      createTables();
    } else {
      db = new SQL.Database();
      createTables();
      seedSchemaOptions();
      await saveToIndexedDB();
    }
  }

  function createTables() {
    db.run(`
      CREATE TABLE IF NOT EXISTS surveys (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        account_name TEXT NOT NULL,
        exported_at TEXT NOT NULL,
        year INTEGER NOT NULL,
        quarter INTEGER NOT NULL,
        schema_version TEXT NOT NULL,
        raw_json TEXT NOT NULL,
        uploaded_at TEXT NOT NULL DEFAULT (datetime('now')),
        account_type TEXT NOT NULL DEFAULT 'other',
        delivery_manager TEXT NOT NULL DEFAULT '',
        UNIQUE(account_name, exported_at)
      )
    `);
    // Migration: add account_type to existing databases that lack the column
    try {
      db.run("ALTER TABLE surveys ADD COLUMN account_type TEXT NOT NULL DEFAULT 'other'");
    } catch (e) {
      // Column already exists — ignore
    }
    // Migration: add delivery_manager to existing databases that lack the column
    try {
      db.run("ALTER TABLE surveys ADD COLUMN delivery_manager TEXT NOT NULL DEFAULT ''");
    } catch (e) {
      // Column already exists — ignore
    }
    // Migration: add forecasted_service_revenue to existing databases
    try {
      db.run("ALTER TABLE surveys ADD COLUMN forecasted_service_revenue REAL DEFAULT 0");
    } catch (e) {
      // Column already exists — ignore
    }
    db.run(`
      CREATE TABLE IF NOT EXISTS schema_options (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        section TEXT NOT NULL,
        subsection TEXT NOT NULL,
        option_id TEXT NOT NULL,
        option_label TEXT NOT NULL,
        option_type TEXT NOT NULL,
        display_order INTEGER DEFAULT 0,
        UNIQUE(section, subsection, option_id)
      )
    `);
  }

  function seedSchemaOptions() {
    const stmt = db.prepare('INSERT OR IGNORE INTO schema_options (section, subsection, option_id, option_label, option_type, display_order) VALUES (?, ?, ?, ?, ?, ?)');
    SCHEMA_SEED.forEach(s => {
      stmt.run([s.section, s.subsection, s.option_id, s.option_label, s.option_type, s.display_order]);
    });
    stmt.free();
  }

  // ═══════════════════════════════════════════
  // IndexedDB Persistence
  // ═══════════════════════════════════════════
  function openIDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = () => {
        req.result.createObjectStore(IDB_STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function saveToIndexedDB() {
    const data = db.export();
    const idb = await openIDB();
    return new Promise((resolve, reject) => {
      const tx = idb.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).put(data, IDB_KEY);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function loadFromIndexedDB() {
    try {
      const idb = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = idb.transaction(IDB_STORE, 'readonly');
        const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
        req.onsuccess = () => resolve(req.result ? new Uint8Array(req.result) : null);
        req.onerror = () => reject(req.error);
      });
    } catch { return null; }
  }

  // ═══════════════════════════════════════════
  // MATURITY INFO MODAL
  // ═══════════════════════════════════════════
  function openMaturityInfoModal() {
    document.getElementById('maturityInfoModal').classList.add('open');
  }
  function closeMaturityInfoModal() {
    document.getElementById('maturityInfoModal').classList.remove('open');
  }

  function openStageDescriptionModal() {
    if (!currentMedianStage) return;
    const info = MATURITY_DESCRIPTIONS[currentMedianStage];
    if (!info) return;
    document.getElementById('stageDescriptionContent').innerHTML = `
      <h2 style="margin-top:0;font-size:1.25rem;">${info.title}</h2>
      <p style="color:#444;font-size:0.97rem;line-height:1.7;">${info.desc}</p>`;
    document.getElementById('stageDescriptionModal').classList.add('open');
  }

  function closeStageDescriptionModal() {
    document.getElementById('stageDescriptionModal').classList.remove('open');
  }

  function openAiUsageInfoModal() {
    const contentEl = document.getElementById('aiUsageInfoContent');
    contentEl.innerHTML = AI_USAGE_ORDER.filter(k => k !== 'dont-know' && k !== 'not-using').map(k => {
      const info = AI_USAGE_DESCRIPTIONS[k];
      if (!info) return '';
      const examplesHtml = info.examples.map(ex =>
        `<li style="padding:0.25rem 0;color:#374151;font-size:0.88rem;line-height:1.5;">${ex}</li>`
      ).join('');
      return `<div class="info-modal-stage" style="border-left:4px solid ${AI_USAGE_COLOR};padding-left:1rem;margin-bottom:1.25rem;">
        <h3 style="margin:0 0 0.4rem;font-size:1rem;">${info.title}</h3>
        <p style="color:#444;font-size:0.92rem;line-height:1.6;margin:0 0 0.6rem;">${info.desc}</p>
        <div style="background:#f9fafb;border-radius:8px;padding:0.6rem 1rem;">
          <div style="font-size:0.78rem;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.3rem;">Examples</div>
          <ul style="margin:0;padding-left:1.25rem;">${examplesHtml}</ul>
        </div>
      </div>`;
    }).join('');
    document.getElementById('aiUsageInfoModal').classList.add('open');
  }
  function closeAiUsageInfoModal() {
    document.getElementById('aiUsageInfoModal').classList.remove('open');
  }

  function openWfmInfoModal() {
    document.getElementById('wfmInfoModal').classList.add('open');
  }
  function closeWfmInfoModal() {
    document.getElementById('wfmInfoModal').classList.remove('open');
  }

  function openWfmStageDescriptionModal() {
    if (currentWfmStage === null) return;
    openWfmStageDetailModal(currentWfmStage);
  }

  function openWfmStageDetailModal(stage) {
    const info = WFM_DESCRIPTIONS[stage];
    if (!info) return;
    const signals = WFM_SIGNALS[stage] || [];
    const signalsExpanded = WFM_SIGNALS_EXPANDED[stage] || signals;
    const color = WFM_COLORS[stage];

    const signalsHtml = signalsExpanded.length > 0
      ? `<div style="margin-top:1.25rem;">
          <h3 style="font-size:0.95rem;font-weight:700;color:#1f2937;margin:0 0 0.6rem;">
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:0.4rem;vertical-align:middle;"></span>
            Signals
          </h3>
          <ul style="margin:0;padding-left:1.25rem;list-style:none;">
            ${signalsExpanded.map((s, i) => `<li style="padding:0.35rem 0;color:#374151;font-size:0.88rem;line-height:1.5;border-bottom:1px solid #f3f4f6;">
              <span style="color:${color};font-weight:700;margin-right:0.4rem;">${signals[i] || ''}</span>
              <span style="display:block;color:#6b7280;font-size:0.82rem;margin-top:0.15rem;">${s}</span>
            </li>`).join('')}
          </ul>
        </div>`
      : '';

    document.getElementById('stageDescriptionContent').innerHTML = `
      <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;">
        <span style="display:inline-flex;align-items:center;justify-content:center;padding:3px 10px;border-radius:10px;background:${color};color:#fff;font-size:0.75rem;font-weight:700;white-space:nowrap;">Stage ${stage}</span>
        <h2 style="margin:0;font-size:1.25rem;">${info.title.replace(/^Stage \d+ — /, '')}</h2>
      </div>
      <p style="color:#444;font-size:0.95rem;line-height:1.7;margin:0 0 0.5rem;">${info.desc}</p>
      ${signalsHtml}`;
    document.getElementById('stageDescriptionModal').classList.add('open');
  }

  // ═══════════════════════════════════════════
  // ACCOUNT MATURITY COMPARISON MODAL
  // ═══════════════════════════════════════════
  function openAccountComparisonModal() {
    const surveys = getFilteredSurveys();

    // Build per-account data: name, id, raw avg, rounded stage
    const accountRows = [];
    surveys.forEach(s => {
      const avg = getWfmAverage(s);
      if (avg < 0) return; // skip accounts with no WFM data
      accountRows.push({
        name: s.account_name,
        id: s.id,
        avg: avg,
        rounded: Math.round(avg)
      });
    });

    // Sort alphabetically by account name
    accountRows.sort((a, b) => a.name.localeCompare(b.name));

    // Color palette matching screenshot: light fills with stronger color at the reached stage
    const FILL_COLORS = {
      0: '#e5e7eb', // Gray
      1: '#fecdd3', // Light pink/red
      2: '#fde68a', // Light amber
      3: '#fde68a', // Light amber
      4: '#bbf7d0', // Light green
      5: '#86efac'  // Medium green
    };
    const MARKER_COLORS = {
      0: '#9ca3af', // Gray
      1: '#f87171', // Red
      2: '#fbbf24', // Amber
      3: '#f59e0b', // Darker amber
      4: '#4ade80', // Green
      5: '#22c55e'  // Dark green
    };

    const tbody = document.getElementById('comparisonMatrixBody');

    if (accountRows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#6b7280;">No accounts with workflow maturity data match the current filters.</td></tr>';
    } else {
      tbody.innerHTML = accountRows.map(account => {
        const linkIcon = account.id
          ? `<a href="account-detail.html?id=${account.id}" class="account-link-icon" title="View account details" onclick="event.stopPropagation();">↗</a>`
          : '';

        const cells = WFM_STAGES.map(stageIdx => {
          if (stageIdx <= account.rounded) {
            if (stageIdx === account.rounded) {
              // The reached stage: full color fill with marker
              return `<td style="text-align:center;">
                <div class="stage-fill" style="background:${FILL_COLORS[stageIdx]};display:flex;align-items:center;justify-content:center;">
                  <span class="stage-marker" style="background:${MARKER_COLORS[stageIdx]};"></span>
                </div>
              </td>`;
            } else {
              // Stages below the reached stage: light color fill
              return `<td><div class="stage-fill" style="background:${FILL_COLORS[stageIdx]};"></div></td>`;
            }
          } else {
            // Stages beyond the reached stage: empty
            return '<td></td>';
          }
        }).join('');

        return `<tr>
          <td class="account-name-cell">${escapeHtml(account.name)}${linkIcon}</td>
          ${cells}
        </tr>`;
      }).join('');
    }

    document.getElementById('accountComparisonModal').classList.add('open');
  }

  function closeAccountComparisonModal() {
    document.getElementById('accountComparisonModal').classList.remove('open');
  }

  function openSdlcPhaseModal(phaseKey) {
    const phase = SDLC_PHASES.find(p => p.key === phaseKey);
    if (!phase) return;

    document.getElementById('sdlcPhaseModalTitle').textContent = `${phase.label} — Use Case Breakdown`;

    // Get use case labels from SCHEMA_SEED
    const useCaseOptions = SCHEMA_SEED
      .filter(s => s.section === 'useCases' && s.subsection === phaseKey)
      .sort((a, b) => a.display_order - b.display_order);

    // Get currently filtered surveys
    const surveys = getFilteredSurveys();

    // Calculate per-use-case stats
    const items = useCaseOptions.map(opt => {
      let doing = 0, need = 0, total = 0;
      surveys.forEach(s => {
        const item = s.data?.useCases?.[phaseKey]?.[opt.option_id];
        if (item === undefined) return;
        total++;
        if (item?.status === 'doing') doing++;
        else if (item?.status === 'need') need++;
      });
      const notUsing = total - doing - need;
      const doingPct = total > 0 ? Math.round((doing / total) * 100) : 0;
      const needPct = total > 0 ? Math.round((need / total) * 100) : 0;
      const notUsingPct = total > 0 ? 100 - doingPct - needPct : 0;
      return { label: opt.option_label, doingPct, needPct, notUsingPct };
    });

    // Sort by "Doing" descending
    items.sort((a, b) => b.doingPct - a.doingPct);

    // Build HTML
    let html = '';
    items.forEach(item => {
      const doingLabel = item.doingPct >= 12 ? `${item.doingPct}%` : '';
      const needLabel = item.needPct >= 12 ? `${item.needPct}%` : '';
      const notUsingLabel = item.notUsingPct >= 12 ? `${item.notUsingPct}%` : '';

      html += `
        <div class="sdlc-modal-item">
          <div class="sdlc-modal-header">
            <span class="sdlc-modal-label">${escapeHtml(item.label)}</span>
            <span class="sdlc-modal-pcts">
              <span class="doing">${item.doingPct}%</span>
              <span class="separator">|</span>
              <span class="need">${item.needPct}%</span>
              <span class="separator">|</span>
              <span class="not-using">${item.notUsingPct}%</span>
            </span>
          </div>
          <div class="sdlc-modal-bar">
            ${item.doingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-doing" style="width:${item.doingPct}%">${doingLabel}</div>` : ''}
            ${item.needPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-need" style="width:${item.needPct}%">${needLabel}</div>` : ''}
            ${item.notUsingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-notusing" style="width:${item.notUsingPct}%">${notUsingLabel}</div>` : ''}
          </div>
        </div>`;
    });

    // Add legend
    html += `
      <div class="sdlc-legend" style="margin-top:1.25rem;">
        <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#22c55e;"></span> Doing</span>
        <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#f59e0b;"></span> Need but not Doing</span>
        <span class="sdlc-legend-item"><span class="sdlc-legend-dot" style="background:#e5e7eb;"></span> Not Using</span>
      </div>`;

    if (surveys.length > 0) {
      html += `<div style="margin-top:0.75rem;font-size:0.75rem;color:#9ca3af;">Based on ${surveys.length} survey${surveys.length !== 1 ? 's' : ''}</div>`;
    }

    document.getElementById('sdlcPhaseModalContent').innerHTML = html;
    document.getElementById('sdlcPhaseModal').classList.add('open');
  }

  function closeSdlcPhaseModal() {
    document.getElementById('sdlcPhaseModal').classList.remove('open');
  }

  // ═══════════════════════════════════════════
  // UPLOAD
  // ═══════════════════════════════════════════
  function openUploadModal() {
    document.getElementById('uploadModal').classList.add('open');
    document.getElementById('uploadResults').innerHTML = '';
    // Pre-populate year/quarter with current values
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentQuarter = Math.ceil((now.getMonth() + 1) / 3);
    const yearSelect = document.getElementById('uploadYear');
    yearSelect.innerHTML = '';
    for (let y = currentYear + 1; y >= currentYear - 3; y--) {
      yearSelect.innerHTML += `<option value="${y}"${y === currentYear ? ' selected' : ''}>${y}</option>`;
    }
    document.getElementById('uploadQuarter').value = String(currentQuarter);
    document.getElementById('uploadDeliveryManager').value = '';
  }
  function closeUploadModal() {
    document.getElementById('uploadModal').classList.remove('open');
  }

  function validateSurveyJSON(data) {
    const errors = [];
    if (!data.schemaVersion) errors.push('Missing schemaVersion');
    if (!data.accountName) errors.push('Missing accountName');
    if (!data.exportedAt) errors.push('Missing exportedAt');
    else if (isNaN(new Date(data.exportedAt).getTime())) errors.push('Invalid exportedAt date');
    return errors;
  }

  async function processFile(file, year, quarter, accountType, deliveryManager) {
    const result = { filename: file.name, status: '', message: '' };

    try {
      let jsonText = null;

      if (file.name.endsWith('.zip')) {
        const zip = await JSZip.loadAsync(file);
        const jsonFile = Object.keys(zip.files).find(name => name.endsWith('.json'));
        if (!jsonFile) {
          result.status = 'error';
          result.message = 'No JSON file found inside ZIP';
          return result;
        }
        jsonText = await zip.files[jsonFile].async('text');
      } else if (file.name.endsWith('.json')) {
        jsonText = await file.text();
      } else {
        result.status = 'error';
        result.message = 'Unsupported file type (use .json or .zip)';
        return result;
      }

      const data = JSON.parse(jsonText);
      const errors = validateSurveyJSON(data);
      if (errors.length > 0) {
        result.status = 'error';
        result.message = errors.join(', ');
        return result;
      }

      // Check for duplicate
      const existing = db.exec('SELECT id FROM surveys WHERE account_name = ? AND exported_at = ?', [data.accountName, data.exportedAt]);
      if (existing.length > 0 && existing[0].values.length > 0) {
        // Replace existing
        db.run('DELETE FROM surveys WHERE account_name = ? AND exported_at = ?', [data.accountName, data.exportedAt]);
        result.status = 'warning';
        result.message = `Replaced existing survey for "${data.accountName}" -> ${year} Q${quarter}`;
      } else {
        result.status = 'success';
        result.message = `Imported "${data.accountName}" -> ${year} Q${quarter}`;
      }

      db.run(
        'INSERT INTO surveys (account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
        [data.accountName, data.exportedAt, year, quarter, data.schemaVersion, jsonText, accountType, deliveryManager]
      );

    } catch (e) {
      result.status = 'error';
      result.message = `Parse error: ${e.message}`;
    }

    return result;
  }

  async function handleFiles(files) {
    const year = parseInt(document.getElementById('uploadYear').value);
    const quarter = parseInt(document.getElementById('uploadQuarter').value);
    const accountType = document.getElementById('uploadAccountType').value;
    const deliveryManager = document.getElementById('uploadDeliveryManager').value.trim();
    const resultsDiv = document.getElementById('uploadResults');
    resultsDiv.innerHTML = '<div style="color:#6b7280;font-size:0.85rem;padding:0.5rem 0;">Processing...</div>';

    const results = [];
    for (const file of files) {
      results.push(await processFile(file, year, quarter, accountType, deliveryManager));
    }

    await saveToIndexedDB();

    // Display results
    resultsDiv.innerHTML = results.map(r => {
      const icon = r.status === 'success' ? '✅' : r.status === 'warning' ? '⚠️' : '❌';
      const cls = r.status === 'success' ? 'upload-result-success' : r.status === 'warning' ? 'upload-result-warning' : 'upload-result-error';
      return `<div class="upload-result-item">
        <span class="upload-result-icon">${icon}</span>
        <span class="upload-result-text ${cls}"><strong>${r.filename}</strong> - ${r.message}</span>
      </div>`;
    }).join('');

    // Refresh dashboard
    populateFilters();
    refreshDashboard();
  }

  // ═══════════════════════════════════════════
  // FILTERS
  // ═══════════════════════════════════════════
  function populateFilters() {
    const yearSelect = document.getElementById('filterYear');
    const rows = db.exec('SELECT DISTINCT year FROM surveys ORDER BY year DESC');
    const years = rows.length > 0 ? rows[0].values.map(r => r[0]) : [];

    const currentVal = yearSelect.value;
    yearSelect.innerHTML = '<option value="all">All Years</option>';
    years.forEach(y => {
      yearSelect.innerHTML += `<option value="${y}"${y == currentVal ? ' selected' : ''}>${y}</option>`;
    });
    if (currentVal && currentVal !== 'all' && years.includes(parseInt(currentVal))) {
      yearSelect.value = currentVal;
    }

    populateAccountsFilter();
    populateDMFilter();
  }

  function getSelectedAccountTypes() {
    const checkboxes = document.querySelectorAll('#accountTypeMenu input[type="checkbox"]');
    const selected = [];
    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
    return selected;
  }

  function getSelectedEngagementTypes() {
    const checkboxes = document.querySelectorAll('#engagementTypeMenu input[type="checkbox"]');
    const selected = [];
    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
    return selected;
  }

  function getFilteredSurveys() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const selectedTypes = getSelectedAccountTypes();

    // No types selected = no results
    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager, forecasted_service_revenue FROM surveys WHERE 1=1';
    const params = [];
    if (year !== 'all') { sql += ' AND year = ?'; params.push(parseInt(year)); }
    if (quarter !== 'all') { sql += ' AND quarter = ?'; params.push(parseInt(quarter)); }
    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    let surveys = result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || '', forecasted_service_revenue: row[9] || 0
    }));

    // Apply engagement type filter (structural filter on JSON data)
    const selectedEngagementTypes = getSelectedEngagementTypes();
    if (selectedEngagementTypes.length === 0) return [];
    if (selectedEngagementTypes.length < ENGAGEMENT_TYPES.length) {
      surveys = surveys.filter(s => {
        const ownership = s.data?.engagement?.ownership;
        if (!ownership) return false;
        return selectedEngagementTypes.some(type => ownership[type]?.selected === true);
      });
    }

    // Apply maturity filter (post-query JS filter)
    if (activeMaturityFilter) {
      surveys = surveys.filter(s =>
        s.data?.clientAILandscape?.maturity?.value === activeMaturityFilter
      );
    }

    // Apply account filter (multi-select)
    if (selectedAccounts.size > 0) {
      surveys = surveys.filter(s => selectedAccounts.has(s.account_name));
    }

    // Apply delivery manager filter (multi-select)
    if (selectedDeliveryManagers.size > 0) {
      surveys = surveys.filter(s => selectedDeliveryManagers.has(s.delivery_manager));
    }

    // Apply limiting factor filter
    if (activeLimitingFactorFilter) {
      surveys = surveys.filter(s => {
        const lf = s.data?.limitingFactors?.[activeLimitingFactorFilter];
        return lf && (lf.rank === 1 || lf.rank === 2);
      });
    }

    // Apply workflow maturity stage filter
    if (activeWfmStageFilter !== null) {
      surveys = surveys.filter(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return false;
        const stages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') stages.push(st);
        });
        if (stages.length === 0) return false;
        const avg = stages.reduce((a, b) => a + b, 0) / stages.length;
        return Math.round(avg) === activeWfmStageFilter;
      });
    }

    // Apply AI tool filter
    if (activeAiToolFilter) {
      surveys = surveys.filter(s => {
        const aiTools = s.data?.toolsAndInfrastructure?.ai;
        if (!aiTools) return false;
        if (activeAiToolFilter === '_custom') {
          return Array.isArray(aiTools.custom) && aiTools.custom.length > 0;
        }
        return aiTools[activeAiToolFilter]?.selected === true;
      });
    }

    // Apply cloud platform multi-select filter (top bar dropdown)
    const selectedCloudPlatforms = getSelectedCloudPlatforms();
    if (selectedCloudPlatforms.length < CLOUD_PLATFORM_ORDER.length) {
      if (selectedCloudPlatforms.length === 0) return [];
      surveys = surveys.filter(s => {
        const cloud = s.data?.toolsAndInfrastructure?.cloud;
        if (!cloud) return false;
        return selectedCloudPlatforms.some(k => cloud[k]?.selected === true);
      });
    }

    // Apply cloud platform single-click filter (chart bar click)
    if (activeCloudPlatformFilter) {
      surveys = surveys.filter(s => {
        const cloud = s.data?.toolsAndInfrastructure?.cloud;
        if (!cloud) return false;
        return cloud[activeCloudPlatformFilter]?.selected === true;
      });
    }

    // Apply AI challenge filter
    if (activeAiChallengeFilter) {
      surveys = surveys.filter(s => {
        const ch = s.data?.clientAILandscape?.challenges?.[activeAiChallengeFilter];
        return ch && (ch.rank === 1 || ch.rank === 2);
      });
    }

    // Apply AI usage filter
    if (activeAiUsageFilter) {
      surveys = surveys.filter(s => {
        const usage = s.data?.clientAILandscape?.usage;
        if (!usage) return false;
        return usage[activeAiUsageFilter]?.selected === true;
      });
    }

    // Apply AI champion filter
    if (activeChampionFilter) {
      surveys = surveys.filter(s => {
        const val = s.data?.teamRoles?.aiChampion?.value;
        if (activeChampionFilter === 'yes') return val === 'yes';
        return val !== 'yes'; // 'no' or missing
      });
    }

    // Apply AI adoption filter (top bar dropdown)
    if (activeAiAdoptionFilter && activeAiAdoptionFilter !== 'all') {
      surveys = surveys.filter(s => {
        const hasAi = surveyHasAiTools(s);
        return activeAiAdoptionFilter === 'using' ? hasAi : !hasAi;
      });
    }

    return surveys;
  }

  // Get all surveys for year/quarter/type (ignoring maturity/account name filters) for the widget itself
  function getAllFilteredSurveys() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const selectedTypes = getSelectedAccountTypes();

    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager, forecasted_service_revenue FROM surveys WHERE 1=1';
    const params = [];
    if (year !== 'all') { sql += ' AND year = ?'; params.push(parseInt(year)); }
    if (quarter !== 'all') { sql += ' AND quarter = ?'; params.push(parseInt(quarter)); }
    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    let surveys = result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || '', forecasted_service_revenue: row[9] || 0
    }));

    // Apply engagement type filter (structural filter on JSON data)
    const selectedEngagementTypes = getSelectedEngagementTypes();
    if (selectedEngagementTypes.length === 0) return [];
    if (selectedEngagementTypes.length < ENGAGEMENT_TYPES.length) {
      surveys = surveys.filter(s => {
        const ownership = s.data?.engagement?.ownership;
        if (!ownership) return false;
        return selectedEngagementTypes.some(type => ownership[type]?.selected === true);
      });
    }

    return surveys;
  }

  // ═══════════════════════════════════════════
  // DASHBOARD RENDERING
  // ═══════════════════════════════════════════
  let charts = {};

  function refreshDashboardComparison(allSurveys, totalCount) {
    const surveysA = getFilteredSurveysForGroup(groupA.filters);
    const surveysB = getFilteredSurveysForGroup(groupB.filters);
    const nameA = groupA.name;
    const nameB = groupB.name;

    // Show/hide states
    document.getElementById('emptyState').style.display = totalCount === 0 ? 'block' : 'none';
    document.getElementById('dashboardContent').style.display = totalCount > 0 ? 'block' : 'none';

    // Update banner
    const banner = document.getElementById('comparisonBanner');
    banner.classList.add('active');
    document.getElementById('compareNameA').textContent = `${nameA} (${surveysA.length})`;
    document.getElementById('compareNameB').textContent = `${nameB} (${surveysB.length})`;

    // Update subtitle
    const subtitleEl = document.getElementById('headerSubtitle');
    subtitleEl.innerHTML = `⚖ Comparing: <strong style="color:${COMPARE_COLOR_A}">${escapeHtml(nameA)}</strong> (${surveysA.length}) vs <strong style="color:${COMPARE_COLOR_B}">${escapeHtml(nameB)}</strong> (${surveysB.length})`;

    if (totalCount === 0) return;

    // Widget comparisons
    renderAdoptionStageComparison(surveysA, surveysB, nameA, nameB);
    renderAiChallengesComparison(surveysA, surveysB, nameA, nameB);
    renderAiUsageComparison(surveysA, surveysB, nameA, nameB);
    updateSectionSummaryComparison(surveysA, surveysB, nameA, nameB);

    renderWorkflowMaturityComparison(surveysA, surveysB, allSurveys, nameA, nameB);
    renderLimitingFactorsComparison(surveysA, surveysB, nameA, nameB);
    renderAiToolsComparison(surveysA, surveysB, nameA, nameB);
    renderRoleToolMatrixComparison(surveysA, surveysB, nameA, nameB);
    renderCloudPlatformsComparison(surveysA, surveysB, nameA, nameB);
    renderSdlcCoverageComparison(surveysA, surveysB, nameA, nameB);
    renderAiAdoptionByRoleComparison(surveysA, surveysB, nameA, nameB);
    renderAiChampionComparison(surveysA, surveysB, nameA, nameB);
    renderAiAdoptionWidgetComparison(surveysA, surveysB, nameA, nameB);
    updateAccountSectionSummaryComparison(surveysA, surveysB, nameA, nameB);

    renderSurveysTableComparison(allSurveys, surveysA, surveysB, nameA, nameB);
    updateSurveysSectionSummaryComparison(surveysA, surveysB, nameA, nameB);

    // Sync dropdowns
    populateAccountsFilter();
    populateDMFilter();
  }

  function refreshDashboard() {
    const surveys = getFilteredSurveys();
    const allSurveys = getAllFilteredSurveys(); // for the widget (unfiltered by maturity)
    const totalAll = db.exec('SELECT COUNT(*) FROM surveys');
    const totalCount = totalAll.length > 0 ? totalAll[0].values[0][0] : 0;

    // ── Comparison Mode Branch ──
    if (comparisonMode) {
      refreshDashboardComparison(allSurveys, totalCount);
      return;
    }
    document.getElementById('comparisonBanner').classList.remove('active');

    // Update subtitle
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    let filterDesc = '';
    if (year !== 'all') filterDesc += year;
    if (quarter !== 'all') filterDesc += (filterDesc ? ' ' : '') + 'Q' + quarter;

    let subtitleText = '';
    if (allSurveys.length > 0) {
      if (surveys.length < allSurveys.length) {
        subtitleText = `Showing ${surveys.length} of ${allSurveys.length} survey${allSurveys.length !== 1 ? 's' : ''}${filterDesc ? ' for ' + filterDesc : ''}`;
      } else {
        subtitleText = `Showing ${surveys.length} survey${surveys.length !== 1 ? 's' : ''}${filterDesc ? ' for ' + filterDesc : ''}`;
      }
    } else if (totalCount > 0) {
      subtitleText = 'No surveys match the selected filters';
    } else {
      subtitleText = 'No surveys uploaded yet';
    }

    const subtitleEl = document.getElementById('headerSubtitle');
    let filterTags = '';
    if (activeMaturityFilter) {
      filterTags += ` <span class="filter-active-tag">Stage: ${MATURITY_LABELS[activeMaturityFilter]} <span class="filter-clear-x" onclick="clearMaturityFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (selectedAccounts.size > 0) {
      const accountLabel = selectedAccounts.size === 1 ? escapeHtml([...selectedAccounts][0]) : `${selectedAccounts.size} accounts`;
      filterTags += ` <span class="filter-active-tag">Account: ${accountLabel} <span class="filter-clear-x" onclick="clearAccountFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (selectedDeliveryManagers.size > 0) {
      const dmLabel = selectedDeliveryManagers.size === 1 ? escapeHtml([...selectedDeliveryManagers][0]) : `${selectedDeliveryManagers.size} DMs`;
      filterTags += ` <span class="filter-active-tag">DM: ${dmLabel} <span class="filter-clear-x" onclick="clearDMFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeLimitingFactorFilter) {
      filterTags += ` <span class="filter-active-tag">Factor: ${LIMITING_FACTOR_LABELS[activeLimitingFactorFilter]} <span class="filter-clear-x" onclick="clearLimitingFactorFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeWfmStageFilter !== null) {
      filterTags += ` <span class="filter-active-tag">WFM: Stage ${activeWfmStageFilter} - ${WFM_LABELS[activeWfmStageFilter]} <span class="filter-clear-x" onclick="clearWfmStageFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAiToolFilter) {
      const toolLabel = activeAiToolFilter === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[activeAiToolFilter] || activeAiToolFilter);
      filterTags += ` <span class="filter-active-tag">Tool: ${toolLabel} <span class="filter-clear-x" onclick="clearAiToolFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAiChallengeFilter) {
      filterTags += ` <span class="filter-active-tag">Challenge: ${AI_CHALLENGE_LABELS[activeAiChallengeFilter] || activeAiChallengeFilter} <span class="filter-clear-x" onclick="clearAiChallengeFilter()" title="Clear filter">&times;</span></span>`;
    }
    const _cpSel = getSelectedCloudPlatforms();
    if (_cpSel.length > 0 && _cpSel.length < CLOUD_PLATFORM_ORDER.length) {
      const cpLabel = _cpSel.length === 1 ? (CLOUD_PLATFORM_LABELS[_cpSel[0]] || _cpSel[0]) : `${_cpSel.length} Platforms`;
      filterTags += ` <span class="filter-active-tag">Platform: ${cpLabel} <span class="filter-clear-x" onclick="clearCloudPlatformFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAiUsageFilter) {
      filterTags += ` <span class="filter-active-tag">Usage: ${AI_USAGE_LABELS[activeAiUsageFilter] || activeAiUsageFilter} <span class="filter-clear-x" onclick="clearAiUsageFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAiAdoptionFilter && activeAiAdoptionFilter !== 'all') {
      const adoptLabel = activeAiAdoptionFilter === 'using' ? 'Using AI Tools' : 'Not Using AI Tools';
      filterTags += ` <span class="filter-active-tag">Adoption: ${adoptLabel} <span class="filter-clear-x" onclick="clearAiAdoptionFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (filterTags) {
      subtitleEl.innerHTML = `${subtitleText}${filterTags}`;
    } else {
      subtitleEl.textContent = subtitleText;
    }

    // Show/hide states
    document.getElementById('emptyState').style.display = totalCount === 0 ? 'block' : 'none';
    document.getElementById('dashboardContent').style.display = totalCount > 0 ? 'block' : 'none';

    if (totalCount === 0) return;

    // Adoption Stage Widget — percentages reflect active filters
    renderAdoptionStageWidget(surveys);

    // Account AI Agentic Workflow — callout reflects filters, circles show all with dimming
    renderWorkflowMaturityWidget(surveys, allSurveys);

    // Limiting Factors Widget — reflects active filters, dimmed/highlighted via filter state
    renderLimitingFactorsWidget(surveys);

    // AI Challenges Widget — reflects active filters, dimmed/highlighted via filter state
    renderAiChallengesWidget(surveys);

    // AI Usage Widget — reflects active filters, dimmed/highlighted via filter state
    renderAiUsageWidget(surveys);

    // Collapsed section summary (must run after renderAdoptionStageWidget sets currentMedianStage)
    updateSectionSummary(surveys);

    // AI Tools Usage Widget — reflects active filters, dimmed/highlighted via filter state
    renderAiToolsWidget(surveys);
    renderRoleToolMatrixWidget(surveys);
    renderCloudPlatformsWidget(surveys);
    renderSdlcCoverageWidget(surveys);
    renderAiAdoptionByRoleWidget(surveys);
    renderAiChampionWidget(surveys);
    renderAiAdoptionWidget(allSurveys);

    // Collapsed account section summary (must run after renderWorkflowMaturityWidget sets currentWfmStage)
    updateAccountSectionSummary(surveys);

    // Surveys table — show all rows, dim non-matching
    renderSurveysTable(allSurveys, surveys);

    // Sync accounts and DM dropdowns with current data
    populateAccountsFilter();
    populateDMFilter();

    // Collapsed surveys section summary
    updateSurveysSectionSummary(surveys, allSurveys);
  }


  function calculateAiUsagePercent(surveys) {
    if (surveys.length === 0) return null;
    const EXCLUDED_KEYS = ['dont-know', 'not-applicable', 'custom', '_meta'];
    let usesAiCount = 0;

    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;

      const hasNamedTool = Object.keys(aiTools).some(key =>
        !EXCLUDED_KEYS.includes(key) && aiTools[key]?.selected === true
      );
      const hasCustomTool = Array.isArray(aiTools.custom) && aiTools.custom.length > 0;

      if (hasNamedTool || hasCustomTool) usesAiCount++;
    });

    return Math.round((usesAiCount / surveys.length) * 100);
  }


  // ═══════════════════════════════════════════
  // CHART HELPERS
  // ═══════════════════════════════════════════
  const CHART_COLORS = {
    primary: '#4f46e5',
    primaryLight: 'rgba(79, 70, 229, 0.7)',
    secondary: '#06b6d4',
    secondaryLight: 'rgba(6, 182, 212, 0.7)',
    success: '#10b981',
    warning: '#f59e0b',
    danger: '#ef4444',
    gray: '#9ca3af',
    palette: ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1']
  };

  function destroyChart(id) {
    if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    // Also check if Chart.js has a chart on this canvas (safety net)
    const canvas = document.getElementById(id);
    if (canvas) {
      const existing = Chart.getChart(canvas);
      if (existing) existing.destroy();
      // Replace canvas element with a fresh one to clear any residual state
      // from previous renders (e.g. 0×0 initialization in hidden containers)
      const fresh = document.createElement('canvas');
      fresh.id = id;
      canvas.parentNode.replaceChild(fresh, canvas);
    }
  }

  // ═══════════════════════════════════════════
  // ADOPTION STAGE WIDGET
  // ═══════════════════════════════════════════

  function renderAdoptionStageWidget(surveys) {
    // Count all maturity values including dont-know
    const counts = {};
    MATURITY_ORDER.forEach(k => counts[k] = 0);
    let totalAll = 0;
    let totalKnown = 0; // excludes dont-know (for weighted average)

    surveys.forEach(s => {
      const val = s.data?.clientAILandscape?.maturity?.value;
      if (val && MATURITY_ORDER.includes(val)) {
        counts[val]++;
        totalAll++;
        if (val !== 'dont-know') totalKnown++;
      }
    });

    // Calculate percentages over total (including dont-know)
    const pcts = {};
    MATURITY_ORDER.forEach(k => {
      pcts[k] = totalAll > 0 ? Math.round((counts[k] / totalAll) * 100) : 0;
    });

    // Calculate median stage index (excluding dont-know)
    const knownIndices = [];
    MATURITY_STAGES.forEach((k, i) => {
      for (let n = 0; n < counts[k]; n++) knownIndices.push(i);
    });
    let medianIndex = -1;
    if (knownIndices.length > 0) {
      const mid = Math.floor(knownIndices.length / 2);
      medianIndex = knownIndices.length % 2 === 1
        ? knownIndices[mid]
        : (knownIndices[mid - 1] + knownIndices[mid]) / 2;
    }
    const avgPosition = totalKnown > 0 ? medianIndex / (MATURITY_STAGES.length - 1) : 0.5;
    const avgStage = totalKnown > 0 ? MATURITY_STAGES[Math.round(medianIndex)] : null;
    currentMedianStage = avgStage;
    currentStagePosition = avgPosition;

    // Update callout
    const calloutValue = document.getElementById('stageCalloutValue');
    if (avgStage) {
      const avgPct = pcts[avgStage] || 0;
      calloutValue.innerHTML = `${MATURITY_ICONS[avgStage]} ${MATURITY_LABELS[avgStage]} (${avgPct}%)`;
    } else {
      calloutValue.textContent = '--';
    }

    // Render stage pipeline (all stages including dont-know)
    const pipeline = document.getElementById('stagePipeline');
    pipeline.innerHTML = MATURITY_ORDER.map((stage, i) => {
      const isActive = activeMaturityFilter === stage;
      const isDimmed = activeMaturityFilter && !isActive;
      const borderColor = isActive ? MATURITY_COLORS[stage] : '#e5e7eb';
      const bgColor = isActive ? (MATURITY_COLORS[stage] + '15') : '#fff';
      const shadowColor = isActive ? (MATURITY_COLORS[stage] + '40') : 'transparent';
      const dimStyle = isDimmed ? 'opacity:0.35;' : '';
      const connector = i < MATURITY_ORDER.length - 1
        ? '<div class="stage-connector">&#9654;</div>'
        : '';
      return `<div class="stage-card ${isActive ? 'active' : ''}"
                   onclick="setMaturityFilter('${stage}')"
                   style="${dimStyle}border-color:${borderColor};background:${bgColor};${isActive ? 'box-shadow:0 0 0 3px ' + shadowColor + ', 0 6px 20px rgba(0,0,0,0.12);' : ''}"
                   title="Click to filter by ${MATURITY_LABELS[stage]}">
        <div class="stage-card-icon">${MATURITY_ICONS[stage]}</div>
        <div class="stage-card-label">${MATURITY_LABELS[stage]}</div>
        <div class="stage-card-pct" style="color:${MATURITY_COLORS[stage]};">${pcts[stage]}%</div>
        <div class="stage-card-count">${counts[stage]} account${counts[stage] !== 1 ? 's' : ''}</div>
      </div>${connector}`;
    }).join('');

    // Update progress bar marker position (index-based, no DOM measurement needed)
    const marker = document.getElementById('progressMarker');
    const targetStageKey = activeMaturityFilter || avgStage;

    if (totalAll === 0 || !targetStageKey) {
      marker.style.display = 'none';
    } else {
      marker.style.display = '';
      const idx = MATURITY_ORDER.indexOf(targetStageKey);
      const total = MATURITY_ORDER.length;
      if (idx >= 0) {
        const pct = Math.max(2, Math.min(98, ((idx + 0.5) / total) * 100));
        marker.style.left = pct + '%';
      }
    }

    // Render legend (all stages including dont-know)
    const legend = document.getElementById('widgetLegend');
    legend.innerHTML = MATURITY_ORDER.map(stage =>
      `<div class="legend-item">
        <div class="legend-dot" style="background:${MATURITY_COLORS[stage]};"></div>
        <span>${MATURITY_LABELS[stage]}</span>
      </div>`
    ).join('');

    // Show/hide filter footer
    const footer = document.getElementById('widgetFooter');
    const _cpSelFooter = getSelectedCloudPlatforms();
    const _cpHasFilter = _cpSelFooter.length > 0 && _cpSelFooter.length < CLOUD_PLATFORM_ORDER.length;
    const hasAnyFilter = activeMaturityFilter || selectedAccounts.size > 0 || selectedDeliveryManagers.size > 0 || activeLimitingFactorFilter || activeAiToolFilter || _cpHasFilter || activeAiChallengeFilter || activeAiUsageFilter || activeWfmStageFilter !== null || (activeAiAdoptionFilter && activeAiAdoptionFilter !== 'all');
    if (hasAnyFilter) {
      footer.style.display = 'flex';
      let tags = '';
      if (activeMaturityFilter) {
        tags += `<span class="filter-active-tag">Stage: ${MATURITY_LABELS[activeMaturityFilter]} <span class="filter-clear-x" onclick="clearMaturityFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (selectedAccounts.size > 0) {
        const accountLabel = selectedAccounts.size === 1 ? escapeHtml([...selectedAccounts][0]) : `${selectedAccounts.size} accounts`;
        tags += `<span class="filter-active-tag">Account: ${accountLabel} <span class="filter-clear-x" onclick="clearAccountFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (selectedDeliveryManagers.size > 0) {
        const dmLabel = selectedDeliveryManagers.size === 1 ? escapeHtml([...selectedDeliveryManagers][0]) : `${selectedDeliveryManagers.size} DMs`;
        tags += `<span class="filter-active-tag">DM: ${dmLabel} <span class="filter-clear-x" onclick="clearDMFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeLimitingFactorFilter) {
        tags += `<span class="filter-active-tag">Factor: ${LIMITING_FACTOR_LABELS[activeLimitingFactorFilter]} <span class="filter-clear-x" onclick="clearLimitingFactorFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeWfmStageFilter !== null) {
        tags += `<span class="filter-active-tag">WFM: Stage ${activeWfmStageFilter} - ${WFM_LABELS[activeWfmStageFilter]} <span class="filter-clear-x" onclick="clearWfmStageFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAiToolFilter) {
        const toolLabel = activeAiToolFilter === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[activeAiToolFilter] || activeAiToolFilter);
        tags += `<span class="filter-active-tag">Tool: ${toolLabel} <span class="filter-clear-x" onclick="clearAiToolFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (_cpHasFilter) {
        const _cpLabelFooter = _cpSelFooter.length === 1 ? (CLOUD_PLATFORM_LABELS[_cpSelFooter[0]] || _cpSelFooter[0]) : `${_cpSelFooter.length} Platforms`;
        tags += `<span class="filter-active-tag">Platform: ${_cpLabelFooter} <span class="filter-clear-x" onclick="clearCloudPlatformFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAiChallengeFilter) {
        tags += `<span class="filter-active-tag">Challenge: ${AI_CHALLENGE_LABELS[activeAiChallengeFilter] || activeAiChallengeFilter} <span class="filter-clear-x" onclick="clearAiChallengeFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAiUsageFilter) {
        tags += `<span class="filter-active-tag">Usage: ${AI_USAGE_LABELS[activeAiUsageFilter] || activeAiUsageFilter} <span class="filter-clear-x" onclick="clearAiUsageFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAiAdoptionFilter && activeAiAdoptionFilter !== 'all') {
        const adoptLabel = activeAiAdoptionFilter === 'using' ? 'Using AI Tools' : 'Not Using AI Tools';
        tags += `<span class="filter-active-tag">Adoption: ${adoptLabel} <span class="filter-clear-x" onclick="clearAiAdoptionFilter()" title="Clear filter">&times;</span></span>`;
      }
      document.getElementById('activeFilterTags').innerHTML = tags;
    } else {
      footer.style.display = 'none';
    }

    // Widget summary
    const adoptionStageSummary = document.getElementById('adoptionStageSummary');
    if (adoptionStageSummary) {
      if (avgStage) {
        adoptionStageSummary.innerHTML = `<span class="widget-summary-label">Median:</span> <span class="widget-summary-value">${MATURITY_LABELS[avgStage]} (${pcts[avgStage]}%)</span>`;
      } else {
        adoptionStageSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  function renderWorkflowMaturityWidget(filteredSurveys, allSurveys) {
    // Helper: compute per-account WFM stages from a survey set
    function computeAccountStages(surveyList) {
      const stages = [];
      surveyList.forEach(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return;
        const roleStages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
        });
        if (roleStages.length === 0) return;
        const avg = roleStages.reduce((a, b) => a + b, 0) / roleStages.length;
        stages.push(Math.round(avg));
      });
      return stages;
    }

    // 1a. Compute from ALL surveys (for circles / distribution)
    const allAccountStages = computeAccountStages(allSurveys);
    const allCounts = {};
    WFM_STAGES.forEach(s => allCounts[s] = 0);
    allAccountStages.forEach(s => { if (allCounts[s] !== undefined) allCounts[s]++; });
    const allTotal = allAccountStages.length;

    // 1b. Compute from FILTERED surveys (for callout / marker / hybrid circles)
    const filteredAccountStages = computeAccountStages(filteredSurveys);
    const filteredCounts = {};
    WFM_STAGES.forEach(s => filteredCounts[s] = 0);
    filteredAccountStages.forEach(s => { if (filteredCounts[s] !== undefined) filteredCounts[s]++; });
    const filteredTotal = filteredAccountStages.length;
    const filteredAvg = filteredTotal > 0
      ? (filteredAccountStages.reduce((a, b) => a + b, 0) / filteredTotal)
      : 0;

    // 2. Percentages — always use filtered data for percentages
    const pcts = {};
    WFM_STAGES.forEach(s => {
      pcts[s] = filteredTotal > 0 ? Math.round((filteredCounts[s] / filteredTotal) * 100) : 0;
    });

    // 3. Update badge — reflects FILTERED data, show stage name
    const avgEl = document.getElementById('wfmAvgValue');
    const roundedStage = Math.round(filteredAvg);
    currentWfmStage = filteredTotal > 0 ? roundedStage : null;
    currentWfmPosition = filteredTotal > 0 ? filteredAvg / 5 : 0.5;
    if (filteredTotal > 0) {
      const wfmPct = pcts[roundedStage] || 0;
      avgEl.textContent = `${WFM_LABELS[roundedStage]} (${wfmPct}%)`;
    } else {
      avgEl.textContent = '--';
    }

    // 6. Render journey cards (always use filtered data for %, hybrid label for WFM filter)
    const journey = document.getElementById('wfmJourney');
    journey.innerHTML = WFM_STAGES.map((stage, i) => {
      const pct = pcts[stage];
      const count = filteredCounts[stage];
      const countLabel = activeWfmStageFilter !== null
        ? `${count} of ${allCounts[stage]} total`
        : `${count} account${count !== 1 ? 's' : ''}`;
      const color = WFM_COLORS[stage];
      const isActive = activeWfmStageFilter === stage;
      const isDimmed = activeWfmStageFilter !== null && !isActive;
      const borderColor = isActive ? color : '#e5e7eb';
      const bgColor = isActive ? (color + '15') : '#fff';
      const dimStyle = isDimmed ? 'opacity:0.35;' : '';
      const shadowStyle = isActive ? `box-shadow:0 0 0 3px ${color}40, 0 6px 20px rgba(0,0,0,0.12);` : '';
      const badgeBg = pct > 0 ? (color + '30') : '#f3f4f6';
      const badgeColor = isDimmed ? '#9ca3af' : (pct > 0 ? '#374151' : '#9ca3af');
      const pctColor = isDimmed ? '#9ca3af' : color;
      const labelWeight = isActive ? 'font-weight:800;' : '';
      const connector = i < WFM_STAGES.length - 1
        ? '<div class="stage-connector">&#9654;</div>'
        : '';

      return `<div class="wfm-card ${isActive ? 'active' : ''}"
                   onclick="setWfmStageFilter(${stage})"
                   style="${dimStyle}border-color:${borderColor};background:${bgColor};${shadowStyle}"
                   title="Click to filter by Stage ${stage}">
        <div class="wfm-card-badge" style="background:${badgeBg};color:${badgeColor};">Stage ${stage}</div>
        <div class="wfm-card-title" style="${labelWeight}">${WFM_LABELS[stage]}</div>
        <div class="wfm-card-pct" style="color:${pctColor};">${pct}%</div>
        <div class="wfm-card-count">${countLabel}</div>
        <div class="wfm-card-sub">${WFM_SUBTITLES[stage]}</div>
      </div>${connector}`;
    }).join('');

    // 7. Position progress bar marker (index-based, no DOM measurement needed)
    const wfmMarker = document.getElementById('wfmProgressMarker');
    const targetWfmIdx = activeWfmStageFilter !== null ? activeWfmStageFilter : roundedStage;

    if (filteredTotal === 0 || targetWfmIdx === null || targetWfmIdx < 0) {
      wfmMarker.style.display = 'none';
    } else {
      wfmMarker.style.display = '';
      const total = WFM_STAGES.length;
      if (targetWfmIdx >= 0 && targetWfmIdx < total) {
        const pct = Math.max(2, Math.min(98, ((targetWfmIdx + 0.5) / total) * 100));
        wfmMarker.style.left = pct + '%';
      }
    }

    // Widget summary
    const wfmSummary = document.getElementById('workflowMaturitySummary');
    if (wfmSummary) {
      if (filteredTotal > 0) {
        wfmSummary.innerHTML = `<span class="widget-summary-label">Avg Stage:</span> <span class="widget-summary-value">${WFM_LABELS[roundedStage]} (${pcts[roundedStage]}%)</span>`;
      } else {
        wfmSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // ═══════════════════════════════════════════
  // LIMITING FACTORS WIDGET
  // ═══════════════════════════════════════════

  function renderLimitingFactorsWidget(surveys) {
    destroyChart('chartLimitingFactors');

    // Count how many times each factor is selected (rank 1 or rank 2)
    const counts = {};
    LIMITING_FACTOR_ORDER.forEach(k => counts[k] = 0);

    const totalSurveys = surveys.length;

    surveys.forEach(s => {
      const lf = s.data?.limitingFactors;
      if (!lf) return;
      Object.entries(lf).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) counts[k]++;
      });
    });

    // Sort factors by mentions descending
    const sorted = [...LIMITING_FACTOR_ORDER].sort((a, b) => counts[b] - counts[a]);

    // Calculate percentages
    const pcts = {};
    sorted.forEach(k => {
      pcts[k] = totalSurveys > 0 ? Math.round((counts[k] / totalSurveys) * 100) : 0;
    });

    const labels = sorted.map(k => LIMITING_FACTOR_LABELS[k] || k);

    // Per-bar colors: dim bars not matching the active filter
    const bgColors = sorted.map(k => {
      if (activeLimitingFactorFilter && activeLimitingFactorFilter !== k) return LF_COLORS.primary + '30';
      return LF_COLORS.primary;
    });
    const yTickColors = sorted.map(k => {
      if (activeLimitingFactorFilter && activeLimitingFactorFilter !== k) return '#d1d5db';
      if (activeLimitingFactorFilter === k) return '#1f2937';
      return '#374151';
    });

    const ctx = document.getElementById('chartLimitingFactors').getContext('2d');
    charts['chartLimitingFactors'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Mentions',
          data: sorted.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const factorKey = sorted[context.dataIndex];
                return `${context.raw}% (${counts[factorKey]} of ${totalSurveys})`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = sorted[context.index];
                const isActive = activeLimitingFactorFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const factorKey = sorted[elements[0].index];
            setLimitingFactorFilter(factorKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const legend = document.getElementById('lfLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${LF_COLORS.primary};"></div>
        <span>% of accounts reporting this factor</span>
      </div>`;

    // Widget summary
    const lfSummary = document.getElementById('limitingFactorsSummary');
    if (lfSummary) {
      const topKey = sorted[0];
      if (topKey && pcts[topKey] > 0) {
        lfSummary.innerHTML = `<span class="widget-summary-label">Top Factor:</span> <span class="widget-summary-value">${LIMITING_FACTOR_LABELS[topKey] || topKey} (${pcts[topKey]}%)</span>`;
      } else {
        lfSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // ═══════════════════════════════════════════
  // COLLAPSED SECTION SUMMARY
  // ═══════════════════════════════════════════
  function updateSectionSummary(surveys) {
    const el = document.getElementById('sectionSummaryLandscape');
    if (!el) return;

    // Average Portfolio Stage (reuse currentMedianStage set by renderAdoptionStageWidget)
    let stagePct = '';
    if (currentMedianStage) {
      let stageCount = 0, stageTotal = 0;
      surveys.forEach(s => {
        const val = s.data?.clientAILandscape?.maturity?.value;
        if (val && MATURITY_ORDER.includes(val)) {
          stageTotal++;
          if (val === currentMedianStage) stageCount++;
        }
      });
      stagePct = stageTotal > 0 ? ` (${Math.round((stageCount / stageTotal) * 100)}%)` : '';
    }
    const stageHtml = currentMedianStage
      ? `${MATURITY_ICONS[currentMedianStage]} ${MATURITY_LABELS[currentMedianStage]}${stagePct}`
      : '--';

    // Top 3 AI Challenges
    const chCounts = {};
    AI_CHALLENGE_ORDER.forEach(k => chCounts[k] = 0);
    surveys.forEach(s => {
      const ch = s.data?.clientAILandscape?.challenges;
      if (!ch) return;
      Object.entries(ch).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) chCounts[k]++;
      });
    });
    const topChallenges = [...AI_CHALLENGE_ORDER]
      .sort((a, b) => chCounts[b] - chCounts[a])
      .filter(k => chCounts[k] > 0)
      .slice(0, 3);

    const totalSurveys = surveys.length;
    const challengePills = topChallenges.map(k => {
      const pct = totalSurveys > 0 ? Math.round((chCounts[k] / totalSurveys) * 100) : 0;
      return `<span class="section-summary-challenge-pill">${AI_CHALLENGE_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    // Top 3 AI Usage types
    const usageCounts = {};
    AI_USAGE_ORDER.forEach(k => usageCounts[k] = 0);
    surveys.forEach(s => {
      const usage = s.data?.clientAILandscape?.usage;
      if (!usage) return;
      AI_USAGE_ORDER.forEach(k => {
        if (usage[k]?.selected === true) usageCounts[k]++;
      });
    });
    const topUsage = [...AI_USAGE_ORDER]
      .sort((a, b) => usageCounts[b] - usageCounts[a])
      .filter(k => usageCounts[k] > 0)
      .slice(0, 3);
    const usagePills = topUsage.map(k => {
      const pct = totalSurveys > 0 ? Math.round((usageCounts[k] / totalSurveys) * 100) : 0;
      return `<span class="section-summary-challenge-pill" style="background:#f5f3ff;border-color:#c4b5fd;color:#6d28d9;">${AI_USAGE_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    const stageMarkerPct = Math.max(4, Math.min(96, currentStagePosition * 100));
    const miniBarHtml = currentMedianStage
      ? `<div class="section-summary-mini-bar"><div class="section-summary-mini-marker" style="left:${stageMarkerPct}%"></div></div>`
      : '';

    el.innerHTML = `
      <div class="section-summary-item" style="flex-direction:column;align-items:flex-start;">
        <div style="display:flex;align-items:center;gap:0.4rem;">
          <span class="section-summary-label">Avg Stage:</span>
          <span class="section-summary-value">${stageHtml}</span>
        </div>
        ${miniBarHtml}
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Challenges:</span>
        <div class="section-summary-challenges">${challengePills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">AI Usage:</span>
        <div class="section-summary-challenges">${usagePills}</div>
      </div>`;
  }

  function updateAccountSectionSummary(surveys) {
    const el = document.getElementById('sectionSummaryAccount');
    if (!el) return;

    // Portfolio Average Maturity (reuse currentWfmStage set by renderWorkflowMaturityWidget)
    let wfmStagePct = '';
    if (currentWfmStage !== null) {
      let wfmCount = 0, wfmTotal = 0;
      surveys.forEach(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return;
        const roleStages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
        });
        if (roleStages.length === 0) return;
        wfmTotal++;
        if (Math.round(roleStages.reduce((a, b) => a + b, 0) / roleStages.length) === currentWfmStage) wfmCount++;
      });
      wfmStagePct = wfmTotal > 0 ? ` (${Math.round((wfmCount / wfmTotal) * 100)}%)` : '';
    }
    const maturityHtml = currentWfmStage !== null
      ? `Stage ${currentWfmStage} — ${WFM_LABELS[currentWfmStage]}${wfmStagePct}`
      : '--';

    // Top 3 Limiting Factors
    const lfCounts = {};
    LIMITING_FACTOR_ORDER.forEach(k => lfCounts[k] = 0);
    surveys.forEach(s => {
      const lf = s.data?.limitingFactors;
      if (!lf) return;
      Object.entries(lf).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) lfCounts[k]++;
      });
    });
    const topFactors = [...LIMITING_FACTOR_ORDER]
      .sort((a, b) => lfCounts[b] - lfCounts[a])
      .filter(k => lfCounts[k] > 0)
      .slice(0, 3);
    const totalSurveysAcct = surveys.length;
    const factorPills = topFactors.map(k => {
      const pct = totalSurveysAcct > 0 ? Math.round((lfCounts[k] / totalSurveysAcct) * 100) : 0;
      return `<span class="section-summary-challenge-pill">${LIMITING_FACTOR_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    // Top 3 AI Tools
    const toolCounts = {};
    AI_TOOL_ORDER.forEach(k => toolCounts[k] = 0);
    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;
      AI_TOOL_ORDER.forEach(k => {
        if (aiTools[k]?.selected === true) toolCounts[k]++;
      });
    });
    const topTools = [...AI_TOOL_ORDER]
      .sort((a, b) => toolCounts[b] - toolCounts[a])
      .filter(k => toolCounts[k] > 0)
      .slice(0, 3);
    const toolPills = topTools.map(k => {
      const c = toolCounts[k];
      const pct = totalSurveysAcct > 0 ? Math.round((c / totalSurveysAcct) * 100) : 0;
      return `<span class="section-summary-challenge-pill" style="background:#eef2ff;border-color:#c7d2fe;color:#4338ca;">${AI_TOOL_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    // Top Cloud Platforms
    const cloudCounts = {};
    CLOUD_PLATFORM_ORDER.forEach(k => cloudCounts[k] = 0);
    surveys.forEach(s => {
      const cloud = s.data?.toolsAndInfrastructure?.cloud;
      if (!cloud) return;
      CLOUD_PLATFORM_ORDER.forEach(k => { if (cloud[k]?.selected === true) cloudCounts[k]++; });
    });
    const topClouds = [...CLOUD_PLATFORM_ORDER]
      .sort((a, b) => cloudCounts[b] - cloudCounts[a])
      .filter(k => cloudCounts[k] > 0).slice(0, 3);
    const cloudPills = topClouds.map(k => {
      const pct = totalSurveysAcct > 0 ? Math.round((cloudCounts[k] / totalSurveysAcct) * 100) : 0;
      return `<span class="section-summary-challenge-pill" style="background:#e0f2fe;border-color:#7dd3fc;color:#0369a1;">${CLOUD_PLATFORM_LABELS[k]} ${pct}%</span>`;
    }).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    const wfmMarkerPct = Math.max(4, Math.min(96, currentWfmPosition * 100));
    const wfmMiniBarHtml = currentWfmStage !== null
      ? `<div class="section-summary-mini-bar"><div class="section-summary-mini-marker" style="left:${wfmMarkerPct}%"></div></div>`
      : '';

    // SDLC top "Doing" phases
    const sdlcSummary = SDLC_PHASES.map(phase => {
      let doing = 0, total = 0;
      surveys.forEach(s => {
        const section = s.data?.useCases?.[phase.key];
        if (!section) return;
        Object.values(section).forEach(item => {
          total++;
          if (item?.status === 'doing') doing++;
        });
      });
      return { label: phase.label, pct: total > 0 ? Math.round((doing / total) * 100) : 0 };
    }).sort((a, b) => b.pct - a.pct).slice(0, 3);
    const sdlcPills = sdlcSummary.filter(p => p.pct > 0).map(p =>
      `<span class="section-summary-challenge-pill" style="background:#ecfdf5;border-color:#a7f3d0;color:#047857;">${p.label} ${p.pct}%</span>`
    ).join('') || '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    // AI Champion coverage
    let champYes = 0;
    surveys.forEach(s => {
      if (s.data?.teamRoles?.aiChampion?.value === 'yes') champYes++;
    });
    const champTotal = surveys.length;
    const champPct = champTotal > 0 ? Math.round((champYes / champTotal) * 100) : 0;
    const champHtml = champTotal > 0
      ? `<div class="section-summary-challenges"><span class="section-summary-challenge-pill" style="background:#fef3c7;border-color:#fcd34d;color:#92400e;">${champYes}/${champTotal} (${champPct}%)</span></div>`
      : '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    // AI Usage %
    const aiUsagePct = calculateAiUsagePercent(surveys);
    const EXCL_KEYS_SUMMARY = ['dont-know', 'not-applicable', 'custom', '_meta'];
    const aiUsageCount = surveys.filter(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return false;
      const hasNamed = Object.keys(aiTools).some(k => !EXCL_KEYS_SUMMARY.includes(k) && aiTools[k]?.selected === true);
      const hasCustom = Array.isArray(aiTools.custom) && aiTools.custom.length > 0;
      return hasNamed || hasCustom;
    }).length;

    // Revenue at Risk — sum revenue from accounts NOT using any AI tool
    let revenueAtRiskTotal = 0;
    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      let hasAi = false;
      if (aiTools) {
        const hasNamed = Object.keys(aiTools).some(k => !EXCL_KEYS_SUMMARY.includes(k) && aiTools[k]?.selected === true);
        const hasCustom = Array.isArray(aiTools.custom) && aiTools.custom.length > 0;
        hasAi = hasNamed || hasCustom;
      }
      if (!hasAi) revenueAtRiskTotal += (s.forecasted_service_revenue || 0);
    });
    const revenueAtRiskHtml = revenueAtRiskTotal > 0
      ? `<span class="section-summary-value" style="color:#dc2626;">${formatCurrency(revenueAtRiskTotal)}</span>`
      : '<span style="color:#9ca3af;font-size:0.75rem;">$0</span>';

    // Collapsed summary
    const aiUsageHtml = aiUsagePct !== null
      ? `<span class="section-summary-value">${aiUsagePct}%</span>`
      : '<span style="color:#9ca3af;font-size:0.75rem;">No data</span>';

    el.innerHTML = `
      <div class="section-summary-item section-summary-ai-usage">
        <span class="section-summary-label" style="color:#4338ca;">AI Usage:</span>
        ${aiUsageHtml}
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item" style="flex-direction:column;align-items:flex-start;">
        <div style="display:flex;align-items:center;gap:0.4rem;">
          <span class="section-summary-label">Avg Maturity:</span>
          <span class="section-summary-value">${maturityHtml}</span>
        </div>
        ${wfmMiniBarHtml}
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Challenges:</span>
        <div class="section-summary-challenges">${factorPills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Top Tools:</span>
        <div class="section-summary-challenges">${toolPills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">Platforms:</span>
        <div class="section-summary-challenges">${cloudPills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">SDLC Doing:</span>
        <div class="section-summary-challenges">${sdlcPills}</div>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">AI Champions:</span>
        ${champHtml}
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label" style="color:#dc2626;">Revenue at Risk:</span>
        ${revenueAtRiskHtml}
      </div>`;
  }

  function updateSurveysSectionSummary(filteredSurveys, allSurveys) {
    const el = document.getElementById('sectionSummarySurveys');
    if (!el) return;

    const hasActiveFilters = allSurveys && filteredSurveys.length < allSurveys.length;
    const countText = hasActiveFilters
      ? `${filteredSurveys.length} of ${allSurveys.length}`
      : `${filteredSurveys.length}`;

    el.innerHTML = `
      <div class="section-summary-item">
        <span class="section-summary-label">Surveys:</span>
        <span class="section-summary-value">${countText}</span>
      </div>`;
  }

  // ═══════════════════════════════════════════
  // AI CHALLENGES WIDGET
  // ═══════════════════════════════════════════
  function renderAiChallengesWidget(surveys) {
    destroyChart('chartAiChallenges');

    // Count how many times each challenge is selected (rank 1 or rank 2)
    const counts = {};
    AI_CHALLENGE_ORDER.forEach(k => counts[k] = 0);

    const totalSurveys = surveys.length;

    surveys.forEach(s => {
      const ch = s.data?.clientAILandscape?.challenges;
      if (!ch) return;
      Object.entries(ch).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) counts[k]++;
      });
    });

    // Sort by mentions descending
    const sorted = [...AI_CHALLENGE_ORDER].sort((a, b) => counts[b] - counts[a]);

    const pcts = {};
    sorted.forEach(k => {
      pcts[k] = totalSurveys > 0 ? Math.round((counts[k] / totalSurveys) * 100) : 0;
    });

    const labels = sorted.map(k => AI_CHALLENGE_LABELS[k] || k);

    const bgColors = sorted.map(k => {
      if (activeAiChallengeFilter && activeAiChallengeFilter !== k) return AI_CHALLENGE_COLORS.primary + '30';
      return AI_CHALLENGE_COLORS.primary;
    });
    const yTickColors = sorted.map(k => {
      if (activeAiChallengeFilter && activeAiChallengeFilter !== k) return '#d1d5db';
      if (activeAiChallengeFilter === k) return '#1f2937';
      return '#374151';
    });

    const ctx = document.getElementById('chartAiChallenges').getContext('2d');
    charts['chartAiChallenges'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Mentions',
          data: sorted.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const challengeKey = sorted[context.dataIndex];
                return `${context.raw}% (${counts[challengeKey]} of ${totalSurveys})`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = sorted[context.index];
                const isActive = activeAiChallengeFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const challengeKey = sorted[elements[0].index];
            setAiChallengeFilter(challengeKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const legend = document.getElementById('aiChallengesLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${AI_CHALLENGE_COLORS.primary};"></div>
        <span>% of accounts reporting this challenge</span>
      </div>`;

    // Widget summary
    const chSummary = document.getElementById('aiChallengesSummary');
    if (chSummary) {
      const topKey = sorted[0];
      if (topKey && pcts[topKey] > 0) {
        chSummary.innerHTML = `<span class="widget-summary-label">Top:</span> <span class="widget-summary-value">${AI_CHALLENGE_LABELS[topKey] || topKey} (${pcts[topKey]}%)</span>`;
      } else {
        chSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // ═══════════════════════════════════════════
  // CURRENT AI USAGE WIDGET
  // ═══════════════════════════════════════════

  function renderAiUsageWidget(surveys) {
    destroyChart('chartAiUsage');

    const counts = {};
    AI_USAGE_ORDER.forEach(k => counts[k] = 0);
    const totalSurveys = surveys.length;

    surveys.forEach(s => {
      const usage = s.data?.clientAILandscape?.usage;
      if (!usage) return;
      AI_USAGE_ORDER.forEach(k => {
        if (usage[k]?.selected === true) counts[k]++;
      });
    });

    const sorted = [...AI_USAGE_ORDER].sort((a, b) => counts[b] - counts[a]);
    const pcts = {};
    sorted.forEach(k => {
      pcts[k] = totalSurveys > 0 ? Math.round((counts[k] / totalSurveys) * 100) : 0;
    });

    const labels = sorted.map(k => AI_USAGE_LABELS[k] || k);
    const bgColors = sorted.map(k => {
      if (activeAiUsageFilter && activeAiUsageFilter !== k) return AI_USAGE_COLOR + '30';
      return AI_USAGE_COLOR;
    });
    const yTickColors = sorted.map(k => {
      if (activeAiUsageFilter && activeAiUsageFilter !== k) return '#d1d5db';
      if (activeAiUsageFilter === k) return '#1f2937';
      return '#374151';
    });

    const ctx = document.getElementById('chartAiUsage').getContext('2d');
    charts['chartAiUsage'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Usage',
          data: sorted.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const usageKey = sorted[context.dataIndex];
                return `${context.raw}% (${counts[usageKey]} of ${totalSurveys})`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: { callback: v => v + '%', font: { size: 11 }, color: '#9ca3af' },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = sorted[context.index];
                const isActive = activeAiUsageFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const usageKey = sorted[elements[0].index];
            setAiUsageFilter(usageKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    const legend = document.getElementById('aiUsageLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${AI_USAGE_COLOR};"></div>
        <span>% of accounts using this approach</span>
      </div>`;

    // Widget summary
    const usageSummary = document.getElementById('aiUsageSummary');
    if (usageSummary) {
      const topKey = sorted[0];
      if (topKey && pcts[topKey] > 0) {
        usageSummary.innerHTML = `<span class="widget-summary-label">Top:</span> <span class="widget-summary-value">${AI_USAGE_LABELS[topKey] || topKey} (${pcts[topKey]}%)</span>`;
      } else {
        usageSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // Helper: count AI usage from a survey set
  function countAiUsage(surveys) {
    const counts = {};
    AI_USAGE_ORDER.forEach(k => counts[k] = 0);
    surveys.forEach(s => {
      const usage = s.data?.clientAILandscape?.usage;
      if (!usage) return;
      AI_USAGE_ORDER.forEach(k => {
        if (usage[k]?.selected === true) counts[k]++;
      });
    });
    return counts;
  }

  // ═══════════════════════════════════════════
  // AI TOOLS USAGE WIDGET
  // ═══════════════════════════════════════════
  function renderAiToolsWidget(surveys) {
    destroyChart('chartAiTools');

    const totalSurveys = surveys.length;
    const EXCLUDED_KEYS = ['dont-know', 'not-applicable', 'custom', '_meta'];

    // Count how many surveys have each named tool selected
    const toolCounts = {};
    AI_TOOL_ORDER.forEach(k => toolCounts[k] = 0);
    let customCount = 0;

    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;
      AI_TOOL_ORDER.forEach(toolKey => {
        if (aiTools[toolKey]?.selected === true) toolCounts[toolKey]++;
      });
      if (Array.isArray(aiTools.custom) && aiTools.custom.length > 0) customCount++;
    });

    // Build sorted list of tools with count > 0, plus custom if any
    const toolKeys = AI_TOOL_ORDER.filter(k => toolCounts[k] > 0);
    if (customCount > 0) toolKeys.push('_custom');

    // Sort by count descending
    toolKeys.sort((a, b) => {
      const ca = a === '_custom' ? customCount : toolCounts[a];
      const cb = b === '_custom' ? customCount : toolCounts[b];
      return cb - ca;
    });

    // Calculate percentages
    const pcts = {};
    const counts = {};
    toolKeys.forEach(k => {
      const c = k === '_custom' ? customCount : toolCounts[k];
      counts[k] = c;
      pcts[k] = totalSurveys > 0 ? Math.round((c / totalSurveys) * 100) : 0;
    });

    const labels = toolKeys.map(k => k === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[k] || k));

    // Per-bar colors: dim bars not matching the active filter
    const bgColors = toolKeys.map(k => {
      if (activeAiToolFilter && activeAiToolFilter !== k) return AI_TOOL_COLOR + '30';
      return AI_TOOL_COLOR;
    });
    const yTickColors = toolKeys.map(k => {
      if (activeAiToolFilter && activeAiToolFilter !== k) return '#d1d5db';
      if (activeAiToolFilter === k) return '#1f2937';
      return '#374151';
    });

    // Adjust chart height dynamically based on number of tools
    const chartContainer = document.querySelector('.ai-tools-chart-container');
    const barCount = toolKeys.length || 1;
    chartContainer.style.height = Math.max(180, barCount * 32 + 40) + 'px';

    const ctx = document.getElementById('chartAiTools').getContext('2d');
    charts['chartAiTools'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Usage',
          data: toolKeys.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const toolKey = toolKeys[context.dataIndex];
                const count = counts[toolKey];
                return `${context.raw}% (${count} of ${totalSurveys} accounts)`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = toolKeys[context.index];
                const isActive = activeAiToolFilter === k;
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const toolKey = toolKeys[elements[0].index];
            setAiToolFilter(toolKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const legend = document.getElementById('aiToolsLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${AI_TOOL_COLOR};"></div>
        <span>% of accounts using this tool</span>
      </div>`;

    // Widget summary
    const toolsSummary = document.getElementById('aiToolsSummary');
    if (toolsSummary) {
      const topKey = toolKeys[0];
      if (topKey && pcts[topKey] > 0) {
        const topLabel = topKey === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[topKey] || topKey);
        toolsSummary.innerHTML = `<span class="widget-summary-label">Most Used:</span> <span class="widget-summary-value">${topLabel} (${pcts[topKey]}%)</span>`;
      } else {
        toolsSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // ═══════════════════════════════════════════
  // CLOUD PLATFORMS WIDGET
  // ═══════════════════════════════════════════
  function renderCloudPlatformsWidget(surveys) {
    destroyChart('chartCloudPlatforms');

    const totalSurveys = surveys.length;

    // Count how many surveys have each platform selected
    const platformCounts = {};
    CLOUD_PLATFORM_ORDER.forEach(k => platformCounts[k] = 0);

    surveys.forEach(s => {
      const cloud = s.data?.toolsAndInfrastructure?.cloud;
      if (!cloud) return;
      CLOUD_PLATFORM_ORDER.forEach(k => {
        if (cloud[k]?.selected === true) platformCounts[k]++;
      });
    });

    // Build sorted list of platforms with count > 0
    const platformKeys = CLOUD_PLATFORM_ORDER.filter(k => platformCounts[k] > 0);

    // Sort by count descending
    platformKeys.sort((a, b) => platformCounts[b] - platformCounts[a]);

    // Calculate percentages
    const pcts = {};
    const counts = {};
    platformKeys.forEach(k => {
      counts[k] = platformCounts[k];
      pcts[k] = totalSurveys > 0 ? Math.round((platformCounts[k] / totalSurveys) * 100) : 0;
    });

    const labels = platformKeys.map(k => CLOUD_PLATFORM_LABELS[k] || k);

    // Per-bar colors: dim bars not matching the active chart-click filter or top-bar dropdown
    const selectedDropdown = getSelectedCloudPlatforms();
    const hasDropdownFilter = selectedDropdown.length > 0 && selectedDropdown.length < CLOUD_PLATFORM_ORDER.length;
    const bgColors = platformKeys.map(k => {
      if (activeCloudPlatformFilter && activeCloudPlatformFilter !== k) return CLOUD_PLATFORM_COLOR + '30';
      if (hasDropdownFilter && !selectedDropdown.includes(k)) return CLOUD_PLATFORM_COLOR + '30';
      return CLOUD_PLATFORM_COLOR;
    });
    const yTickColors = platformKeys.map(k => {
      if (activeCloudPlatformFilter && activeCloudPlatformFilter !== k) return '#d1d5db';
      if (activeCloudPlatformFilter === k) return '#1f2937';
      if (hasDropdownFilter && !selectedDropdown.includes(k)) return '#d1d5db';
      if (hasDropdownFilter && selectedDropdown.includes(k)) return '#1f2937';
      return '#374151';
    });

    // Adjust chart height dynamically based on number of platforms
    const chartContainer = document.querySelector('.cloud-platforms-chart-container');
    const barCount = platformKeys.length || 1;
    chartContainer.style.height = Math.max(100, barCount * 32 + 40) + 'px';

    const ctx = document.getElementById('chartCloudPlatforms').getContext('2d');
    charts['chartCloudPlatforms'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Usage',
          data: platformKeys.map(k => pcts[k]),
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const platformKey = platformKeys[context.dataIndex];
                const count = counts[platformKey];
                return `${context.raw}% (${count} of ${totalSurveys} accounts)`;
              }
            }
          }
        },
        scales: {
          x: {
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            ticks: {
              font: function(context) {
                const k = platformKeys[context.index];
                const isActive = activeCloudPlatformFilter === k || (hasDropdownFilter && selectedDropdown.includes(k));
                return { size: 12, weight: isActive ? '700' : '500' };
              },
              color: yTickColors
            },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const platformKey = platformKeys[elements[0].index];
            setCloudPlatformFilter(platformKey);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });

    // Render legend
    const cpLegend = document.getElementById('cloudPlatformsLegend');
    cpLegend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${CLOUD_PLATFORM_COLOR};"></div>
        <span>% of accounts using this platform</span>
      </div>`;

    // Widget summary
    const cpSummary = document.getElementById('cloudPlatformsSummary');
    if (cpSummary) {
      const topKey = platformKeys[0];
      if (topKey && pcts[topKey] > 0) {
        cpSummary.innerHTML = `<span class="widget-summary-label">Primary:</span> <span class="widget-summary-value">${CLOUD_PLATFORM_LABELS[topKey] || topKey} (${pcts[topKey]}%)</span>`;
      } else {
        cpSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // ═══════════════════════════════════════════
  // COMPARISON MODE — WIDGET RENDERERS
  // ═══════════════════════════════════════════

  // Helper: count limiting factors from a survey set
  function countLimitingFactors(surveys) {
    const counts = {};
    LIMITING_FACTOR_ORDER.forEach(k => counts[k] = 0);
    surveys.forEach(s => {
      const lf = s.data?.limitingFactors;
      if (!lf) return;
      Object.entries(lf).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) counts[k]++;
      });
    });
    return counts;
  }

  // Helper: count AI challenges from a survey set
  function countAiChallenges(surveys) {
    const counts = {};
    AI_CHALLENGE_ORDER.forEach(k => counts[k] = 0);
    surveys.forEach(s => {
      const ch = s.data?.clientAILandscape?.challenges;
      if (!ch) return;
      Object.entries(ch).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1 || v?.rank === 2) counts[k]++;
      });
    });
    return counts;
  }

  // Helper: count AI tools from a survey set
  function countAiTools(surveys) {
    const toolCounts = {};
    AI_TOOL_ORDER.forEach(k => toolCounts[k] = 0);
    let customCount = 0;
    surveys.forEach(s => {
      const aiTools = s.data?.toolsAndInfrastructure?.ai;
      if (!aiTools) return;
      AI_TOOL_ORDER.forEach(toolKey => {
        if (aiTools[toolKey]?.selected === true) toolCounts[toolKey]++;
      });
      if (Array.isArray(aiTools.custom) && aiTools.custom.length > 0) customCount++;
    });
    return { toolCounts, customCount };
  }

  // Helper: count cloud platforms from a survey set
  function countCloudPlatforms(surveys) {
    const platformCounts = {};
    CLOUD_PLATFORM_ORDER.forEach(k => platformCounts[k] = 0);
    surveys.forEach(s => {
      const cloud = s.data?.toolsAndInfrastructure?.cloud;
      if (!cloud) return;
      CLOUD_PLATFORM_ORDER.forEach(k => {
        if (cloud[k]?.selected === true) platformCounts[k]++;
      });
    });
    return { platformCounts };
  }

  // Helper: compute per-account WFM average stages from a survey set
  function computeWfmAccountStages(surveyList) {
    const stages = [];
    surveyList.forEach(s => {
      const wfm = s.data?.workflowMaturity;
      if (!wfm) return;
      const roleStages = [];
      ROLE_ORDER.forEach(role => {
        const st = wfm[role]?.stage;
        if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
      });
      if (roleStages.length === 0) return;
      const avg = roleStages.reduce((a, b) => a + b, 0) / roleStages.length;
      stages.push(Math.round(avg));
    });
    return stages;
  }

  function renderLimitingFactorsComparison(surveysA, surveysB, nameA, nameB) {
    destroyChart('chartLimitingFactors');
    const countsA = countLimitingFactors(surveysA);
    const countsB = countLimitingFactors(surveysB);
    const totalA = surveysA.length, totalB = surveysB.length;

    // Use consistent sort order: sort by max of A and B
    const sorted = [...LIMITING_FACTOR_ORDER].sort((a, b) => {
      const maxA = Math.max(countsA[a] || 0, countsB[a] || 0);
      const maxB = Math.max(countsA[b] || 0, countsB[b] || 0);
      return maxB - maxA;
    });

    const labels = sorted.map(k => LIMITING_FACTOR_LABELS[k] || k);
    const pctsA = sorted.map(k => totalA > 0 ? Math.round((countsA[k] / totalA) * 100) : 0);
    const pctsB = sorted.map(k => totalB > 0 ? Math.round((countsB[k] / totalB) * 100) : 0);

    const ctx = document.getElementById('chartLimitingFactors').getContext('2d');
    charts['chartLimitingFactors'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: nameA, data: pctsA, backgroundColor: COMPARE_COLOR_A, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 },
          { label: nameB, data: pctsB, backgroundColor: COMPARE_COLOR_B, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 }
        ]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 11, weight: '600' }, usePointStyle: true, pointStyle: 'rectRounded', padding: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}%` } }
        },
        scales: {
          x: { max: 100, ticks: { callback: v => v + '%', font: { size: 11 }, color: '#9ca3af' }, grid: { color: '#f3f4f6' }, border: { display: false } },
          y: { ticks: { font: { size: 12, weight: '500' }, color: '#374151' }, grid: { display: false }, border: { display: false } }
        }
      }
    });

    const legend = document.getElementById('lfLegend');
    legend.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_A};"></div><span>${escapeHtml(nameA)}</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_B};"></div><span>${escapeHtml(nameB)}</span></div>`;
  }

  function renderAiChallengesComparison(surveysA, surveysB, nameA, nameB) {
    destroyChart('chartAiChallenges');
    const countsA = countAiChallenges(surveysA);
    const countsB = countAiChallenges(surveysB);
    const totalA = surveysA.length, totalB = surveysB.length;

    const sorted = [...AI_CHALLENGE_ORDER].sort((a, b) => {
      const maxA = Math.max(countsA[a] || 0, countsB[a] || 0);
      const maxB = Math.max(countsA[b] || 0, countsB[b] || 0);
      return maxB - maxA;
    });

    const labels = sorted.map(k => AI_CHALLENGE_LABELS[k] || k);
    const pctsA = sorted.map(k => totalA > 0 ? Math.round((countsA[k] / totalA) * 100) : 0);
    const pctsB = sorted.map(k => totalB > 0 ? Math.round((countsB[k] / totalB) * 100) : 0);

    const ctx = document.getElementById('chartAiChallenges').getContext('2d');
    charts['chartAiChallenges'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: nameA, data: pctsA, backgroundColor: COMPARE_COLOR_A, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 },
          { label: nameB, data: pctsB, backgroundColor: COMPARE_COLOR_B, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 }
        ]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 11, weight: '600' }, usePointStyle: true, pointStyle: 'rectRounded', padding: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}%` } }
        },
        scales: {
          x: { max: 100, ticks: { callback: v => v + '%', font: { size: 11 }, color: '#9ca3af' }, grid: { color: '#f3f4f6' }, border: { display: false } },
          y: { ticks: { font: { size: 12, weight: '500' }, color: '#374151' }, grid: { display: false }, border: { display: false } }
        }
      }
    });

    const legend = document.getElementById('aiChallengesLegend');
    legend.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_A};"></div><span>${escapeHtml(nameA)}</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_B};"></div><span>${escapeHtml(nameB)}</span></div>`;
  }

  function renderAiUsageComparison(surveysA, surveysB, nameA, nameB) {
    destroyChart('chartAiUsage');
    const countsA = countAiUsage(surveysA);
    const countsB = countAiUsage(surveysB);
    const totalA = surveysA.length, totalB = surveysB.length;

    const sorted = [...AI_USAGE_ORDER].sort((a, b) => {
      const maxA = Math.max(countsA[a] || 0, countsB[a] || 0);
      const maxB = Math.max(countsA[b] || 0, countsB[b] || 0);
      return maxB - maxA;
    });

    const labels = sorted.map(k => AI_USAGE_LABELS[k] || k);
    const pctsA = sorted.map(k => totalA > 0 ? Math.round((countsA[k] / totalA) * 100) : 0);
    const pctsB = sorted.map(k => totalB > 0 ? Math.round((countsB[k] / totalB) * 100) : 0);

    const ctx = document.getElementById('chartAiUsage').getContext('2d');
    charts['chartAiUsage'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: nameA, data: pctsA, backgroundColor: COMPARE_COLOR_A, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 },
          { label: nameB, data: pctsB, backgroundColor: COMPARE_COLOR_B, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 }
        ]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 11, weight: '600' }, usePointStyle: true, pointStyle: 'rectRounded', padding: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}%` } }
        },
        scales: {
          x: { max: 100, ticks: { callback: v => v + '%', font: { size: 11 }, color: '#9ca3af' }, grid: { color: '#f3f4f6' }, border: { display: false } },
          y: { ticks: { font: { size: 12, weight: '500' }, color: '#374151' }, grid: { display: false }, border: { display: false } }
        }
      }
    });

    const legend = document.getElementById('aiUsageLegend');
    legend.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_A};"></div><span>${escapeHtml(nameA)}</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_B};"></div><span>${escapeHtml(nameB)}</span></div>`;
  }

  function renderAiToolsComparison(surveysA, surveysB, nameA, nameB) {
    destroyChart('chartAiTools');
    const totalA = surveysA.length, totalB = surveysB.length;
    const tA = countAiTools(surveysA), tB = countAiTools(surveysB);

    // Merge all tool keys that have at least 1 count in either group
    const allKeys = AI_TOOL_ORDER.filter(k => tA.toolCounts[k] > 0 || tB.toolCounts[k] > 0);
    if (tA.customCount > 0 || tB.customCount > 0) allKeys.push('_custom');

    allKeys.sort((a, b) => {
      const ca = a === '_custom' ? Math.max(tA.customCount, tB.customCount) : Math.max(tA.toolCounts[a] || 0, tB.toolCounts[a] || 0);
      const cb = b === '_custom' ? Math.max(tA.customCount, tB.customCount) : Math.max(tA.toolCounts[b] || 0, tB.toolCounts[b] || 0);
      return cb - ca;
    });

    const labels = allKeys.map(k => k === '_custom' ? 'Other / Custom' : (AI_TOOL_LABELS[k] || k));
    const pctsA = allKeys.map(k => { const c = k === '_custom' ? tA.customCount : (tA.toolCounts[k] || 0); return totalA > 0 ? Math.round((c / totalA) * 100) : 0; });
    const pctsB = allKeys.map(k => { const c = k === '_custom' ? tB.customCount : (tB.toolCounts[k] || 0); return totalB > 0 ? Math.round((c / totalB) * 100) : 0; });

    const chartContainer = document.querySelector('.ai-tools-chart-container');
    const barCount = allKeys.length || 1;
    chartContainer.style.height = Math.max(180, barCount * 36 + 40) + 'px';

    const ctx = document.getElementById('chartAiTools').getContext('2d');
    charts['chartAiTools'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: nameA, data: pctsA, backgroundColor: COMPARE_COLOR_A, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 },
          { label: nameB, data: pctsB, backgroundColor: COMPARE_COLOR_B, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 }
        ]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 11, weight: '600' }, usePointStyle: true, pointStyle: 'rectRounded', padding: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}%` } }
        },
        scales: {
          x: { max: 100, ticks: { callback: v => v + '%', font: { size: 11 }, color: '#9ca3af' }, grid: { color: '#f3f4f6' }, border: { display: false } },
          y: { ticks: { font: { size: 12, weight: '500' }, color: '#374151' }, grid: { display: false }, border: { display: false } }
        }
      }
    });

    const legend = document.getElementById('aiToolsLegend');
    legend.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_A};"></div><span>${escapeHtml(nameA)}</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_B};"></div><span>${escapeHtml(nameB)}</span></div>`;
  }

  // --- Cloud Platforms Comparison ---
  function renderCloudPlatformsComparison(surveysA, surveysB, nameA, nameB) {
    destroyChart('chartCloudPlatforms');
    const totalA = surveysA.length, totalB = surveysB.length;
    const cpA = countCloudPlatforms(surveysA), cpB = countCloudPlatforms(surveysB);

    const allKeys = CLOUD_PLATFORM_ORDER.filter(k => cpA.platformCounts[k] > 0 || cpB.platformCounts[k] > 0);
    allKeys.sort((a, b) => Math.max(cpA.platformCounts[b] || 0, cpB.platformCounts[b] || 0) - Math.max(cpA.platformCounts[a] || 0, cpB.platformCounts[a] || 0));

    const labels = allKeys.map(k => CLOUD_PLATFORM_LABELS[k] || k);
    const pctsA = allKeys.map(k => totalA > 0 ? Math.round((cpA.platformCounts[k] / totalA) * 100) : 0);
    const pctsB = allKeys.map(k => totalB > 0 ? Math.round((cpB.platformCounts[k] / totalB) * 100) : 0);

    const chartContainer = document.querySelector('.cloud-platforms-chart-container');
    const barCount = allKeys.length || 1;
    chartContainer.style.height = Math.max(100, barCount * 36 + 40) + 'px';

    const ctx = document.getElementById('chartCloudPlatforms').getContext('2d');
    charts['chartCloudPlatforms'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: nameA, data: pctsA, backgroundColor: COMPARE_COLOR_A, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 },
          { label: nameB, data: pctsB, backgroundColor: COMPARE_COLOR_B, borderRadius: 4, barPercentage: 0.45, categoryPercentage: 0.8 }
        ]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 11, weight: '600' }, usePointStyle: true, pointStyle: 'rectRounded', padding: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}%` } }
        },
        scales: {
          x: { max: 100, ticks: { callback: v => v + '%', font: { size: 11 }, color: '#9ca3af' }, grid: { color: '#f3f4f6' }, border: { display: false } },
          y: { ticks: { font: { size: 12, weight: '500' }, color: '#374151' }, grid: { display: false }, border: { display: false } }
        }
      }
    });

    const cpLegend = document.getElementById('cloudPlatformsLegend');
    cpLegend.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_A};"></div><span>${escapeHtml(nameA)}</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_B};"></div><span>${escapeHtml(nameB)}</span></div>`;
  }

  // --- Adoption Stage Comparison ---
  function renderAdoptionStageComparison(surveysA, surveysB, nameA, nameB) {
    const maturityOrder = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing'];

    function computeStageData(surveys) {
      const counts = {}; maturityOrder.forEach(k => counts[k] = 0);
      let total = 0;
      surveys.forEach(s => {
        const val = s.data?.clientAILandscape?.maturity?.value;
        if (val && maturityOrder.includes(val)) { counts[val]++; total++; }
      });
      const pcts = {}; maturityOrder.forEach(k => pcts[k] = total > 0 ? Math.round((counts[k] / total) * 100) : 0);
      // Weighted average for position
      let weightedSum = 0;
      maturityOrder.forEach((k, i) => weightedSum += counts[k] * i);
      const avgPos = total > 0 ? weightedSum / (total * (maturityOrder.length - 1)) : 0.5;
      // Median stage
      const idx = total > 0 ? Math.round(weightedSum / total) : 2;
      return { counts, pcts, total, avgPos, medianStage: maturityOrder[idx] };
    }

    const dataA = computeStageData(surveysA);
    const dataB = computeStageData(surveysB);

    // Render pipeline with two rows
    const pipeline = document.getElementById('stagePipeline');
    pipeline.innerHTML = maturityOrder.map((k, i) => {
      const color = MATURITY_COLORS[k];
      return `<div class="stage-card" style="border-color:${color};opacity:1;cursor:default;">
        <div class="stage-card-icon">${MATURITY_ICONS[k]}</div>
        <div class="stage-card-label">${MATURITY_LABELS[k]}</div>
        <div style="display:flex;gap:0.5rem;align-items:center;justify-content:center;margin-top:0.3rem;">
          <span style="font-size:0.85rem;font-weight:700;color:${COMPARE_COLOR_A};">${dataA.pcts[k]}%</span>
          <span style="font-size:0.7rem;color:#9ca3af;">vs</span>
          <span style="font-size:0.85rem;font-weight:700;color:${COMPARE_COLOR_B};">${dataB.pcts[k]}%</span>
        </div>
        <div class="stage-card-count" style="font-size:0.65rem;color:#9ca3af;">${dataA.counts[k]} vs ${dataB.counts[k]}</div>
      </div>${i < maturityOrder.length - 1 ? '<div class="stage-connector">&#9654;</div>' : ''}`;
    }).join('');

    // Update badge callout with both groups
    const calloutValue = document.getElementById('stageCalloutValue');
    if (calloutValue) {
      const iconA = MATURITY_ICONS[dataA.medianStage];
      const iconB = MATURITY_ICONS[dataB.medianStage];
      const pctA = dataA.pcts[dataA.medianStage] || 0;
      const pctB = dataB.pcts[dataB.medianStage] || 0;
      calloutValue.innerHTML = `<span style="color:${COMPARE_COLOR_A};">${iconA} ${MATURITY_LABELS[dataA.medianStage]} (${pctA}%)</span> <span style="color:#9ca3af;font-size:0.75rem;">vs</span> <span style="color:${COMPARE_COLOR_B};">${iconB} ${MATURITY_LABELS[dataB.medianStage]} (${pctB}%)</span>`;
      calloutValue.style.cursor = 'default';
      calloutValue.onclick = null;
    }

    // Progress marker — show two markers
    const marker = document.getElementById('progressMarker');
    if (marker) {
      marker.innerHTML = `<span style="color:${COMPARE_COLOR_A};position:absolute;left:${dataA.avgPos * 100}%;transform:translateX(-50%);">▲</span>` +
        `<span style="color:${COMPARE_COLOR_B};position:absolute;left:${dataB.avgPos * 100}%;transform:translateX(-50%);">▲</span>`;
      marker.style.left = '0%';
      marker.style.color = 'transparent';
    }

    // Legend with both groups
    const legend = document.getElementById('widgetLegend');
    if (legend) {
      legend.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_A};"></div><span>${escapeHtml(nameA)} (${surveysA.length})</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:${COMPARE_COLOR_B};"></div><span>${escapeHtml(nameB)} (${surveysB.length})</span></div>`;
    }

    // Hide filter footer in comparison mode
    const footer = document.getElementById('widgetFooter');
    if (footer) footer.style.display = 'none';
  }

  // --- Workflow Maturity Comparison ---
  function renderWorkflowMaturityComparison(surveysA, surveysB, allSurveys, nameA, nameB) {
    const stagesA = computeWfmAccountStages(surveysA);
    const stagesB = computeWfmAccountStages(surveysB);

    const countsA = {}, countsB = {};
    WFM_STAGES.forEach(s => { countsA[s] = 0; countsB[s] = 0; });
    stagesA.forEach(s => { if (countsA[s] !== undefined) countsA[s]++; });
    stagesB.forEach(s => { if (countsB[s] !== undefined) countsB[s]++; });
    const totalA = stagesA.length, totalB = stagesB.length;

    const pctsA = {}, pctsB = {};
    WFM_STAGES.forEach(s => {
      pctsA[s] = totalA > 0 ? Math.round((countsA[s] / totalA) * 100) : 0;
      pctsB[s] = totalB > 0 ? Math.round((countsB[s] / totalB) * 100) : 0;
    });

    const avgA = totalA > 0 ? stagesA.reduce((a, b) => a + b, 0) / totalA : 0;
    const avgB = totalB > 0 ? stagesB.reduce((a, b) => a + b, 0) / totalB : 0;
    const roundedA = Math.round(avgA), roundedB = Math.round(avgB);

    // Update badge
    const avgEl = document.getElementById('wfmAvgValue');
    if (avgEl) {
      avgEl.innerHTML = `<span style="color:${COMPARE_COLOR_A};">${WFM_LABELS[roundedA]} (${pctsA[roundedA] || 0}%)</span> <span style="color:#9ca3af;font-size:0.75rem;">vs</span> <span style="color:${COMPARE_COLOR_B};">${WFM_LABELS[roundedB]} (${pctsB[roundedB] || 0}%)</span>`;
    }

    // Journey cards with dual percentages
    const journey = document.getElementById('wfmJourney');
    journey.innerHTML = WFM_STAGES.map((stage, i) => {
      const color = WFM_COLORS[stage];
      const connector = i < WFM_STAGES.length - 1 ? '<div class="stage-connector">&#9654;</div>' : '';
      return `<div class="wfm-card" style="border-color:${color};cursor:default;">
        <div class="wfm-card-badge" style="background:${color}30;color:#374151;">Stage ${stage}</div>
        <div class="wfm-card-title">${WFM_LABELS[stage]}</div>
        <div style="display:flex;gap:0.4rem;align-items:center;justify-content:center;margin:0.2rem 0;">
          <span style="font-size:0.85rem;font-weight:700;color:${COMPARE_COLOR_A};">${pctsA[stage]}%</span>
          <span style="font-size:0.65rem;color:#9ca3af;">vs</span>
          <span style="font-size:0.85rem;font-weight:700;color:${COMPARE_COLOR_B};">${pctsB[stage]}%</span>
        </div>
        <div class="wfm-card-count" style="font-size:0.65rem;">${countsA[stage]} vs ${countsB[stage]}</div>
      </div>${connector}`;
    }).join('');

    // Dual progress markers
    const markerEl = document.getElementById('wfmProgressMarker');
    if (markerEl) {
      markerEl.innerHTML = `<span style="color:${COMPARE_COLOR_A};position:absolute;left:${(avgA / 5) * 100}%;transform:translateX(-50%);">▲</span>` +
        `<span style="color:${COMPARE_COLOR_B};position:absolute;left:${(avgB / 5) * 100}%;transform:translateX(-50%);">▲</span>`;
      markerEl.style.left = '0%';
      markerEl.style.color = 'transparent';
    }
  }

  // --- SDLC Coverage Comparison ---
  function renderSdlcCoverageComparison(surveysA, surveysB, nameA, nameB) {
    const container = document.getElementById('sdlcCoverageContent');
    const insightEl = document.getElementById('sdlcKeyInsight');
    if (!container) return;

    function computeSdlcData(surveys) {
      const data = {};
      SDLC_PHASES.forEach(ph => {
        let using = 0, notUsing = 0;
        surveys.forEach(s => {
          const val = s.data?.sdlcAiUsage?.[ph.key]?.value;
          if (val === 'yes') using++;
          else if (val === 'no') notUsing++;
        });
        const total = using + notUsing;
        data[ph.key] = { using, notUsing, total, pct: total > 0 ? Math.round((using / total) * 100) : 0 };
      });
      return data;
    }

    const dataA = computeSdlcData(surveysA);
    const dataB = computeSdlcData(surveysB);

    container.innerHTML = SDLC_PHASES.map(ph => {
      const pctA = dataA[ph.key].pct, pctB = dataB[ph.key].pct;
      return `<div style="margin-bottom:0.75rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
          <span style="font-size:0.82rem;font-weight:600;color:#374151;">${ph.label}</span>
          <div style="display:flex;gap:0.75rem;font-size:0.78rem;font-weight:700;">
            <span style="color:${COMPARE_COLOR_A};">${pctA}%</span>
            <span style="color:${COMPARE_COLOR_B};">${pctB}%</span>
          </div>
        </div>
        <div style="display:flex;gap:4px;height:18px;">
          <div style="flex:1;background:#e5e7eb;border-radius:4px;overflow:hidden;position:relative;">
            <div style="width:${pctA}%;height:100%;background:${COMPARE_COLOR_A};border-radius:4px;"></div>
          </div>
          <div style="flex:1;background:#e5e7eb;border-radius:4px;overflow:hidden;position:relative;">
            <div style="width:${pctB}%;height:100%;background:${COMPARE_COLOR_B};border-radius:4px;"></div>
          </div>
        </div>
      </div>`;
    }).join('');

    if (insightEl) {
      insightEl.innerHTML = `<span style="color:${COMPARE_COLOR_A};font-weight:600;">${escapeHtml(nameA)}</span> vs <span style="color:${COMPARE_COLOR_B};font-weight:600;">${escapeHtml(nameB)}</span> — AI coverage comparison by SDLC phase`;
    }
  }

  // --- AI Adoption by Role Heatmap Comparison ---
  function renderAiAdoptionByRoleComparison(surveysA, surveysB, nameA, nameB) {
    const container = document.getElementById('aiAdoptionByRoleContent');
    if (!container) return;

    function computeRoleData(surveys, toolFilter) {
      const roleStageCounts = {};
      ROLE_ORDER.forEach(role => { roleStageCounts[role] = {}; WFM_STAGES.forEach(s => roleStageCounts[role][s] = 0); });
      surveys.forEach(s => {
        const wfm = s.data?.workflowMaturity;
        if (!wfm) return;
        const matrix = s.data?.roleToolMatrix;
        ROLE_ORDER.forEach(role => {
          // When an AI tool filter is active, only count this role if it actually uses the filtered tool
          if (toolFilter) {
            if (toolFilter === '_custom') {
              const hasCustom = matrix && Object.keys(matrix).some(k =>
                k.startsWith(role + ':custom-') && matrix[k]?.selected
              );
              if (!hasCustom) return;
            } else {
              if (!matrix || !matrix[`${role}:${toolFilter}`]?.selected) return;
            }
          }
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number' && roleStageCounts[role][st] !== undefined) {
            roleStageCounts[role][st]++;
          }
        });
      });
      const rolePcts = {};
      ROLE_ORDER.forEach(role => {
        const total = WFM_STAGES.reduce((acc, s) => acc + roleStageCounts[role][s], 0);
        rolePcts[role] = {};
        WFM_STAGES.forEach(s => rolePcts[role][s] = total > 0 ? Math.round((roleStageCounts[role][s] / total) * 100) : 0);
      });
      return rolePcts;
    }

    const pctsA = computeRoleData(surveysA, groupA.filters?.aiTool);
    const pctsB = computeRoleData(surveysB, groupB.filters?.aiTool);

    function renderHeatmapTable(pcts, groupName, color) {
      let maxPct = 0;
      ROLE_ORDER.forEach(role => WFM_STAGES.forEach(s => { if (pcts[role][s] > maxPct) maxPct = pcts[role][s]; }));

      let html = `<div style="margin-bottom:1rem;">
        <div style="font-size:0.8rem;font-weight:700;color:${color};margin-bottom:0.4rem;">${escapeHtml(groupName)}</div>
        <table class="role-heatmap"><thead><tr><th class="rh-role-header"></th>`;
      WFM_STAGES.forEach(s => html += `<th><span class="rh-stage-num">S${s}</span><span class="rh-stage-name">${WFM_LABELS[s]}</span></th>`);
      html += '</tr></thead><tbody>';
      ROLE_ORDER.forEach(role => {
        html += `<tr><td class="rh-role-header">${ROLE_FULL_NAMES[role]}</td>`;
        WFM_STAGES.forEach(s => {
          const pct = pcts[role][s];
          const intensity = maxPct > 0 ? pct / maxPct : 0;
          const alpha = Math.round(intensity * 200 + 20).toString(16).padStart(2, '0');
          const bg = pct > 0 ? (color + alpha) : '#f9fafb';
          const textColor = intensity > 0.6 ? '#fff' : '#374151';
          html += `<td><div class="rh-pct-circle ${pct === 0 ? 'rh-pct-zero' : ''}" style="background:${bg};color:${pct > 0 ? textColor : '#9ca3af'};">${pct}%</div></td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      return html;
    }

    container.innerHTML = renderHeatmapTable(pctsA, nameA, COMPARE_COLOR_A) + renderHeatmapTable(pctsB, nameB, COMPARE_COLOR_B);
  }

  // --- AI Champion Comparison ---
  function renderAiChampionComparison(surveysA, surveysB, nameA, nameB) {
    const container = document.getElementById('aiChampionContent');
    if (!container) return;

    function computeChampionData(surveys) {
      let yes = 0, no = 0;
      surveys.forEach(s => {
        const val = s.data?.teamRoles?.aiChampion?.value;
        if (val === 'yes') yes++; else no++;
      });
      const total = surveys.length;
      return { yes, no, total, pct: total > 0 ? Math.round((yes / total) * 100) : 0 };
    }

    const dataA = computeChampionData(surveysA);
    const dataB = computeChampionData(surveysB);

    container.innerHTML = `<div class="compare-widget-dual">
      <div class="compare-panel panel-a">
        <div class="compare-panel-label label-a">${escapeHtml(nameA)}</div>
        <div style="font-size:1.5rem;font-weight:800;color:${COMPARE_COLOR_A};">${dataA.pct}%</div>
        <div style="font-size:0.8rem;color:#6b7280;">${dataA.yes} of ${dataA.total} accounts</div>
      </div>
      <div class="compare-panel panel-b">
        <div class="compare-panel-label label-b">${escapeHtml(nameB)}</div>
        <div style="font-size:1.5rem;font-weight:800;color:${COMPARE_COLOR_B};">${dataB.pct}%</div>
        <div style="font-size:0.8rem;color:#6b7280;">${dataB.yes} of ${dataB.total} accounts</div>
      </div>
    </div>`;
  }


  // --- Surveys Table Comparison ---
  function renderSurveysTableComparison(allSurveys, surveysA, surveysB, nameA, nameB) {
    const idsA = new Set(surveysA.map(s => s.id));
    const idsB = new Set(surveysB.map(s => s.id));
    const sorted = sortSurveys(allSurveys);

    const tbody = document.getElementById('surveysTableBody');
    if (allSurveys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:2rem;">No surveys match the base filters.</td></tr>';
      return;
    }

    let html = '';

    sorted.forEach(s => {
      const inA = idsA.has(s.id);
      const inB = idsB.has(s.id);
      const inNeither = !inA && !inB;
      const rowStyle = inNeither ? 'opacity:0.3;' : '';

      let groupTag = '';
      if (inA && inB) groupTag = `<span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:8px;font-size:0.65rem;font-weight:700;background:${COMPARE_COLOR_A};color:#fff;margin-right:2px;">A</span><span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:8px;font-size:0.65rem;font-weight:700;background:${COMPARE_COLOR_B};color:#fff;">B</span>`;
      else if (inA) groupTag = `<span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:8px;font-size:0.65rem;font-weight:700;background:${COMPARE_COLOR_A};color:#fff;">A</span>`;
      else if (inB) groupTag = `<span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:8px;font-size:0.65rem;font-weight:700;background:${COMPARE_COLOR_B};color:#fff;">B</span>`;
      else groupTag = `<span style="font-size:0.65rem;color:#9ca3af;">—</span>`;

      const maturityVal = s.data?.clientAILandscape?.maturity?.value || '-';
      const maturityLabel = MATURITY_LABELS[maturityVal] || maturityVal;

      const wfm = s.data?.workflowMaturity;
      let wfmCell = '-';
      if (wfm) {
        const roleStages = [];
        ROLE_ORDER.forEach(role => { const st = wfm[role]?.stage; if (typeof st === 'number') roleStages.push(st); });
        if (roleStages.length > 0) {
          const avg = roleStages.reduce((a, b) => a + b, 0) / roleStages.length;
          const rounded = Math.round(avg);
          wfmCell = `<span class="maturity-badge">${WFM_LABELS[rounded] || 'Stage ' + rounded} (${avg.toFixed(1)})</span>`;
        }
      }

      const maturityClass = maturityVal !== '-' ? `maturity-${maturityVal}` : '';
      const accountType = s.account_type || 'other';

      html += `<tr style="${rowStyle}cursor:pointer;" onclick="window.location.href='account-detail.html?id=${s.id}'" title="Click to view ${escapeHtml(s.account_name)} details">
        <td style="text-align:center;width:40px;">${groupTag}</td>
        <td><strong>${escapeHtml(s.account_name)}</strong></td>
        <td><span class="type-badge type-${accountType}">${ACCOUNT_TYPE_LABELS[accountType] || accountType}</span></td>
        <td><span class="maturity-badge ${maturityClass}">${maturityLabel}</span></td>
        <td>${wfmCell}</td>
        <td>${escapeHtml(s.delivery_manager || '--')}</td>
        <td>Q${s.quarter} ${s.year}</td>
        <td class="actions" onclick="event.stopPropagation();">
          <button class="btn-icon" title="Download JSON" onclick="downloadSurvey(${s.id})">📥</button>
        </td>
      </tr>`;
    });

    tbody.innerHTML = html;
  }

  // --- Section Summaries Comparison ---
  function updateSectionSummaryComparison(surveysA, surveysB, nameA, nameB) {
    const el = document.getElementById('sectionSummaryLandscape');
    if (!el) return;
    el.innerHTML = `<div class="section-summary-item">
      <span class="section-summary-label">Comparing:</span>
      <span class="section-summary-value"><span style="color:${COMPARE_COLOR_A};">${escapeHtml(nameA)} (${surveysA.length})</span> vs <span style="color:${COMPARE_COLOR_B};">${escapeHtml(nameB)} (${surveysB.length})</span></span>
    </div>`;
  }

  function updateAccountSectionSummaryComparison(surveysA, surveysB, nameA, nameB) {
    const el = document.getElementById('sectionSummaryAccount');
    if (!el) return;
    const stagesA = computeWfmAccountStages(surveysA);
    const stagesB = computeWfmAccountStages(surveysB);
    const avgA = stagesA.length > 0 ? Math.round(stagesA.reduce((a, b) => a + b, 0) / stagesA.length) : null;
    const avgB = stagesB.length > 0 ? Math.round(stagesB.reduce((a, b) => a + b, 0) / stagesB.length) : null;
    const labelA = avgA !== null ? `${WFM_LABELS[avgA]}` : '--';
    const labelB = avgB !== null ? `${WFM_LABELS[avgB]}` : '--';

    const pctA = calculateAiUsagePercent(surveysA);
    const pctB = calculateAiUsagePercent(surveysB);

    // Revenue at Risk for comparison
    const EXCL_CMP = ['dont-know', 'not-applicable', 'custom', '_meta'];
    const riskCalc = (surveys) => {
      let total = 0;
      surveys.forEach(s => {
        const aiTools = s.data?.toolsAndInfrastructure?.ai;
        let hasAi = false;
        if (aiTools) {
          hasAi = Object.keys(aiTools).some(k => !EXCL_CMP.includes(k) && aiTools[k]?.selected === true)
            || (Array.isArray(aiTools.custom) && aiTools.custom.length > 0);
        }
        if (!hasAi) total += (s.forecasted_service_revenue || 0);
      });
      return total;
    };
    const riskA = riskCalc(surveysA);
    const riskB = riskCalc(surveysB);

    el.innerHTML = `
      <div class="section-summary-item section-summary-ai-usage">
        <span class="section-summary-label" style="color:#4338ca;">AI Usage:</span>
        <span class="section-summary-value"><span style="color:${COMPARE_COLOR_A};">${pctA !== null ? pctA + '%' : '--'}</span> vs <span style="color:${COMPARE_COLOR_B};">${pctB !== null ? pctB + '%' : '--'}</span></span>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label">WFM:</span>
        <span class="section-summary-value"><span style="color:${COMPARE_COLOR_A};">${labelA}</span> vs <span style="color:${COMPARE_COLOR_B};">${labelB}</span></span>
      </div>
      <div class="section-summary-divider"></div>
      <div class="section-summary-item">
        <span class="section-summary-label" style="color:#dc2626;">Revenue at Risk:</span>
        <span class="section-summary-value"><span style="color:${COMPARE_COLOR_A};">${formatCurrency(riskA) || '$0'}</span> vs <span style="color:${COMPARE_COLOR_B};">${formatCurrency(riskB) || '$0'}</span></span>
      </div>`;
  }

  function updateSurveysSectionSummaryComparison(surveysA, surveysB, nameA, nameB) {
    const el = document.getElementById('sectionSummarySurveys');
    if (!el) return;
    el.innerHTML = `<div class="section-summary-item">
      <span class="section-summary-label">Surveys:</span>
      <span class="section-summary-value"><span style="color:${COMPARE_COLOR_A};">${surveysA.length}</span> vs <span style="color:${COMPARE_COLOR_B};">${surveysB.length}</span></span>
    </div>`;
  }

  // ═══════════════════════════════════════════
  // SDLC AI COVERAGE MAP
  // ═══════════════════════════════════════════
  const SDLC_PHASES = [
    { key: 'requirements', label: 'Requirements' },
    { key: 'code-dev', label: 'Development' },
    { key: 'documentation', label: 'Documentation' },
    { key: 'pm', label: 'PM' },
    { key: 'design-ux', label: 'Design & UX' },
    { key: 'data-analytics', label: 'Data & Analytics' }
  ];

  function renderSdlcCoverageWidget(surveys) {
    const container = document.getElementById('sdlcCoverageContent');
    const insightEl = document.getElementById('sdlcKeyInsight');
    if (!container) return;

    if (surveys.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No survey data available</div>';
      insightEl.style.display = 'none';
      return;
    }

    // Aggregate data per phase
    const phaseData = SDLC_PHASES.map(phase => {
      let doing = 0, need = 0, total = 0;

      surveys.forEach(s => {
        const section = s.data?.useCases?.[phase.key];
        if (!section) return;
        Object.values(section).forEach(item => {
          const status = item?.status;
          total++;
          if (status === 'doing') doing++;
          else if (status === 'need') need++;
        });
      });

      const notUsing = total - doing - need;
      const doingPct = total > 0 ? Math.round((doing / total) * 100) : 0;
      const needPct = total > 0 ? Math.round((need / total) * 100) : 0;
      const notUsingPct = total > 0 ? 100 - doingPct - needPct : 0;

      return { ...phase, doing, need, notUsing, total, doingPct, needPct, notUsingPct };
    });

    // Render bars
    let html = '';
    phaseData.forEach(p => {
      const doingLabel = p.doingPct >= 10 ? `${p.doingPct}%` : '';
      const needLabel = p.needPct >= 10 ? `${p.needPct}%` : '';
      const notUsingLabel = p.notUsingPct >= 10 ? `${p.notUsingPct}%` : '';

      html += `
        <div class="sdlc-phase-block" onclick="openSdlcPhaseModal('${p.key}')" title="Click for use case breakdown">
          <div class="sdlc-phase-header">
            <span class="sdlc-phase-label">${escapeHtml(p.label)}</span>
            <span class="sdlc-phase-stats">
              <span class="doing">${p.doingPct}% Doing</span>
              <span class="separator">|</span>
              <span class="need">${p.needPct}% Need</span>
            </span>
          </div>
          <div class="sdlc-bar-track">
            ${p.doingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-doing" style="width:${p.doingPct}%">${doingLabel}</div>` : ''}
            ${p.needPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-need" style="width:${p.needPct}%">${needLabel}</div>` : ''}
            ${p.notUsingPct > 0 ? `<div class="sdlc-bar-segment sdlc-bar-notusing" style="width:${p.notUsingPct}%">${notUsingLabel}</div>` : ''}
          </div>
        </div>`;
    });
    container.innerHTML = html;

    // Key insight: find phases with highest "need" percentage
    const sortedByNeed = [...phaseData].sort((a, b) => b.needPct - a.needPct);
    const topNeed = sortedByNeed.filter(p => p.needPct > 0).slice(0, 2);
    if (topNeed.length > 0 && topNeed[0].needPct >= 10) {
      const phaseNames = topNeed.map(p => p.label).join(' & ');
      insightEl.innerHTML = `<strong>Key Insight:</strong> High "Need" in ${escapeHtml(phaseNames)} signals strategic blind spots — teams see value but lack enablement`;
      insightEl.style.display = '';
    } else if (phaseData.some(p => p.doingPct >= 50)) {
      const topDoing = [...phaseData].sort((a, b) => b.doingPct - a.doingPct)[0];
      insightEl.innerHTML = `<strong>Key Insight:</strong> ${escapeHtml(topDoing.label)} leads AI adoption at ${topDoing.doingPct}% — consider extending its practices to other phases`;
      insightEl.style.display = '';
    } else {
      insightEl.style.display = 'none';
    }

    // Widget summary
    const sdlcSummary = document.getElementById('sdlcCoverageSummary');
    if (sdlcSummary) {
      const insightText = insightEl.textContent;
      if (insightText) {
        sdlcSummary.innerHTML = `<span class="widget-summary-value">${insightEl.innerHTML}</span>`;
      } else {
        const topDoing = [...phaseData].sort((a, b) => b.doingPct - a.doingPct)[0];
        if (topDoing && topDoing.doingPct > 0) {
          sdlcSummary.innerHTML = `<span class="widget-summary-label">Highest Doing:</span> <span class="widget-summary-value">${escapeHtml(topDoing.label)} (${topDoing.doingPct}%)</span>`;
        } else {
          sdlcSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
        }
      }
    }
  }

  // ═══════════════════════════════════════════
  // AI ADOPTION BY ROLE HEATMAP WIDGET
  // ═══════════════════════════════════════════
  // Store role-stage account lists for popup
  let rhCellAccounts = {};

  function showRhCellPopup(role, stage, evt) {
    const popup = document.getElementById('rhCellPopup');
    const title = document.getElementById('rhCellPopupTitle');
    const body = document.getElementById('rhCellPopupBody');

    const roleName = ROLE_FULL_NAMES[role] || role;
    const stageName = WFM_LABELS[stage] || `Stage ${stage}`;
    const key = `${role}_${stage}`;
    const accounts = rhCellAccounts[key] || [];

    title.textContent = `${roleName} — Stage ${stage}: ${stageName} (${accounts.length})`;

    if (accounts.length === 0) {
      body.innerHTML = '<div class="rh-cell-popup-empty">No accounts at this stage</div>';
    } else {
      body.innerHTML = accounts.map(a =>
        `<div class="rh-cell-popup-item">${escapeHtml(a)}</div>`
      ).join('');
    }

    // Position near the click
    popup.classList.add('open');
    const rect = evt.currentTarget.getBoundingClientRect();
    let top = rect.bottom + 6;
    let left = rect.left + rect.width / 2 - 110;

    // Keep within viewport
    const popupW = 240;
    const popupH = popup.offsetHeight || 200;
    if (left + popupW > window.innerWidth - 12) left = window.innerWidth - popupW - 12;
    if (left < 12) left = 12;
    if (top + popupH > window.innerHeight - 12) top = rect.top - popupH - 6;

    popup.style.top = `${top}px`;
    popup.style.left = `${left}px`;
  }

  function closeRhCellPopup() {
    document.getElementById('rhCellPopup')?.classList.remove('open');
  }

  function renderAiAdoptionByRoleWidget(surveys) {
    const container = document.getElementById('aiAdoptionByRoleContent');
    if (!container) return;

    if (surveys.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No survey data available</div>';
      return;
    }

    // Count per-role per-stage + track account names
    const roleStageCounts = {};
    const roleStageAccounts = {};
    const roleTotals = {};
    ROLE_ORDER.forEach(role => {
      roleStageCounts[role] = {};
      roleStageAccounts[role] = {};
      WFM_STAGES.forEach(s => { roleStageCounts[role][s] = 0; roleStageAccounts[role][s] = []; });
      roleTotals[role] = 0;
    });

    surveys.forEach(s => {
      const wfm = s.data?.workflowMaturity;
      if (!wfm) return;
      const acctName = s.data?.accountName || s.account_name || 'Unknown';
      const matrix = s.data?.roleToolMatrix;
      ROLE_ORDER.forEach(role => {
        // When an AI tool filter is active, only count this role if it actually uses the filtered tool
        if (activeAiToolFilter) {
          if (activeAiToolFilter === '_custom') {
            // Check if role uses any custom tool
            const hasCustom = matrix && Object.keys(matrix).some(k =>
              k.startsWith(role + ':custom-') && matrix[k]?.selected
            );
            if (!hasCustom) return;
          } else {
            if (!matrix || !matrix[`${role}:${activeAiToolFilter}`]?.selected) return;
          }
        }
        const st = wfm[role]?.stage;
        if (st !== null && st !== undefined && typeof st === 'number' && st >= 0 && st <= 5) {
          roleStageCounts[role][st]++;
          roleStageAccounts[role][st].push(acctName);
          roleTotals[role]++;
        }
      });
    });

    // Store globally for popup access
    rhCellAccounts = {};
    ROLE_ORDER.forEach(role => {
      WFM_STAGES.forEach(stage => {
        rhCellAccounts[`${role}_${stage}`] = roleStageAccounts[role][stage].sort();
      });
    });

    // Compute percentages
    const roleStagePcts = {};
    ROLE_ORDER.forEach(role => {
      roleStagePcts[role] = {};
      const total = roleTotals[role];
      WFM_STAGES.forEach(stage => {
        roleStagePcts[role][stage] = total > 0
          ? Math.round((roleStageCounts[role][stage] / total) * 100)
          : 0;
      });
    });

    // Find max pct for heatmap intensity normalization
    let maxPct = 0;
    ROLE_ORDER.forEach(role => {
      WFM_STAGES.forEach(stage => {
        if (roleStagePcts[role][stage] > maxPct) maxPct = roleStagePcts[role][stage];
      });
    });
    if (maxPct === 0) maxPct = 1;

    // Compute overall per-account stage distribution (matches Maturity Journey widget)
    // When a tool filter is active, only include roles that actually use the filtered tool
    const accountStages = [];
    surveys.forEach(s => {
      const wfm = s.data?.workflowMaturity;
      if (!wfm) return;
      const matrix = s.data?.roleToolMatrix;
      const roleStages = [];
      ROLE_ORDER.forEach(role => {
        if (activeAiToolFilter) {
          if (activeAiToolFilter === '_custom') {
            const hasCustom = matrix && Object.keys(matrix).some(k =>
              k.startsWith(role + ':custom-') && matrix[k]?.selected
            );
            if (!hasCustom) return;
          } else {
            if (!matrix || !matrix[`${role}:${activeAiToolFilter}`]?.selected) return;
          }
        }
        const st = wfm[role]?.stage;
        if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
      });
      if (roleStages.length === 0) return;
      accountStages.push(Math.round(roleStages.reduce((a, b) => a + b, 0) / roleStages.length));
    });
    const overallCounts = {};
    WFM_STAGES.forEach(s => overallCounts[s] = 0);
    accountStages.forEach(s => { if (overallCounts[s] !== undefined) overallCounts[s]++; });
    const overallTotal = accountStages.length;
    const overallPcts = {};
    WFM_STAGES.forEach(s => {
      overallPcts[s] = overallTotal > 0 ? Math.round((overallCounts[s] / overallTotal) * 100) : 0;
    });

    // Build column headers
    let headerHtml = '<th class="rh-role-header" style="background:#1e3a5f;border:1px solid #2d4a6f;">&nbsp;</th>';
    WFM_STAGES.forEach(stage => {
      const color = WFM_COLORS[stage];
      headerHtml += `<th onclick="openWfmStageDetailModal(${stage})" style="cursor:pointer;" title="Click for stage description &amp; signals">
        <span class="rh-stage-num" style="background:${color};">Stage ${stage}</span>
        <span class="rh-stage-name">${WFM_LABELS[stage]}</span>
        <span class="rh-stage-pct">${overallPcts[stage]}%</span>
      </th>`;
    });

    // Build rows
    let bodyHtml = '';
    ROLE_ORDER.forEach(role => {
      const fullName = ROLE_FULL_NAMES[role];

      let rowHtml = `<td class="rh-role-header">
        <span class="rh-role-abbr">${escapeHtml(fullName)}</span>
      </td>`;

      WFM_STAGES.forEach(stage => {
        const pct = roleStagePcts[role][stage];
        const color = WFM_COLORS[stage];

        // Heatmap tint: intensity proportional to pct relative to max
        let bgStyle = '';
        if (pct > 0) {
          const intensity = 0.10 + (pct / maxPct) * 0.35;
          const alphaHex = Math.round(intensity * 255).toString(16).padStart(2, '0');
          bgStyle = `background: ${color}${alphaHex};`;
        }

        const pctClass = pct === 0 ? 'rh-pct-circle rh-pct-zero' : 'rh-pct-circle';
        const count = roleStageCounts[role][stage];
        const clickable = count > 0;
        const tdClass = clickable ? 'rh-clickable' : '';
        const clickAttr = clickable ? `onclick="showRhCellPopup('${role}', ${stage}, event)"` : '';
        const titleAttr = clickable ? `title="${count} account${count !== 1 ? 's' : ''} — click to see"` : '';
        rowHtml += `<td class="${tdClass}" style="${bgStyle}" ${clickAttr} ${titleAttr}><span class="${pctClass}">${pct}%</span></td>`;
      });

      bodyHtml += `<tr>${rowHtml}</tr>`;
    });

    container.innerHTML = `
      <table class="role-heatmap">
        <thead><tr>${headerHtml}</tr></thead>
        <tbody>${bodyHtml}</tbody>
      </table>
    `;

    // Widget summary
    const abrSummary = document.getElementById('aiAdoptionByRoleSummary');
    if (abrSummary) {
      const activeRoles = ROLE_ORDER.filter(r => roleTotals[r] > 0);
      if (activeRoles.length > 0) {
        // Find role with highest stage
        let bestRole = null, bestStage = -1;
        activeRoles.forEach(role => {
          for (let s = 5; s >= 0; s--) {
            if (roleStagePcts[role][s] > 0 && s > bestStage) { bestStage = s; bestRole = role; break; }
          }
        });
        const roleLabel = ROLE_LABELS[bestRole] || bestRole;
        abrSummary.innerHTML = `<span class="widget-summary-label">Roles:</span> <span class="widget-summary-value">${activeRoles.length} tracked</span> <span style="margin:0 0.3rem;color:#d1d5db;">|</span> <span class="widget-summary-label">Highest:</span> <span class="widget-summary-value">${roleLabel} at Stage ${bestStage}</span>`;
      } else {
        abrSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  // ═══════════════════════════════════════════
  // AI TOOLS BY ROLE WIDGET (Role × Tool Heatmap)
  // ═══════════════════════════════════════════
  function renderRoleToolMatrixWidget(surveys) {
    const container = document.getElementById('roleToolMatrixContent');
    if (!container) return;

    if (surveys.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No survey data available</div>';
      return;
    }

    // 1. Aggregate: count selected=true per role × tool across all surveys
    //    Per-role denominator: only count accounts where that role uses ≥1 AI tool
    const roleToolCounts = {};
    const roleActiveCount = {};  // accounts where this role uses at least one tool

    ROLE_ORDER.forEach(role => {
      roleToolCounts[role] = {};
      roleActiveCount[role] = 0;
      AI_TOOL_ORDER.forEach(tool => { roleToolCounts[role][tool] = 0; });
    });

    surveys.forEach(s => {
      const matrix = s.data?.roleToolMatrix;
      if (!matrix) return;
      ROLE_ORDER.forEach(role => {
        let roleUsesAny = false;
        AI_TOOL_ORDER.forEach(tool => {
          if (matrix[`${role}:${tool}`]?.selected) {
            roleToolCounts[role][tool]++;
            roleUsesAny = true;
          }
        });
        if (roleUsesAny) roleActiveCount[role]++;
      });
    });

    // Filter to roles that actually use AI tools
    const activeRoles = ROLE_ORDER.filter(r => roleActiveCount[r] > 0);

    if (activeRoles.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No role-tool matrix data available</div>';
      return;
    }

    // 2. Compute percentages (per-role denominator)
    const roleToolPcts = {};
    activeRoles.forEach(role => {
      roleToolPcts[role] = {};
      AI_TOOL_ORDER.forEach(tool => {
        roleToolPcts[role][tool] = Math.round((roleToolCounts[role][tool] / roleActiveCount[role]) * 100);
      });
    });

    // 3. Filter tools: only include those with at least 1 usage among active roles, sorted by total descending
    const toolTotals = {};
    AI_TOOL_ORDER.forEach(tool => {
      toolTotals[tool] = activeRoles.reduce((sum, role) => sum + roleToolCounts[role][tool], 0);
    });
    const activeTools = AI_TOOL_ORDER
      .filter(tool => toolTotals[tool] > 0)
      .sort((a, b) => toolTotals[b] - toolTotals[a]);

    if (activeTools.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No tools selected for any role</div>';
      return;
    }

    // 4. Find max percentage for heatmap intensity normalization
    let maxPct = 0;
    activeRoles.forEach(role => {
      activeTools.forEach(tool => {
        if (roleToolPcts[role][tool] > maxPct) maxPct = roleToolPcts[role][tool];
      });
    });
    if (maxPct === 0) maxPct = 1;

    // 5. Build column headers
    let headerHtml = '<th class="rh-role-header" style="background:#1e3a5f;border:1px solid #2d4a6f;">&nbsp;</th>';
    activeTools.forEach(tool => {
      headerHtml += `<th><span class="rh-stage-name" style="white-space:nowrap;">${escapeHtml(AI_TOOL_LABELS[tool] || tool)}</span></th>`;
    });

    // 6. Build rows (only roles that use AI tools)
    let bodyHtml = '';
    activeRoles.forEach(role => {
      let rowHtml = `<td class="rh-role-header">
        <span class="rh-role-abbr">${escapeHtml(ROLE_FULL_NAMES[role])}</span>
      </td>`;

      activeTools.forEach(tool => {
        const pct = roleToolPcts[role][tool];
        let bgStyle = '';
        if (pct > 0) {
          const intensity = 0.10 + (pct / maxPct) * 0.35;
          const alphaHex = Math.round(intensity * 255).toString(16).padStart(2, '0');
          bgStyle = `background: ${AI_TOOL_COLOR}${alphaHex};`;
        }
        const pctClass = pct === 0 ? 'rh-pct-circle rh-pct-zero' : 'rh-pct-circle';
        rowHtml += `<td style="${bgStyle}"><span class="${pctClass}">${pct}%</span></td>`;
      });

      bodyHtml += `<tr>${rowHtml}</tr>`;
    });

    container.innerHTML = `
      <table class="role-heatmap">
        <thead><tr>${headerHtml}</tr></thead>
        <tbody>${bodyHtml}</tbody>
      </table>
    `;

    // Widget summary
    const rtmSummary = document.getElementById('roleToolMatrixSummary');
    if (rtmSummary) {
      if (activeTools.length > 0 && activeRoles.length > 0) {
        rtmSummary.innerHTML = `<span class="widget-summary-label">Coverage:</span> <span class="widget-summary-value">${activeTools.length} tools across ${activeRoles.length} roles</span>`;
      } else {
        rtmSummary.innerHTML = '<span style="color:#9ca3af;">No data</span>';
      }
    }
  }

  function renderRoleToolMatrixComparison(surveysA, surveysB, nameA, nameB) {
    const container = document.getElementById('roleToolMatrixContent');
    if (!container) return;

    function computeRoleToolData(surveys) {
      const roleToolCounts = {};
      const roleActiveCount = {};
      ROLE_ORDER.forEach(role => {
        roleToolCounts[role] = {};
        roleActiveCount[role] = 0;
        AI_TOOL_ORDER.forEach(tool => { roleToolCounts[role][tool] = 0; });
      });
      surveys.forEach(s => {
        const matrix = s.data?.roleToolMatrix;
        if (!matrix) return;
        ROLE_ORDER.forEach(role => {
          let roleUsesAny = false;
          AI_TOOL_ORDER.forEach(tool => {
            if (matrix[`${role}:${tool}`]?.selected) {
              roleToolCounts[role][tool]++;
              roleUsesAny = true;
            }
          });
          if (roleUsesAny) roleActiveCount[role]++;
        });
      });
      const activeRoles = ROLE_ORDER.filter(r => roleActiveCount[r] > 0);
      const pcts = {};
      activeRoles.forEach(role => {
        pcts[role] = {};
        AI_TOOL_ORDER.forEach(tool => {
          pcts[role][tool] = Math.round((roleToolCounts[role][tool] / roleActiveCount[role]) * 100);
        });
      });
      const toolTotals = {};
      AI_TOOL_ORDER.forEach(tool => {
        toolTotals[tool] = activeRoles.reduce((sum, role) => sum + roleToolCounts[role][tool], 0);
      });
      return { pcts, toolTotals, activeRoles };
    }

    const dataA = computeRoleToolData(surveysA);
    const dataB = computeRoleToolData(surveysB);

    // Union of active tools from both groups, sorted by combined total descending
    const activeTools = AI_TOOL_ORDER
      .filter(tool => (dataA.toolTotals[tool] || 0) > 0 || (dataB.toolTotals[tool] || 0) > 0)
      .sort((a, b) => ((dataB.toolTotals[b] || 0) + (dataA.toolTotals[b] || 0))
                     - ((dataB.toolTotals[a] || 0) + (dataA.toolTotals[a] || 0)));

    if (activeTools.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No role-tool data available</div>';
      return;
    }

    // Union of active roles from both groups
    const allActiveRoles = ROLE_ORDER.filter(r =>
      (dataA.activeRoles || []).includes(r) || (dataB.activeRoles || []).includes(r)
    );

    function renderHeatmapTable(pcts, roles, groupName, color) {
      let maxPct = 0;
      roles.forEach(role => activeTools.forEach(tool => {
        if ((pcts[role]?.[tool] || 0) > maxPct) maxPct = pcts[role]?.[tool] || 0;
      }));

      let html = `<div style="margin-bottom:1rem;">
        <div style="font-size:0.8rem;font-weight:700;color:${color};margin-bottom:0.4rem;">${escapeHtml(groupName)}</div>
        <table class="role-heatmap"><thead><tr><th class="rh-role-header"></th>`;
      activeTools.forEach(tool => {
        html += `<th><span class="rh-stage-name">${escapeHtml(AI_TOOL_LABELS[tool] || tool)}</span></th>`;
      });
      html += '</tr></thead><tbody>';
      roles.forEach(role => {
        html += `<tr><td class="rh-role-header">${escapeHtml(ROLE_FULL_NAMES[role])}</td>`;
        activeTools.forEach(tool => {
          const pct = pcts[role]?.[tool] || 0;
          const intensity = maxPct > 0 ? pct / maxPct : 0;
          const alpha = Math.round(intensity * 200 + 20).toString(16).padStart(2, '0');
          const bg = pct > 0 ? (color + alpha) : '#f9fafb';
          const textColor = intensity > 0.6 ? '#fff' : '#374151';
          html += `<td><div class="rh-pct-circle ${pct === 0 ? 'rh-pct-zero' : ''}" style="background:${bg};color:${pct > 0 ? textColor : '#9ca3af'};">${pct}%</div></td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      return html;
    }

    container.innerHTML = renderHeatmapTable(dataA.pcts, allActiveRoles, nameA, COMPARE_COLOR_A)
                        + renderHeatmapTable(dataB.pcts, allActiveRoles, nameB, COMPARE_COLOR_B);
  }

  // ═══════════════════════════════════════════
  // AI CHAMPION COVERAGE WIDGET
  // ═══════════════════════════════════════════
  let activeChampionFilter = null; // 'yes', 'no', or null

  function setChampionFilter(val) {
    activeChampionFilter = activeChampionFilter === val ? null : val;
    refreshDashboard();
  }

  function toggleChampionDetails() {
    const toggle = document.querySelector('.champion-details-toggle');
    const content = document.querySelector('.champion-accounts-collapsible');
    if (!toggle || !content) return;
    const isExpanded = toggle.classList.toggle('expanded');
    content.classList.toggle('expanded');
    toggle.querySelector('.toggle-text').textContent = isExpanded ? 'Hide accounts' : 'Show accounts';
  }

  function renderAiChampionWidget(surveys) {
    const container = document.getElementById('aiChampionContent');
    if (!container) return;

    const withChampion = [];
    const withoutChampion = [];

    surveys.forEach(s => {
      const champion = s.data?.teamRoles?.aiChampion;
      const val = champion?.value;
      const acctName = s.data?.accountName || s.account || 'Unknown';
      const champions = champion?.champions || [];
      const futureChampions = champion?.futureChampions || [];

      if (val === 'yes') {
        withChampion.push({ name: acctName, champions, futureChampions });
      } else {
        withoutChampion.push({ name: acctName, champions, futureChampions });
      }
    });

    const total = surveys.length;
    const yesPct = total > 0 ? Math.round((withChampion.length / total) * 100) : 0;
    const noPct = total > 0 ? 100 - yesPct : 0;

    const yesActive = activeChampionFilter === 'yes';
    const noActive = activeChampionFilter === 'no';
    const anyFilter = activeChampionFilter !== null;

    const yesDim = anyFilter && !yesActive ? 'opacity:0.4;' : '';
    const noDim = anyFilter && !noActive ? 'opacity:0.4;' : '';
    const yesBorder = yesActive ? 'border-color:#22c55e;box-shadow:0 0 0 3px #22c55e40;' : '';
    const noBorder = noActive ? 'border-color:#ef4444;box-shadow:0 0 0 3px #ef444440;' : '';

    let html = `
      <div class="champion-summary">
        <div class="champion-card ${yesActive ? 'active' : ''}" onclick="setChampionFilter('yes')" style="${yesDim}${yesBorder}" title="Click to filter">
          <div class="champion-card-icon">✅</div>
          <div class="champion-card-info">
            <div class="champion-card-label">Has AI Champion</div>
            <div class="champion-card-value" style="color:#22c55e;">${yesPct}%</div>
            <div class="champion-card-count">${withChampion.length} account${withChampion.length !== 1 ? 's' : ''}</div>
          </div>
        </div>
        <div class="champion-card ${noActive ? 'active' : ''}" onclick="setChampionFilter('no')" style="${noDim}${noBorder}" title="Click to filter">
          <div class="champion-card-icon">❌</div>
          <div class="champion-card-info">
            <div class="champion-card-label">No AI Champion</div>
            <div class="champion-card-value" style="color:#ef4444;">${noPct}%</div>
            <div class="champion-card-count">${withoutChampion.length} account${withoutChampion.length !== 1 ? 's' : ''}</div>
          </div>
        </div>
      </div>

      <div class="champion-bar-container">
        <div class="champion-bar">
          <div class="champion-bar-yes" style="width:${yesPct}%;"></div>
          <div class="champion-bar-no" style="width:${noPct}%;"></div>
        </div>
        <div class="champion-bar-label">${yesPct}% champion coverage across ${total} account${total !== 1 ? 's' : ''}</div>
      </div>

      <div class="champion-details-toggle" onclick="toggleChampionDetails()">
        <span class="toggle-text">Show accounts</span>
        <span class="chevron">&#9662;</span>
      </div>
      <div class="champion-accounts-collapsible">
        <div class="champion-accounts">
          <div class="champion-accounts-col">
            <div class="champion-accounts-title" style="color:#22c55e;">✅ With Champion (${withChampion.length})</div>
            ${withChampion.length > 0 ? withChampion.map(a => {
              const names = a.champions.length > 0 ? ` <span class="champion-name">(${a.champions.join(', ')})</span>` : '';
              return `<div class="champion-account-item">${a.name}${names}</div>`;
            }).join('') : '<div class="champion-account-item" style="color:#9ca3af;font-style:italic;">None</div>'}
          </div>
          <div class="champion-accounts-col">
            <div class="champion-accounts-title" style="color:#ef4444;">❌ Without Champion (${withoutChampion.length})</div>
            ${withoutChampion.length > 0 ? withoutChampion.map(a => {
              const future = a.futureChampions.length > 0 ? ` <span class="champion-name" style="color:#f59e0b;">(future: ${a.futureChampions.join(', ')})</span>` : '';
              return `<div class="champion-account-item">${a.name}${future}</div>`;
            }).join('') : '<div class="champion-account-item" style="color:#9ca3af;font-style:italic;">None</div>'}
          </div>
        </div>
      </div>
    `;

    container.innerHTML = html;

    // Widget summary
    const champSummary = document.getElementById('aiChampionSummary');
    if (champSummary) {
      champSummary.innerHTML = `<span class="widget-summary-label">Coverage:</span> <span class="widget-summary-value">${yesPct}% (${withChampion.length} of ${total} accounts)</span>`;
    }
  }

  // ═══════════════════════════════════════════
  // REVENUE AT RISK WIDGET
  // ═══════════════════════════════════════════
  function toggleRevenueDetails() {
    const collapsible = document.querySelector('#aiAdoptionContent .revenue-accounts-collapsible');
    if (!collapsible) return;
    const isExpanded = collapsible.classList.contains('open');
    collapsible.classList.toggle('open');
    const toggle = collapsible.previousElementSibling;
    if (toggle) toggle.querySelector('.toggle-text').textContent = isExpanded ? 'Show accounts' : 'Hide accounts';
  }

  function setAiAdoptionFilter(val) {
    activeAiAdoptionFilter = activeAiAdoptionFilter === val ? 'all' : val;
    document.getElementById('filterAiAdoption').value = activeAiAdoptionFilter;
    refreshDashboard();
  }

  function renderAiAdoptionWidget(surveys) {
    const container = document.getElementById('aiAdoptionContent');
    if (!container) return;

    if (surveys.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:2rem;">No survey data available</div>';
      return;
    }

    const atRisk = [];
    const usingAi = [];

    surveys.forEach(s => {
      const acctName = s.data?.accountName || s.account_name || 'Unknown';
      const revenue = s.forecasted_service_revenue || 0;
      if (surveyHasAiTools(s)) { usingAi.push({ name: acctName, revenue }); }
      else { atRisk.push({ name: acctName, revenue }); }
    });

    atRisk.sort((a, b) => b.revenue - a.revenue);
    usingAi.sort((a, b) => b.revenue - a.revenue);

    const totalAccounts = surveys.length;
    const yesPct = Math.round((usingAi.length / totalAccounts) * 100);
    const noPct = 100 - yesPct;
    const totalUsingAi = usingAi.reduce((sum, a) => sum + a.revenue, 0);
    const totalAtRisk = atRisk.reduce((sum, a) => sum + a.revenue, 0);

    const usingActive = activeAiAdoptionFilter === 'using';
    const notUsingActive = activeAiAdoptionFilter === 'not-using';
    const anyFilter = activeAiAdoptionFilter !== 'all';

    container.innerHTML = `
      <div class="ai-adoption-cards">
        <div class="ai-adoption-card-unified" onclick="setAiAdoptionFilter('using')" style="border-left:4px solid #22c55e;cursor:pointer;opacity:${anyFilter && !usingActive ? '0.4' : '1'};${usingActive ? 'box-shadow:0 0 0 2px #22c55e;' : ''}" title="Click to filter: Using AI Tools">
          <div class="ai-adoption-card-pct" style="color:#22c55e;">${yesPct}%</div>
          <div class="ai-adoption-card-title">Using AI Tools</div>
          <div class="ai-adoption-card-detail">${usingAi.length} of ${totalAccounts} accounts</div>
          <div class="ai-adoption-card-revenue" style="color:#22c55e;">${formatCurrency(totalUsingAi) || '$0'}</div>
          <div class="ai-adoption-card-revenue-label">Service Revenue</div>
        </div>
        <div class="ai-adoption-card-unified" onclick="setAiAdoptionFilter('not-using')" style="border-left:4px solid #f59e0b;cursor:pointer;opacity:${anyFilter && !notUsingActive ? '0.4' : '1'};${notUsingActive ? 'box-shadow:0 0 0 2px #f59e0b;' : ''}" title="Click to filter: Not Using AI Tools">
          <div class="ai-adoption-card-pct" style="color:#f59e0b;">${noPct}%</div>
          <div class="ai-adoption-card-title">Not Using AI Tools</div>
          <div class="ai-adoption-card-detail">${atRisk.length} of ${totalAccounts} accounts</div>
          <div class="ai-adoption-card-revenue" style="color:#ef4444;">${formatCurrency(totalAtRisk) || '$0'}</div>
          <div class="ai-adoption-card-revenue-label">Service Revenue at Risk</div>
        </div>
      </div>

      <div class="champion-details-toggle" onclick="toggleRevenueDetails()">
        <span class="toggle-text">Show accounts</span>
        <span class="chevron">&#9662;</span>
      </div>
      <div class="revenue-accounts-collapsible">
        <div class="revenue-accounts">
          <div>
            <div class="revenue-accounts-title" style="color:#22c55e;">Using AI (${usingAi.length})</div>
            ${usingAi.length > 0 ? usingAi.map(a =>
              `<div class="revenue-account-item">${a.name} <span class="revenue-account-amount" style="color:#22c55e;">${formatCurrency(a.revenue) || '$0'}</span></div>`
            ).join('') : '<div class="revenue-account-item" style="color:#9ca3af;font-style:italic;">None</div>'}
          </div>
          <div>
            <div class="revenue-accounts-title" style="color:#ef4444;">Not Using AI (${atRisk.length})</div>
            ${atRisk.length > 0 ? atRisk.map(a =>
              `<div class="revenue-account-item">${a.name} <span class="revenue-account-amount" style="color:#ef4444;">${formatCurrency(a.revenue) || '$0'}</span></div>`
            ).join('') : '<div class="revenue-account-item" style="color:#9ca3af;font-style:italic;">None</div>'}
          </div>
        </div>
      </div>
    `;

    // Widget summary
    const adoptSummary = document.getElementById('aiAdoptionSummary');
    if (adoptSummary) {
      adoptSummary.innerHTML = `<span class="widget-summary-label">AI Adoption:</span> <span class="widget-summary-value">${yesPct}% using AI (${usingAi.length} of ${totalAccounts} accounts)</span>`;
    }
  }

  function renderAiAdoptionWidgetComparison(surveysA, surveysB, nameA, nameB) {
    const container = document.getElementById('aiAdoptionContent');
    if (!container) return;

    function classify(surveys) {
      let usingCount = 0, notUsingCount = 0, revUsing = 0, revAtRisk = 0;
      surveys.forEach(s => {
        const revenue = s.forecasted_service_revenue || 0;
        if (surveyHasAiTools(s)) { usingCount++; revUsing += revenue; }
        else { notUsingCount++; revAtRisk += revenue; }
      });
      const total = surveys.length;
      const yesPct = total > 0 ? Math.round((usingCount / total) * 100) : null;
      return { yesPct, noPct: yesPct !== null ? 100 - yesPct : null, usingCount, notUsingCount, total, revUsing, revAtRisk };
    }

    const a = classify(surveysA);
    const b = classify(surveysB);

    container.innerHTML = `
      <div class="ai-adoption-cards">
        <div class="ai-adoption-card-unified" style="border-left:4px solid #22c55e;">
          <div class="ai-adoption-card-pct">
            <span style="color:${COMPARE_COLOR_A};">${a.yesPct !== null ? a.yesPct + '%' : '--'}</span>
            <span style="font-size:0.8rem;color:#9ca3af;"> vs </span>
            <span style="color:${COMPARE_COLOR_B};">${b.yesPct !== null ? b.yesPct + '%' : '--'}</span>
          </div>
          <div class="ai-adoption-card-title">Using AI Tools</div>
          <div class="ai-adoption-card-detail">${nameA} vs ${nameB}</div>
          <div class="ai-adoption-card-revenue">
            <span style="color:${COMPARE_COLOR_A};">${formatCurrency(a.revUsing) || '$0'}</span>
            <span style="font-size:0.7rem;color:#9ca3af;"> vs </span>
            <span style="color:${COMPARE_COLOR_B};">${formatCurrency(b.revUsing) || '$0'}</span>
          </div>
          <div class="ai-adoption-card-revenue-label">Service Revenue</div>
        </div>
        <div class="ai-adoption-card-unified" style="border-left:4px solid #f59e0b;">
          <div class="ai-adoption-card-pct">
            <span style="color:${COMPARE_COLOR_A};">${a.noPct !== null ? a.noPct + '%' : '--'}</span>
            <span style="font-size:0.8rem;color:#9ca3af;"> vs </span>
            <span style="color:${COMPARE_COLOR_B};">${b.noPct !== null ? b.noPct + '%' : '--'}</span>
          </div>
          <div class="ai-adoption-card-title">Not Using AI Tools</div>
          <div class="ai-adoption-card-detail">${nameA} vs ${nameB}</div>
          <div class="ai-adoption-card-revenue">
            <span style="color:${COMPARE_COLOR_A};">${formatCurrency(a.revAtRisk) || '$0'}</span>
            <span style="font-size:0.7rem;color:#9ca3af;"> vs </span>
            <span style="color:${COMPARE_COLOR_B};">${formatCurrency(b.revAtRisk) || '$0'}</span>
          </div>
          <div class="ai-adoption-card-revenue-label">Service Revenue at Risk</div>
        </div>
      </div>
    `;
  }

  // ═══════════════════════════════════════════
  // SURVEYS TABLE
  // ═══════════════════════════════════════════
  function getWfmAverage(s) {
    const wfm = s.data?.workflowMaturity;
    if (!wfm) return -1;
    const stages = [];
    ROLE_ORDER.forEach(role => {
      const st = wfm[role]?.stage;
      if (st !== null && st !== undefined && typeof st === 'number') stages.push(st);
    });
    return stages.length > 0 ? stages.reduce((a, b) => a + b, 0) / stages.length : -1;
  }

  function sortSurveys(surveys) {
    const sorted = [...surveys];
    const dir = tableSortDirection === 'asc' ? 1 : -1;

    sorted.sort((a, b) => {
      let va, vb;
      switch (tableSortColumn) {
        case 'account':
          return dir * (a.account_name || '').localeCompare(b.account_name || '');
        case 'type':
          return dir * (a.account_type || '').localeCompare(b.account_type || '');
        case 'maturity':
          va = MATURITY_ORDER.indexOf(a.data?.clientAILandscape?.maturity?.value);
          vb = MATURITY_ORDER.indexOf(b.data?.clientAILandscape?.maturity?.value);
          if (va === -1) va = 999;
          if (vb === -1) vb = 999;
          return dir * (va - vb);
        case 'wfm':
          va = getWfmAverage(a);
          vb = getWfmAverage(b);
          if (va === -1) va = dir > 0 ? 999 : -999;
          if (vb === -1) vb = dir > 0 ? 999 : -999;
          return dir * (va - vb);
        case 'dm':
          return dir * (a.delivery_manager || '').localeCompare(b.delivery_manager || '');
        case 'revenue':
          return dir * ((a.forecasted_service_revenue || 0) - (b.forecasted_service_revenue || 0));
        case 'quarter':
          va = (a.year || 0) * 10 + (a.quarter || 0);
          vb = (b.year || 0) * 10 + (b.quarter || 0);
          return dir * (va - vb);
        default:
          return 0;
      }
    });
    return sorted;
  }

  function onSortColumn(column) {
    if (tableSortColumn === column) {
      tableSortDirection = tableSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      tableSortColumn = column;
      tableSortDirection = 'asc';
    }
    if (comparisonMode) {
      const allSurveys = getAllFilteredSurveys();
      const surveysA = getFilteredSurveysForGroup(groupA.filters);
      const surveysB = getFilteredSurveysForGroup(groupB.filters);
      renderSurveysTableComparison(allSurveys, surveysA, surveysB, groupA.name, groupB.name);
    } else {
      renderSurveysTable(getAllFilteredSurveys(), getFilteredSurveys());
    }
  }

  function renderSurveysTable(allSurveys, filteredSurveys) {
    const tbody = document.getElementById('surveysTableBody');
    if (allSurveys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:2rem;">No surveys match the selected filters</td></tr>';
      return;
    }

    const filteredIds = new Set(filteredSurveys.map(s => s.id));
    const hasActiveFilters = filteredSurveys.length < allSurveys.length;

    // Sort surveys before rendering
    const sorted = sortSurveys(allSurveys);

    // Update header sort indicators
    document.querySelectorAll('.surveys-table th.sortable').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
      if (th.dataset.sort === tableSortColumn) {
        th.classList.add(tableSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    });

    tbody.innerHTML = sorted.map(s => {
      const maturity = s.data?.clientAILandscape?.maturity?.value || '-';
      const maturityLabel = MATURITY_LABELS[maturity] || maturity;
      const maturityClass = maturity !== '-' ? `maturity-${maturity}` : '';

      const isSelected = selectedAccounts.has(s.account_name);
      const isMatched = filteredIds.has(s.id);
      const isDimmed = hasActiveFilters && !isMatched;
      const rowStyle = isSelected ? 'background:#eef2ff;' : (isDimmed ? 'opacity:0.4;' : '');
      const escapedName = escapeHtml(s.account_name).replace(/'/g, "\\'");

      const accountType = s.account_type || 'other';
      const typeOptions = ACCOUNT_TYPES.map(t =>
        `<option value="${t.id}"${t.id === accountType ? ' selected' : ''}>${t.label}</option>`
      ).join('');

      const dmValue = escapeHtml(s.delivery_manager || '');
      const revenueDisplay = s.forecasted_service_revenue ? formatCurrency(s.forecasted_service_revenue) : '';

      // Compute WFM stage for this account (same logic as widget)
      let wfmCell = '-';
      const wfm = s.data?.workflowMaturity;
      if (wfm) {
        const roleStages = [];
        ROLE_ORDER.forEach(role => {
          const st = wfm[role]?.stage;
          if (st !== null && st !== undefined && typeof st === 'number') roleStages.push(st);
        });
        if (roleStages.length > 0) {
          const avg = roleStages.reduce((a, b) => a + b, 0) / roleStages.length;
          const rounded = Math.round(avg);
          const label = WFM_LABELS[rounded] || `Stage ${rounded}`;
          wfmCell = `<span class="maturity-badge">${label} (${avg.toFixed(1)})</span>`;
        }
      }

      return `<tr style="${rowStyle}cursor:pointer;" onclick="window.location.href='account-detail.html?id=${s.id}'" title="Click to view ${escapeHtml(s.account_name)} details">
        <td style="text-align:center;width:40px;" onclick="event.stopPropagation();">
          <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleAccountSelection('${escapedName}')" title="Select ${escapeHtml(s.account_name)}">
        </td>
        <td onclick="event.stopPropagation();">
          <input type="text" class="account-name-input" value="${escapeHtml(s.account_name)}"
            style="${isSelected ? 'color:#4f46e5;' : ''}"
            onchange="updateAccountName(${s.id}, this.value.trim(), this)"
            title="Click to edit account name">
        </td>
        <td onclick="event.stopPropagation();">
          <select class="account-type-select" onchange="updateAccountType(${s.id}, this.value)" title="Change account type">
            ${typeOptions}
          </select>
        </td>
        <td><span class="maturity-badge ${maturityClass}">${maturityLabel}</span></td>
        <td>${wfmCell}</td>
        <td onclick="event.stopPropagation();">
          <input type="text" class="dm-input" value="${dmValue}" placeholder="—"
            onchange="updateDeliveryManager(${s.id}, this.value.trim())"
            title="Edit delivery manager">
        </td>
        <td onclick="event.stopPropagation();">
          <input type="text" class="revenue-input" value="${revenueDisplay}" placeholder="$0"
            onchange="updateForecastedRevenue(${s.id}, this.value)"
            title="Edit forecasted service revenue (USD)">
        </td>
        <td>Q${s.quarter} ${s.year}</td>
        <td class="actions" onclick="event.stopPropagation();">
          <button class="btn-icon" title="Download JSON" onclick="downloadSurvey(${s.id})">📥</button>
          <button class="btn-icon" title="Delete survey" onclick="deleteSurvey(${s.id}, '${escapedName}')">🗑️</button>
        </td>
      </tr>`;
    }).join('');

    // Sync "select all" checkbox in table header
    const selectAllCb = document.getElementById('selectAllTableAccounts');
    if (selectAllCb) {
      const visibleNames = new Set(sorted.map(s => s.account_name));
      const allSelected = visibleNames.size > 0 && [...visibleNames].every(n => selectedAccounts.has(n));
      const someSelected = [...visibleNames].some(n => selectedAccounts.has(n));
      selectAllCb.checked = allSelected;
      selectAllCb.indeterminate = someSelected && !allSelected;
    }
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function downloadSurvey(id) {
    const result = db.exec('SELECT account_name, raw_json FROM surveys WHERE id = ?', [id]);
    if (result.length === 0) return;
    const name = result[0].values[0][0];
    const json = result[0].values[0][1];
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${name.replace(/[^a-zA-Z0-9_-]/g, '_')}_survey.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportAllSurveys() {
    const result = db.exec('SELECT account_name, exported_at, year, quarter, raw_json, forecasted_service_revenue FROM surveys ORDER BY account_name, year, quarter');
    if (result.length === 0 || result[0].values.length === 0) {
      alert('No surveys to export.');
      return;
    }
    const surveys = result[0].values.map(row => ({
      account_name: row[0],
      exported_at: row[1],
      year: row[2],
      quarter: row[3],
      data: JSON.parse(row[4]),
      forecasted_service_revenue: row[5] || 0
    }));
    const json = JSON.stringify(surveys, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-surveys-export-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportDashboardPDF() {
    // 1. Expand all collapsed sections and widgets so containers have real dimensions
    const collapsedSections = [...document.querySelectorAll('.widget-section.collapsed')];
    collapsedSections.forEach(s => s.classList.remove('collapsed'));
    const collapsedWidgets = [...document.querySelectorAll('.widget-card.widget-collapsed')];
    collapsedWidgets.forEach(w => w.classList.remove('widget-collapsed'));

    // 2. Force synchronous reflow — ensures ALL containers have computed dimensions
    document.getElementById('dashboardContent').offsetHeight;

    // 3. Recreate all charts with normal animation (DO NOT disable animation —
    //    Chart.js v4 skips the initial draw entirely when animation=false)
    refreshDashboard();

    // 4. Force reflow for dynamic container heights set during render
    document.getElementById('dashboardContent').offsetHeight;

    // 5. Resize all charts to pick up final container dimensions
    Object.values(charts).forEach(chart => {
      if (chart && chart.canvas) chart.resize();
    });

    // 6. Wait for chart animations to fully complete (~1s default),
    //    then convert canvases to images and trigger print
    setTimeout(() => {
      const canvasMap = [];
      Object.entries(charts).forEach(([id, chart]) => {
        if (!chart || !chart.canvas) return;
        const canvas = chart.canvas;
        if (canvas.width === 0 || canvas.height === 0) return;
        try {
          const img = document.createElement('img');
          img.src = canvas.toDataURL('image/png');
          img.className = 'print-chart-img';
          img.style.width = '100%';
          canvas.style.display = 'none';
          canvas.parentNode.insertBefore(img, canvas);
          canvasMap.push({ canvas, img });
        } catch (e) {
          console.warn('PDF export: failed to capture chart:', id, e);
        }
      });

      window.print();

      // Restore everything
      canvasMap.forEach(({ canvas, img }) => {
        canvas.style.display = '';
        img.remove();
      });
      collapsedSections.forEach(s => s.classList.add('collapsed'));
      collapsedWidgets.forEach(w => w.classList.add('widget-collapsed'));
    }, 1500);
  }

  async function updateAccountType(id, newType) {
    db.run('UPDATE surveys SET account_type = ? WHERE id = ?', [newType, id]);
    await saveToIndexedDB();
    // No full refresh needed — the dropdown already shows the new value
  }

  async function updateDeliveryManager(id, newDM) {
    db.run('UPDATE surveys SET delivery_manager = ? WHERE id = ?', [newDM, id]);
    await saveToIndexedDB();
  }

  async function updateAccountName(id, newName, inputEl) {
    if (!newName) {
      alert('Account name cannot be empty.');
      const result = db.exec('SELECT account_name FROM surveys WHERE id = ?', [id]);
      if (result.length > 0) inputEl.value = result[0].values[0][0];
      return;
    }
    const oldResult = db.exec('SELECT account_name FROM surveys WHERE id = ?', [id]);
    if (oldResult.length === 0) return;
    const oldName = oldResult[0].values[0][0];
    if (newName === oldName) return;

    // Check for UNIQUE constraint conflict (same name + exported_at)
    const conflict = db.exec(
      'SELECT id FROM surveys WHERE account_name = ? AND exported_at = (SELECT exported_at FROM surveys WHERE id = ?)',
      [newName, id]
    );
    if (conflict.length > 0 && conflict[0].values.length > 0) {
      alert('An account with this name already exists for the same export date.');
      inputEl.value = oldName;
      return;
    }

    // Update database column
    db.run('UPDATE surveys SET account_name = ? WHERE id = ?', [newName, id]);

    // Also update accountName inside the raw_json so exports stay consistent
    const jsonResult = db.exec('SELECT raw_json FROM surveys WHERE id = ?', [id]);
    if (jsonResult.length > 0) {
      const data = JSON.parse(jsonResult[0].values[0][0]);
      data.accountName = newName;
      db.run('UPDATE surveys SET raw_json = ? WHERE id = ?', [JSON.stringify(data), id]);
    }

    await saveToIndexedDB();

    // Update selectedAccounts set if the old name was selected
    if (selectedAccounts.has(oldName)) {
      selectedAccounts.delete(oldName);
      selectedAccounts.add(newName);
    }

    // Full refresh — account name affects filters, dashboard widgets, etc.
    populateFilters();
    refreshDashboard();
  }

  function formatCurrency(value) {
    if (!value || value === 0) return '';
    return new Intl.NumberFormat('en-US', {
      style: 'currency', currency: 'USD',
      minimumFractionDigits: 0, maximumFractionDigits: 0
    }).format(value);
  }

  function parseCurrencyInput(str) {
    if (!str) return 0;
    const cleaned = str.replace(/[^0-9.\-]/g, '');
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : Math.round(num);
  }

  async function updateForecastedRevenue(id, rawValue) {
    const amount = parseCurrencyInput(rawValue);
    db.run('UPDATE surveys SET forecasted_service_revenue = ? WHERE id = ?', [amount, id]);
    await saveToIndexedDB();
    refreshDashboard();
  }

  async function deleteSurvey(id, name) {
    if (!confirm(`Delete the survey for "${name}"? This cannot be undone.`)) return;
    db.run('DELETE FROM surveys WHERE id = ?', [id]);
    await saveToIndexedDB();
    populateFilters();
    refreshDashboard();
  }

  // ═══════════════════════════════════════════
  // DATABASE EXPORT / IMPORT
  // ═══════════════════════════════════════════
  function exportDatabase() {
    const data = db.export();
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-survey-dashboard-backup-${new Date().toISOString().slice(0, 10)}.sqlite`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function importDatabase(file) {
    try {
      const buffer = await file.arrayBuffer();
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
      });
      const newDb = new SQL.Database(new Uint8Array(buffer));
      // Verify it has the expected tables
      const tables = newDb.exec("SELECT name FROM sqlite_master WHERE type='table'");
      const tableNames = tables.length > 0 ? tables[0].values.map(r => r[0]) : [];
      if (!tableNames.includes('surveys')) {
        alert('Invalid backup file: missing "surveys" table.');
        newDb.close();
        return;
      }
      if (db) db.close();
      db = newDb;
      await saveToIndexedDB();
      populateFilters();
      refreshDashboard();
      alert('Database restored successfully!');
    } catch (e) {
      alert('Error restoring database: ' + e.message);
    }
  }

  async function clearDatabase() {
    const countResult = db.exec('SELECT COUNT(*) FROM surveys');
    const count = countResult.length > 0 ? countResult[0].values[0][0] : 0;
    if (count === 0) {
      alert('The database is already empty.');
      return;
    }
    if (!confirm(`This will permanently delete all ${count} survey${count !== 1 ? 's' : ''} from the database.\n\nThis action cannot be undone. Consider creating a backup first.\n\nAre you sure?`)) return;
    db.run('DELETE FROM surveys');
    await saveToIndexedDB();
    activeMaturityFilter = null;
    selectedAccounts.clear();
    selectedDeliveryManagers.clear();
    populateFilters();
    refreshDashboard();
  }


  // ═══════════════════════════════════════════
  // EVENT LISTENERS
  // ═══════════════════════════════════════════
  function setupEventListeners() {
    // Upload button
    document.getElementById('uploadBtn').addEventListener('click', openUploadModal);

    // Modal overlay close
    document.getElementById('uploadModal').addEventListener('click', e => {
      if (e.target === document.getElementById('uploadModal')) closeUploadModal();
    });
    document.getElementById('maturityInfoModal').addEventListener('click', e => {
      if (e.target === document.getElementById('maturityInfoModal')) closeMaturityInfoModal();
    });
    document.getElementById('stageDescriptionModal').addEventListener('click', e => {
      if (e.target === document.getElementById('stageDescriptionModal')) closeStageDescriptionModal();
    });
    document.getElementById('wfmInfoModal').addEventListener('click', e => {
      if (e.target === document.getElementById('wfmInfoModal')) closeWfmInfoModal();
    });
    document.getElementById('sdlcPhaseModal').addEventListener('click', e => {
      if (e.target === document.getElementById('sdlcPhaseModal')) closeSdlcPhaseModal();
    });

    // Escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeUploadModal();
        closeMaturityInfoModal();
        closeStageDescriptionModal();
        closeWfmInfoModal();
        closeSdlcPhaseModal();
      }
    });

    // Drop zone
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => {
      if (e.target.files.length > 0) handleFiles(e.target.files);
      e.target.value = '';
    });

    // Filters
    document.getElementById('filterYear').addEventListener('change', () => {
      activeMaturityFilter = null;
      selectedAccounts.clear();
      selectedDeliveryManagers.clear();
      refreshDashboard();
    });
    document.getElementById('filterQuarter').addEventListener('change', () => {
      activeMaturityFilter = null;
      selectedAccounts.clear();
      selectedDeliveryManagers.clear();
      refreshDashboard();
    });
    // Table column sorting
    document.querySelectorAll('.surveys-table th.sortable').forEach(th => {
      th.addEventListener('click', () => onSortColumn(th.dataset.sort));
    });
    // Close account type menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('accountTypeMenu');
      const container = document.getElementById('filterAccountType');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterAccountType .multi-select-btn')?.classList.remove('open');
      }
    });
    // Close engagement type menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('engagementTypeMenu');
      const container = document.getElementById('filterEngagementType');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterEngagementType .multi-select-btn')?.classList.remove('open');
      }
    });

    // Close accounts menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('accountsMenu');
      const container = document.getElementById('filterAccounts');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterAccounts .multi-select-btn')?.classList.remove('open');
      }
    });
    // Close DM menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('dmMenu');
      const container = document.getElementById('filterDM');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('#filterDM .multi-select-btn')?.classList.remove('open');
      }
    });

    // Actions dropdown toggle
    document.getElementById('actionsToggle').addEventListener('click', toggleActionsMenu);
    // Close actions menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('actionsMenu');
      const container = document.querySelector('.actions-wrapper');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.getElementById('actionsToggle')?.classList.remove('open');
      }
    });
    // Auto-close actions menu after any action item is clicked
    document.querySelectorAll('.actions-menu-item').forEach(item => {
      item.addEventListener('click', () => {
        document.getElementById('actionsMenu')?.classList.remove('open');
        document.getElementById('actionsToggle')?.classList.remove('open');
      });
    });

    // Close role-heatmap cell popup when clicking outside
    document.addEventListener('click', e => {
      const popup = document.getElementById('rhCellPopup');
      if (popup && popup.classList.contains('open') && !popup.contains(e.target) && !e.target.closest('.rh-clickable')) {
        popup.classList.remove('open');
      }
    });

    // Database export/import/clear
    document.getElementById('exportDbBtn').addEventListener('click', exportDatabase);
    document.getElementById('exportSurveysBtn').addEventListener('click', exportAllSurveys);
    document.getElementById('exportPdfBtn').addEventListener('click', exportDashboardPDF);
    document.getElementById('importDbInput').addEventListener('change', e => {
      if (e.target.files.length > 0) importDatabase(e.target.files[0]);
      e.target.value = '';
    });
    document.getElementById('clearDbBtn').addEventListener('click', clearDatabase);
  }

  // ═══════════════════════════════════════════
  // AI CHAT PANEL
  // ═══════════════════════════════════════════

  function toggleAiChatPanel() { aiChatOpen ? closeAiChatPanel() : openAiChatPanel(); }

  function openAiChatPanel() {
    aiChatOpen = true;
    document.getElementById('aiFab').classList.add('hidden');
    document.getElementById('aiChatPanel').classList.add('open');
    document.getElementById('aiChatOverlay').classList.add('open');
    setTimeout(() => document.getElementById('aiChatInput').focus(), 300);
  }

  function closeAiChatPanel() {
    aiChatOpen = false;
    document.getElementById('aiChatPanel').classList.remove('open');
    document.getElementById('aiChatOverlay').classList.remove('open');
    document.getElementById('aiFab').classList.remove('hidden');
  }

  function toggleAiChatSettings() {
    document.getElementById('aiChatSettings').classList.toggle('open');
  }

  function loadAiKeys() {
    const openaiKey = localStorage.getItem(AI_PROVIDERS.openai.keyStorageKey) || '';
    const anthropicKey = localStorage.getItem(AI_PROVIDERS.anthropic.keyStorageKey) || '';
    document.getElementById('openaiApiKey').value = openaiKey;
    document.getElementById('anthropicApiKey').value = anthropicKey;

    const savedProvider = localStorage.getItem('ai_dashboard_provider') || 'openai';
    const savedModel = localStorage.getItem('ai_dashboard_model') || '';
    document.getElementById('aiProvider').value = savedProvider;
    populateAiModels(savedProvider, savedModel);
    updateAiKeyIndicator();
  }

  function saveAiKeys() {
    const openaiKey = document.getElementById('openaiApiKey').value.trim();
    const anthropicKey = document.getElementById('anthropicApiKey').value.trim();

    if (openaiKey) localStorage.setItem(AI_PROVIDERS.openai.keyStorageKey, openaiKey);
    else localStorage.removeItem(AI_PROVIDERS.openai.keyStorageKey);

    if (anthropicKey) localStorage.setItem(AI_PROVIDERS.anthropic.keyStorageKey, anthropicKey);
    else localStorage.removeItem(AI_PROVIDERS.anthropic.keyStorageKey);

    localStorage.setItem('ai_dashboard_provider', document.getElementById('aiProvider').value);
    localStorage.setItem('ai_dashboard_model', document.getElementById('aiModel').value);

    updateAiKeyIndicator();
    const status = document.getElementById('aiKeyStatus');
    status.textContent = '✓ Keys saved!';
    status.style.color = '#10b981';
    setTimeout(() => { status.textContent = ''; }, 2000);
  }

  function onAiProviderChange() {
    const provider = document.getElementById('aiProvider').value;
    populateAiModels(provider, '');
    localStorage.setItem('ai_dashboard_provider', provider);
    updateAiKeyIndicator();
  }

  function onAiModelChange() {
    const provider = document.getElementById('aiProvider').value;
    const model = document.getElementById('aiModel').value;
    localStorage.setItem('ai_dashboard_model', model);
    const models = AI_PROVIDERS[provider]?.models || [];
    document.getElementById('aiModelLabel').textContent = models.find(m => m.id === model)?.label || model;
  }

  function populateAiModels(provider, selectedModel) {
    const models = AI_PROVIDERS[provider]?.models || [];
    const select = document.getElementById('aiModel');
    select.innerHTML = models.map(m =>
      `<option value="${m.id}"${m.id === selectedModel ? ' selected' : ''}>${m.label}</option>`
    ).join('');
    if (!selectedModel && models.length > 0) select.value = models[0].id;

    document.getElementById('aiProviderLabel').textContent = AI_PROVIDERS[provider]?.label || provider;
    document.getElementById('aiModelLabel').textContent = models.find(m => m.id === select.value)?.label || select.value;
  }

  function updateAiKeyIndicator() {
    const provider = document.getElementById('aiProvider').value;
    const keyStorageKey = AI_PROVIDERS[provider]?.keyStorageKey;
    const hasKey = !!localStorage.getItem(keyStorageKey);
    document.getElementById('aiKeyIndicator').innerHTML = hasKey
      ? '<span style="color:#10b981;">🔑 Key set</span>'
      : '<span style="color:#f59e0b;">🔒 No key</span>';
  }

  // ── Data Context Builder ──
  function buildDataContext() {
    const surveys = getFilteredSurveys();
    const allSurveys = getAllFilteredSurveys();
    const yearVal = document.getElementById('filterYear').value;
    const quarterVal = document.getElementById('filterQuarter').value;

    let ctx = '=== DASHBOARD DATA CONTEXT ===\n\n';

    // 1. Filter state
    ctx += '## Current Filters\n';
    ctx += `Year: ${yearVal === 'all' ? 'All' : yearVal}\n`;
    ctx += `Quarter: ${quarterVal === 'all' ? 'All' : 'Q' + quarterVal}\n`;
    ctx += `Total surveys (base): ${allSurveys.length}\n`;
    ctx += `Filtered surveys shown: ${surveys.length}\n`;
    if (activeMaturityFilter) ctx += `Maturity filter: ${MATURITY_LABELS[activeMaturityFilter]}\n`;
    if (selectedAccounts.size > 0) ctx += `Account filter: ${[...selectedAccounts].join(', ')}\n`;
    if (selectedDeliveryManagers.size > 0) ctx += `DM filter: ${[...selectedDeliveryManagers].join(', ')}\n`;
    if (activeLimitingFactorFilter) ctx += `Limiting factor filter: ${LIMITING_FACTOR_LABELS[activeLimitingFactorFilter]}\n`;
    if (activeWfmStageFilter !== null) ctx += `WFM stage filter: Stage ${activeWfmStageFilter}\n`;
    if (activeAiToolFilter) ctx += `AI tool filter: ${AI_TOOL_LABELS[activeAiToolFilter] || activeAiToolFilter}\n`;
    if (activeAiChallengeFilter) ctx += `AI challenge filter: ${AI_CHALLENGE_LABELS[activeAiChallengeFilter]}\n`;
    ctx += '\n';

    // 2. Adoption stage distribution
    ctx += '## AI Adoption Stage Distribution\n';
    const matCounts = {};
    MATURITY_ORDER.forEach(k => matCounts[k] = 0);
    surveys.forEach(s => {
      const val = s.data?.clientAILandscape?.maturity?.value;
      if (val && matCounts[val] !== undefined) matCounts[val]++;
    });
    MATURITY_ORDER.forEach(k => {
      const pct = surveys.length > 0 ? Math.round((matCounts[k] / surveys.length) * 100) : 0;
      ctx += `${MATURITY_LABELS[k]}: ${matCounts[k]} (${pct}%)\n`;
    });
    ctx += '\n';

    // 3. WFM by role
    ctx += '## Workflow Maturity by Role (Average Stage 0-5)\n';
    ROLE_ORDER.forEach(role => {
      const stages = [];
      surveys.forEach(s => {
        const st = s.data?.workflowMaturity?.[role]?.stage;
        if (typeof st === 'number') stages.push(st);
      });
      const avg = stages.length > 0 ? (stages.reduce((a, b) => a + b, 0) / stages.length).toFixed(1) : 'N/A';
      ctx += `${ROLE_FULL_NAMES[role]}: avg stage ${avg} (${stages.length} responses)\n`;
    });
    ctx += '\n';

    // 4. Limiting factors
    ctx += '## Limiting Factors (ranked #1 or #2)\n';
    const lfCounts = countLimitingFactors(surveys);
    LIMITING_FACTOR_ORDER.forEach(k => {
      const pct = surveys.length > 0 ? Math.round((lfCounts[k] / surveys.length) * 100) : 0;
      ctx += `${LIMITING_FACTOR_LABELS[k]}: ${lfCounts[k]} accounts (${pct}%)\n`;
    });
    ctx += '\n';

    // 5. AI challenges
    ctx += '## AI Challenges (ranked #1 or #2)\n';
    const chCounts = countAiChallenges(surveys);
    AI_CHALLENGE_ORDER.forEach(k => {
      const pct = surveys.length > 0 ? Math.round((chCounts[k] / surveys.length) * 100) : 0;
      ctx += `${AI_CHALLENGE_LABELS[k]}: ${chCounts[k]} accounts (${pct}%)\n`;
    });
    ctx += '\n';

    // 6. AI tools
    ctx += '## AI Tools Usage\n';
    const toolData = countAiTools(surveys);
    AI_TOOL_ORDER.filter(k => toolData.toolCounts[k] > 0)
      .sort((a, b) => toolData.toolCounts[b] - toolData.toolCounts[a])
      .forEach(k => {
        const pct = surveys.length > 0 ? Math.round((toolData.toolCounts[k] / surveys.length) * 100) : 0;
        ctx += `${AI_TOOL_LABELS[k]}: ${toolData.toolCounts[k]} accounts (${pct}%)\n`;
      });
    if (toolData.customCount > 0) {
      const pct = surveys.length > 0 ? Math.round((toolData.customCount / surveys.length) * 100) : 0;
      ctx += `Other/Custom: ${toolData.customCount} accounts (${pct}%)\n`;
    }
    ctx += '\n';

    // 7. SDLC coverage
    ctx += '## SDLC AI Coverage\n';
    SDLC_PHASES.forEach(phase => {
      let using = 0, notUsing = 0;
      surveys.forEach(s => {
        const val = s.data?.sdlcAiUsage?.[phase.key]?.value;
        if (val === 'yes') using++;
        else if (val === 'no') notUsing++;
      });
      const total = using + notUsing;
      const pct = total > 0 ? Math.round((using / total) * 100) : 0;
      ctx += `${phase.label}: ${pct}% using AI (${using} of ${total})\n`;
    });
    ctx += '\n';

    // 8. AI Champion
    let champYes = 0;
    surveys.forEach(s => { if (s.data?.teamRoles?.aiChampion?.value === 'yes') champYes++; });
    const champPct = surveys.length > 0 ? Math.round((champYes / surveys.length) * 100) : 0;
    ctx += `## AI Champion\n${champYes} of ${surveys.length} accounts have a designated AI champion (${champPct}%)\n\n`;

    // 9. Per-account detail — comprehensive
    if (surveys.length > 0 && surveys.length <= 50) {
      ctx += '## Per-Account Detail\n';
      surveys.forEach(s => {
        const name = s.account_name || s.data?.accountName || 'Unknown';
        const type = ACCOUNT_TYPE_LABELS[s.account_type] || s.account_type || '-';
        const dm = s.delivery_manager || '-';
        ctx += `\n### ${name}\n`;
        ctx += `Type: ${type} | DM: ${dm}\n`;

        // Client AI Landscape
        const landscape = s.data?.clientAILandscape || {};
        const maturity = landscape.maturity?.value;
        const priority = landscape.priority?.value;
        const governance = landscape.governance?.value;
        ctx += `Maturity: ${MATURITY_LABELS[maturity] || maturity || '-'}`;
        const PRIORITY_MAP = { 'not-priority': 'Not a Priority', low: 'Low', medium: 'Medium', high: 'High', 'dont-know': "Don't Know" };
        ctx += ` | Priority: ${PRIORITY_MAP[priority] || priority || '-'}`;
        ctx += ` | Governance: ${GOVERNANCE_LABELS[governance] || governance || '-'}\n`;

        // Client AI Usage
        const usage = landscape.usage;
        if (usage) {
          const usageItems = [];
          AI_USAGE_ORDER.forEach(k => { if (usage[k]?.selected === true) usageItems.push(AI_USAGE_LABELS[k]); });
          if (usageItems.length > 0) ctx += `Client AI Usage: ${usageItems.join(', ')}\n`;
        }

        // Client Challenges (ranked)
        const challenges = landscape.challenges;
        if (challenges) {
          const ranked = [];
          Object.entries(challenges).forEach(([k, v]) => {
            if (!k.startsWith('_') && v?.rank) ranked.push({ label: AI_CHALLENGE_LABELS[k] || k, rank: v.rank });
          });
          ranked.sort((a, b) => a.rank - b.rank);
          if (ranked.length > 0) ctx += `Client Challenges: ${ranked.map(r => `#${r.rank} ${r.label}`).join(', ')}\n`;
        }

        // Client Approved Tools
        const approvedTools = landscape.approvedTools;
        if (approvedTools) {
          const APPROVED_TOOL_MAP = { 'github-copilot': 'GitHub Copilot', chatgpt: 'ChatGPT', claude: 'Claude', gemini: 'Gemini', cursor: 'Cursor', 'amazon-q-kiro': 'Amazon Q/Kiro', 'ms-copilot': 'MS Copilot', 'atlassian-rovo': 'Rovo' };
          const items = [];
          Object.entries(approvedTools).forEach(([k, v]) => {
            if (!k.startsWith('_') && v?.selected === true) items.push(APPROVED_TOOL_MAP[k] || k);
          });
          if (items.length > 0) ctx += `Client Approved Tools: ${items.join(', ')}\n`;
        }

        // Engagement
        const engagement = s.data?.engagement || {};
        const ownership = engagement.ownership;
        if (ownership) {
          const ownershipItems = [];
          ENGAGEMENT_TYPES.forEach(t => { if (ownership[t.id]?.selected === true) ownershipItems.push(t.label); });
          if (ownershipItems.length > 0) ctx += `Engagement: ${ownershipItems.join(', ')}`;
          const payment = engagement.aiToolPayment?.value;
          const PAYMENT_MAP = { us: 'We Pay', customer: 'Customer Pays', mix: 'Mix', tbd: 'TBD' };
          if (payment) ctx += ` | Tool Payment: ${PAYMENT_MAP[payment] || payment}`;
          ctx += '\n';
        }

        // Compliance
        const compliance = engagement.compliance;
        if (compliance) {
          const items = [];
          Object.entries(compliance).forEach(([k, v]) => {
            if (!k.startsWith('_') && v?.selected === true) {
              const seed = SCHEMA_SEED.find(ss => ss.section === 'engagement' && ss.subsection === 'compliance' && ss.option_id === k);
              items.push(seed ? seed.option_label : k.toUpperCase());
            }
          });
          if (items.length > 0) ctx += `Compliance: ${items.join(', ')}\n`;
        }

        // Team Roles
        const teamRoles = s.data?.teamRoles;
        if (teamRoles) {
          const roles = [];
          ROLE_ORDER.forEach(r => { if (teamRoles.roles?.[r]?.selected === true) roles.push(ROLE_FULL_NAMES[r] || r); });
          if (roles.length > 0) ctx += `Team Roles: ${roles.join(', ')}\n`;
        }

        // AI Champion
        const champion = teamRoles?.aiChampion;
        const champVal = champion?.value === 'yes' ? 'Yes' : 'No';
        ctx += `AI Champion: ${champVal}`;
        const champNames = champion?.champions || [];
        if (champNames.length > 0) ctx += ` (${champNames.join(', ')})`;
        const futureChamps = champion?.futureChampions || [];
        if (futureChamps.length > 0) ctx += ` | Future Champions: ${futureChamps.join(', ')}`;
        ctx += '\n';

        // AI Tools
        const aiTools = s.data?.toolsAndInfrastructure?.ai;
        if (aiTools) {
          const items = [];
          AI_TOOL_ORDER.forEach(k => { if (aiTools[k]?.selected === true) items.push(AI_TOOL_LABELS[k]); });
          if (Array.isArray(aiTools.custom)) aiTools.custom.forEach(c => { if (c) items.push(c); });
          if (items.length > 0) ctx += `AI Tools: ${items.join(', ')}\n`;
        }

        // Cloud Platforms
        const cloud = s.data?.toolsAndInfrastructure?.cloud;
        if (cloud) {
          const items = [];
          CLOUD_PLATFORM_ORDER.forEach(k => { if (cloud[k]?.selected === true) items.push(CLOUD_PLATFORM_LABELS[k]); });
          if (items.length > 0) ctx += `Cloud: ${items.join(', ')}\n`;
        }

        // Workflow Maturity per role
        const wfm = s.data?.workflowMaturity;
        if (wfm) {
          const wfmParts = [];
          const wfmStages = [];
          ROLE_ORDER.forEach(role => {
            const st = wfm[role]?.stage;
            if (typeof st === 'number') {
              wfmParts.push(`${ROLE_LABELS[role]}=${st}`);
              wfmStages.push(st);
            }
          });
          const avgWfm = wfmStages.length > 0 ? (wfmStages.reduce((a, b) => a + b, 0) / wfmStages.length).toFixed(1) : 'N/A';
          if (wfmParts.length > 0) ctx += `WFM (0-5): ${wfmParts.join(', ')} | Avg: ${avgWfm}\n`;
        }

        // Limiting Factors (ranked)
        const lf = s.data?.limitingFactors;
        if (lf) {
          const ranked = [];
          Object.entries(lf).forEach(([k, v]) => {
            if (!k.startsWith('_') && v?.rank) ranked.push({ label: LIMITING_FACTOR_LABELS[k] || k, rank: v.rank });
          });
          ranked.sort((a, b) => a.rank - b.rank);
          if (ranked.length > 0) ctx += `Limiting Factors: ${ranked.map(r => `#${r.rank} ${r.label}`).join(', ')}\n`;
        }

        // SDLC AI Coverage
        const sdlcUsage = s.data?.sdlcAiUsage;
        if (sdlcUsage) {
          const items = [];
          SDLC_PHASES.forEach(ph => {
            const val = sdlcUsage[ph.key]?.value;
            if (val === 'yes') items.push(ph.label);
          });
          if (items.length > 0) ctx += `SDLC AI Coverage: ${items.join(', ')}\n`;
        }

        // Use Cases summary (doing vs need counts per SDLC phase)
        const useCases = s.data?.useCases;
        if (useCases) {
          const doingPhases = [];
          const needPhases = [];
          SDLC_PHASES.forEach(phase => {
            const section = useCases[phase.key];
            if (!section) return;
            let doing = 0, need = 0;
            Object.values(section).forEach(item => {
              if (item?.status === 'doing') doing++;
              else if (item?.status === 'need') need++;
            });
            if (doing > 0) doingPhases.push(`${phase.label}(${doing})`);
            if (need > 0) needPhases.push(`${phase.label}(${need})`);
          });
          if (doingPhases.length > 0) ctx += `Use Cases Already Doing: ${doingPhases.join(', ')}\n`;
          if (needPhases.length > 0) ctx += `Use Cases Needed: ${needPhases.join(', ')}\n`;
        }

        // Success Stories
        const successStories = s.data?.teamRoles?.successStories;
        if (successStories?.hasSuccessStories === 'yes' && Array.isArray(successStories?.stories) && successStories.stories.length > 0) {
          ctx += `Success Stories: ${successStories.stories.join('; ')}\n`;
        }
      });
      ctx += '\n';
    } else if (surveys.length > 50) {
      ctx += `## Per-Account Detail\n(${surveys.length} accounts — too many for inline detail. Apply filters to narrow down, or ask about specific accounts.)\n\n`;
    }

    return ctx;
  }

  // ── System Prompt ──
  function buildSystemPrompt() {
    return `You are an AI adoption analytics assistant for a delivery management team. You analyze survey data from client accounts to provide insights about AI adoption maturity, workflow automation, tool usage, and team readiness.

You are embedded in the "AI Adoption Dashboard" — a tool used by delivery managers and AI practice leads to track AI adoption progress across their client portfolio. Each survey represents one client account's AI adoption assessment.

Data is provided at two levels:
1. **Aggregate summaries** — portfolio-wide distributions and percentages
2. **Per-account detail** — full breakdown for each individual account (up to 50 accounts)

Data dimensions available per account:
- AI Adoption Stage: Not Started, Exploring, Piloting, Scaling, Optimizing
- Client AI Priority: Not a Priority, Low, Medium, High
- Client AI Governance: No Governance, Informal, Developing, Established
- Client AI Usage: Not Using, Off-the-Shelf Tools, AI in Business Apps, Custom Solutions, Process Automation, Customer-Facing AI
- Client Challenges (ranked #1/#2): Unclear ROI, Skills Gap, Data Issues, Security/Compliance, Budget/Buy-in, Infrastructure
- Client Approved Tools: which AI tools the client has officially approved
- Engagement Model: Staff Augmentation, Project Ownership, Program Ownership, Business Outcome
- AI Tool Payment: who pays for AI tools (us, customer, mix, TBD)
- Compliance Requirements: HIPAA, GDPR, SOX, PCI-DSS, FedRAMP, SOC 2, CCPA, ISO 27001
- Team Roles: Project Manager, Business Analyst, Solutions Architect, Developer, QA Manual, QA Automation, Data Engineer, DevOps, UI/UX Designer
- AI Tools in use: GitHub Copilot, ChatGPT, Claude, Claude Code, Cursor, Windsurf, Gemini, Amazon Q/Kiro, Microsoft Copilot, IntelliJ AI, Rovo, v0, Bolt, Lovable, Perplexity (plus custom tools)
- Cloud Platforms: AWS, GCP, Azure, On-Premises
- Workflow Maturity (WFM): Stages 0-5 per role (No AI → Individual AI → Team Practices → AI-Chained → Event-Triggered → Semi-Agentic)
- Limiting Factors (ranked #1/#2): Lack of Time, Lack of Knowledge, Unclear Value, Client Not Ready, Lack of Access, Other
- SDLC AI Coverage: Requirements, Development, Documentation, PM, Design & UX, Data & Analytics
- Use Cases: per SDLC phase, count of use cases "already doing" vs "needed"
- AI Champion: whether the account has a designated AI champion, with champion names
- Success Stories: notable AI wins reported by the account

Instructions:
- Provide specific, data-driven answers. Reference account names, percentages, and distributions.
- When asked about a specific account, use the per-account detail section to give a complete picture.
- When asked about tool usage, limiting factors, challenges, etc., break down by individual account — not just aggregate totals.
- When asked for recommendations, be practical and actionable.
- Highlight patterns, outliers, and potential risks.
- If the data is limited or ambiguous, say so.
- Format responses with markdown: use **bold** for emphasis, bullet lists for clarity, and keep paragraphs concise.
- You are speaking to a delivery/AI adoption manager. Use professional but approachable language.`;
  }

  // ── Claude.ai Integration ──
  function buildClipboardPayload() {
    const systemPrompt = buildSystemPrompt();
    const dataContext = buildDataContext();

    let payload = '';
    payload += '=== AI ADOPTION DASHBOARD - DATA EXPORT ===\n\n';
    payload += 'I am pasting context from the AI Adoption Dashboard. ';
    payload += 'Below you will find your role/instructions followed by the current dashboard data. ';
    payload += 'Please use this context to answer my questions about the survey data.\n\n';
    payload += '--- INSTRUCTIONS ---\n\n';
    payload += systemPrompt;
    payload += '\n\n--- DATA ---\n\n';
    payload += dataContext;
    payload += '--- END OF CONTEXT ---\n\n';
    payload += 'I have pasted the full dashboard context above. Please confirm you have received it, then I will ask my questions.';

    return payload;
  }

  async function copyDataContext() {
    try {
      const payload = buildClipboardPayload();
      await navigator.clipboard.writeText(payload);

      // Show inline instructions
      const instructionsEl = document.getElementById('aiCopyInstructions');
      if (instructionsEl) instructionsEl.style.display = 'block';

      // Show toast
      showAiToast('Context copied! Paste it into your preferred AI assistant.');
    } catch (err) {
      // Fallback for non-HTTPS or file:// protocol
      try {
        const payload = buildClipboardPayload();
        const textArea = document.createElement('textarea');
        textArea.value = payload;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        const instructionsEl = document.getElementById('aiCopyInstructions');
        if (instructionsEl) instructionsEl.style.display = 'block';
        showAiToast('Context copied! Paste it into your preferred AI assistant.');
      } catch (fallbackErr) {
        showAiToast('Could not copy to clipboard. Please check browser permissions.');
      }
    }
  }

  function showAiToast(message, duration = 4000) {
    const toast = document.getElementById('aiToast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); }, duration);
  }

  function toggleApiSection() {
    document.getElementById('aiApiSection').classList.toggle('open');
  }

  // ── API Callers ──
  async function callOpenAI(messages, apiKey, model) {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
      body: JSON.stringify({ model, messages, max_tokens: 2048, temperature: 0.7 })
    });
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || `OpenAI API error: ${response.status}`);
    }
    const data = await response.json();
    return data.choices?.[0]?.message?.content || 'No response generated.';
  }

  async function callAnthropic(messages, apiKey, model) {
    const systemContent = messages.filter(m => m.role === 'system').map(m => m.content).join('\n\n');
    const conversationMessages = messages.filter(m => m.role !== 'system').map(m => ({ role: m.role, content: m.content }));

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({ model, max_tokens: 2048, system: systemContent, messages: conversationMessages })
    });
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || `Anthropic API error: ${response.status}`);
    }
    const data = await response.json();
    return data.content?.[0]?.text || 'No response generated.';
  }

  // ── Message Handling ──
  async function sendAiMessage(overrideText) {
    if (aiChatLoading) return;

    const input = document.getElementById('aiChatInput');
    const text = overrideText || input.value.trim();
    if (!text) return;

    const provider = document.getElementById('aiProvider').value;
    const model = document.getElementById('aiModel').value;
    const keyStorageKey = AI_PROVIDERS[provider]?.keyStorageKey;
    const apiKey = localStorage.getItem(keyStorageKey);

    if (!apiKey) {
      appendAiMessage('error', 'Please set your API key in the settings (click the ⚙ gear icon above).');
      document.getElementById('aiChatSettings').classList.add('open');
      return;
    }

    // Clear input and hide quick prompts
    if (!overrideText) input.value = '';
    input.style.height = 'auto';
    const quickEl = document.getElementById('aiQuickPrompts');
    if (quickEl) quickEl.style.display = 'none';

    // Add user message
    aiChatHistory.push({ role: 'user', content: text });
    appendAiMessage('user', text);

    // Show loading
    aiChatLoading = true;
    updateSendButtonState();
    const loadingEl = appendAiLoading();

    try {
      const dataContext = buildDataContext();
      const systemPrompt = buildSystemPrompt();

      const messages = [{ role: 'system', content: systemPrompt + '\n\n' + dataContext }];

      // Include conversation history (last 20 messages = ~10 exchanges)
      const recentHistory = aiChatHistory.slice(-20);
      recentHistory.forEach(msg => messages.push({ role: msg.role, content: msg.content }));

      let response;
      if (provider === 'openai') {
        response = await callOpenAI(messages, apiKey, model);
      } else {
        response = await callAnthropic(messages, apiKey, model);
      }

      loadingEl.remove();
      aiChatHistory.push({ role: 'assistant', content: response });
      appendAiMessage('assistant', response);
    } catch (err) {
      loadingEl.remove();
      appendAiMessage('error', `Error: ${err.message}`);
    } finally {
      aiChatLoading = false;
      updateSendButtonState();
    }
  }

  function sendQuickPrompt(el) {
    sendAiMessage(el.textContent);
  }

  function appendAiMessage(role, content) {
    const container = document.getElementById('aiChatMessages');
    const div = document.createElement('div');
    div.className = `ai-chat-message ${role}`;

    if (role === 'assistant') {
      div.innerHTML = `<div class="markdown-content">${renderMarkdown(content)}</div>`;
    } else if (role === 'error') {
      div.innerHTML = `<div style="color:#ef4444;font-size:0.85rem;">${escapeHtml(content)}</div>`;
    } else {
      div.textContent = content;
    }

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
  }

  function appendAiLoading() {
    const container = document.getElementById('aiChatMessages');
    const div = document.createElement('div');
    div.className = 'ai-chat-message assistant ai-chat-loading';
    div.innerHTML = '<div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div>';
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
  }

  function updateSendButtonState() {
    const btn = document.getElementById('aiChatSendBtn');
    btn.disabled = aiChatLoading;
  }

  function clearAiChat() {
    aiChatHistory = [];
    const container = document.getElementById('aiChatMessages');
    // Save quick prompts reference, clear, re-add
    const quickEl = document.getElementById('aiQuickPrompts');
    container.innerHTML = '';
    if (quickEl) {
      quickEl.style.display = '';
      container.appendChild(quickEl);
    }
    // Reset copy instructions and API section
    const instructionsEl = document.getElementById('aiCopyInstructions');
    if (instructionsEl) instructionsEl.style.display = 'none';
    const apiSection = document.getElementById('aiApiSection');
    if (apiSection) apiSection.classList.remove('open');
  }

  // ── Lightweight Markdown Renderer ──
  function renderMarkdown(text) {
    if (!text) return '';
    let html = escapeHtml(text);

    // Bold: **text**
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic: *text* (but not inside bold)
    html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
    // Inline code: `code`
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Headers
    html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
    // Unordered lists
    html = html.replace(/(^|\n)(- .+(?:\n- .+)*)/g, function(match, pre, listBlock) {
      const items = listBlock.split('\n').map(line => '<li>' + line.replace(/^- /, '') + '</li>').join('');
      return pre + '<ul>' + items + '</ul>';
    });
    // Ordered lists
    html = html.replace(/(^|\n)(\d+\. .+(?:\n\d+\. .+)*)/g, function(match, pre, listBlock) {
      const items = listBlock.split('\n').map(line => '<li>' + line.replace(/^\d+\. /, '') + '</li>').join('');
      return pre + '<ol>' + items + '</ol>';
    });
    // Paragraphs
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    return '<p>' + html + '</p>';
  }

  // ── Utilities ──
  function handleAiChatKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendAiMessage();
    }
  }

  function autoResizeAiInput(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  function initAiChat() {
    loadAiKeys();
    // Close on Escape
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && aiChatOpen) closeAiChatPanel();
    });
  }

  // ═══════════════════════════════════════════
  // INIT
  // ═══════════════════════════════════════════
  async function init() {
    try {
      await initDatabase();
      setupEventListeners();
      populateFilters();

      // Hide loading, show content
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      refreshDashboard();
      initAiChat();

      // Listen for updates from the survey tool in another tab
      try {
        const bc = new BroadcastChannel('ai-survey-dashboard-sync');
        bc.onmessage = async (event) => {
          if (event.data?.type === 'db-updated') {
            console.log('Dashboard DB updated by survey tool — reloading...');
            const savedData = await loadFromIndexedDB();
            if (savedData) {
              if (db) db.close();
              const SQL = await initSqlJs({
                locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
              });
              db = new SQL.Database(savedData);
              populateFilters();
              refreshDashboard();
            }
          }
        };
      } catch (e) { /* BroadcastChannel not supported */ }
    } catch (e) {
      document.getElementById('loadingState').innerHTML = `
        <div style="color:#ef4444;text-align:center;padding:2rem;">
          <div style="font-size:2rem;margin-bottom:1rem;">&#9888;&#65039;</div>
          <div style="font-weight:600;margin-bottom:0.5rem;">Failed to initialize database</div>
          <div style="font-size:0.85rem;color:#6b7280;">${e.message}</div>
        </div>`;
      console.error('Init error:', e);
    }
  }

  init();
</script>
<div class="rh-cell-popup" id="rhCellPopup">
  <div class="rh-cell-popup-header">
    <span id="rhCellPopupTitle"></span>
    <button class="rh-cell-popup-close" onclick="closeRhCellPopup()">&times;</button>
  </div>
  <div class="rh-cell-popup-body" id="rhCellPopupBody"></div>
</div>
</body>
</html>
