<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Adoption Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f3f4f6;
      color: #1f2937;
      min-height: 100vh;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .dashboard-header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1.25rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-back {
      font-size: 0.85rem;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
    }
    .header-back:hover { text-decoration: underline; }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .filter-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #6b7280;
    }
    .filter-select {
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1f2937;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .filter-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .header-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }
    .btn-primary:hover { background: #4338ca; }
    .btn-secondary {
      background: #fff;
      color: #374151;
      border: 1.5px solid #e5e7eb;
    }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
    .btn-danger {
      background: none;
      color: #ef4444;
      border: none;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
    }
    .btn-danger:hover { background: #fef2f2; }
    .btn-icon {
      background: none;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      color: #6b7280;
      border-radius: 6px;
    }
    .btn-icon:hover { background: #f3f4f6; color: #1f2937; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .dashboard-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem 2rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SUMMARY CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .summary-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .summary-card-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    .summary-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1f2937;
    }
    .summary-card-label {
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 500;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WIDGET CARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .widget-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 1.75rem;
      margin-bottom: 1.5rem;
    }
    .widget-header {
      margin-bottom: 1.25rem;
    }
    .widget-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .widget-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }
    .widget-question {
      font-size: 0.9rem;
      color: #4b5563;
      font-style: italic;
      margin-top: 0.75rem;
      padding: 0.6rem 0.85rem;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 3px solid #4f46e5;
    }

    /* Stage Callout */
    .stage-callout {
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin: 1.25rem 0;
      display: inline-flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .stage-callout-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6366f1;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .stage-callout-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #312e81;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .stage-callout-desc {
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Stage Pipeline */
    .stage-pipeline {
      display: flex;
      align-items: stretch;
      justify-content: center;
      gap: 0;
      margin: 1.5rem 0 1rem;
    }
    .stage-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.85rem 0.75rem;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      max-width: 160px;
      min-width: 100px;
      text-align: center;
      position: relative;
      background: #fff;
    }
    .stage-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      z-index: 2;
    }
    .stage-card.active {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 2;
    }
    .stage-card-icon {
      font-size: 1.5rem;
      margin-bottom: 0.35rem;
    }
    .stage-card-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #374151;
      line-height: 1.2;
      margin-bottom: 0.25rem;
    }
    .stage-card-pct {
      font-size: 1.1rem;
      font-weight: 800;
      color: #1f2937;
    }
    .stage-card-count {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.1rem;
    }
    .stage-connector {
      display: flex;
      align-items: center;
      color: #d1d5db;
      font-size: 1.1rem;
      padding: 0 0.15rem;
      flex-shrink: 0;
    }

    /* Gradient Progress Bar */
    .progress-section {
      margin: 1rem 0 1.5rem;
      padding: 0 0.5rem;
    }
    .progress-gradient-bar {
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(to right, #9ca3af, #3b82f6, #f59e0b, #10b981, #8b5cf6);
      position: relative;
      margin: 0.75rem 0 0.4rem;
    }
    .progress-marker {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #1f2937;
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      transition: left 0.5s ease;
    }
    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    /* Distribution Chart */
    .distribution-section {
      margin-top: 1.5rem;
    }
    .distribution-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #374151;
      margin-bottom: 0.75rem;
    }
    .distribution-chart-container {
      position: relative;
      width: 100%;
      height: 200px;
    }

    /* Limiting Factors Chart */
    .lf-chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }

    /* Widget Legend */
    .widget-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.25rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Widget Footer (filter controls) */
    .widget-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }
    .filter-active-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      border: 1px solid #c7d2fe;
    }
    .filter-clear-btn {
      background: none;
      border: 1px solid #d1d5db;
      color: #6b7280;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-clear-btn:hover {
      background: #f9fafb;
      color: #374151;
      border-color: #9ca3af;
    }
    .filter-clear-x {
      cursor: pointer;
      font-weight: 700;
      margin-left: 0.2rem;
      font-size: 0.9rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHARTS GRID (kept for future widgets)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .chart-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
    }
    .chart-card-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    .chart-container {
      position: relative;
      width: 100%;
      min-height: 250px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SURVEYS TABLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .surveys-section {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .surveys-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .surveys-section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
    }
    .surveys-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .surveys-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
      color: #6b7280;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .surveys-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f3f4f6;
      color: #374151;
    }
    .surveys-table tbody tr:hover td {
      background: #eef2ff;
    }
    .surveys-table tbody tr {
      transition: background 0.15s;
    }
    .surveys-table .actions {
      display: flex;
      gap: 0.25rem;
    }
    .maturity-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    /* Account Type Badges */
    .account-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .account-type-enterprise { background: #dbeafe; color: #1d4ed8; }
    .account-type-key-account { background: #fef3c7; color: #92400e; }
    .account-type-enterprise-key { background: #d1fae5; color: #065f46; }
    .account-type-other { background: #f3f4f6; color: #6b7280; }

    /* Inline Account Type Select */
    .account-type-select {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .account-type-select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .dm-input {
      padding: 0.2rem 0.4rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      outline: none;
      width: 120px;
      box-sizing: border-box;
    }
    .dm-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    .dm-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .maturity-not-started { background: #f3f4f6; color: #6b7280; }
    .maturity-exploring { background: #dbeafe; color: #1d4ed8; }
    .maturity-piloting { background: #fef3c7; color: #92400e; }
    .maturity-scaling { background: #d1fae5; color: #065f46; }
    .maturity-optimizing { background: #ede9fe; color: #5b21b6; }
    .maturity-dont-know { background: #f3f4f6; color: #9ca3af; }

    /* More info link */
    .more-info-link {
      font-size: 0.85rem;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .more-info-link:hover {
      text-decoration: underline;
      color: #4338ca;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MATURITY INFO MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .info-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .info-modal-overlay.open {
      display: flex;
    }
    .info-modal {
      background: #fff;
      border-radius: 16px;
      max-width: 720px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .info-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .info-modal-close:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .info-modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .info-modal-stage {
      margin-bottom: 1.5rem;
    }
    .info-modal-stage:last-child {
      margin-bottom: 0;
    }
    .info-modal-stage h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #4f46e5;
      margin: 0 0 0.5rem;
    }
    .info-modal-stage p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }
    .info-modal-summary {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }
    .info-modal-summary h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 0.5rem;
    }
    .info-modal-summary p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UPLOAD MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .modal-close:hover { background: #f3f4f6; color: #1f2937; }
    .modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .drop-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafbfc;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: #4f46e5;
      background: #eef2ff;
    }
    .drop-zone-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .drop-zone-text { font-size: 0.95rem; color: #6b7280; }
    .drop-zone-hint { font-size: 0.8rem; color: #9ca3af; margin-top: 0.25rem; }
    .upload-results {
      margin-top: 1.25rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .upload-result-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.85rem;
    }
    .upload-result-item:last-child { border-bottom: none; }
    .upload-result-icon { flex-shrink: 0; }
    .upload-result-text { color: #374151; }
    .upload-result-error { color: #ef4444; }
    .upload-result-warning { color: #f59e0b; }
    .upload-result-success { color: #10b981; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EMPTY STATE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    .empty-state-text {
      font-size: 0.95rem;
      color: #6b7280;
      margin-bottom: 1.5rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .loading-overlay {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4rem;
      flex-direction: column;
      gap: 1rem;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #4f46e5;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: #6b7280; font-size: 0.9rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MULTI-SELECT DROPDOWN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .multi-select {
      position: relative;
      display: inline-block;
    }
    .multi-select-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1f2937;
      background: #fff;
      cursor: pointer;
      outline: none;
      min-width: 120px;
    }
    .multi-select-btn:hover { border-color: #d1d5db; }
    .multi-select-btn:focus, .multi-select-btn.open {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .multi-select-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-select-arrow {
      font-size: 0.7rem;
      color: #6b7280;
      flex-shrink: 0;
    }
    .multi-select-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #fff;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 200;
      min-width: 200px;
      padding: 0.4rem 0;
    }
    .multi-select-menu.open { display: block; }
    .multi-select-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.85rem;
      font-size: 0.85rem;
      color: #374151;
      cursor: pointer;
      transition: background 0.1s;
    }
    .multi-select-item:hover { background: #f3f4f6; }
    .multi-select-item input[type="checkbox"] {
      accent-color: #4f46e5;
      width: 15px;
      height: 15px;
      cursor: pointer;
    }
    .multi-select-actions {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0.85rem;
      border-top: 1px solid #f3f4f6;
      margin-top: 0.25rem;
    }
    .multi-select-actions button {
      background: none;
      border: none;
      color: #4f46e5;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.15rem 0;
    }
    .multi-select-actions button:hover { text-decoration: underline; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
      .dashboard-content { padding: 1rem; }
      .dashboard-header { padding: 1rem; }
      .header-top { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .header-controls { width: 100%; }
      .stage-pipeline { flex-wrap: wrap; gap: 0.5rem; }
      .stage-connector { display: none; }
      .stage-card { min-width: 80px; }
    }
    @media (max-width: 600px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
      .surveys-table { font-size: 0.8rem; }
      .surveys-table th, .surveys-table td { padding: 0.5rem; }
      .widget-card { padding: 1.25rem; }
      .stage-card { padding: 0.6rem 0.5rem; }
      .stage-card-icon { font-size: 1.2rem; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-top">
      <div class="header-title">AI Adoption Dashboard</div>
      <a href="index.html" class="header-back">Back to Survey Tool</a>
    </div>
    <div class="header-controls">
      <div class="filter-group">
        <span class="filter-label">Year:</span>
        <select class="filter-select" id="filterYear"></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Quarter:</span>
        <select class="filter-select" id="filterQuarter">
          <option value="all">All</option>
          <option value="1">Q1</option>
          <option value="2">Q2</option>
          <option value="3">Q3</option>
          <option value="4">Q4</option>
        </select>
      </div>
      <div class="filter-group" style="position:relative;">
        <span class="filter-label">Type:</span>
        <div class="multi-select" id="filterAccountType">
          <button class="multi-select-btn" onclick="toggleAccountTypeMenu()" type="button">
            <span class="multi-select-text" id="accountTypeLabel">All Types</span>
            <span class="multi-select-arrow">&#9662;</span>
          </button>
          <div class="multi-select-menu" id="accountTypeMenu">
            <label class="multi-select-item">
              <input type="checkbox" value="enterprise" checked onchange="onAccountTypeChange()"> Enterprise
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="key-account" checked onchange="onAccountTypeChange()"> Key Account
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="enterprise-key" checked onchange="onAccountTypeChange()"> Enterprise + Key
            </label>
            <label class="multi-select-item">
              <input type="checkbox" value="other" checked onchange="onAccountTypeChange()"> Other
            </label>
            <div class="multi-select-actions">
              <button type="button" onclick="selectAllAccountTypes()">Select All</button>
              <button type="button" onclick="clearAccountTypes()">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" id="uploadBtn">Upload Survey</button>
      <button class="btn btn-secondary" id="exportDbBtn" title="Export database backup">Backup</button>
      <label class="btn btn-secondary" title="Restore database from backup" style="margin:0;">
        Restore
        <input type="file" id="importDbInput" accept=".sqlite,.db" style="display:none;">
      </label>
      <button class="btn btn-secondary" id="clearDbBtn" title="Delete all surveys and reset the database" style="color:#ef4444;border-color:#fecaca;">Clear Database</button>
    </div>
    <div class="header-subtitle" id="headerSubtitle">Loading...</div>
  </header>

  <!-- Loading State -->
  <div id="loadingState" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing database...</div>
  </div>

  <!-- Main Content (hidden until loaded) -->
  <div id="mainContent" class="dashboard-content" style="display:none;">

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">ğŸ“Š</div>
      <div class="empty-state-title">No surveys uploaded yet</div>
      <div class="empty-state-text">Upload survey JSON or ZIP files to see aggregated analytics across all your AI adoption assessments.</div>
      <button class="btn btn-primary" onclick="openUploadModal()">Upload Your First Survey</button>
    </div>

    <!-- Dashboard Content (hidden when empty) -->
    <div id="dashboardContent" style="display:none;">

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-card-icon">ğŸ“‹</div>
          <div class="summary-card-value" id="totalSurveys">0</div>
          <div class="summary-card-label">Surveys</div>
        </div>
      </div>

      <!-- Widget: Client AI Adoption Stage -->
      <div class="widget-card" id="adoptionStageWidget">
        <div class="widget-header">
          <div class="widget-title">Client AI Adoption Stage</div>
          <div class="widget-subtitle">Portfolio-wide adoption maturity</div>
          <div class="widget-question">At what stage is the client in their AI adoption journey? <a href="#" class="more-info-link" onclick="event.preventDefault();openMaturityInfoModal();">More info</a></div>
        </div>

        <!-- Average Stage Callout -->
        <div class="stage-callout" id="stageCallout">
          <div class="stage-callout-label">Average Portfolio Stage</div>
          <div class="stage-callout-value" id="stageCalloutValue">--</div>
          <div class="stage-callout-desc">Weighted average stage across all clients</div>
        </div>

        <!-- Stage Pipeline -->
        <div class="stage-pipeline" id="stagePipeline">
          <!-- Populated by JS -->
        </div>

        <!-- Gradient Progress Bar -->
        <div class="progress-section">
          <div class="progress-gradient-bar">
            <div class="progress-marker" id="progressMarker" style="left:50%;"></div>
          </div>
          <div class="progress-labels">
            <span>Less Mature</span>
            <span>More Mature</span>
          </div>
        </div>

        <!-- Distribution Chart -->
        <div class="distribution-section">
          <div class="distribution-title">Client Distribution</div>
          <div class="distribution-chart-container">
            <canvas id="chartDistribution"></canvas>
          </div>
        </div>

        <!-- Legend -->
        <div class="widget-legend" id="widgetLegend">
          <!-- Populated by JS -->
        </div>

        <!-- Filter Footer (shown when any filter active) -->
        <div class="widget-footer" id="widgetFooter" style="display:none;">
          <div id="activeFilterTags" style="display:flex;gap:0.5rem;flex-wrap:wrap;"></div>
          <button class="filter-clear-btn" onclick="clearAllFilters()">Clear All Filters</button>
        </div>
      </div>

      <!-- Widget: Limiting Factors -->
      <div class="widget-card" id="limitingFactorsWidget">
        <div class="widget-header">
          <div class="widget-title">Limiting Factors</div>
          <div class="widget-subtitle">What holds teams back from adopting AI</div>
          <div class="widget-question">Which factors are most frequently limiting AI adoption across the portfolio?</div>
        </div>
        <div class="lf-chart-container">
          <canvas id="chartLimitingFactors"></canvas>
        </div>
        <div class="widget-legend" id="lfLegend"></div>
      </div>

      <!-- Surveys Table -->
      <div class="surveys-section">
        <div class="surveys-section-header">
          <div class="surveys-section-title">Uploaded Surveys</div>
        </div>
        <table class="surveys-table">
          <thead>
            <tr>
              <th>Account</th>
              <th>Type</th>
              <th>Client AI Maturity</th>
              <th>Delivery Manager</th>
              <th>Quarter</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="surveysTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal">
      <button class="modal-close" onclick="closeUploadModal()" title="Close">&times;</button>
      <h2>Upload Survey Files</h2>
      <div style="display:flex;gap:1rem;margin-bottom:1.25rem;align-items:end;flex-wrap:wrap;">
        <div style="flex:1;min-width:120px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Year</label>
          <select class="filter-select" id="uploadYear" style="width:100%;"></select>
        </div>
        <div style="flex:1;min-width:120px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Quarter</label>
          <select class="filter-select" id="uploadQuarter" style="width:100%;">
            <option value="1">Q1 (Jan-Mar)</option>
            <option value="2">Q2 (Apr-Jun)</option>
            <option value="3">Q3 (Jul-Sep)</option>
            <option value="4">Q4 (Oct-Dec)</option>
          </select>
        </div>
        <div style="flex:1;min-width:150px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Account Type</label>
          <select class="filter-select" id="uploadAccountType" style="width:100%;">
            <option value="enterprise">Enterprise</option>
            <option value="key-account">Key Account</option>
            <option value="enterprise-key">Enterprise + Key Account</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <label style="display:block;font-size:0.8rem;font-weight:600;color:#6b7280;margin-bottom:0.35rem;text-transform:uppercase;letter-spacing:0.05em;">Delivery Manager</label>
          <input type="text" class="filter-select" id="uploadDeliveryManager" placeholder="e.g. John Smith" style="width:100%;box-sizing:border-box;">
        </div>
      </div>
      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">ğŸ“</div>
        <div class="drop-zone-text">Drag & drop JSON or ZIP files here</div>
        <div class="drop-zone-hint">or click to browse</div>
        <input type="file" id="fileInput" accept=".json,.zip" multiple style="display:none;">
      </div>
      <div class="upload-results" id="uploadResults"></div>
    </div>
  </div>

  <!-- Maturity Info Modal -->
  <div class="info-modal-overlay" id="maturityInfoModal">
    <div class="info-modal">
      <button class="info-modal-close" onclick="closeMaturityInfoModal()" title="Close">&times;</button>
      <h2>AI Adoption Journey â€” Stage Descriptions</h2>

      <div class="info-modal-stage">
        <h3>ğŸš« Not Started â€” "AI is not on the agenda"</h3>
        <p>At this stage, AI is essentially absent from the client's strategy. There are no initiatives, no owners, and no clear awareness of where AI could add value. If AI is mentioned, it's usually abstract or perceived as something for "big tech companies," not something actionable for them. Decisions are driven by existing processes and tools, and there is often uncertainty or skepticism around AI's relevance, cost, or risk.</p>
      </div>

      <div class="info-modal-stage">
        <h3>ğŸ” Exploring â€” "We are trying to understand AI"</h3>
        <p>Here the client has curiosity, but not commitment. AI is being researched, discussed, or experimented with informally â€” maybe through demos, workshops, vendor conversations, or isolated experiments by motivated individuals. There is no production usage, no clear ROI expectations, and no governance. Learning is the goal, not outcomes. This stage is about sense-making, not delivery.</p>
      </div>

      <div class="info-modal-stage">
        <h3>ğŸ§ª Piloting â€” "We are testing if AI actually works for us"</h3>
        <p>This is a key inflection point. The client is running concrete POCs tied to real problems (often in limited scopes like SDLC, support, or analytics). There is some budget, some sponsorship, and early success criteria â€” but AI is still treated as an experiment. Results are evaluated cautiously, risks are contained, and decisions about scaling are pending. AI exists, but it's not yet trusted or systemic.</p>
      </div>

      <div class="info-modal-stage">
        <h3>ğŸ“ˆ Scaling â€” "AI is becoming part of how we operate"</h3>
        <p>Now AI has proven value. Successful pilots are expanded across teams, functions, or products. Investment increases, governance starts to matter, and repeatability becomes important. The client begins to standardize tools, define ownership, train people, and integrate AI into workflows. The focus shifts from "does this work?" to "how do we roll this out safely and consistently?"</p>
      </div>

      <div class="info-modal-stage">
        <h3>âš¡ Optimizing â€” "AI is embedded and continuously improved"</h3>
        <p>At this stage, AI is no longer a project â€” it's infrastructure. AI is embedded into core processes and products, measured with KPIs, and continuously refined. The client actively optimizes models, workflows, and cost/value tradeoffs. People are trained by default, governance is mature, and AI decisions are part of normal business planning. The question is no longer whether to use AI, but how to do it better.</p>
      </div>

      <div class="info-modal-summary">
        <h3>The big difference across stages</h3>
        <p>Early stages are about learning and reducing uncertainty. Middle stages are about proving value and managing risk. Later stages are about institutionalizing and optimizing impact.</p>
      </div>
    </div>
  </div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SCHEMA DEFINITIONS (mirrors index.html)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const SCHEMA_SEED = [
    // Engagement â€” Ownership
    { section: 'engagement', subsection: 'ownership', option_id: 'staff', option_label: 'Staff Augmentation', option_type: 'multi-select', display_order: 1 },
    { section: 'engagement', subsection: 'ownership', option_id: 'project', option_label: 'Project Ownership', option_type: 'multi-select', display_order: 2 },
    { section: 'engagement', subsection: 'ownership', option_id: 'program', option_label: 'Program Ownership', option_type: 'multi-select', display_order: 3 },
    { section: 'engagement', subsection: 'ownership', option_id: 'outcome', option_label: 'Business Outcome', option_type: 'multi-select', display_order: 4 },

    // Engagement â€” Payment
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'us', option_label: 'We Are/Will', option_type: 'single-select', display_order: 1 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'customer', option_label: 'Customer Is/Will', option_type: 'single-select', display_order: 2 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'mix', option_label: 'It Is a Mix', option_type: 'single-select', display_order: 3 },
    { section: 'engagement', subsection: 'aiToolPayment', option_id: 'tbd', option_label: 'To Be Determined', option_type: 'single-select', display_order: 4 },

    // Engagement â€” Compliance
    { section: 'engagement', subsection: 'compliance', option_id: 'hipaa', option_label: 'HIPAA', option_type: 'multi-select', display_order: 1 },
    { section: 'engagement', subsection: 'compliance', option_id: 'gdpr', option_label: 'GDPR', option_type: 'multi-select', display_order: 2 },
    { section: 'engagement', subsection: 'compliance', option_id: 'sox', option_label: 'SOX', option_type: 'multi-select', display_order: 3 },
    { section: 'engagement', subsection: 'compliance', option_id: 'pci-dss', option_label: 'PCI-DSS', option_type: 'multi-select', display_order: 4 },
    { section: 'engagement', subsection: 'compliance', option_id: 'fedramp', option_label: 'FedRAMP', option_type: 'multi-select', display_order: 5 },
    { section: 'engagement', subsection: 'compliance', option_id: 'soc2', option_label: 'SOC 2', option_type: 'multi-select', display_order: 6 },
    { section: 'engagement', subsection: 'compliance', option_id: 'ccpa', option_label: 'CCPA', option_type: 'multi-select', display_order: 7 },
    { section: 'engagement', subsection: 'compliance', option_id: 'iso27001', option_label: 'ISO 27001', option_type: 'multi-select', display_order: 8 },

    // Client AI Landscape â€” Maturity
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'not-started', option_label: 'Not Started', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'exploring', option_label: 'Exploring', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'piloting', option_label: 'Piloting', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'scaling', option_label: 'Scaling', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'optimizing', option_label: 'Optimizing', option_type: 'single-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'maturity', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 6 },

    // Client AI Landscape â€” Usage
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'multi-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'not-using', option_label: 'Not Using AI', option_type: 'multi-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'off-the-shelf', option_label: 'Off-the-Shelf Tools', option_type: 'multi-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'business-apps', option_label: 'AI in Business Apps', option_type: 'multi-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'custom-solutions', option_label: 'Custom AI Solutions', option_type: 'multi-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'business-processes', option_label: 'Process Automation', option_type: 'multi-select', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'usage', option_id: 'customer-facing', option_label: 'Customer-Facing AI', option_type: 'multi-select', display_order: 7 },

    // Client AI Landscape â€” Priority
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'not-priority', option_label: 'Not a Priority', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'low', option_label: 'Low Priority', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'medium', option_label: 'Medium Priority', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'high', option_label: 'High Priority', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'priority', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 5 },

    // Client AI Landscape â€” Governance
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'none', option_label: 'No Governance', option_type: 'single-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'informal', option_label: 'Informal', option_type: 'single-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'developing', option_label: 'Developing', option_type: 'single-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'established', option_label: 'Established', option_type: 'single-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'governance', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'single-select', display_order: 5 },

    // Client AI Landscape â€” Challenges
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'unclear-roi', option_label: 'Unclear ROI', option_type: 'ranked', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'skills', option_label: 'Skills Gap', option_type: 'ranked', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'data', option_label: 'Data Issues', option_type: 'ranked', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'security', option_label: 'Security/Compliance', option_type: 'ranked', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'budget', option_label: 'Budget/Buy-in', option_type: 'ranked', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'infrastructure', option_label: 'Infrastructure', option_type: 'ranked', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'challenges', option_id: 'dont-know', option_label: "I Don't Know", option_type: 'ranked', display_order: 7 },

    // Client AI Landscape â€” Approved Tools
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'github-copilot', option_label: 'GitHub Copilot', option_type: 'multi-select', display_order: 1 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'chatgpt', option_label: 'ChatGPT / OpenAI', option_type: 'multi-select', display_order: 2 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'claude', option_label: 'Claude / Anthropic', option_type: 'multi-select', display_order: 3 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'gemini', option_label: 'Gemini / Google', option_type: 'multi-select', display_order: 4 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'cursor', option_label: 'Cursor', option_type: 'multi-select', display_order: 5 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'amazon-q-kiro', option_label: 'Amazon Q / Kiro', option_type: 'multi-select', display_order: 6 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'ms-copilot', option_label: 'Microsoft Copilot', option_type: 'multi-select', display_order: 7 },
    { section: 'clientAILandscape', subsection: 'approvedTools', option_id: 'atlassian-rovo', option_label: 'Atlassian Rovo', option_type: 'multi-select', display_order: 8 },

    // Team Roles
    { section: 'teamRoles', subsection: 'roles', option_id: 'pm', option_label: 'Project Managers / Scrum Masters', option_type: 'multi-select', display_order: 1 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'ba', option_label: 'Business Analysts / Product Managers', option_type: 'multi-select', display_order: 2 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'arch', option_label: 'Solutions Architects', option_type: 'multi-select', display_order: 3 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'swe', option_label: 'Software Engineers', option_type: 'multi-select', display_order: 4 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'qa', option_label: 'Manual QA', option_type: 'multi-select', display_order: 5 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'qaa', option_label: 'QA Automation Engineers', option_type: 'multi-select', display_order: 6 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'data', option_label: 'Data Engineers / Scientists', option_type: 'multi-select', display_order: 7 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'devops', option_label: 'DevOps Engineers', option_type: 'multi-select', display_order: 8 },
    { section: 'teamRoles', subsection: 'roles', option_id: 'ux', option_label: 'UI/UX Designers', option_type: 'multi-select', display_order: 9 },

    // Tools â€” AI
    { section: 'tools', subsection: 'ai', option_id: 'copilot', option_label: 'GitHub Copilot', option_type: 'multi-select', display_order: 1 },
    { section: 'tools', subsection: 'ai', option_id: 'chatgpt', option_label: 'ChatGPT / OpenAI', option_type: 'multi-select', display_order: 2 },
    { section: 'tools', subsection: 'ai', option_id: 'claude', option_label: 'Claude (Anthropic)', option_type: 'multi-select', display_order: 3 },
    { section: 'tools', subsection: 'ai', option_id: 'claudecode', option_label: 'Claude Code', option_type: 'multi-select', display_order: 4 },
    { section: 'tools', subsection: 'ai', option_id: 'cursor', option_label: 'Cursor', option_type: 'multi-select', display_order: 5 },
    { section: 'tools', subsection: 'ai', option_id: 'windsurf', option_label: 'Windsurf', option_type: 'multi-select', display_order: 6 },
    { section: 'tools', subsection: 'ai', option_id: 'gemini', option_label: 'Gemini (Google)', option_type: 'multi-select', display_order: 7 },
    { section: 'tools', subsection: 'ai', option_id: 'amazonq', option_label: 'Amazon Q / Kiro', option_type: 'multi-select', display_order: 8 },
    { section: 'tools', subsection: 'ai', option_id: 'mscopilot', option_label: 'Microsoft Copilot', option_type: 'multi-select', display_order: 9 },
    { section: 'tools', subsection: 'ai', option_id: 'intellij', option_label: 'IntelliJ AI', option_type: 'multi-select', display_order: 10 },
    { section: 'tools', subsection: 'ai', option_id: 'rovo', option_label: 'Atlassian Rovo', option_type: 'multi-select', display_order: 11 },
    { section: 'tools', subsection: 'ai', option_id: 'v0', option_label: 'v0 (Vercel)', option_type: 'multi-select', display_order: 12 },
    { section: 'tools', subsection: 'ai', option_id: 'bolt', option_label: 'Bolt.new', option_type: 'multi-select', display_order: 13 },
    { section: 'tools', subsection: 'ai', option_id: 'lovable', option_label: 'Lovable', option_type: 'multi-select', display_order: 14 },
    { section: 'tools', subsection: 'ai', option_id: 'perplexity', option_label: 'Perplexity', option_type: 'multi-select', display_order: 15 },

    // Tools â€” Cloud
    { section: 'tools', subsection: 'cloud', option_id: 'aws', option_label: 'Amazon Web Services (AWS)', option_type: 'multi-select', display_order: 1 },
    { section: 'tools', subsection: 'cloud', option_id: 'gcp', option_label: 'Google Cloud Platform (GCP)', option_type: 'multi-select', display_order: 2 },
    { section: 'tools', subsection: 'cloud', option_id: 'azure', option_label: 'Microsoft Azure', option_type: 'multi-select', display_order: 3 },
    { section: 'tools', subsection: 'cloud', option_id: 'onprem', option_label: 'On-Premises', option_type: 'multi-select', display_order: 4 },

    // Use Cases â€” Code Development
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-completion', option_label: 'Code completion and suggestions', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-generation', option_label: 'Generate code from natural language', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-refactoring', option_label: 'Code refactoring and optimization', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-review', option_label: 'Automated code review assistance', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'debugging', option_label: 'Debugging and error resolution', option_type: 'tri-state', display_order: 5 },
    { section: 'useCases', subsection: 'code-dev', option_id: 'code-explanation', option_label: 'Code explanation and documentation', option_type: 'tri-state', display_order: 6 },

    // Use Cases â€” Documentation
    { section: 'useCases', subsection: 'documentation', option_id: 'api-docs', option_label: 'API documentation generation', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'documentation', option_id: 'readme-generation', option_label: 'README and setup guides', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'documentation', option_id: 'technical-specs', option_label: 'Technical specification writing', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'documentation', option_id: 'inline-comments', option_label: 'Code comments and docstrings', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'documentation', option_id: 'release-notes', option_label: 'Release notes generation', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Requirements
    { section: 'useCases', subsection: 'requirements', option_id: 'user-stories', option_label: 'User story creation and refinement', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'requirements', option_id: 'requirements-analysis', option_label: 'Requirements gap analysis', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'requirements', option_id: 'acceptance-criteria', option_label: 'Acceptance criteria generation', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'requirements', option_id: 'impact-analysis', option_label: 'Impact analysis for changes', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'requirements', option_id: 'backlog-refinement', option_label: 'Backlog grooming assistance', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Project Management
    { section: 'useCases', subsection: 'pm', option_id: 'meeting-summaries', option_label: 'Meeting summaries and action items', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'pm', option_id: 'status-reports', option_label: 'Status report generation', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'pm', option_id: 'risk-identification', option_label: 'Risk identification and mitigation', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'pm', option_id: 'estimation', option_label: 'Effort estimation assistance', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'pm', option_id: 'stakeholder-comms', option_label: 'Stakeholder communication drafts', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Design & UX
    { section: 'useCases', subsection: 'design-ux', option_id: 'design-feedback', option_label: 'Design critique and feedback', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'copy-writing', option_label: 'UI copy and microcopy writing', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'accessibility', option_label: 'Accessibility recommendations', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'user-research', option_label: 'User research analysis', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'design-ux', option_id: 'persona-creation', option_label: 'Persona and journey mapping', option_type: 'tri-state', display_order: 5 },

    // Use Cases â€” Data & Analytics
    { section: 'useCases', subsection: 'data-analytics', option_id: 'sql-generation', option_label: 'SQL query generation', option_type: 'tri-state', display_order: 1 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-transformation', option_label: 'Data transformation scripts', option_type: 'tri-state', display_order: 2 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-analysis', option_label: 'Data analysis and insights', option_type: 'tri-state', display_order: 3 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'pipeline-development', option_label: 'Data pipeline development', option_type: 'tri-state', display_order: 4 },
    { section: 'useCases', subsection: 'data-analytics', option_id: 'data-quality', option_label: 'Data quality checks', option_type: 'tri-state', display_order: 5 },

    // Workflow Maturity Stages
    { section: 'workflowMaturity', subsection: 'stages', option_id: '0', option_label: 'Stage 0 - No AI Usage', option_type: 'stage', display_order: 0 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '1', option_label: 'Stage 1 - Individual AI Usage', option_type: 'stage', display_order: 1 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '2', option_label: 'Stage 2 - Team AI Practices', option_type: 'stage', display_order: 2 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '3', option_label: 'Stage 3 - AI-Chained Tasks', option_type: 'stage', display_order: 3 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '4', option_label: 'Stage 4 - Event-Triggered AI', option_type: 'stage', display_order: 4 },
    { section: 'workflowMaturity', subsection: 'stages', option_id: '5', option_label: 'Stage 5 - Semi-Agentic AI', option_type: 'stage', display_order: 5 },

    // Limiting Factors
    { section: 'limitingFactors', subsection: 'factors', option_id: 'time', option_label: 'Lack of time / competing priorities', option_type: 'ranked', display_order: 1 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'knowledge', option_label: 'Lack of knowledge or practical skills', option_type: 'ranked', display_order: 2 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'unclear-value', option_label: 'Unclear value or relevant use cases', option_type: 'ranked', display_order: 3 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'client', option_label: 'Client or stakeholder not ready or supportive', option_type: 'ranked', display_order: 4 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'access', option_label: 'Lack of access to tools, data, budget, or clear governance', option_type: 'ranked', display_order: 5 },
    { section: 'limitingFactors', subsection: 'factors', option_id: 'other', option_label: 'Other', option_type: 'ranked', display_order: 6 },
  ];

  // Label lookups for display
  const MATURITY_LABELS = { 'not-started': 'Not Started', 'exploring': 'Exploring', 'piloting': 'Piloting', 'scaling': 'Scaling', 'optimizing': 'Optimizing', 'dont-know': "Don't Know" };
  const MATURITY_ORDER = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing', 'dont-know'];
  const MATURITY_STAGES = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing']; // without dont-know
  const MATURITY_COLORS = {
    'not-started': '#9ca3af',
    'exploring': '#3b82f6',
    'piloting': '#f59e0b',
    'scaling': '#10b981',
    'optimizing': '#8b5cf6',
    'dont-know': '#d1d5db'
  };
  const MATURITY_ICONS = {
    'not-started': 'ğŸš«',
    'exploring': 'ğŸ”',
    'piloting': 'ğŸ§ª',
    'scaling': 'ğŸ“ˆ',
    'optimizing': 'âš¡',
    'dont-know': 'â“'
  };
  const GOVERNANCE_LABELS = { 'none': 'No Governance', 'informal': 'Informal', 'developing': 'Developing', 'established': 'Established', 'dont-know': "Don't Know" };
  const GOVERNANCE_ORDER = ['none', 'informal', 'developing', 'established', 'dont-know'];

  // Limiting Factors
  const LIMITING_FACTOR_LABELS = {
    time: 'Lack of time',
    knowledge: 'Lack of knowledge',
    'unclear-value': 'Unclear value',
    client: 'Client not ready',
    access: 'Lack of access',
    other: 'Other'
  };
  const LIMITING_FACTOR_ORDER = ['time', 'knowledge', 'unclear-value', 'client', 'access', 'other'];
  const LF_COLORS = { primary: '#4f46e5', secondary: '#93c5fd' };

  const ROLE_LABELS = {
    pm: 'PM / Scrum', ba: 'BA / PM', arch: 'Architects', swe: 'Software Eng.',
    qa: 'Manual QA', qaa: 'QA Automation', data: 'Data Eng.', devops: 'DevOps', ux: 'UI/UX'
  };
  const ROLE_ORDER = ['pm', 'ba', 'arch', 'swe', 'qa', 'qaa', 'data', 'devops', 'ux'];

  // Account Types
  const ACCOUNT_TYPES = [
    { id: 'enterprise', label: 'Enterprise' },
    { id: 'key-account', label: 'Key Account' },
    { id: 'enterprise-key', label: 'Enterprise + Key Account' },
    { id: 'other', label: 'Other' },
  ];
  const ACCOUNT_TYPE_LABELS = {};
  ACCOUNT_TYPES.forEach(t => ACCOUNT_TYPE_LABELS[t.id] = t.label);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GLOBAL FILTER STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let activeMaturityFilter = null; // null = all, or a stage id like 'exploring'
  let activeAccountFilter = null;  // null = all, or an account name string

  function setMaturityFilter(stage) {
    activeMaturityFilter = (activeMaturityFilter === stage) ? null : stage;
    refreshDashboard();
  }

  function clearMaturityFilter() {
    activeMaturityFilter = null;
    refreshDashboard();
  }

  function setAccountFilter(accountName) {
    activeAccountFilter = (activeAccountFilter === accountName) ? null : accountName;
    refreshDashboard();
  }

  function clearAccountFilter() {
    activeAccountFilter = null;
    refreshDashboard();
  }

  function clearAllFilters() {
    activeMaturityFilter = null;
    activeAccountFilter = null;
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACCOUNT TYPE MULTI-SELECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function toggleAccountTypeMenu() {
    const menu = document.getElementById('accountTypeMenu');
    const btn = document.querySelector('.multi-select-btn');
    const isOpen = menu.classList.contains('open');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
    if (!isOpen) btn.focus();
  }

  function updateAccountTypeLabel() {
    const selected = getSelectedAccountTypes();
    const label = document.getElementById('accountTypeLabel');
    if (selected.length === 0) {
      label.textContent = 'None';
    } else if (selected.length === ACCOUNT_TYPES.length) {
      label.textContent = 'All Types';
    } else if (selected.length === 1) {
      label.textContent = ACCOUNT_TYPE_LABELS[selected[0]];
    } else {
      label.textContent = `${selected.length} types`;
    }
  }

  function onAccountTypeChange() {
    updateAccountTypeLabel();
    activeMaturityFilter = null;
    activeAccountFilter = null;
    refreshDashboard();
  }

  function selectAllAccountTypes() {
    document.querySelectorAll('#accountTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = true);
    onAccountTypeChange();
  }

  function clearAccountTypes() {
    document.querySelectorAll('#accountTypeMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
    onAccountTypeChange();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATABASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let db = null;
  const IDB_NAME = 'AISurveyDashboard';
  const IDB_STORE = 'database';
  const IDB_KEY = 'sqliteDb';

  async function initDatabase() {
    const SQL = await initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
    });

    // Try to load from IndexedDB
    const savedData = await loadFromIndexedDB();
    if (savedData) {
      db = new SQL.Database(savedData);
      // Run migrations for existing databases
      createTables();
    } else {
      db = new SQL.Database();
      createTables();
      seedSchemaOptions();
      await saveToIndexedDB();
    }
  }

  function createTables() {
    db.run(`
      CREATE TABLE IF NOT EXISTS surveys (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        account_name TEXT NOT NULL,
        exported_at TEXT NOT NULL,
        year INTEGER NOT NULL,
        quarter INTEGER NOT NULL,
        schema_version TEXT NOT NULL,
        raw_json TEXT NOT NULL,
        uploaded_at TEXT NOT NULL DEFAULT (datetime('now')),
        account_type TEXT NOT NULL DEFAULT 'other',
        delivery_manager TEXT NOT NULL DEFAULT '',
        UNIQUE(account_name, exported_at)
      )
    `);
    // Migration: add account_type to existing databases that lack the column
    try {
      db.run("ALTER TABLE surveys ADD COLUMN account_type TEXT NOT NULL DEFAULT 'other'");
    } catch (e) {
      // Column already exists â€” ignore
    }
    // Migration: add delivery_manager to existing databases that lack the column
    try {
      db.run("ALTER TABLE surveys ADD COLUMN delivery_manager TEXT NOT NULL DEFAULT ''");
    } catch (e) {
      // Column already exists â€” ignore
    }
    db.run(`
      CREATE TABLE IF NOT EXISTS schema_options (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        section TEXT NOT NULL,
        subsection TEXT NOT NULL,
        option_id TEXT NOT NULL,
        option_label TEXT NOT NULL,
        option_type TEXT NOT NULL,
        display_order INTEGER DEFAULT 0,
        UNIQUE(section, subsection, option_id)
      )
    `);
  }

  function seedSchemaOptions() {
    const stmt = db.prepare('INSERT OR IGNORE INTO schema_options (section, subsection, option_id, option_label, option_type, display_order) VALUES (?, ?, ?, ?, ?, ?)');
    SCHEMA_SEED.forEach(s => {
      stmt.run([s.section, s.subsection, s.option_id, s.option_label, s.option_type, s.display_order]);
    });
    stmt.free();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IndexedDB Persistence
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openIDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = () => {
        req.result.createObjectStore(IDB_STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function saveToIndexedDB() {
    const data = db.export();
    const idb = await openIDB();
    return new Promise((resolve, reject) => {
      const tx = idb.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).put(data, IDB_KEY);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function loadFromIndexedDB() {
    try {
      const idb = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = idb.transaction(IDB_STORE, 'readonly');
        const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
        req.onsuccess = () => resolve(req.result ? new Uint8Array(req.result) : null);
        req.onerror = () => reject(req.error);
      });
    } catch { return null; }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MATURITY INFO MODAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openMaturityInfoModal() {
    document.getElementById('maturityInfoModal').classList.add('open');
  }
  function closeMaturityInfoModal() {
    document.getElementById('maturityInfoModal').classList.remove('open');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UPLOAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openUploadModal() {
    document.getElementById('uploadModal').classList.add('open');
    document.getElementById('uploadResults').innerHTML = '';
    // Pre-populate year/quarter with current values
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentQuarter = Math.ceil((now.getMonth() + 1) / 3);
    const yearSelect = document.getElementById('uploadYear');
    yearSelect.innerHTML = '';
    for (let y = currentYear + 1; y >= currentYear - 3; y--) {
      yearSelect.innerHTML += `<option value="${y}"${y === currentYear ? ' selected' : ''}>${y}</option>`;
    }
    document.getElementById('uploadQuarter').value = String(currentQuarter);
    document.getElementById('uploadDeliveryManager').value = '';
  }
  function closeUploadModal() {
    document.getElementById('uploadModal').classList.remove('open');
  }

  function validateSurveyJSON(data) {
    const errors = [];
    if (!data.schemaVersion) errors.push('Missing schemaVersion');
    if (!data.accountName) errors.push('Missing accountName');
    if (!data.exportedAt) errors.push('Missing exportedAt');
    else if (isNaN(new Date(data.exportedAt).getTime())) errors.push('Invalid exportedAt date');
    return errors;
  }

  async function processFile(file, year, quarter, accountType, deliveryManager) {
    const result = { filename: file.name, status: '', message: '' };

    try {
      let jsonText = null;

      if (file.name.endsWith('.zip')) {
        const zip = await JSZip.loadAsync(file);
        const jsonFile = Object.keys(zip.files).find(name => name.endsWith('.json'));
        if (!jsonFile) {
          result.status = 'error';
          result.message = 'No JSON file found inside ZIP';
          return result;
        }
        jsonText = await zip.files[jsonFile].async('text');
      } else if (file.name.endsWith('.json')) {
        jsonText = await file.text();
      } else {
        result.status = 'error';
        result.message = 'Unsupported file type (use .json or .zip)';
        return result;
      }

      const data = JSON.parse(jsonText);
      const errors = validateSurveyJSON(data);
      if (errors.length > 0) {
        result.status = 'error';
        result.message = errors.join(', ');
        return result;
      }

      // Check for duplicate
      const existing = db.exec('SELECT id FROM surveys WHERE account_name = ? AND exported_at = ?', [data.accountName, data.exportedAt]);
      if (existing.length > 0 && existing[0].values.length > 0) {
        // Replace existing
        db.run('DELETE FROM surveys WHERE account_name = ? AND exported_at = ?', [data.accountName, data.exportedAt]);
        result.status = 'warning';
        result.message = `Replaced existing survey for "${data.accountName}" -> ${year} Q${quarter}`;
      } else {
        result.status = 'success';
        result.message = `Imported "${data.accountName}" -> ${year} Q${quarter}`;
      }

      db.run(
        'INSERT INTO surveys (account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
        [data.accountName, data.exportedAt, year, quarter, data.schemaVersion, jsonText, accountType, deliveryManager]
      );

    } catch (e) {
      result.status = 'error';
      result.message = `Parse error: ${e.message}`;
    }

    return result;
  }

  async function handleFiles(files) {
    const year = parseInt(document.getElementById('uploadYear').value);
    const quarter = parseInt(document.getElementById('uploadQuarter').value);
    const accountType = document.getElementById('uploadAccountType').value;
    const deliveryManager = document.getElementById('uploadDeliveryManager').value.trim();
    const resultsDiv = document.getElementById('uploadResults');
    resultsDiv.innerHTML = '<div style="color:#6b7280;font-size:0.85rem;padding:0.5rem 0;">Processing...</div>';

    const results = [];
    for (const file of files) {
      results.push(await processFile(file, year, quarter, accountType, deliveryManager));
    }

    await saveToIndexedDB();

    // Display results
    resultsDiv.innerHTML = results.map(r => {
      const icon = r.status === 'success' ? 'âœ…' : r.status === 'warning' ? 'âš ï¸' : 'âŒ';
      const cls = r.status === 'success' ? 'upload-result-success' : r.status === 'warning' ? 'upload-result-warning' : 'upload-result-error';
      return `<div class="upload-result-item">
        <span class="upload-result-icon">${icon}</span>
        <span class="upload-result-text ${cls}"><strong>${r.filename}</strong> - ${r.message}</span>
      </div>`;
    }).join('');

    // Refresh dashboard
    populateFilters();
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FILTERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function populateFilters() {
    const yearSelect = document.getElementById('filterYear');
    const rows = db.exec('SELECT DISTINCT year FROM surveys ORDER BY year DESC');
    const years = rows.length > 0 ? rows[0].values.map(r => r[0]) : [];

    const currentVal = yearSelect.value;
    yearSelect.innerHTML = '<option value="all">All Years</option>';
    years.forEach(y => {
      yearSelect.innerHTML += `<option value="${y}"${y == currentVal ? ' selected' : ''}>${y}</option>`;
    });
    if (currentVal && currentVal !== 'all' && years.includes(parseInt(currentVal))) {
      yearSelect.value = currentVal;
    }
  }

  function getSelectedAccountTypes() {
    const checkboxes = document.querySelectorAll('#accountTypeMenu input[type="checkbox"]');
    const selected = [];
    checkboxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
    return selected;
  }

  function getFilteredSurveys() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const selectedTypes = getSelectedAccountTypes();

    // No types selected = no results
    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager FROM surveys WHERE 1=1';
    const params = [];
    if (year !== 'all') { sql += ' AND year = ?'; params.push(parseInt(year)); }
    if (quarter !== 'all') { sql += ' AND quarter = ?'; params.push(parseInt(quarter)); }
    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    let surveys = result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || ''
    }));

    // Apply maturity filter (post-query JS filter)
    if (activeMaturityFilter) {
      surveys = surveys.filter(s =>
        s.data?.clientAILandscape?.maturity?.value === activeMaturityFilter
      );
    }

    // Apply account filter
    if (activeAccountFilter) {
      surveys = surveys.filter(s => s.account_name === activeAccountFilter);
    }

    return surveys;
  }

  // Get all surveys for year/quarter/type (ignoring maturity/account name filters) for the widget itself
  function getAllFilteredSurveys() {
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    const selectedTypes = getSelectedAccountTypes();

    if (selectedTypes.length === 0) return [];

    let sql = 'SELECT id, account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager FROM surveys WHERE 1=1';
    const params = [];
    if (year !== 'all') { sql += ' AND year = ?'; params.push(parseInt(year)); }
    if (quarter !== 'all') { sql += ' AND quarter = ?'; params.push(parseInt(quarter)); }
    if (selectedTypes.length < ACCOUNT_TYPES.length) {
      sql += ` AND account_type IN (${selectedTypes.map(() => '?').join(',')})`;
      params.push(...selectedTypes);
    }
    sql += ' ORDER BY account_name';

    const result = db.exec(sql, params);
    if (result.length === 0) return [];

    return result[0].values.map(row => ({
      id: row[0], account_name: row[1], exported_at: row[2],
      year: row[3], quarter: row[4], schema_version: row[5],
      data: JSON.parse(row[6]), account_type: row[7] || 'other', delivery_manager: row[8] || ''
    }));
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DASHBOARD RENDERING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let charts = {};

  function refreshDashboard() {
    const surveys = getFilteredSurveys();
    const allSurveys = getAllFilteredSurveys(); // for the widget (unfiltered by maturity)
    const totalAll = db.exec('SELECT COUNT(*) FROM surveys');
    const totalCount = totalAll.length > 0 ? totalAll[0].values[0][0] : 0;

    // Update subtitle
    const year = document.getElementById('filterYear').value;
    const quarter = document.getElementById('filterQuarter').value;
    let filterDesc = '';
    if (year !== 'all') filterDesc += year;
    if (quarter !== 'all') filterDesc += (filterDesc ? ' ' : '') + 'Q' + quarter;

    let subtitleText = '';
    if (surveys.length > 0) {
      subtitleText = `Showing ${surveys.length} survey${surveys.length !== 1 ? 's' : ''}${filterDesc ? ' for ' + filterDesc : ''}`;
    } else if (totalCount > 0) {
      subtitleText = 'No surveys match the selected filters';
    } else {
      subtitleText = 'No surveys uploaded yet';
    }

    const subtitleEl = document.getElementById('headerSubtitle');
    let filterTags = '';
    if (activeMaturityFilter) {
      filterTags += ` <span class="filter-active-tag">Stage: ${MATURITY_LABELS[activeMaturityFilter]} <span class="filter-clear-x" onclick="clearMaturityFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (activeAccountFilter) {
      filterTags += ` <span class="filter-active-tag">Account: ${escapeHtml(activeAccountFilter)} <span class="filter-clear-x" onclick="clearAccountFilter()" title="Clear filter">&times;</span></span>`;
    }
    if (filterTags) {
      subtitleEl.innerHTML = `${subtitleText}${filterTags}`;
    } else {
      subtitleEl.textContent = subtitleText;
    }

    // Show/hide states
    document.getElementById('emptyState').style.display = totalCount === 0 ? 'block' : 'none';
    document.getElementById('dashboardContent').style.display = totalCount > 0 ? 'block' : 'none';

    if (totalCount === 0) return;

    // Summary cards (show count of filtered surveys)
    updateSummaryCards(surveys);

    // Adoption Stage Widget â€” percentages reflect active filters
    renderAdoptionStageWidget(surveys);

    // Distribution chart always shows all dots (dimmed/highlighted via filter state)
    renderDistributionChart(allSurveys);

    // Limiting Factors Widget
    renderLimitingFactorsWidget(surveys);

    // Surveys table â€” filtered by active filters
    renderSurveysTable(surveys);
  }

  function updateSummaryCards(surveys) {
    document.getElementById('totalSurveys').textContent = surveys.length;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHART HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const CHART_COLORS = {
    primary: '#4f46e5',
    primaryLight: 'rgba(79, 70, 229, 0.7)',
    secondary: '#06b6d4',
    secondaryLight: 'rgba(6, 182, 212, 0.7)',
    success: '#10b981',
    warning: '#f59e0b',
    danger: '#ef4444',
    gray: '#9ca3af',
    palette: ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1']
  };

  function destroyChart(id) {
    if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    // Also check if Chart.js has a chart on this canvas (safety net)
    const canvas = document.getElementById(id);
    if (canvas) {
      const existing = Chart.getChart(canvas);
      if (existing) existing.destroy();
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ADOPTION STAGE WIDGET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderAdoptionStageWidget(surveys) {
    // Count all maturity values including dont-know
    const counts = {};
    MATURITY_ORDER.forEach(k => counts[k] = 0);
    let totalAll = 0;
    let totalKnown = 0; // excludes dont-know (for weighted average)

    surveys.forEach(s => {
      const val = s.data?.clientAILandscape?.maturity?.value;
      if (val && MATURITY_ORDER.includes(val)) {
        counts[val]++;
        totalAll++;
        if (val !== 'dont-know') totalKnown++;
      }
    });

    // Calculate percentages over total (including dont-know)
    const pcts = {};
    MATURITY_ORDER.forEach(k => {
      pcts[k] = totalAll > 0 ? Math.round((counts[k] / totalAll) * 100) : 0;
    });

    // Calculate weighted average index (excluding dont-know)
    let weightedSum = 0;
    MATURITY_STAGES.forEach((k, i) => {
      weightedSum += counts[k] * i;
    });
    const avgIndex = totalKnown > 0 ? weightedSum / totalKnown : -1;
    const avgPosition = totalKnown > 0 ? avgIndex / (MATURITY_STAGES.length - 1) : 0.5;
    const avgStage = totalKnown > 0 ? MATURITY_STAGES[Math.round(avgIndex)] : null;

    // Update callout
    const calloutValue = document.getElementById('stageCalloutValue');
    if (avgStage) {
      calloutValue.innerHTML = `${MATURITY_ICONS[avgStage]} ${MATURITY_LABELS[avgStage]}`;
    } else {
      calloutValue.textContent = '--';
    }

    // Render stage pipeline (all stages including dont-know)
    const pipeline = document.getElementById('stagePipeline');
    pipeline.innerHTML = MATURITY_ORDER.map((stage, i) => {
      const isActive = activeMaturityFilter === stage;
      const borderColor = isActive ? MATURITY_COLORS[stage] : '#e5e7eb';
      const bgColor = isActive ? (MATURITY_COLORS[stage] + '15') : '#fff';
      const shadowColor = isActive ? (MATURITY_COLORS[stage] + '40') : 'transparent';
      const connector = i < MATURITY_ORDER.length - 1
        ? '<div class="stage-connector">&#9654;</div>'
        : '';
      return `<div class="stage-card ${isActive ? 'active' : ''}"
                   onclick="setMaturityFilter('${stage}')"
                   style="border-color:${borderColor};background:${bgColor};${isActive ? 'box-shadow:0 0 0 3px ' + shadowColor + ', 0 6px 20px rgba(0,0,0,0.12);' : ''}"
                   title="Click to filter by ${MATURITY_LABELS[stage]}">
        <div class="stage-card-icon">${MATURITY_ICONS[stage]}</div>
        <div class="stage-card-label">${MATURITY_LABELS[stage]}</div>
        <div class="stage-card-pct" style="color:${MATURITY_COLORS[stage]};">${pcts[stage]}%</div>
        <div class="stage-card-count">${counts[stage]} client${counts[stage] !== 1 ? 's' : ''}</div>
      </div>${connector}`;
    }).join('');

    // Update progress bar marker
    const marker = document.getElementById('progressMarker');
    const markerPct = Math.max(5, Math.min(95, avgPosition * 100));
    marker.style.left = markerPct + '%';

    // Render legend (all stages including dont-know)
    const legend = document.getElementById('widgetLegend');
    legend.innerHTML = MATURITY_ORDER.map(stage =>
      `<div class="legend-item">
        <div class="legend-dot" style="background:${MATURITY_COLORS[stage]};"></div>
        <span>${MATURITY_LABELS[stage]}</span>
      </div>`
    ).join('');

    // Show/hide filter footer
    const footer = document.getElementById('widgetFooter');
    const hasAnyFilter = activeMaturityFilter || activeAccountFilter;
    if (hasAnyFilter) {
      footer.style.display = 'flex';
      let tags = '';
      if (activeMaturityFilter) {
        tags += `<span class="filter-active-tag">Stage: ${MATURITY_LABELS[activeMaturityFilter]} <span class="filter-clear-x" onclick="clearMaturityFilter()" title="Clear filter">&times;</span></span>`;
      }
      if (activeAccountFilter) {
        tags += `<span class="filter-active-tag">Account: ${escapeHtml(activeAccountFilter)} <span class="filter-clear-x" onclick="clearAccountFilter()" title="Clear filter">&times;</span></span>`;
      }
      document.getElementById('activeFilterTags').innerHTML = tags;
    } else {
      footer.style.display = 'none';
    }
  }

  function renderDistributionChart(surveys) {
    destroyChart('chartDistribution');
    const ctx = document.getElementById('chartDistribution').getContext('2d');

    // Build scatter points: each survey becomes a dot at its stage's x position
    // Stack dots vertically when multiple accounts share a stage (jitter by row)
    const stageSlots = {}; // stage -> array of account names
    MATURITY_ORDER.forEach(k => stageSlots[k] = []);

    surveys.forEach(s => {
      const val = s.data?.clientAILandscape?.maturity?.value;
      if (val && MATURITY_ORDER.includes(val)) {
        stageSlots[val].push(s.account_name);
      }
    });

    // Create one dataset per stage for color coding (including dont-know)
    const datasets = MATURITY_ORDER.map((stage, stageIdx) => {
      const accounts = stageSlots[stage];
      const points = accounts.map((name, rowIdx) => ({
        x: stageIdx,
        y: rowIdx,
        accountName: name
      }));

      const stageFilteredOut = activeMaturityFilter && activeMaturityFilter !== stage;

      // Per-point colors: dim dots not matching filters, highlight selected account
      const bgColors = points.map(pt => {
        const accountDimmed = activeAccountFilter && pt.accountName !== activeAccountFilter;
        if (stageFilteredOut || accountDimmed) return MATURITY_COLORS[stage] + '30';
        return MATURITY_COLORS[stage] + 'cc';
      });
      const borderColors = points.map(pt => {
        const isSelected = activeAccountFilter && pt.accountName === activeAccountFilter;
        if (isSelected) return '#1f2937';
        return MATURITY_COLORS[stage];
      });
      const radii = points.map(pt => {
        const isSelected = activeAccountFilter && pt.accountName === activeAccountFilter;
        return isSelected ? 14 : 10;
      });
      const borderWidths = points.map(pt => {
        const isSelected = activeAccountFilter && pt.accountName === activeAccountFilter;
        return isSelected ? 3 : 2;
      });

      return {
        data: points,
        backgroundColor: bgColors,
        borderColor: borderColors,
        borderWidth: borderWidths,
        pointRadius: radii,
        pointHoverRadius: 14,
        pointStyle: 'circle',
        label: MATURITY_LABELS[stage],
      };
    });

    // Find max y for axis range
    const maxDots = Math.max(1, ...MATURITY_ORDER.map(k => stageSlots[k].length));

    charts['chartDistribution'] = new Chart(ctx, {
      type: 'scatter',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: function() { return ''; },
              label: function(context) {
                const pt = context.raw;
                const stageName = MATURITY_LABELS[MATURITY_ORDER[pt.x]];
                return `${pt.accountName} â€” ${stageName}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            min: -0.5,
            max: MATURITY_ORDER.length - 0.5,
            ticks: {
              stepSize: 1,
              callback: function(value) {
                return MATURITY_ORDER[value] ? MATURITY_LABELS[MATURITY_ORDER[value]] : '';
              },
              font: { size: 11, weight: '600' },
              color: '#6b7280'
            },
            grid: { display: false }
          },
          y: {
            min: -0.5,
            max: maxDots - 0.5,
            ticks: { display: false },
            grid: { display: false },
            border: { display: false }
          }
        },
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const pt = datasets[elements[0].datasetIndex].data[elements[0].index];
            // Clicking a dot filters by that account
            setAccountFilter(pt.accountName);
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
      }
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LIMITING FACTORS WIDGET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderLimitingFactorsWidget(surveys) {
    destroyChart('chartLimitingFactors');

    // Count how many times each factor appears as primary (rank 1) or secondary (rank 2)
    const primaryCounts = {};
    const secondaryCounts = {};
    LIMITING_FACTOR_ORDER.forEach(k => { primaryCounts[k] = 0; secondaryCounts[k] = 0; });

    const totalSurveys = surveys.length;

    surveys.forEach(s => {
      const lf = s.data?.limitingFactors;
      if (!lf) return;
      Object.entries(lf).forEach(([k, v]) => {
        if (k.startsWith('_')) return;
        if (v?.rank === 1) primaryCounts[k]++;
        else if (v?.rank === 2) secondaryCounts[k]++;
      });
    });

    // Sort factors by total mentions (primary + secondary) descending
    const sorted = [...LIMITING_FACTOR_ORDER].sort((a, b) => {
      const totalA = primaryCounts[a] + secondaryCounts[a];
      const totalB = primaryCounts[b] + secondaryCounts[b];
      return totalB - totalA;
    });

    // Calculate percentages
    const primaryPcts = {};
    const secondaryPcts = {};
    sorted.forEach(k => {
      primaryPcts[k] = totalSurveys > 0 ? Math.round((primaryCounts[k] / totalSurveys) * 100) : 0;
      secondaryPcts[k] = totalSurveys > 0 ? Math.round((secondaryCounts[k] / totalSurveys) * 100) : 0;
    });

    const labels = sorted.map(k => LIMITING_FACTOR_LABELS[k] || k);

    const ctx = document.getElementById('chartLimitingFactors').getContext('2d');
    charts['chartLimitingFactors'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Primary',
            data: sorted.map(k => primaryPcts[k]),
            backgroundColor: LF_COLORS.primary,
            borderRadius: 4,
            barPercentage: 0.7,
            categoryPercentage: 0.8
          },
          {
            label: 'Secondary',
            data: sorted.map(k => secondaryPcts[k]),
            backgroundColor: LF_COLORS.secondary,
            borderRadius: 4,
            barPercentage: 0.7,
            categoryPercentage: 0.8
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const factorKey = sorted[context.dataIndex];
                const rank = context.datasetIndex === 0 ? 'Primary' : 'Secondary';
                const count = context.datasetIndex === 0 ? primaryCounts[factorKey] : secondaryCounts[factorKey];
                return `${rank}: ${context.raw}% (${count} of ${totalSurveys})`;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: true,
            max: 100,
            ticks: {
              callback: v => v + '%',
              font: { size: 11 },
              color: '#9ca3af'
            },
            grid: { color: '#f3f4f6' },
            border: { display: false }
          },
          y: {
            stacked: true,
            ticks: {
              font: { size: 12, weight: '500' },
              color: '#374151'
            },
            grid: { display: false },
            border: { display: false }
          }
        }
      }
    });

    // Render legend
    const legend = document.getElementById('lfLegend');
    legend.innerHTML = `
      <div class="legend-item">
        <div class="legend-dot" style="background:${LF_COLORS.primary};"></div>
        <span>Primary factor</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:${LF_COLORS.secondary};"></div>
        <span>Secondary factor</span>
      </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SURVEYS TABLE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderSurveysTable(surveys) {
    const tbody = document.getElementById('surveysTableBody');
    if (surveys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9ca3af;padding:2rem;">No surveys match the selected filters</td></tr>';
      return;
    }

    tbody.innerHTML = surveys.map(s => {
      const maturity = s.data?.clientAILandscape?.maturity?.value || '-';
      const maturityLabel = MATURITY_LABELS[maturity] || maturity;
      const maturityClass = maturity !== '-' ? `maturity-${maturity}` : '';

      const isSelected = activeAccountFilter === s.account_name;
      const rowStyle = isSelected ? 'background:#eef2ff;' : '';
      const escapedName = escapeHtml(s.account_name).replace(/'/g, "\\'");

      const accountType = s.account_type || 'other';
      const typeOptions = ACCOUNT_TYPES.map(t =>
        `<option value="${t.id}"${t.id === accountType ? ' selected' : ''}>${t.label}</option>`
      ).join('');

      const dmValue = escapeHtml(s.delivery_manager || '');

      return `<tr style="${rowStyle}cursor:pointer;" onclick="window.location.href='account-detail.html?id=${s.id}'" title="Click to view ${escapeHtml(s.account_name)} details">
        <td><strong style="${isSelected ? 'color:#4f46e5;' : ''}">${escapeHtml(s.account_name)}</strong></td>
        <td onclick="event.stopPropagation();">
          <select class="account-type-select" onchange="updateAccountType(${s.id}, this.value)" title="Change account type">
            ${typeOptions}
          </select>
        </td>
        <td><span class="maturity-badge ${maturityClass}">${maturityLabel}</span></td>
        <td onclick="event.stopPropagation();">
          <input type="text" class="dm-input" value="${dmValue}" placeholder="â€”"
            onchange="updateDeliveryManager(${s.id}, this.value.trim())"
            title="Edit delivery manager">
        </td>
        <td>Q${s.quarter} ${s.year}</td>
        <td class="actions" onclick="event.stopPropagation();">
          <button class="btn-icon" title="Download JSON" onclick="downloadSurvey(${s.id})">ğŸ“¥</button>
          <button class="btn-icon" title="Delete survey" onclick="deleteSurvey(${s.id}, '${escapedName}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join('');
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function downloadSurvey(id) {
    const result = db.exec('SELECT account_name, raw_json FROM surveys WHERE id = ?', [id]);
    if (result.length === 0) return;
    const name = result[0].values[0][0];
    const json = result[0].values[0][1];
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${name.replace(/[^a-zA-Z0-9_-]/g, '_')}_survey.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function updateAccountType(id, newType) {
    db.run('UPDATE surveys SET account_type = ? WHERE id = ?', [newType, id]);
    await saveToIndexedDB();
    // No full refresh needed â€” the dropdown already shows the new value
  }

  async function updateDeliveryManager(id, newDM) {
    db.run('UPDATE surveys SET delivery_manager = ? WHERE id = ?', [newDM, id]);
    await saveToIndexedDB();
  }

  async function deleteSurvey(id, name) {
    if (!confirm(`Delete the survey for "${name}"? This cannot be undone.`)) return;
    db.run('DELETE FROM surveys WHERE id = ?', [id]);
    await saveToIndexedDB();
    populateFilters();
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATABASE EXPORT / IMPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function exportDatabase() {
    const data = db.export();
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-survey-dashboard-backup-${new Date().toISOString().slice(0, 10)}.sqlite`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function importDatabase(file) {
    try {
      const buffer = await file.arrayBuffer();
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
      });
      const newDb = new SQL.Database(new Uint8Array(buffer));
      // Verify it has the expected tables
      const tables = newDb.exec("SELECT name FROM sqlite_master WHERE type='table'");
      const tableNames = tables.length > 0 ? tables[0].values.map(r => r[0]) : [];
      if (!tableNames.includes('surveys')) {
        alert('Invalid backup file: missing "surveys" table.');
        newDb.close();
        return;
      }
      if (db) db.close();
      db = newDb;
      await saveToIndexedDB();
      populateFilters();
      refreshDashboard();
      alert('Database restored successfully!');
    } catch (e) {
      alert('Error restoring database: ' + e.message);
    }
  }

  async function clearDatabase() {
    const countResult = db.exec('SELECT COUNT(*) FROM surveys');
    const count = countResult.length > 0 ? countResult[0].values[0][0] : 0;
    if (count === 0) {
      alert('The database is already empty.');
      return;
    }
    if (!confirm(`This will permanently delete all ${count} survey${count !== 1 ? 's' : ''} from the database.\n\nThis action cannot be undone. Consider creating a backup first.\n\nAre you sure?`)) return;
    db.run('DELETE FROM surveys');
    await saveToIndexedDB();
    activeMaturityFilter = null;
    activeAccountFilter = null;
    populateFilters();
    refreshDashboard();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EVENT LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function setupEventListeners() {
    // Upload button
    document.getElementById('uploadBtn').addEventListener('click', openUploadModal);

    // Modal overlay close
    document.getElementById('uploadModal').addEventListener('click', e => {
      if (e.target === document.getElementById('uploadModal')) closeUploadModal();
    });

    // Escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeUploadModal();
    });

    // Drop zone
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => {
      if (e.target.files.length > 0) handleFiles(e.target.files);
      e.target.value = '';
    });

    // Filters
    document.getElementById('filterYear').addEventListener('change', () => {
      activeMaturityFilter = null;
      activeAccountFilter = null;
      refreshDashboard();
    });
    document.getElementById('filterQuarter').addEventListener('change', () => {
      activeMaturityFilter = null;
      activeAccountFilter = null;
      refreshDashboard();
    });
    // Close account type menu when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('accountTypeMenu');
      const container = document.getElementById('filterAccountType');
      if (menu && container && !container.contains(e.target)) {
        menu.classList.remove('open');
        document.querySelector('.multi-select-btn')?.classList.remove('open');
      }
    });

    // Database export/import/clear
    document.getElementById('exportDbBtn').addEventListener('click', exportDatabase);
    document.getElementById('importDbInput').addEventListener('change', e => {
      if (e.target.files.length > 0) importDatabase(e.target.files[0]);
      e.target.value = '';
    });
    document.getElementById('clearDbBtn').addEventListener('click', clearDatabase);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init() {
    try {
      await initDatabase();
      setupEventListeners();
      populateFilters();

      // Hide loading, show content
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      refreshDashboard();
    } catch (e) {
      document.getElementById('loadingState').innerHTML = `
        <div style="color:#ef4444;text-align:center;padding:2rem;">
          <div style="font-size:2rem;margin-bottom:1rem;">&#9888;&#65039;</div>
          <div style="font-weight:600;margin-bottom:0.5rem;">Failed to initialize database</div>
          <div style="font-size:0.85rem;color:#6b7280;">${e.message}</div>
        </div>`;
      console.error('Init error:', e);
    }
  }

  init();
</script>
</body>
</html>
