<!DOCTYPE html>
<!-- AI Adoption Assessment Wizard - Standalone (HTML+JS+CSS) -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Adoption Assessment</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      color: #1f2937;
    }

    /* ═══════════════════════════════════════════
       SIDEBAR
       ═══════════════════════════════════════════ */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100vh;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1.5rem 1.25rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-logo-icon {
      width: 36px;
      height: 36px;
      background: #eef2ff;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-logo-text {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0.75rem;
    }

    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.7rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-bottom: 0.25rem;
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: 500;
      position: relative;
    }

    .sidebar-nav-item:hover {
      background: #f3f4f6;
      color: #1f2937;
    }

    .sidebar-nav-item.active {
      background: #eef2ff;
      color: #4f46e5;
      font-weight: 600;
    }

    .sidebar-nav-item.completed .nav-status {
      color: #22c55e;
    }

    .nav-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
      background: #f3f4f6;
      transition: all 0.15s;
    }

    .sidebar-nav-item.active .nav-icon {
      background: #4f46e5;
      color: #fff;
      font-size: 0.85rem;
    }

    .sidebar-nav-item.completed .nav-icon {
      background: #dcfce7;
    }

    .nav-label {
      flex: 1;
      line-height: 1.3;
    }

    .nav-status {
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .sidebar-footer {
      padding: 1rem 1.25rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .sidebar-clear-btn {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .sidebar-clear-btn:hover {
      background: #fef2f2;
      color: #ef4444;
      border-color: #fca5a5;
    }

    .save-status {
      font-size: 0.8rem;
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .save-status::before {
      content: '✓';
      font-size: 0.85rem;
    }

    .save-status.saving {
      color: #f59e0b;
    }

    .save-status.saving::before {
      content: '↻';
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ═══════════════════════════════════════════
       MOBILE HEADER
       ═══════════════════════════════════════════ */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      align-items: center;
      padding: 0 1rem;
      z-index: 90;
      gap: 0.75rem;
    }

    .mobile-menu-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 0.25rem;
    }

    .mobile-header-title {
      font-weight: 700;
      font-size: 1rem;
      color: #1f2937;
      flex: 1;
    }

    .mobile-save {
      font-size: 0.75rem;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 99;
    }

    /* Info Modal */
    .info-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .info-modal-overlay.open {
      display: flex;
    }
    .info-modal {
      background: #fff;
      border-radius: 16px;
      max-width: 720px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 2rem;
      position: relative;
    }
    .info-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    .info-modal-close:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .info-modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 1.5rem;
      padding-right: 2rem;
    }
    .info-modal-stage {
      margin-bottom: 1.5rem;
    }
    .info-modal-stage:last-child {
      margin-bottom: 0;
    }
    .info-modal-stage h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #4f46e5;
      margin: 0 0 0.5rem;
    }
    .info-modal-stage p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }
    .info-modal-summary {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }
    .info-modal-summary h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 0.5rem;
    }
    .info-modal-summary p {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.6;
      margin: 0;
    }
    .more-info-link {
      font-size: 0.85rem;
      color: #4f46e5;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      margin-left: 0.5rem;
    }
    .more-info-link:hover {
      text-decoration: underline;
      color: #4338ca;
    }

    /* ═══════════════════════════════════════════
       MAIN CONTENT AREA
       ═══════════════════════════════════════════ */
    .main-wrapper {
      margin-left: 260px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .content-header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1.25rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
    }

    .page-subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 0.15rem;
    }

    .progress-pill {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .progress-pill-bar {
      width: 120px;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-pill-fill {
      height: 100%;
      background: #4f46e5;
      border-radius: 3px;
      transition: width 0.4s ease;
    }

    .progress-pill-text {
      font-size: 0.8rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 1.5rem 2rem 3rem;
      width: 100%;
      transition: max-width 0.3s ease;
    }

    .main-container.expanded {
      max-width: 1100px;
    }

    /* ═══════════════════════════════════════════
       CARD
       ═══════════════════════════════════════════ */
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    .card-header {
      background: #fff;
      padding: 1.75rem 2rem 0.5rem;
      color: #1f2937;
      border-bottom: none;
    }

    .step-indicator {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      color: #4f46e5;
      background: #eef2ff;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-title {
      font-size: 1.35rem;
      font-weight: 700;
      margin-bottom: 0.35rem;
      color: #1f2937;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
    }

    /* Welcome Page Styles */
    .welcome-header {
      text-align: center;
      padding: 2rem 2rem 0.5rem;
      background: #fff;
    }

    .welcome-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      width: 64px;
      height: 64px;
      background: #eef2ff;
      border-radius: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .welcome-title {
      font-size: 1.75rem !important;
      color: #1f2937 !important;
    }

    .welcome-subtitle {
      font-size: 1rem;
      max-width: 500px;
      margin: 0 auto;
      color: #6b7280 !important;
    }

    .welcome-body {
      padding: 1.5rem 2rem 2rem !important;
    }

    .welcome-purpose {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      border: 1px solid #e2e8f0;
    }

    .welcome-purpose h3 {
      color: #4f46e5;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .welcome-purpose p {
      color: #64748b;
      font-size: 0.95rem;
      line-height: 1.6;
      margin: 0;
    }

    .welcome-sections h3 {
      color: #1e293b;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .welcome-sections-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .welcome-section-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.85rem;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #f3f4f6;
    }

    .welcome-section-icon {
      font-size: 1.1rem;
    }

    .welcome-section-text {
      font-size: 0.85rem;
      color: #475569;
    }

    .welcome-info {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    .welcome-info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .welcome-info-icon {
      font-size: 1.1rem;
    }

    .welcome-info-text {
      font-size: 0.9rem;
      color: #475569;
    }

    .welcome-account-section {
      margin-top: 0.5rem;
    }

    .welcome-account-section .account-name-label {
      font-size: 1.15rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.75rem;
    }

    .welcome-account-input {
      font-size: 1.1rem;
      padding: 0.9rem 1.15rem;
      max-width: 600px;
    }

    .welcome-footer {
      justify-content: center !important;
      padding: 1.5rem 2rem !important;
    }

    .btn-large {
      padding: 0.9rem 2.5rem !important;
      font-size: 1.05rem !important;
    }

    /* ═══════════════════════════════════════════
       RESTORE SURVEY
       ═══════════════════════════════════════════ */
    .welcome-restore-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }

    .welcome-restore-section h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.75rem;
    }

    .restore-buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn-restore {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.55rem 1rem;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #374151;
    }

    .btn-restore:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    /* Restore Modal */
    .restore-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .restore-modal-overlay.open {
      display: flex;
    }

    .restore-modal {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 560px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .restore-modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .restore-modal-header h2 {
      font-size: 1.15rem;
      font-weight: 700;
      color: #1f2937;
    }

    .restore-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.25rem;
      line-height: 1;
    }

    .restore-modal-close:hover {
      color: #1f2937;
    }

    .restore-modal-body {
      padding: 1.25rem 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .restore-survey-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .restore-survey-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      transition: all 0.15s;
    }

    .restore-survey-item:hover {
      border-color: #818cf8;
      background: #eef2ff;
    }

    .restore-survey-info {
      flex: 1;
      min-width: 0;
    }

    .restore-survey-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: #1f2937;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .restore-survey-date {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }

    .restore-survey-actions {
      display: flex;
      gap: 0.4rem;
      margin-left: 0.75rem;
      flex-shrink: 0;
    }

    .restore-survey-actions button {
      padding: 0.35rem 0.65rem;
      font-size: 0.78rem;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }

    .btn-restore-load {
      background: #4f46e5;
      color: #fff;
    }

    .btn-restore-load:hover {
      background: #4338ca;
    }

    .btn-restore-delete {
      background: transparent;
      color: #9ca3af;
      border-color: #e5e7eb !important;
    }

    .btn-restore-delete:hover {
      background: #fef2f2;
      color: #ef4444;
      border-color: #fca5a5 !important;
    }

    .btn-restore-download {
      background: transparent;
      color: #6b7280;
      border-color: #e5e7eb !important;
    }

    .btn-restore-download:hover {
      background: #f0fdf4;
      color: #16a34a;
      border-color: #86efac !important;
    }

    .restore-empty {
      text-align: center;
      padding: 2rem 1rem;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    .restore-modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
    }

    /* ═══════════════════════════════════════════
       CARD BODY & FOOTER
       ═══════════════════════════════════════════ */
    .card-body {
      padding: 1.75rem 2rem;
    }

    .card-footer {
      padding: 1.25rem 2rem;
      background: #fafbfc;
      border-top: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ═══════════════════════════════════════════
       BUTTONS
       ═══════════════════════════════════════════ */
    .btn {
      padding: 0.75rem 1.75rem;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .btn-secondary {
      background: #fff;
      color: #4b5563;
      border: 1.5px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }

    .btn-primary:hover {
      background: #4338ca;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .selection-count {
      color: #9ca3af;
      font-size: 0.85rem;
    }

    /* ═══════════════════════════════════════════
       ROLE GRID
       ═══════════════════════════════════════════ */
    .role-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.6rem;
    }

    .role-card {
      border: 1.5px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.85rem 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background: #fff;
      position: relative;
    }

    .role-card:hover {
      border-color: #c7d2fe;
      background: #fafafe;
    }

    .role-card.selected {
      border-color: #4f46e5;
      background: #eef2ff;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .role-icon {
      width: 40px;
      height: 40px;
      background: #f3f4f6;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      margin-bottom: 0.4rem;
    }

    .role-card.selected .role-icon {
      background: #4f46e5;
    }

    .role-name {
      font-weight: 600;
      font-size: 0.8rem;
      color: #374151;
      line-height: 1.2;
    }

    .checkmark {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      background: #4f46e5;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 11px;
    }

    .role-card.selected .checkmark {
      display: flex;
    }

    /* ═══════════════════════════════════════════
       TOOL SELECTION
       ═══════════════════════════════════════════ */
    .tool-category {
      margin-bottom: 1.75rem;
      background: #fafbfc;
      border-radius: 12px;
      padding: 1.25rem;
      border: 1px solid #f3f4f6;
    }

    .tool-category:last-child {
      margin-bottom: 0;
    }

    .tool-category-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .tool-category-label {
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    .tool-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .tool-card {
      min-width: 100px;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.6rem 0.9rem;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #fff;
    }

    .tool-card:hover {
      border-color: #c7d2fe;
      background: #fafafe;
    }

    .tool-card.selected {
      border-color: #4f46e5;
      background: #eef2ff;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .tool-card-name {
      font-weight: 500;
      font-size: 0.85rem;
      color: #374151;
    }

    .tool-card.selected .tool-card-name {
      font-weight: 600;
      color: #4f46e5;
    }

    .tool-card.selected .tool-card-name::before {
      content: '✓ ';
    }

    .tool-add-input {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tool-add-input input {
      width: 160px;
      padding: 0.55rem 0.9rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .tool-add-input input:focus {
      border-color: #4f46e5;
    }

    .tool-add-input button {
      padding: 0.55rem 1rem;
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .tool-card.special-option {
      background: #f9fafb;
      border-style: dashed;
    }

    .tool-card.special-option.selected {
      background: #f3f4f6;
      border-color: #9ca3af;
      border-style: dashed;
      box-shadow: none;
    }

    .tool-card.special-option.selected .tool-card-name {
      color: #6b7280;
    }

    .tool-card.special-option.selected .tool-card-name::before {
      content: '';
    }

    .tool-card.not-applicable.selected {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .tool-card.not-applicable.selected .tool-card-name {
      color: #b45309;
    }

    .tool-add-input button:hover {
      background: #4338ca;
    }

    .custom-tool-input button:hover {
      background: #4338ca;
    }

    .custom-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: #eef2ff;
      color: #4f46e5;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }

    .custom-tag button {
      background: none;
      border: none;
      color: #6366f1;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      padding: 0;
    }

    /* ═══════════════════════════════════════════
       MATRIX STYLES
       ═══════════════════════════════════════════ */
    .matrix-container {
      overflow-x: auto;
    }

    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 400px;
      background: #fff;
    }

    .matrix-table th,
    .matrix-table td {
      padding: 1rem 1.5rem;
      text-align: center;
      border: 1px solid #e5e7eb;
    }

    .matrix-table thead th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .matrix-corner {
      text-align: left !important;
      font-weight: 600;
    }

    .tool-column-header {
      min-width: 140px;
    }

    .role-row-header {
      text-align: left !important;
      font-weight: 600;
      background: #f9fafb;
      color: #374151;
    }

    .matrix-table td {
      background: #fff;
    }

    .matrix-checkbox {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: #4f46e5;
    }

    .hidden {
      display: none;
    }

    /* ═══════════════════════════════════════════
       AI WORKFLOW MATURITY
       ═══════════════════════════════════════════ */
    .wfm-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .wfm-stage-header {
      display: flex;
      min-width: 960px;
      gap: 0;
    }

    .wfm-stage-header .wfm-role-col {
      width: 100px;
      min-width: 100px;
      flex-shrink: 0;
    }

    .wfm-stage-tab {
      flex: 1;
      text-align: center;
      padding: 0.75rem 0.35rem;
      position: relative;
      border: 1.5px solid #e5e7eb;
      border-bottom: 3px solid #4f46e5;
      margin-left: -1.5px;
      background: #fafbfc;
    }
    .wfm-stage-tab:first-of-type {
      margin-left: 0;
      border-top-left-radius: 10px;
    }
    .wfm-stage-tab:last-of-type {
      border-top-right-radius: 10px;
    }

    .wfm-stage-num {
      display: inline-block;
      font-size: 0.6rem;
      font-weight: 700;
      color: #fff;
      background: #4f46e5;
      border-radius: 4px;
      padding: 0.1rem 0.4rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .wfm-stage-title {
      display: block;
      font-size: 0.82rem;
      font-weight: 700;
      color: #1f2937;
      margin-top: 0.2rem;
      line-height: 1.2;
    }

    .wfm-stage-sub {
      display: block;
      font-size: 0.62rem;
      color: #9ca3af;
      margin-top: 0.15rem;
      line-height: 1.3;
      font-style: italic;
    }

    .wfm-body {
      min-width: 960px;
    }

    .wfm-row {
      display: flex;
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.15s;
      align-items: stretch;
    }

    .wfm-row:last-child {
      border-bottom: 1.5px solid #e5e7eb;
    }

    .wfm-row:hover {
      background: #fafbfc;
    }

    .wfm-role-col {
      width: 100px;
      min-width: 100px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.3rem;
    }

    .wfm-role-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
      background: #374151;
      color: #fff;
      border-radius: 8px;
      padding: 0.5rem 0.4rem;
      width: 100%;
      text-align: center;
    }

    .wfm-role-badge-abbr {
      font-weight: 800;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    .wfm-role-badge-name {
      font-size: 0.55rem;
      opacity: 0.85;
      line-height: 1.2;
    }

    .wfm-cell {
      flex: 1;
      padding: 0.55rem 0.45rem;
      font-size: 0.68rem;
      color: #6b7280;
      line-height: 1.35;
      cursor: pointer;
      border-left: 1px solid #f3f4f6;
      transition: all 0.15s;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .wfm-cell:hover {
      background: #f5f3ff;
    }

    .wfm-cell-radio {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #cbd5e1;
      background: #fff;
      margin: 0 auto;
      flex-shrink: 0;
      transition: all 0.15s;
      position: relative;
    }

    .wfm-cell:hover .wfm-cell-radio {
      border-color: #818cf8;
    }

    .wfm-cell-desc {
      font-size: 0.65rem;
      color: #9ca3af;
      line-height: 1.3;
      text-align: center;
    }

    .wfm-cell.selected {
      background: #eef2ff;
      border-left-color: #c7d2fe;
    }

    .wfm-cell.selected .wfm-cell-radio {
      border-color: #4f46e5;
      background: #4f46e5;
    }

    .wfm-cell.selected .wfm-cell-radio::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 0.6rem;
      font-weight: 700;
    }

    .wfm-cell.selected .wfm-cell-desc {
      color: #4338ca;
      font-weight: 500;
    }

    /* Signals row */
    .wfm-signals-row {
      display: flex;
      border-top: 2px solid #d1d5db;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      min-width: 960px;
    }

    .wfm-signals-row .wfm-role-col {
      width: 100px;
      min-width: 100px;
      flex-shrink: 0;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 0.5rem 0.3rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
      font-style: italic;
    }

    .wfm-signals-row .wfm-cell {
      font-size: 0.62rem;
      color: #6b7280;
      cursor: default;
      padding: 0.4rem 0.45rem;
      display: block;
    }

    .wfm-signals-row .wfm-cell:hover {
      background: transparent;
    }

    .wfm-signals-row .wfm-cell ul {
      margin: 0;
      padding-left: 0.9rem;
      list-style: disc;
    }

    .wfm-signals-row .wfm-cell li {
      margin-bottom: 0.12rem;
    }

    /* Role-Tool Matrix styles */
    .role-tool-matrix {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }

    .role-tool-matrix thead th {
      background: #f9fafb;
      color: #374151;
      font-weight: 600;
      padding: 0.85rem 0.75rem;
      text-align: center;
      border-bottom: 2px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      font-size: 0.85rem;
    }

    .role-tool-matrix thead th:first-child {
      text-align: left;
      min-width: 200px;
      background: #f9fafb;
    }

    .role-tool-matrix thead th:last-child {
      border-right: none;
    }

    .role-tool-matrix tbody tr {
      transition: background-color 0.15s;
    }

    .role-tool-matrix tbody tr:nth-child(even) {
      background: #fafbfc;
    }

    .role-tool-matrix tbody tr:hover {
      background: #f5f3ff;
    }

    .role-tool-matrix tbody td {
      padding: 0.85rem 0.75rem;
      border-bottom: 1px solid #f3f4f6;
      border-right: 1px solid #f3f4f6;
      text-align: center;
      vertical-align: middle;
    }

    .role-tool-matrix tbody td:first-child {
      text-align: left;
      font-weight: 500;
      color: #374151;
    }

    .role-tool-matrix tbody td:last-child {
      border-right: none;
    }

    .role-tool-matrix tbody tr:last-child td {
      border-bottom: none;
    }

    .matrix-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #4f46e5;
    }

    .matrix-empty {
      text-align: center;
      padding: 2rem;
      color: #9ca3af;
      font-style: italic;
    }

    /* Use cases styles */
    .usecase-category {
      margin-bottom: 2rem;
      background: #fafbfc;
      border-radius: 12px;
      padding: 1.25rem;
      border: 1px solid #f3f4f6;
    }

    .usecase-category:last-child {
      margin-bottom: 0;
    }

    .usecase-category-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .usecase-category-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .usecase-category-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1f2937;
    }

    .usecase-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .usecase-column {
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      min-height: 120px;
    }

    .usecase-column-header {
      font-weight: 600;
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .usecase-column.need {
      border: 2px solid #fbbf24;
      background: #fffbeb;
    }

    .usecase-column.need .usecase-column-header {
      color: #b45309;
      border-bottom-color: #fbbf24;
    }

    .usecase-column.doing {
      border: 2px solid #22c55e;
      background: #f0fdf4;
    }

    .usecase-column.doing .usecase-column-header {
      color: #15803d;
      border-bottom-color: #22c55e;
    }

    .usecase-column-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 60px;
    }

    .usecase-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      font-size: 0.9rem;
    }

    .usecase-card:hover {
      border-color: #a5b4fc;
      background: #f5f3ff;
    }

    .usecase-column.need .usecase-card {
      border-color: #fcd34d;
    }

    .usecase-column.need .usecase-card:hover {
      background: #fef3c7;
    }

    .usecase-column.doing .usecase-card {
      border-color: #86efac;
    }

    .usecase-column.doing .usecase-card:hover {
      background: #dcfce7;
    }

    .usecase-name {
      font-weight: 500;
      color: #374151;
      flex: 1;
    }

    .usecase-delete-btn {
      background: none;
      border: none;
      color: #d1d5db;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
      flex-shrink: 0;
    }

    .usecase-delete-btn:hover {
      color: #ef4444;
    }

    .usecase-move-btn {
      font-size: 1rem;
      color: #9ca3af;
      transition: color 0.2s;
      padding: 0 0.25rem;
    }

    .usecase-column.need .usecase-move-btn {
      color: #f59e0b;
    }

    .usecase-column.need .usecase-card:hover .usecase-move-btn {
      color: #22c55e;
    }

    .usecase-column.doing .usecase-move-btn {
      color: #22c55e;
    }

    .usecase-column.doing .usecase-card:hover .usecase-move-btn {
      color: #f59e0b;
    }

    .usecase-empty {
      color: #9ca3af;
      font-size: 0.85rem;
      font-style: italic;
      text-align: center;
      padding: 1rem;
    }

    .usecase-add-input {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .usecase-add-input input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .usecase-add-input input:focus {
      border-color: #4f46e5;
    }

    .usecase-add-input button {
      padding: 0.75rem 1rem;
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .usecase-add-input button:hover {
      background: #4338ca;
    }

    /* Engagement / Ownership slider styles */
    .engagement-section {
      margin-bottom: 2rem;
    }

    .engagement-section:last-child {
      margin-bottom: 0;
    }

    .engagement-label {
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .engagement-hint {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }

    .ownership-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .client-ai-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .client-ai-options .option-card {
      flex: 0 1 auto;
      min-width: 120px;
      padding: 0.75rem;
    }

    .client-ai-options .option-card-icon {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }

    .client-ai-options .option-card-title {
      font-size: 0.85rem;
    }

    .client-ai-options .option-card-desc {
      font-size: 0.7rem;
    }

    /* Compact inline options — force all cards in one row */
    .inline-options {
      flex-wrap: nowrap !important;
      gap: 0.5rem;
    }

    .inline-options .option-card {
      flex: 1 1 0;
      min-width: 0;
      padding: 0.6rem 0.4rem;
    }

    .inline-options .option-card-icon {
      font-size: 1.1rem;
      margin-bottom: 0.15rem;
    }

    .inline-options .option-card-title {
      font-size: 0.78rem;
      line-height: 1.2;
    }

    .inline-options .option-card-desc {
      font-size: 0.65rem;
      line-height: 1.2;
      margin-top: 0.1rem;
    }

    /* AI Adoption Journey — horizontal pipeline */
    .journey-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .journey-idk {
      display: flex;
      margin-bottom: 0.25rem;
    }

    .journey-idk .option-card {
      flex: 0 0 auto;
      min-width: 120px;
      padding: 0.5rem 1rem;
      border-style: dashed;
    }

    .journey-idk .option-card-icon {
      font-size: 1.1rem;
      margin-bottom: 0.1rem;
    }

    .journey-idk .option-card-title {
      font-size: 0.8rem;
    }

    .journey-idk .option-card-desc {
      display: none;
    }

    .journey-pipeline {
      display: flex;
      align-items: stretch;
      gap: 0;
      position: relative;
    }

    .journey-stage {
      flex: 1;
      text-align: center;
      padding: 0.75rem 0.4rem;
      cursor: pointer;
      border: 2px solid #e5e7eb;
      background: #fff;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
    }

    .journey-stage:first-child {
      border-radius: 12px 0 0 12px;
    }

    .journey-stage:last-child {
      border-radius: 0 12px 12px 0;
    }

    .journey-stage:not(:first-child) {
      margin-left: -2px;
    }

    .journey-stage:hover {
      background: #f5f3ff;
      border-color: #a5b4fc;
      z-index: 1;
    }

    .journey-stage.passed {
      background: #f0fdf4;
      border-color: #86efac;
      z-index: 1;
    }

    .journey-stage.active {
      background: #eef2ff;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
      z-index: 3;
    }

    .journey-stage-icon {
      font-size: 1.3rem;
    }

    .journey-stage-name {
      font-weight: 600;
      font-size: 0.8rem;
      color: #1f2937;
    }

    .journey-stage.active .journey-stage-name {
      color: #4f46e5;
    }

    .journey-stage-desc {
      font-size: 0.65rem;
      color: #9ca3af;
    }

    .journey-arrow-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0.5rem;
      margin-top: 0.25rem;
    }

    .journey-arrow-label span {
      font-size: 0.7rem;
      color: #9ca3af;
      font-style: italic;
    }

    .journey-arrow-line {
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, #ef4444, #f59e0b, #22c55e);
      margin: 0 0.5rem;
    }

    /* Option cards for engagement questions */
    .option-cards {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .option-card {
      flex: 1;
      min-width: 150px;
      border: 1.5px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.15rem;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      background: #fff;
    }

    .option-card:hover {
      border-color: #c7d2fe;
      background: #fafafe;
    }

    .option-card.selected {
      border-color: #4f46e5;
      background: #eef2ff;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
    }

    .option-card-icon {
      font-size: 1.75rem;
      margin-bottom: 0.4rem;
    }

    .option-card-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #374151;
    }

    .option-card-desc {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 0.2rem;
    }

    .limiting-factors-hint {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1rem;
      transition: color 0.2s;
    }

    .limiting-factors-hint.at-max {
      color: #f59e0b;
      font-weight: 600;
    }

    .limiting-factors-options {
      flex-wrap: wrap;
    }

    .limiting-factors-options.at-max .option-card:not(.selected) {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .limiting-factors-options .option-card {
      position: relative;
    }

    .limiting-factors-options .option-card[data-rank]::after {
      content: attr(data-rank);
      position: absolute;
      top: 10px;
      right: 12px;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.3px;
      color: #312e81;
      background: #e0e7ff;
      border: 1px solid #c7d2fe;
    }

    #clientChallengeOptions .option-card {
      position: relative;
    }

    #clientChallengeOptions .option-card[data-rank]::after {
      content: attr(data-rank);
      position: absolute;
      top: 6px;
      right: 8px;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #4f46e5;
      background: #eef2ff;
    }

    #clientChallengeOptions.at-max .option-card:not(.selected) {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .challenges-hint {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
      transition: color 0.2s;
    }

    .challenges-hint.at-max {
      color: #f59e0b;
      font-weight: 600;
    }

    .limiting-factor-other-wrap {
      margin-top: 1.5rem;
    }

    .limiting-factor-other-wrap.hidden {
      display: none;
    }

    /* Compliance chips styles */
    .compliance-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .compliance-chips.custom-compliance {
      margin-top: 0.6rem;
    }

    .compliance-chip {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.9rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 25px;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 0.85rem;
    }

    .compliance-chip:hover {
      border-color: #c7d2fe;
      background: #fafafe;
    }

    .compliance-chip.selected {
      border-color: #4f46e5;
      background: #eef2ff;
    }

    .compliance-icon {
      font-size: 1rem;
    }

    .compliance-name {
      font-weight: 500;
      color: #374151;
    }

    .compliance-chip.selected .compliance-name {
      color: #4f46e5;
      font-weight: 600;
    }

    .compliance-chip .compliance-delete {
      margin-left: 0.25rem;
      color: #9ca3af;
      font-size: 1rem;
      line-height: 1;
    }

    .compliance-chip:hover .compliance-delete {
      color: #ef4444;
    }

    .compliance-add-input {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }

    .compliance-add-input input {
      flex: 1;
      max-width: 300px;
      padding: 0.55rem 0.9rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .compliance-add-input input:focus {
      border-color: #4f46e5;
    }

    .compliance-add-input button {
      padding: 0.55rem 1rem;
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .compliance-add-input button:hover {
      background: #4338ca;
    }

    /* Account name input styles */
    .account-name-section {
      margin-bottom: 2rem;
    }

    .account-name-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .account-name-input {
      width: 100%;
      max-width: 500px;
      padding: 0.75rem 1rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .account-name-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
    }

    .roles-section-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 1rem;
    }

    .validation-error {
      background: #fef2f2;
      border: 1px solid #fca5a5;
      color: #dc2626;
      padding: 0.65rem 1rem;
      border-radius: 10px;
      font-size: 0.85rem;
      margin-top: 1rem;
      display: none;
    }
    .validation-error.visible { display: block; }

    /* ═══════════════════════════════════════════
       STEP NOTES
       ═══════════════════════════════════════════ */
    .step-notes {
      margin-top: 1.5rem;
      border-top: 1px solid #f3f4f6;
      padding-top: 1rem;
    }

    .step-notes-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: #6b7280;
      padding: 0.35rem 0;
      transition: color 0.15s;
    }

    .step-notes-toggle:hover {
      color: #4f46e5;
    }

    .step-notes-toggle .notes-chevron {
      transition: transform 0.2s;
      font-size: 0.7rem;
    }

    .step-notes-toggle.open .notes-chevron {
      transform: rotate(90deg);
    }

    .step-notes-toggle .notes-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4f46e5;
      display: none;
    }

    .step-notes-toggle.has-content .notes-dot {
      display: inline-block;
    }

    .step-notes-body {
      display: none;
      margin-top: 0.75rem;
    }

    .step-notes-body.open {
      display: block;
    }

    .step-notes-textarea {
      width: 100%;
      min-height: 80px;
      padding: 0.75rem 1rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      font-size: 0.875rem;
      font-family: inherit;
      color: #374151;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
      background: #fafbfc;
      line-height: 1.5;
    }

    .step-notes-textarea:focus {
      border-color: #4f46e5;
      background: #fff;
    }

    .step-notes-textarea::placeholder {
      color: #9ca3af;
    }

    /* ═══════════════════════════════════════════
       REVIEW SECTION
       ═══════════════════════════════════════════ */
    .review-section {
      background: #fafbfc;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 0.75rem;
      border: 1px solid #f3f4f6;
    }
    .review-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      cursor: pointer;
    }
    .review-section-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: #1f2937;
    }
    .review-edit-btn {
      background: #eef2ff;
      border: 1px solid #e0e7ff;
      color: #4f46e5;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0.3rem 0.75rem;
      border-radius: 6px;
      transition: all 0.15s;
    }
    .review-edit-btn:hover {
      background: #4f46e5;
      color: #fff;
    }
    .review-content {
      font-size: 0.875rem;
      color: #4b5563;
      line-height: 1.6;
    }
    .review-content ul {
      list-style: disc;
      margin-left: 1.25rem;
    }
    .review-empty {
      color: #9ca3af;
      font-style: italic;
      font-size: 0.85rem;
    }

    /* ═══════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════ */
    @media (max-width: 900px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-overlay.open {
        display: block;
      }
      .mobile-header {
        display: flex;
      }
      .main-wrapper {
        margin-left: 0;
        padding-top: 56px;
      }
      .content-header {
        position: static;
      }
    }

    @media (max-width: 640px) {
      .main-container {
        padding: 1rem;
      }
      .card-footer {
        flex-direction: column;
        gap: 0.75rem;
      }
      .card-footer .btn {
        width: 100%;
        text-align: center;
      }
      .role-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      }
      .option-cards {
        flex-direction: column;
      }
      .inline-options {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        gap: 0.4rem;
      }
      .inline-options .option-card {
        flex: 0 1 auto;
        min-width: 70px;
        padding: 0.5rem 0.3rem;
      }
      .inline-options .option-card-title {
        font-size: 0.7rem;
      }
      .journey-pipeline {
        flex-wrap: nowrap;
      }
      .journey-stage-desc {
        display: none;
      }
      .journey-stage-name {
        font-size: 0.7rem;
      }
      .option-card {
        min-width: unset;
      }
      .usecase-columns {
        grid-template-columns: 1fr;
      }
      .matrix-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .maturity-desc {
        display: none;
      }
      .maturity-name {
        font-size: 0.7rem;
      }
      .welcome-sections-grid {
        grid-template-columns: 1fr;
      }
      .welcome-info {
        flex-direction: column;
        gap: 0.75rem;
      }
      .ownership-options {
        grid-template-columns: 1fr;
      }
      .card-header {
        padding: 1.25rem;
      }
      .card-body {
        padding: 1rem;
      }
      .content-header {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
      }
      .progress-pill {
        width: 100%;
      }
      .progress-pill-bar {
        flex: 1;
      }
    }
  </style>
</head>
<body id="artifacts-component-root-html">
  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="#4f46e5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <span class="sidebar-logo-text">AI Assessment</span>
    </div>
    <nav class="sidebar-nav" id="sidebarNav">
      <!-- Populated by JS -->
    </nav>
    <div class="sidebar-footer">
      <a href="dashboard.html" style="display:flex;align-items:center;gap:0.4rem;padding:0.5rem 0.75rem;margin-bottom:0.75rem;background:#eef2ff;color:#4f46e5;border-radius:8px;text-decoration:none;font-size:0.85rem;font-weight:600;transition:background 0.15s;" onmouseover="this.style.background='#e0e7ff'" onmouseout="this.style.background='#eef2ff'">📊 Open Dashboard</a>
      <span class="save-status" id="saveStatus">Progress auto-saved</span>
      <button class="sidebar-clear-btn" id="clearProgress">Clear All Data</button>
    </div>
  </aside>

  <!-- Mobile Header -->
  <div class="mobile-header" id="mobileHeader">
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="mobile-header-title">AI Assessment</div>
    <span class="save-status mobile-save" id="saveStatusMobile">Saved</span>
  </div>

  <!-- Main Content -->
  <div class="main-wrapper">
    <div class="content-header" id="contentHeader">
      <div class="content-header-left">
        <h1 class="page-title" id="pageTitle">Welcome</h1>
        <p class="page-subtitle" id="pageSubtitle">Get started with your AI adoption assessment</p>
      </div>
      <div class="content-header-right">
        <div class="progress-pill" id="progressPill">
          <div class="progress-pill-bar">
            <div class="progress-pill-fill" id="progressFill" style="width: 0%;"></div>
          </div>
          <span class="progress-pill-text" id="progressText" aria-live="polite">Step 0 of 8</span>
        </div>
      </div>
    </div>

    <div class="main-container">
      <div class="card">
      <!-- Welcome Page -->
      <div id="step0" class="step">
        <div class="card-header welcome-header">
          <div class="welcome-icon">🚀</div>
          <h1 class="card-title welcome-title">AI Adoption Assessment</h1>
          <p class="card-subtitle welcome-subtitle">Understand your team's AI readiness and identify opportunities for growth</p>
        </div>
        <div class="card-body welcome-body">
          <div class="welcome-purpose">
            <h3>Why this assessment?</h3>
            <p>This survey helps us understand your current AI adoption landscape, identify opportunities for improvement, and align resources to accelerate your team's success with AI tools and practices.</p>
          </div>
          
          <div class="welcome-sections">
            <h3>What we'll cover</h3>
            <div class="welcome-sections-grid">
              <div class="welcome-section-item">
                <span class="welcome-section-icon">👥</span>
                <span class="welcome-section-text">Team roles & composition</span>
              </div>
              <div class="welcome-section-item">
                <span class="welcome-section-icon">🛠️</span>
                <span class="welcome-section-text">Tools & infrastructure</span>
              </div>
              <div class="welcome-section-item">
                <span class="welcome-section-icon">🤝</span>
                <span class="welcome-section-text">Engagement model</span>
              </div>
              <div class="welcome-section-item">
                <span class="welcome-section-icon">🏢</span>
                <span class="welcome-section-text">Client AI landscape</span>
              </div>
            </div>
          </div>
          
          <div class="welcome-info">
            <div class="welcome-info-item">
              <span class="welcome-info-icon">⏱️</span>
              <span class="welcome-info-text"><strong>Time:</strong> ~5-10 minutes</span>
            </div>
            <div class="welcome-info-item">
              <span class="welcome-info-icon">💾</span>
              <span class="welcome-info-text"><strong>Auto-save:</strong> Your progress is saved automatically</span>
            </div>
          </div>
          
          <div class="welcome-account-section">
            <label class="account-name-label" for="accountNameInput">Account / Project Name</label>
            <input type="text" id="accountNameInput" class="account-name-input welcome-account-input" placeholder="Enter account or project name...">
          </div>
          <div class="validation-error" id="step0Error" role="alert"></div>

          <div class="welcome-restore-section">
            <h3>Restore a previous survey</h3>
            <div class="restore-buttons">
              <button class="btn-restore" id="restoreFromListBtn" type="button">📋 From Saved Surveys</button>
              <button class="btn-restore" id="restoreFromFileBtn" type="button">📁 From ZIP File</button>
              <input type="file" id="restoreFileInput" accept=".zip" style="display:none">
            </div>
          </div>
        </div>
        <div class="card-footer welcome-footer">
          <button class="btn btn-primary btn-large" id="startAssessment" disabled>Start Assessment →</button>
        </div>
      </div>

      <!-- Step 1: Roles -->
      <div id="step1" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 3</div>
          <h1 class="card-title">Tell us about your project</h1>
          <p class="card-subtitle">Select the team roles involved in this project</p>
        </div>
        <div class="card-body">
          <div class="roles-section-label">Who's on your team?</div>
          <div class="role-grid" id="roleGrid">
        <div class="role-card" data-role-id="pm">
          <div class="checkmark">✓</div>
          <div class="role-icon">📋</div>
          <div class="role-name">Project Managers / Scrum Masters</div>
        </div>
      
        <div class="role-card" data-role-id="ba">
          <div class="checkmark">✓</div>
          <div class="role-icon">📊</div>
          <div class="role-name">Business Analysts / Product Managers</div>
        </div>
      
        <div class="role-card" data-role-id="ux">
          <div class="checkmark">✓</div>
          <div class="role-icon">🎨</div>
          <div class="role-name">UI/UX Designers</div>
        </div>
      
        <div class="role-card" data-role-id="devops">
          <div class="checkmark">✓</div>
          <div class="role-icon">⚙️</div>
          <div class="role-name">DevOps Engineers</div>
        </div>
      
        <div class="role-card" data-role-id="swe">
          <div class="checkmark">✓</div>
          <div class="role-icon">💻</div>
          <div class="role-name">Software Engineers</div>
        </div>
      
        <div class="role-card" data-role-id="qa">
          <div class="checkmark">✓</div>
          <div class="role-icon">🔍</div>
          <div class="role-name">Manual QA</div>
        </div>
      
        <div class="role-card" data-role-id="qaa">
          <div class="checkmark">✓</div>
          <div class="role-icon">🤖</div>
          <div class="role-name">QA Automation Engineers</div>
        </div>
      
        <div class="role-card selected" data-role-id="data">
          <div class="checkmark">✓</div>
          <div class="role-icon">📈</div>
          <div class="role-name">Data Engineers / Scientists</div>
        </div>
      
        <div class="role-card" data-role-id="arch">
          <div class="checkmark">✓</div>
          <div class="role-icon">🏗️</div>
          <div class="role-name">Solutions Architects</div>
        </div>
      </div>

          <!-- AI Champion Question -->
          <div class="engagement-section" style="margin-top: 2rem;">
            <div class="engagement-label">Is there someone responsible for driving and championing AI adoption within the account?</div>
            <div class="option-cards client-ai-options" id="aiChampionOptions">
              <div class="option-card" data-value="no">
                <div class="option-card-icon">❌</div>
                <div class="option-card-title">No</div>
                <div class="option-card-desc">No AI champion identified</div>
              </div>
              <div class="option-card" data-value="yes">
                <div class="option-card-icon">✅</div>
                <div class="option-card-title">Yes</div>
                <div class="option-card-desc">There is an AI champion</div>
              </div>
            </div>
            <div id="aiChampionNameSection" style="display: none; margin-top: 1rem;">
              <div id="aiChampionsList"></div>
              <div style="margin-top: 0.75rem;">
                <label class="account-name-label">Add a champion:</label>
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                  <input type="text" id="aiChampionInput" class="account-name-input" placeholder="e.g., John Smith, Solutions Architect" maxlength="200" style="flex: 1; min-width: 200px;">
                </div>
                <button class="btn btn-secondary" id="addChampionBtn" style="margin-top: 0.5rem;">+ Add Champion</button>
              </div>
            </div>
            <div id="aiFutureChampionSection" style="display: none; margin-top: 1rem;">
              <div id="aiFutureChampionsList"></div>
              <div style="margin-top: 0.75rem;">
                <label class="account-name-label">Who would you like to nominate as a future AI champion?</label>
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                  <input type="text" id="aiFutureChampionInput" class="account-name-input" placeholder="e.g., Jane Doe, Tech Lead" maxlength="200" style="flex: 1; min-width: 200px;">
                </div>
                <button class="btn btn-secondary" id="addFutureChampionBtn" style="margin-top: 0.5rem;">+ Add Future Champion</button>
              </div>
            </div>
          </div>

          <!-- AI Success Stories -->
          <div class="engagement-section" style="margin-top: 2rem;">
            <div class="engagement-label">Do you have an AI Success Story you'd like to share?</div>
            <div class="option-cards client-ai-options" id="aiSuccessStoryToggle">
              <div class="option-card" data-value="no">
                <div class="option-card-icon">❌</div>
                <div class="option-card-title">No</div>
                <div class="option-card-desc">No stories to share</div>
              </div>
              <div class="option-card" data-value="yes">
                <div class="option-card-icon">✅</div>
                <div class="option-card-title">Yes</div>
                <div class="option-card-desc">I have stories to share</div>
              </div>
            </div>
            <div id="aiSuccessStoriesSection" style="display: none; margin-top: 1rem;">
              <div id="aiSuccessStoriesList"></div>
              <div style="margin-top: 0.75rem;">
                <label class="account-name-label">Add a success story:</label>
                <textarea id="aiSuccessStoryInput" class="account-name-input" style="max-width:100%;min-height:80px;resize:vertical;" placeholder="Describe the AI success story..."></textarea>
                <button class="btn btn-secondary" id="addSuccessStoryBtn" style="margin-top: 0.5rem;">+ Add Story</button>
              </div>
            </div>
          </div>

          <div class="step-notes" data-step="1">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(1)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="1" placeholder="Add any additional notes about team roles, AI champion, or success stories..."></textarea>
            </div>
          </div>
          <div class="validation-error" id="step1Error" role="alert"></div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step1Back">← Back</button>
          <div class="selection-count" id="roleCount">1 roles selected</div>
          <button class="btn btn-primary" id="step1Next">Continue →</button>
        </div>
      </div>

      <!-- Step 2: Tools & Infrastructure -->
      <div id="step2" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 4</div>
          <h1 class="card-title">What tools and infrastructure does your team use?</h1>
          <p class="card-subtitle">Select all tools and platforms used in your project</p>
        </div>
        <div class="card-body" id="toolsContainer">
          <!-- Tools will be populated by JS (including cloud platforms) -->
        </div>
        <div class="card-body" style="padding-top:0;">
          <div class="step-notes" data-step="2" style="margin-top:0;">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(2)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="2" placeholder="Add any additional notes about tools, infrastructure, or tech stack..."></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step2Back">← Back</button>
          <button class="btn btn-primary" id="step2Next">Continue →</button>
        </div>
      </div>

      <!-- Step 5: Customer Engagement -->
      <div id="step5" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 1</div>
          <h1 class="card-title">What's your engagement model?</h1>
          <p class="card-subtitle">Define your relationship and responsibilities with the customer</p>
        </div>
        <div class="card-body">
          <!-- Question 1: Ownership Level (Multi-select) -->
          <div class="engagement-section">
            <div class="engagement-label">What level of ownership do you have on this project?</div>
            <div class="engagement-hint">Select all that apply</div>
            <div class="option-cards ownership-options" id="ownershipOptions">
              <div class="option-card" data-value="staff">
                <div class="option-card-icon">👤</div>
                <div class="option-card-title">Staff Augmentation</div>
                <div class="option-card-desc">Team members embedded with client</div>
              </div>
              <div class="option-card" data-value="project">
                <div class="option-card-icon">📁</div>
                <div class="option-card-title">Project Ownership</div>
                <div class="option-card-desc">Full ownership of project delivery</div>
              </div>
              <div class="option-card" data-value="program">
                <div class="option-card-icon">📊</div>
                <div class="option-card-title">Program Ownership</div>
                <div class="option-card-desc">Ownership across multiple projects</div>
              </div>
              <div class="option-card" data-value="outcome">
                <div class="option-card-icon">🎯</div>
                <div class="option-card-title">Business Outcome</div>
                <div class="option-card-desc">Accountable for business results</div>
              </div>
            </div>
          </div>

          <!-- Question 2: AI Tool Payment -->
          <div class="engagement-section">
            <div class="engagement-label">Who pays (or will pay) for AI tools?</div>
            <div class="option-cards" id="paymentOptions">
              <div class="option-card" data-value="us">
                <div class="option-card-icon">🏢</div>
                <div class="option-card-title">We Are/Will</div>
                <div class="option-card-desc">Our organization pays</div>
              </div>
              <div class="option-card" data-value="customer">
                <div class="option-card-icon">🤝</div>
                <div class="option-card-title">Customer Is/Will</div>
                <div class="option-card-desc">Customer pays for tools</div>
              </div>
              <div class="option-card" data-value="mix">
                <div class="option-card-icon">🔀</div>
                <div class="option-card-title">It Is a Mix</div>
                <div class="option-card-desc">Shared between both</div>
              </div>
              <div class="option-card" data-value="tbd">
                <div class="option-card-icon">💭</div>
                <div class="option-card-title">To Be Determined</div>
                <div class="option-card-desc">Still need to figure out</div>
              </div>
            </div>
          </div>

          <!-- Question 3: Compliance Requirements -->
          <div class="engagement-section">
            <div class="engagement-label">What compliance requirements apply to this project?</div>
            <div class="compliance-chips" id="complianceOptions">
              <div class="compliance-chip" data-value="hipaa">
                <span class="compliance-icon">🏥</span>
                <span class="compliance-name">HIPAA</span>
              </div>
              <div class="compliance-chip" data-value="gdpr">
                <span class="compliance-icon">🇪🇺</span>
                <span class="compliance-name">GDPR</span>
              </div>
              <div class="compliance-chip" data-value="sox">
                <span class="compliance-icon">📊</span>
                <span class="compliance-name">SOX</span>
              </div>
              <div class="compliance-chip" data-value="pci-dss">
                <span class="compliance-icon">💳</span>
                <span class="compliance-name">PCI-DSS</span>
              </div>
              <div class="compliance-chip" data-value="fedramp">
                <span class="compliance-icon">🏛️</span>
                <span class="compliance-name">FedRAMP</span>
              </div>
              <div class="compliance-chip" data-value="soc2">
                <span class="compliance-icon">🔒</span>
                <span class="compliance-name">SOC 2</span>
              </div>
              <div class="compliance-chip" data-value="ccpa">
                <span class="compliance-icon">🌴</span>
                <span class="compliance-name">CCPA</span>
              </div>
              <div class="compliance-chip" data-value="iso27001">
                <span class="compliance-icon">📋</span>
                <span class="compliance-name">ISO 27001</span>
              </div>
            </div>
            <div id="customComplianceChips" class="compliance-chips custom-compliance"></div>
            <div class="compliance-add-input">
              <input type="text" placeholder="Add other compliance requirement..." id="customComplianceInput">
              <button type="button" id="addComplianceBtn">Add</button>
            </div>
          </div>

          <div class="step-notes" data-step="5">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(5)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="5" placeholder="Add any additional notes about engagement model, ownership, or compliance..."></textarea>
            </div>
          </div>
          <div class="validation-error" id="step5Error" role="alert"></div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step5Back">← Back</button>
          <button class="btn btn-primary" id="step5Next">Continue →</button>
        </div>
      </div>

      <!-- Step 6: Client AI Landscape -->
      <div id="step6" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 2</div>
          <h1 class="card-title">Client AI Adoption — As-Is State</h1>
          <p class="card-subtitle">(irrespective of DataArt's involvement)</p>
        </div>
        <div class="card-body">
          <!-- Question 1: AI Adoption Journey -->
          <div class="engagement-section">
            <div class="engagement-label">At what stage is the client in their AI adoption journey? <a class="more-info-link" onclick="openMaturityInfoModal()">ℹ️ More info</a></div>
            <div class="journey-container" id="maturityStages">
              <div class="journey-idk">
                <div class="option-card" data-value="dont-know">
                  <div class="option-card-icon">🤷</div>
                  <div class="option-card-title">I Don't Know</div>
                </div>
              </div>
              <div class="journey-pipeline">
                <div class="journey-stage" data-value="not-started">
                  <span class="journey-stage-icon">🚫</span>
                  <span class="journey-stage-name">Not Started</span>
                  <span class="journey-stage-desc">No AI initiatives</span>
                </div>
                <div class="journey-stage" data-value="exploring">
                  <span class="journey-stage-icon">🔍</span>
                  <span class="journey-stage-name">Exploring</span>
                  <span class="journey-stage-desc">Researching</span>
                </div>
                <div class="journey-stage" data-value="piloting">
                  <span class="journey-stage-icon">🧪</span>
                  <span class="journey-stage-name">Piloting</span>
                  <span class="journey-stage-desc">Running POCs</span>
                </div>
                <div class="journey-stage" data-value="scaling">
                  <span class="journey-stage-icon">📈</span>
                  <span class="journey-stage-name">Scaling</span>
                  <span class="journey-stage-desc">Expanding</span>
                </div>
                <div class="journey-stage" data-value="optimizing">
                  <span class="journey-stage-icon">⚡</span>
                  <span class="journey-stage-name">Optimizing</span>
                  <span class="journey-stage-desc">AI embedded</span>
                </div>
              </div>
              <div class="journey-arrow-label">
                <span>Early stage</span>
                <div class="journey-arrow-line"></div>
                <span>Mature</span>
              </div>
            </div>
          </div>

          <!-- Question 2: Current AI Usage -->
          <div class="engagement-section">
            <div class="engagement-label">How is the client currently using AI?</div>
            <div class="engagement-hint">Select all that apply</div>
            <div class="option-cards client-ai-options" id="clientUsageOptions">
              <div class="option-card" data-value="dont-know">
                <div class="option-card-icon">🤷</div>
                <div class="option-card-title">I Don't Know</div>
                <div class="option-card-desc">Unsure of AI usage</div>
              </div>
              <div class="option-card" data-value="not-using">
                <div class="option-card-icon">❌</div>
                <div class="option-card-title">Not Using AI</div>
                <div class="option-card-desc">No AI adoption yet</div>
              </div>
              <div class="option-card" data-value="off-the-shelf">
                <div class="option-card-icon">📦</div>
                <div class="option-card-title">Off-the-Shelf Tools</div>
                <div class="option-card-desc">Copilot, ChatGPT, Gemini, etc.</div>
              </div>
              <div class="option-card" data-value="business-apps">
                <div class="option-card-icon">💼</div>
                <div class="option-card-title">AI in Business Apps</div>
                <div class="option-card-desc">AI features in existing platforms</div>
              </div>
              <div class="option-card" data-value="custom-solutions">
                <div class="option-card-icon">🔧</div>
                <div class="option-card-title">Custom AI Solutions</div>
                <div class="option-card-desc">In-house built AI/ML models</div>
              </div>
              <div class="option-card" data-value="business-processes">
                <div class="option-card-icon">⚙️</div>
                <div class="option-card-title">Process Automation</div>
                <div class="option-card-desc">AI-driven workflows & RPA</div>
              </div>
              <div class="option-card" data-value="customer-facing">
                <div class="option-card-icon">👥</div>
                <div class="option-card-title">Customer-Facing AI</div>
                <div class="option-card-desc">Chatbots, recommendations, etc.</div>
              </div>
            </div>
          </div>

          <!-- Question 3: Strategic Priority -->
          <div class="engagement-section">
            <div class="engagement-label">Is AI a strategic priority for the client?</div>
            <div class="option-cards client-ai-options inline-options" id="clientPriorityOptions">
              <div class="option-card" data-value="dont-know">
                <div class="option-card-icon">🤷</div>
                <div class="option-card-title">I Don't Know</div>
                <div class="option-card-desc">Unsure of AI priority</div>
              </div>
              <div class="option-card" data-value="not-priority">
                <div class="option-card-icon">➖</div>
                <div class="option-card-title">Not a Priority</div>
                <div class="option-card-desc">No focus on AI</div>
              </div>
              <div class="option-card" data-value="low">
                <div class="option-card-icon">🔻</div>
                <div class="option-card-title">Low Priority</div>
                <div class="option-card-desc">Exploring opportunistically</div>
              </div>
              <div class="option-card" data-value="medium">
                <div class="option-card-icon">▶️</div>
                <div class="option-card-title">Medium Priority</div>
                <div class="option-card-desc">Dedicated budget/resources</div>
              </div>
              <div class="option-card" data-value="high">
                <div class="option-card-icon">🔺</div>
                <div class="option-card-title">High Priority</div>
                <div class="option-card-desc">Executive sponsorship</div>
              </div>
            </div>
          </div>

          <!-- Question 4: AI Governance -->
          <div class="engagement-section">
            <div class="engagement-label">Does the client have AI governance in place?</div>
            <div class="option-cards client-ai-options inline-options" id="clientGovernanceOptions">
              <div class="option-card" data-value="dont-know">
                <div class="option-card-icon">🤷</div>
                <div class="option-card-title">I Don't Know</div>
                <div class="option-card-desc">Unsure of governance</div>
              </div>
              <div class="option-card" data-value="none">
                <div class="option-card-icon">🚫</div>
                <div class="option-card-title">No Governance</div>
                <div class="option-card-desc">No policies in place</div>
              </div>
              <div class="option-card" data-value="informal">
                <div class="option-card-icon">📝</div>
                <div class="option-card-title">Informal</div>
                <div class="option-card-desc">Informal guidelines only</div>
              </div>
              <div class="option-card" data-value="developing">
                <div class="option-card-icon">🔄</div>
                <div class="option-card-title">Developing</div>
                <div class="option-card-desc">Policies being developed</div>
              </div>
              <div class="option-card" data-value="established">
                <div class="option-card-icon">✅</div>
                <div class="option-card-title">Established</div>
                <div class="option-card-desc">Formal AI governance</div>
              </div>
            </div>
          </div>

          <!-- Question 5: Biggest Challenges -->
          <div class="engagement-section">
            <div class="engagement-label">What are the client's biggest AI challenges?</div>
            <div class="challenges-hint" id="clientChallengesHint">Select up to 2 (Primary and Secondary)</div>
            <div class="option-cards client-ai-options" id="clientChallengeOptions">
              <div class="option-card" data-value="dont-know">
                <div class="option-card-icon">🤷</div>
                <div class="option-card-title">I Don't Know</div>
                <div class="option-card-desc">Unsure of challenges</div>
              </div>
              <div class="option-card" data-value="unclear-roi">
                <div class="option-card-icon">❓</div>
                <div class="option-card-title">Unclear ROI</div>
                <div class="option-card-desc">Use cases or value unclear</div>
              </div>
              <div class="option-card" data-value="skills">
                <div class="option-card-icon">🎓</div>
                <div class="option-card-title">Skills Gap</div>
                <div class="option-card-desc">Lack of talent/skills</div>
              </div>
              <div class="option-card" data-value="data">
                <div class="option-card-icon">📊</div>
                <div class="option-card-title">Data Issues</div>
                <div class="option-card-desc">Quality or availability</div>
              </div>
              <div class="option-card" data-value="security">
                <div class="option-card-icon">🔒</div>
                <div class="option-card-title">Security/Compliance</div>
                <div class="option-card-desc">Privacy or regulatory</div>
              </div>
              <div class="option-card" data-value="budget">
                <div class="option-card-icon">💰</div>
                <div class="option-card-title">Budget/Buy-in</div>
                <div class="option-card-desc">Funding or sponsorship</div>
              </div>
              <div class="option-card" data-value="infrastructure">
                <div class="option-card-icon">🏗️</div>
                <div class="option-card-title">Infrastructure</div>
                <div class="option-card-desc">Technology readiness</div>
              </div>
            </div>
          </div>
          <!-- Question 6: Approved AI Tools List -->
          <div class="engagement-section">
            <div class="engagement-label">Is there an approved list of AI tools?</div>
            <div class="option-cards client-ai-options inline-options" id="clientApprovedToolsOptions">
              <div class="option-card" data-value="dont-know">
                <div class="option-card-icon">🤷</div>
                <div class="option-card-title">I Don't Know</div>
                <div class="option-card-desc">Unsure if list exists</div>
              </div>
              <div class="option-card" data-value="no">
                <div class="option-card-icon">❌</div>
                <div class="option-card-title">No</div>
                <div class="option-card-desc">No approved list</div>
              </div>
              <div class="option-card" data-value="yes">
                <div class="option-card-icon">✅</div>
                <div class="option-card-title">Yes</div>
                <div class="option-card-desc">Approved list exists</div>
              </div>
            </div>
            <div id="approvedToolsDetailSection" style="display: none; margin-top: 1rem;">
              <label class="account-name-label">Which tools are on the approved list?</label>
              <div class="engagement-hint">Select all that apply</div>
              <div class="compliance-chips" id="approvedToolsChips">
                <div class="compliance-chip" data-value="github-copilot">
                  <span class="compliance-icon">🤖</span>
                  <span class="compliance-name">GitHub Copilot</span>
                </div>
                <div class="compliance-chip" data-value="chatgpt">
                  <span class="compliance-icon">💬</span>
                  <span class="compliance-name">ChatGPT / OpenAI</span>
                </div>
                <div class="compliance-chip" data-value="claude">
                  <span class="compliance-icon">🧠</span>
                  <span class="compliance-name">Claude / Anthropic</span>
                </div>
                <div class="compliance-chip" data-value="gemini">
                  <span class="compliance-icon">✨</span>
                  <span class="compliance-name">Gemini / Google</span>
                </div>
                <div class="compliance-chip" data-value="cursor">
                  <span class="compliance-icon">📝</span>
                  <span class="compliance-name">Cursor</span>
                </div>
                <div class="compliance-chip" data-value="amazon-q-kiro">
                  <span class="compliance-icon">📦</span>
                  <span class="compliance-name">Amazon Q / Kiro</span>
                </div>
                <div class="compliance-chip" data-value="ms-copilot">
                  <span class="compliance-icon">🪟</span>
                  <span class="compliance-name">Microsoft Copilot</span>
                </div>
                <div class="compliance-chip" data-value="atlassian-rovo">
                  <span class="compliance-icon">🔵</span>
                  <span class="compliance-name">Atlassian Rovo</span>
                </div>
              </div>
              <div id="customApprovedToolsChips" class="compliance-chips custom-compliance"></div>
              <div class="compliance-add-input">
                <input type="text" placeholder="Add other approved tool..." id="customApprovedToolInput">
                <button type="button" id="addApprovedToolBtn">Add</button>
              </div>
            </div>
          </div>

          <div class="step-notes" data-step="6">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(6)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="6" placeholder="Add any additional notes about the client's AI landscape..."></textarea>
            </div>
          </div>
          <div class="validation-error" id="step6Error" role="alert"></div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step6Back">← Back</button>
          <button class="btn btn-primary" id="step6Next">Continue →</button>
        </div>
      </div>


      <!-- Step 4: Role-Tool Matrix -->
      <div id="step4" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 5</div>
          <h1 class="card-title">Who uses which AI tools?</h1>
          <p class="card-subtitle">Check the boxes where a role uses a tool</p>
        </div>
        <div class="card-body">
          <div id="roleToolMatrixContainer">
            <!-- Matrix will be populated by JS -->
          </div>
          <div class="step-notes" data-step="4">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(4)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="4" placeholder="Add any additional notes about role-tool assignments..."></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step4Back">← Back</button>
          <button class="btn btn-primary" id="step4Next">Continue →</button>
        </div>
      </div>

      <!-- Step 3: AI Use Cases -->
      <div id="step3" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 6</div>
          <h1 class="card-title">What are your AI use case needs?</h1>
          <p class="card-subtitle">Move use cases between "Need" and "Already Doing" columns</p>
        </div>
        <div class="card-body" id="useCasesContainer">
          <!-- Use cases will be populated by JS -->
        </div>
        <div class="card-body" style="padding-top:0;">
          <div class="step-notes" data-step="3" style="margin-top:0;">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(3)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="3" placeholder="Add any additional notes about AI use cases or priorities..."></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step3Back">← Back</button>
          <button class="btn btn-primary" id="step3Next">Continue →</button>
        </div>
      </div>

      <!-- Step 7: Limiting Factors -->
      <div id="step7" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 8</div>
          <h1 class="card-title">What are the main factors limiting your ability to adopt or use AI more effectively in your current work?</h1>
          <p class="card-subtitle">Select up to 2 options</p>
        </div>
        <div class="card-body">
          <div class="limiting-factors-hint" id="limitingFactorsHint">Select up to 2</div>
          <div class="option-cards limiting-factors-options" id="limitingFactorsOptions">
            <div class="option-card" data-value="time">
              <div class="option-card-icon">⏱️</div>
              <div class="option-card-title">Lack of time / competing priorities</div>
            </div>
            <div class="option-card" data-value="knowledge">
              <div class="option-card-icon">📚</div>
              <div class="option-card-title">Lack of knowledge or practical skills</div>
            </div>
            <div class="option-card" data-value="unclear-value">
              <div class="option-card-icon">❓</div>
              <div class="option-card-title">Unclear value or relevant use cases</div>
            </div>
            <div class="option-card" data-value="client">
              <div class="option-card-icon">🤝</div>
              <div class="option-card-title">Client or stakeholder not ready or supportive</div>
            </div>
            <div class="option-card" data-value="access">
              <div class="option-card-icon">🔒</div>
              <div class="option-card-title">Lack of access to tools, data, budget, or clear governance</div>
            </div>
            <div class="option-card" data-value="other">
              <div class="option-card-icon">📝</div>
              <div class="option-card-title">Other (please specify)...</div>
            </div>
          </div>
          <div class="limiting-factor-other-wrap hidden" id="limitingFactorOtherWrap">
            <label class="account-name-label" for="limitingFactorOtherInput">Please specify</label>
            <input type="text" id="limitingFactorOtherInput" class="account-name-input" placeholder="Describe other limiting factors...">
          </div>
          <div class="step-notes" data-step="7">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(7)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="7" placeholder="Add any additional notes about limiting factors or challenges..."></textarea>
            </div>
          </div>
          <div class="validation-error" id="step7Error" role="alert"></div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step7Back">← Back</button>
          <button class="btn btn-primary" id="step7Next">Continue →</button>
        </div>
      </div>

      <!-- Step 9: AI Workflow Maturity -->
      <div id="step9" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Step 7</div>
          <h1 class="card-title">AI Workflow Maturity</h1>
          <p class="card-subtitle">Select the current stage for each role</p>
        </div>
        <div class="card-body">
          <div id="workflowMaturityContainer">
            <!-- Populated by JS -->
          </div>
          <div class="validation-error" id="step9Error" role="alert"></div>
          <div class="step-notes" data-step="9">
            <button type="button" class="step-notes-toggle" onclick="toggleStepNotes(9)">
              <span class="notes-chevron">▶</span> Additional Notes <span class="notes-dot"></span>
            </button>
            <div class="step-notes-body">
              <textarea class="step-notes-textarea" data-step="9" placeholder="Add any additional notes about workflow maturity or AI practices..."></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step9Back">← Back</button>
          <button class="btn btn-primary" id="step9Next">Continue →</button>
        </div>
      </div>

      <!-- Step 8: Review -->
      <div id="step8" class="step hidden">
        <div class="card-header">
          <div class="step-indicator">Review</div>
          <h1 class="card-title">Review your assessment</h1>
          <p class="card-subtitle">Check your answers before downloading</p>
        </div>
        <div class="card-body">
          <div id="reviewContainer"></div>
          <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid #e5e7eb;">
            <label style="font-size:0.85rem;font-weight:600;color:#374151;display:block;margin-bottom:0.4rem;" for="downloadNameInput">Download file name (optional)</label>
            <input type="text" id="downloadNameInput" placeholder="Leave blank for default name..." style="width:100%;max-width:500px;padding:0.55rem 0.85rem;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;">
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" id="step8Back">← Back</button>
          <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
            <button class="btn btn-primary" id="updateDashboardSurvey" style="display:none;">🔄 Update in Dashboard</button>
            <button class="btn btn-primary" id="downloadAssessmentReview">📦 Download Assessment</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Restore Survey Modal -->
  <div class="restore-modal-overlay" id="restoreModalOverlay">
    <div class="restore-modal">
      <div class="restore-modal-header">
        <h2>Saved Surveys</h2>
        <button class="restore-modal-close" id="restoreModalClose">&times;</button>
      </div>
      <div class="restore-modal-body">
        <div id="restoreSurveyList" class="restore-survey-list"></div>
      </div>
      <div class="restore-modal-footer">
        <button class="btn btn-secondary" id="restoreModalDone">Close</button>
      </div>
    </div>
  </div>

  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Maturity Info Modal -->
  <div class="info-modal-overlay" id="maturityInfoModal">
    <div class="info-modal">
      <button class="info-modal-close" onclick="closeMaturityInfoModal()" title="Close">&times;</button>
      <h2>AI Adoption Journey — Stage Descriptions</h2>

      <div class="info-modal-stage">
        <h3>🚫 Not Started — "AI is not on the agenda"</h3>
        <p>At this stage, AI is essentially absent from the client's strategy. There are no initiatives, no owners, and no clear awareness of where AI could add value. If AI is mentioned, it's usually abstract or perceived as something for "big tech companies," not something actionable for them. Decisions are driven by existing processes and tools, and there is often uncertainty or skepticism around AI's relevance, cost, or risk.</p>
      </div>

      <div class="info-modal-stage">
        <h3>🔍 Exploring — "We are trying to understand AI"</h3>
        <p>Here the client has curiosity, but not commitment. AI is being researched, discussed, or experimented with informally — maybe through demos, workshops, vendor conversations, or isolated experiments by motivated individuals. There is no production usage, no clear ROI expectations, and no governance. Learning is the goal, not outcomes. This stage is about sense-making, not delivery.</p>
      </div>

      <div class="info-modal-stage">
        <h3>🧪 Piloting — "We are testing if AI actually works for us"</h3>
        <p>This is a key inflection point. The client is running concrete POCs tied to real problems (often in limited scopes like SDLC, support, or analytics). There is some budget, some sponsorship, and early success criteria — but AI is still treated as an experiment. Results are evaluated cautiously, risks are contained, and decisions about scaling are pending. AI exists, but it's not yet trusted or systemic.</p>
      </div>

      <div class="info-modal-stage">
        <h3>📈 Scaling — "AI is becoming part of how we operate"</h3>
        <p>Now AI has proven value. Successful pilots are expanded across teams, functions, or products. Investment increases, governance starts to matter, and repeatability becomes important. The client begins to standardize tools, define ownership, train people, and integrate AI into workflows. The focus shifts from "does this work?" to "how do we roll this out safely and consistently?"</p>
      </div>

      <div class="info-modal-stage">
        <h3>⚡ Optimizing — "AI is embedded and continuously improved"</h3>
        <p>At this stage, AI is no longer a project — it's infrastructure. AI is embedded into core processes and products, measured with KPIs, and continuously refined. The client actively optimizes models, workflows, and cost/value tradeoffs. People are trained by default, governance is mature, and AI decisions are part of normal business planning. The question is no longer whether to use AI, but how to do it better.</p>
      </div>

      <div class="info-modal-summary">
        <h3>The big difference across stages</h3>
        <p>Early stages are about learning and reducing uncertainty. Middle stages are about proving value and managing risk. Later stages are about institutionalizing and optimizing impact.</p>
      </div>
    </div>
  </div>

  <script>
    // Data
    const roles = [
      { id: 'pm', name: 'Project Managers / Scrum Masters', icon: '📋' },
      { id: 'ba', name: 'Business Analysts / Product Managers', icon: '📊' },
      { id: 'arch', name: 'Solutions Architects', icon: '🏗️' },
      { id: 'swe', name: 'Software Engineers', icon: '💻' },
      { id: 'qa', name: 'Manual QA', icon: '🔍' },
      { id: 'qaa', name: 'QA Automation Engineers', icon: '🤖' },
      { id: 'data', name: 'Data Engineers / Scientists', icon: '📈' },
      { id: 'devops', name: 'DevOps Engineers', icon: '⚙️' },
      { id: 'ux', name: 'UI/UX Designers', icon: '🎨' },
    ];

    const toolCategories = [
      {
        id: 'cloud',
        name: 'Cloud Platforms',
        description: 'Where your application runs',
        icon: '☁️',
        showAlways: true,
        tools: [
          { id: 'aws', name: 'Amazon Web Services (AWS)' },
          { id: 'gcp', name: 'Google Cloud Platform (GCP)' },
          { id: 'azure', name: 'Microsoft Azure' },
          { id: 'onprem', name: 'On-Premises' },
        ]
      },
      {
        id: 'ai',
        name: 'AI Tools',
        description: 'AI assistants and code generation tools',
        icon: '🧠',
        showAlways: true,
        tools: [
          { id: 'copilot', name: 'GitHub Copilot' },
          { id: 'chatgpt', name: 'ChatGPT / OpenAI' },
          { id: 'claude', name: 'Claude (Anthropic)' },
          { id: 'claudecode', name: 'Claude Code' },
          { id: 'cursor', name: 'Cursor' },
          { id: 'windsurf', name: 'Windsurf' },
          { id: 'gemini', name: 'Gemini (Google)' },
          { id: 'amazonq', name: 'Amazon Q / Kiro' },
          { id: 'mscopilot', name: 'Microsoft Copilot' },
          { id: 'intellij', name: 'IntelliJ AI' },
          { id: 'rovo', name: 'Atlassian Rovo' },
          { id: 'v0', name: 'v0 (Vercel)' },
          { id: 'bolt', name: 'Bolt.new' },
          { id: 'lovable', name: 'Lovable' },
          { id: 'perplexity', name: 'Perplexity' },
        ]
      },
      {
        id: 'collab',
        name: 'Collaboration Tools',
        description: 'Communication and project management',
        icon: '🤝',
        showAlways: true,
        tools: [
          { id: 'slack', name: 'Slack' },
          { id: 'teams', name: 'Microsoft Teams' },
          { id: 'jira', name: 'Jira' },
          { id: 'confluence', name: 'Confluence' },
          { id: 'notion', name: 'Notion' },
          { id: 'azuredevops', name: 'Azure DevOps' },
          { id: 'githubissues', name: 'GitHub Issues' },
          { id: 'googleworkspace', name: 'Google Workspace' },
          { id: 'sharepoint', name: 'SharePoint' },
        ]
      },
      {
        id: 'testmgmt',
        name: 'Test Management Tools',
        description: 'Test case and QA management',
        icon: '✅',
        showForRoles: ['qa', 'qaa'],
        tools: [
          { id: 'testrail', name: 'TestRail' },
          { id: 'zephyr', name: 'Zephyr' },
        ]
      },
      {
        id: 'scm',
        name: 'Source Control',
        description: 'Version control and code repositories',
        icon: '📦',
        showAlways: true,
        tools: [
          { id: 'github', name: 'GitHub' },
          { id: 'gitlab', name: 'GitLab' },
          { id: 'bitbucket', name: 'Bitbucket' },
          { id: 'azurerepos', name: 'Azure Repos' },
        ]
      },
      {
        id: 'cicd',
        name: 'CI/CD Tools',
        description: 'Continuous integration and deployment',
        icon: '🚀',
        showAlways: true,
        tools: [
          { id: 'githubactions', name: 'GitHub Actions' },
          { id: 'jenkins', name: 'Jenkins' },
          { id: 'gitlabci', name: 'GitLab CI' },
          { id: 'circleci', name: 'CircleCI' },
          { id: 'azurepipelines', name: 'Azure Pipelines' },
          { id: 'argocd', name: 'ArgoCD' },
        ]
      },
      {
        id: 'design',
        name: 'Design Tools',
        description: 'UI/UX design and prototyping',
        icon: '🎨',
        showForRoles: ['ux'],
        tools: [
          { id: 'figma', name: 'Figma' },
          { id: 'miro', name: 'Miro' },
        ]
      },
    ];

    // Use case categories
    const useCaseCategories = [
      {
        id: 'code-dev',
        name: 'Code Development',
        icon: '💻',
        items: [
          { id: 'code-completion', label: 'Code completion and suggestions' },
          { id: 'code-generation', label: 'Generate code from natural language' },
          { id: 'code-refactoring', label: 'Code refactoring and optimization' },
          { id: 'code-review', label: 'Automated code review assistance' },
          { id: 'debugging', label: 'Debugging and error resolution' },
          { id: 'code-explanation', label: 'Code explanation and documentation' }
        ]
      },
      {
        id: 'documentation',
        name: 'Documentation',
        icon: '📄',
        items: [
          { id: 'api-docs', label: 'API documentation generation' },
          { id: 'readme-generation', label: 'README and setup guides' },
          { id: 'technical-specs', label: 'Technical specification writing' },
          { id: 'inline-comments', label: 'Code comments and docstrings' },
          { id: 'release-notes', label: 'Release notes generation' }
        ]
      },
      {
        id: 'requirements',
        name: 'Requirements & Analysis',
        icon: '📊',
        items: [
          { id: 'user-stories', label: 'User story creation and refinement' },
          { id: 'requirements-analysis', label: 'Requirements gap analysis' },
          { id: 'acceptance-criteria', label: 'Acceptance criteria generation' },
          { id: 'impact-analysis', label: 'Impact analysis for changes' },
          { id: 'backlog-refinement', label: 'Backlog grooming assistance' }
        ]
      },
      {
        id: 'pm',
        name: 'Project Management',
        icon: '📋',
        items: [
          { id: 'meeting-summaries', label: 'Meeting summaries and action items' },
          { id: 'status-reports', label: 'Status report generation' },
          { id: 'risk-identification', label: 'Risk identification and mitigation' },
          { id: 'estimation', label: 'Effort estimation assistance' },
          { id: 'stakeholder-comms', label: 'Stakeholder communication drafts' }
        ]
      },
      {
        id: 'design-ux',
        name: 'Design & UX',
        icon: '🎨',
        items: [
          { id: 'design-feedback', label: 'Design critique and feedback' },
          { id: 'copy-writing', label: 'UI copy and microcopy writing' },
          { id: 'accessibility', label: 'Accessibility recommendations' },
          { id: 'user-research', label: 'User research analysis' },
          { id: 'persona-creation', label: 'Persona and journey mapping' }
        ]
      },
      {
        id: 'data-analytics',
        name: 'Data & Analytics',
        icon: '📈',
        items: [
          { id: 'sql-generation', label: 'SQL query generation' },
          { id: 'data-transformation', label: 'Data transformation scripts' },
          { id: 'data-analysis', label: 'Data analysis and insights' },
          { id: 'pipeline-development', label: 'Data pipeline development' },
          { id: 'data-quality', label: 'Data quality checks' }
        ]
      }
    ];

    // Use case helpers
    function getUseCaseLabel(categoryId, itemId) {
      const cat = useCaseCategories.find(c => c.id === categoryId);
      if (cat) {
        const item = cat.items.find(i => i.id === itemId);
        if (item) return item.label;
      }
      // Check custom items
      const catData = useCaseData[categoryId];
      if (catData && catData.custom) {
        const custom = catData.custom.find(c => (typeof c === 'string' ? c : c.id) === itemId);
        if (custom) return typeof custom === 'string' ? custom : custom.label;
      }
      return itemId;
    }

    // Reverse map for migrating old text-based use case data to IDs
    const useCaseTextToId = {};
    useCaseCategories.forEach(cat => {
      cat.items.forEach(item => {
        useCaseTextToId[item.label] = item.id;
      });
    });

    // State
    let currentStep = 1;
    let accountName = '';
    let aiChampion = null;        // 'yes', 'no'
    let aiChampions = [];         // array of strings (champion names)
    let aiFutureChampions = [];    // array of strings (future champion nominations)
    let hasSuccessStories = null;  // 'yes', 'no'
    let successStories = [];       // array of strings
    let selectedRoles = new Set();
    let selectedTools = {};
    let customTools = {};
    let selectedOwnership = new Set();   // Multi-select: staff, project, program, outcome
    let aiToolPayment = null;            // 'us', 'customer', 'mix', 'tbd'
    let selectedCompliance = new Set();  // Selected compliance requirements
    let customCompliance = [];           // Custom compliance requirements [{id, name}]
    let selectedLimitingFactors = new Set();  // Max 2; values: time, knowledge, unclear-value, client, access, other
    let limitingFactorsOrder = [];     // Ordered list for primary/secondary
    let limitingFactorOther = '';      // "Other" free text when other is selected
    
    // Client AI Landscape
    let clientAIMaturity = null;       // not-started, exploring, piloting, scaling, optimizing
    let clientAIUsage = new Set();     // Multi-select: not-using, off-the-shelf, business-apps, custom-solutions, business-processes, customer-facing
    let clientAIPriority = null;       // not-priority, low, medium, high
    let clientAIGovernance = null;     // none, informal, developing, established
    let selectedChallenges = new Set();
    let clientChallengeOrder = [];      // Ordered list for primary/secondary challenges
    let clientApprovedTools = null;    // dont-know, no, yes
    let selectedApprovedTools = new Set(); // selected approved tool chips
    let customApprovedTools = [];      // custom approved tools [{id, name}]

    // Role-Tool Matrix: { "roleId:toolId": true }
    let roleToolMatrix = {};

    // AI Workflow Maturity: { roleId: stageIndex (0-5) }
    let workflowMaturity = {};

    // Step notes: { stepId: 'text' }
    let stepNotes = {};

    const wfmStages = [
      { num: 'Stage 0', title: 'No AI Usage', sub: 'AI not used in delivery workflows' },
      { num: 'Stage 1', title: 'Individual AI Usage', sub: 'AI used by individuals only' },
      { num: 'Stage 2', title: 'Team AI Practices', sub: 'Shared, manual AI usage at team level' },
      { num: 'Stage 3', title: 'AI-Chained Tasks', sub: 'Sequential AI steps from one intent' },
      { num: 'Stage 4', title: 'Event-Triggered AI', sub: 'AI reacts automatically to SDLC events' },
      { num: 'Stage 5', title: 'Semi-Agentic AI', sub: 'AI recommends, humans decide' }
    ];

    const wfmRoleDescriptions = {
      pm: [
        'Planning, estimation, and reporting done entirely manually',
        'Uses AI to draft status updates and meeting notes',
        'Team uses shared prompts for sprint planning and risk reviews',
        'Defines scope, identifies risks, maps dependencies, and drafts timeline in one AI-assisted flow',
        'AI automatically flags sprint risks when sprint is created or updated',
        'AI analyzes sprint data and recommends scope or priority adjustments'
      ],
      swe: [
        'No AI tools in IDEs or development environment',
        'Uses Copilot for code snippets and refactoring help',
        'Team has agreed standards for AI usage in code reviews',
        'Takes a story and generates code skeleton with corresponding unit tests automatically',
        'AI automatically reviews pull requests when they are created',
        'AI identifies and suggests specific refactoring or tech-debt targets'
      ],
      qa: [
        'Test cases written fully by hand without AI assistance',
        'Uses AI to brainstorm test cases and scenarios',
        'Team uses shared prompts for consistent test case generation',
        'Generates test cases, creates test data, and produces automation scripts in sequence',
        'AI automatically analyzes and categorizes failed test runs',
        'AI recommends which tests to prioritize based on risk and coverage'
      ],
      qaa: [
        'Automation scripts written without AI assistance',
        'Uses AI to generate test automation snippets',
        'Team uses shared prompts for consistent automation patterns',
        'Generates test framework, creates page objects, and produces test suites in sequence',
        'AI automatically runs and triages test failures on each build',
        'AI recommends test suite optimizations and identifies flaky tests'
      ],
      ba: [
        'Requirements written without any AI assistance',
        'Uses AI to rewrite requirements and user stories',
        'Team follows standard AI-assisted story templates',
        'Transforms requirements into acceptance criteria and complete test scenarios',
        'AI automatically enriches tickets with context when created',
        'AI analyzes requirements and proposes simplifications or improvements'
      ],
      ux: [
        'No AI used for ideation or content creation',
        'Uses AI for copy generation, ideas, and quick wireframes',
        'Team uses shared AI workflows for personas and UX copy',
        'Converts requirements into wireframes with UX copy and design variants',
        'AI automatically generates UX feedback when design changes are committed',
        'AI analyzes feedback patterns and suggests UX improvements'
      ],
      devops: [
        'Manual troubleshooting and script writing',
        'Uses AI to explain logs and troubleshoot errors',
        'Team maintains AI-assisted runbooks for common tasks',
        'Analyzes incidents, generates root cause analysis, and suggests mitigation steps',
        'AI automatically summarizes incidents when alerts are triggered',
        'AI monitors usage patterns and recommends scaling or infrastructure changes'
      ],
      arch: [
        'Designs created entirely without AI input',
        'Uses AI to sanity-check design decisions',
        'Team consistently uses AI in design review sessions',
        'Converts requirements into architecture draft with documented tradeoffs',
        'AI automatically checks designs against architectural standards',
        'AI evaluates multiple architectural options with pros and cons'
      ],
      data: [
        'No AI-assisted analysis or feature engineering',
        'Uses AI to write SQL queries and Python snippets',
        'Team shares AI notebooks for analysis and exploration',
        'Transforms business questions into datasets with engineered features and model drafts',
        'AI automatically validates pipelines and detects data drift',
        'AI analyzes model performance and suggests feature or model improvements'
      ]
    };

    const wfmSignals = [
      ['AI tools blocked or discouraged', 'No AI policy or guidance', '"Shadow AI" usage only', 'No leadership discussion about AI'],
      ['Tool usage varies widely', 'No shared standards', 'Outputs differ by person', 'Knowledge not reusable'],
      ['Prompt libraries', 'AI referenced in ceremonies', 'Repeatable outputs', 'Onboarding includes AI practices'],
      ['Prompt chains', 'Reused workflows', 'Scripts or templates', 'Consistent flow across tickets'],
      ['Bots posting comments', 'Jira / GitHub / CI integrations', 'Background AI execution', 'Reduced manual triggering'],
      ['Dashboards with AI insights', 'Confidence / risk scores', 'Recommendation reports', 'Humans approve actions']
    ];

    const wfmSignalsExpanded = [
      ['AI tools are explicitly prohibited or strongly discouraged by policy', 'No formal AI policy exists or guidelines have been communicated', 'Team members use AI tools privately without management knowledge', 'Leadership has not discussed or acknowledged AI adoption needs'],
      ['Different team members use AI tools in inconsistent ways', 'No agreed-upon standards for prompts or workflows', 'Same task produces different quality outputs depending on who does it', 'Learnings and techniques are not shared or documented'],
      ['Team maintains shared libraries of effective prompts', 'AI capabilities and limitations discussed in team ceremonies', 'Outputs follow consistent patterns and quality standards', 'New team members are taught AI practices as part of onboarding'],
      ['Multiple prompts are chained together for complex tasks', 'Documented workflows that multiple team members follow', 'Scripts or templates standardize common AI interactions', 'Work items follow predictable AI-assisted flows'],
      ['AI systems post updates directly to collaboration tools', 'Integrations with project management and CI/CD pipelines', 'AI tasks execute without manual triggering', 'Less time spent on repetitive manual AI interactions'],
      ['Visual dashboards showing AI-generated insights and metrics', 'AI provides confidence scores and risk assessments', 'Regular reports with AI-generated recommendations', 'Human review and approval gates before AI actions take effect']
    ];

    // Use Cases state - stores items by category: { categoryId: { need: Set, doing: Set, custom: [] } }
    let useCaseData = {};
    let useCasesInitialized = false;

    // Dashboard source tracking — set when restoring from dashboard, cleared on new survey
    let dashboardSource = null;

    // Render flags
    let toolsRendered = false;
    // engagementRendered removed — listeners now in setupEventListeners()
    // clientAIRendered removed — listeners now in setupEventListeners()

    // Compliance options data
    const complianceOptions = [
      { id: 'hipaa', name: 'HIPAA', icon: '🏥' },
      { id: 'gdpr', name: 'GDPR', icon: '🇪🇺' },
      { id: 'sox', name: 'SOX', icon: '📊' },
      { id: 'pci-dss', name: 'PCI-DSS', icon: '💳' },
      { id: 'fedramp', name: 'FedRAMP', icon: '🏛️' },
      { id: 'soc2', name: 'SOC 2', icon: '🔒' },
      { id: 'ccpa', name: 'CCPA', icon: '🌴' },
      { id: 'iso27001', name: 'ISO 27001', icon: '📋' },
    ];

    const ownershipLabels = {
      staff: { name: 'Staff Augmentation', description: 'Team members work under client direction' },
      project: { name: 'Project Ownership', description: 'Full ownership of project delivery' },
      program: { name: 'Program Ownership', description: 'Ownership across multiple related projects' },
      outcome: { name: 'Business Outcome', description: 'Accountable for business results' }
    };

    const STORAGE_KEY = 'ai-adoption-assessment';

    // LocalStorage functions
    function updateSaveStatus(text, saving) {
      const el = document.getElementById('saveStatus');
      const elMobile = document.getElementById('saveStatusMobile');
      if (el) { el.textContent = text; el.className = saving ? 'save-status saving' : 'save-status'; }
      if (elMobile) { elMobile.textContent = text; elMobile.className = saving ? 'save-status mobile-save saving' : 'save-status mobile-save'; }
    }

    function saveToLocalStorage() {
      updateSaveStatus('Saving...', true);
      
      const state = {
        currentStep,
        accountName,
        aiChampion,
        aiChampions,
        aiFutureChampions,
        hasSuccessStories,
        successStories,
        selectedRoles: Array.from(selectedRoles),
        selectedTools: Object.fromEntries(
          Object.entries(selectedTools).map(([k, v]) => [k, Array.from(v)])
        ),
        customTools,
        selectedOwnership: Array.from(selectedOwnership),
        aiToolPayment,
        selectedCompliance: Array.from(selectedCompliance),
        customCompliance,
        selectedLimitingFactors: Array.from(selectedLimitingFactors),
        limitingFactorsOrder,
        limitingFactorOther,
        clientAIMaturity,
        clientAIUsage: Array.from(clientAIUsage),
        clientAIPriority,
        clientAIGovernance,
        selectedChallenges: Array.from(selectedChallenges),
        clientChallengeOrder,
        clientApprovedTools,
        selectedApprovedTools: Array.from(selectedApprovedTools),
        customApprovedTools,
        roleToolMatrix,
        workflowMaturity,
        stepNotes,
        useCaseData: Object.fromEntries(
          Object.entries(useCaseData).map(([catId, data]) => [catId, {
            need: Array.from(data.need || []),
            doing: Array.from(data.doing || []),
            custom: data.custom || []
          }])
        ),
        dashboardSource,
        savedAt: new Date().toISOString()
      };

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        setTimeout(() => updateSaveStatus('Progress auto-saved', false), 500);
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
        updateSaveStatus('Failed to save', false);
      }
    }

    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return false;
        
        const state = JSON.parse(saved);
        
        currentStep = state.currentStep || 1;
        accountName = state.accountName || '';
        aiChampion = state.aiChampion || null;
        aiChampions = state.aiChampions || [];
        // Backward compat: migrate old single-champion data
        if (!state.aiChampions && state.aiChampionName) {
          aiChampions = [state.aiChampionName];
        }
        aiFutureChampions = state.aiFutureChampions || [];
        // Backward compat: migrate old single future champion data
        if (!state.aiFutureChampions && state.aiFutureChampionName) {
          aiFutureChampions = [state.aiFutureChampionName];
        }
        hasSuccessStories = state.hasSuccessStories || null;
        successStories = state.successStories || [];
        selectedRoles = new Set(state.selectedRoles || []);
        selectedTools = Object.fromEntries(
          Object.entries(state.selectedTools || {}).map(([k, v]) => [k, new Set(v)])
        );
        customTools = state.customTools || {};
        selectedOwnership = new Set(state.selectedOwnership || []);
        aiToolPayment = state.aiToolPayment || null;
        selectedCompliance = new Set(state.selectedCompliance || []);
        customCompliance = state.customCompliance || [];
        selectedLimitingFactors = new Set(state.selectedLimitingFactors || []);
        limitingFactorsOrder = Array.isArray(state.limitingFactorsOrder) ? state.limitingFactorsOrder : [];
        limitingFactorOther = state.limitingFactorOther || '';
        clientAIMaturity = state.clientAIMaturity || null;
        clientAIUsage = new Set(state.clientAIUsage || []);
        clientAIPriority = state.clientAIPriority || null;
        clientAIGovernance = state.clientAIGovernance || null;
        selectedChallenges = new Set(state.selectedChallenges || []);
        clientChallengeOrder = state.clientChallengeOrder || [];
        clientApprovedTools = state.clientApprovedTools || null;
        selectedApprovedTools = new Set(state.selectedApprovedTools || []);
        customApprovedTools = state.customApprovedTools || [];
        roleToolMatrix = state.roleToolMatrix || {};
        workflowMaturity = state.workflowMaturity || {};
        stepNotes = state.stepNotes || {};
        dashboardSource = state.dashboardSource || null;

        // Restore use case data
        if (state.useCaseData) {
          useCaseData = Object.fromEntries(
            Object.entries(state.useCaseData).map(([catId, data]) => [catId, {
              need: new Set(data.need || []),
              doing: new Set(data.doing || []),
              custom: data.custom || []
            }])
          );
          // Migrate old text-based use case items to IDs
          Object.entries(useCaseData).forEach(([catId, catData]) => {
            ['need', 'doing'].forEach(col => {
              const migrated = new Set();
              catData[col].forEach(val => {
                const asId = useCaseTextToId[val];
                migrated.add(asId || val); // custom items kept as-is
              });
              catData[col] = migrated;
            });
            // Migrate custom items from string[] to {id, label}[]
            if (catData.custom.length > 0 && typeof catData.custom[0] === 'string') {
              catData.custom = catData.custom.map(text => ({ id: text, label: text }));
            }
          });
          useCasesInitialized = true;
        }

        return true;
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
        return false;
      }
    }

    function clearLocalStorage() {
      if (confirm('Are you sure you want to clear all progress? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY);
        
        // Reset all state
        currentStep = 1;
        accountName = '';
        aiChampion = null;
        aiChampions = [];
        aiFutureChampions = [];
        hasSuccessStories = null;
        successStories = [];
        selectedRoles = new Set();
        selectedTools = {};
        customTools = {};
        selectedOwnership = new Set();
        aiToolPayment = null;
        selectedCompliance = new Set();
        customCompliance = [];
        selectedLimitingFactors = new Set();
        limitingFactorsOrder = [];
        limitingFactorOther = '';
        clientAIMaturity = null;
        clientAIUsage = new Set();
        clientAIPriority = null;
        clientAIGovernance = null;
        selectedChallenges = new Set();
        clientChallengeOrder = [];
        clientApprovedTools = null;
        selectedApprovedTools = new Set();
        customApprovedTools = [];
        roleToolMatrix = {};
        workflowMaturity = {};
        stepNotes = {};
        useCaseData = {};
        useCasesInitialized = false;
        dashboardSource = null;

        // Reset render flags so steps re-initialize
        toolsRendered = false;
        
        // Reset UI elements
        renderRoles();
        updateRoleUI();
        
        // Reset account name input
        const accountInput = document.getElementById('accountNameInput');
        if (accountInput) accountInput.value = '';

        // Reset step notes UI
        restoreAllNotesUI();

        // Reset engagement UI
        document.querySelectorAll('#ownershipOptions .option-card').forEach(card => {
          card.classList.remove('selected');
        });
        document.querySelectorAll('#paymentOptions .option-card').forEach(card => {
          card.classList.remove('selected');
        });
        document.querySelectorAll('#complianceOptions .compliance-chip').forEach(chip => {
          chip.classList.remove('selected');
        });
        const customComplianceContainer = document.getElementById('customComplianceChips');
        if (customComplianceContainer) customComplianceContainer.innerHTML = '';
        
        document.querySelectorAll('#limitingFactorsOptions .option-card').forEach(card => {
          card.classList.remove('selected');
          card.removeAttribute('data-rank');
        });
        const otherWrap = document.getElementById('limitingFactorOtherWrap');
        if (otherWrap) otherWrap.classList.add('hidden');
        const otherInput = document.getElementById('limitingFactorOtherInput');
        if (otherInput) otherInput.value = '';
        
        // Clear any pending auto-save
        clearTimeout(saveTimeout);
        
        // Go to welcome page
        goToStep(0);

        updateSaveStatus('Progress cleared', false);
      }
    }

    // Debounced auto-save
    let saveTimeout;
    function autoSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveToLocalStorage, 1000);
    }

    // ═══════════════════════════════════════════
    // Survey Library — reads from dashboard IndexedDB/SQLite
    // ═══════════════════════════════════════════

    const DASHBOARD_IDB_NAME = 'AISurveyDashboard';
    const DASHBOARD_IDB_STORE = 'database';
    const DASHBOARD_IDB_KEY = 'sqliteDb';

    function openDashboardIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DASHBOARD_IDB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(DASHBOARD_IDB_STORE)) {
            db.createObjectStore(DASHBOARD_IDB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function loadDashboardDB() {
      try {
        const idb = await openDashboardIDB();
        const data = await new Promise((resolve, reject) => {
          const tx = idb.transaction(DASHBOARD_IDB_STORE, 'readonly');
          const req = tx.objectStore(DASHBOARD_IDB_STORE).get(DASHBOARD_IDB_KEY);
          req.onsuccess = () => resolve(req.result ? new Uint8Array(req.result) : null);
          req.onerror = () => reject(req.error);
        });
        idb.close();
        if (!data) { console.warn('No SQLite data found in IndexedDB'); return null; }
        console.log(`Loaded SQLite DB from IndexedDB: ${data.byteLength} bytes`);
        const SQL = await initSqlJs({
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
        });
        return new SQL.Database(data);
      } catch (e) {
        console.error('Failed to load dashboard database:', e);
        return null;
      }
    }

    async function getDashboardSurveys() {
      const db = await loadDashboardDB();
      if (!db) return [];
      try {
        // First check count
        const countResult = db.exec('SELECT COUNT(*) FROM surveys');
        const count = countResult.length ? countResult[0].values[0][0] : 0;
        console.log(`Dashboard DB contains ${count} survey(s)`);

        const result = db.exec('SELECT id, account_name, exported_at, year, quarter, raw_json, account_type, delivery_manager, forecasted_service_revenue FROM surveys ORDER BY account_name ASC, exported_at DESC');
        if (!result.length) return [];
        return result[0].values.map(row => ({
          id: row[0],
          account_name: row[1],
          exported_at: row[2],
          year: row[3],
          quarter: row[4],
          raw_json: row[5],
          account_type: row[6] || 'other',
          delivery_manager: row[7] || '',
          forecasted_service_revenue: row[8] || 0
        }));
      } catch (e) {
        console.error('Failed to query surveys:', e);
        return [];
      } finally {
        db.close();
      }
    }

    async function saveToDashboardDB() {
      try {
        if (!dashboardSource) {
          return { success: false, message: 'This survey was not restored from the dashboard.' };
        }

        const jsonContent = generateJSON();
        const jsonData = JSON.parse(jsonContent);

        if (!jsonData.accountName || !jsonData.exportedAt || !jsonData.schemaVersion) {
          return { success: false, message: 'Survey data is incomplete.' };
        }

        const dashDb = await loadDashboardDB();
        if (!dashDb) {
          return { success: false, message: 'Could not open the dashboard database. Open the dashboard at least once first.' };
        }

        try {
          const exportDate = new Date(jsonData.exportedAt);
          const year = exportDate.getFullYear();
          const quarter = Math.ceil((exportDate.getMonth() + 1) / 3);

          // Check if source row still exists
          const check = dashDb.exec('SELECT id FROM surveys WHERE id = ?', [dashboardSource.id]);
          if (check.length && check[0].values.length) {
            // Update in place — preserve account_type, delivery_manager, forecasted_service_revenue
            dashDb.run(
              'UPDATE surveys SET account_name = ?, exported_at = ?, year = ?, quarter = ?, schema_version = ?, raw_json = ? WHERE id = ?',
              [jsonData.accountName, jsonData.exportedAt, year, quarter, jsonData.schemaVersion, jsonContent, dashboardSource.id]
            );
          } else {
            // Source row was deleted — re-insert with original metadata
            dashDb.run(
              'INSERT INTO surveys (account_name, exported_at, year, quarter, schema_version, raw_json, account_type, delivery_manager, forecasted_service_revenue) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)',
              [jsonData.accountName, jsonData.exportedAt, year, quarter, jsonData.schemaVersion, jsonContent,
               dashboardSource.account_type || 'other', dashboardSource.delivery_manager || '', dashboardSource.forecasted_service_revenue || 0]
            );
            const newIdResult = dashDb.exec('SELECT last_insert_rowid()');
            dashboardSource.id = newIdResult[0].values[0][0];
          }
          dashboardSource.exported_at = jsonData.exportedAt;
          dashboardSource.account_name = jsonData.accountName;
          dashboardSource.year = year;
          dashboardSource.quarter = quarter;

          // Write modified DB back to IndexedDB
          const exportedData = dashDb.export();
          const idb = await openDashboardIDB();
          await new Promise((resolve, reject) => {
            const tx = idb.transaction(DASHBOARD_IDB_STORE, 'readwrite');
            tx.objectStore(DASHBOARD_IDB_STORE).put(exportedData, DASHBOARD_IDB_KEY);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
          idb.close();

          // Notify dashboard if open in another tab
          try {
            const bc = new BroadcastChannel('ai-survey-dashboard-sync');
            bc.postMessage({ type: 'db-updated', source: 'survey-tool' });
            bc.close();
          } catch (e) { /* BroadcastChannel not supported */ }

          saveToLocalStorage(); // persist updated dashboardSource

          return { success: true, message: `Updated "${jsonData.accountName}" in dashboard.` };

        } finally {
          dashDb.close();
        }
      } catch (e) {
        console.error('Failed to save to dashboard DB:', e);
        return { success: false, message: `Error: ${e.message}` };
      }
    }

    function updateDashboardButtons() {
      const updateBtn = document.getElementById('updateDashboardSurvey');
      if (updateBtn) updateBtn.style.display = dashboardSource ? '' : 'none';
    }

    async function restoreSurveyFromZip(file) {
      try {
        const zip = await JSZip.loadAsync(file);
        // Find the JSON file inside the zip
        let jsonFile = null;
        zip.forEach((path, entry) => {
          if (path.endsWith('.json') && !entry.dir) jsonFile = entry;
        });
        if (!jsonFile) {
          alert('No JSON file found in the ZIP archive.');
          return;
        }
        const jsonContent = await jsonFile.async('string');
        const parsed = JSON.parse(jsonContent);

        // ZIP restore has no dashboard source
        dashboardSource = null;
        // The exported JSON is a report, not the raw state.
        // We need to convert it back to a state object.
        restoreSurveyFromExportedJSON(parsed);
      } catch (e) {
        console.error('Failed to restore from ZIP:', e);
        alert('Failed to read ZIP file. Make sure it is a valid survey export.');
      }
    }

    function restoreSurveyFromExportedJSON(data) {
      // Build a state object from the exported JSON schema (supports 2.0.0 and 2.1.0)
      const state = {
        currentStep: 8, // go to review
        accountName: data.accountName || '',
        aiChampion: null,
        aiChampions: [],
        aiFutureChampions: [],
        hasSuccessStories: null,
        successStories: [],
        selectedRoles: [],
        selectedTools: {},
        customTools: {},
        selectedOwnership: [],
        aiToolPayment: null,
        selectedCompliance: [],
        customCompliance: [],
        selectedLimitingFactors: [],
        limitingFactorsOrder: [],
        limitingFactorOther: '',
        clientAIMaturity: null,
        clientAIUsage: [],
        clientAIPriority: null,
        clientAIGovernance: null,
        selectedChallenges: [],
        clientChallengeOrder: [],
        clientApprovedTools: null,
        selectedApprovedTools: [],
        customApprovedTools: [],
        roleToolMatrix: {},
        workflowMaturity: {},
        stepNotes: {},
        useCaseData: {},
        savedAt: new Date().toISOString()
      };

      // ── Engagement (Step 5) ──
      if (data.engagement) {
        const eng = data.engagement;
        if (eng.ownership) {
          state.selectedOwnership = Object.entries(eng.ownership)
            .filter(([k,v]) => !k.startsWith('_') && typeof v === 'object' && v.selected)
            .map(([k]) => k);
        }
        if (eng.aiToolPayment) {
          // { value: "mix" } format
          state.aiToolPayment = eng.aiToolPayment.value || null;
        }
        if (eng.compliance) {
          state.selectedCompliance = Object.entries(eng.compliance)
            .filter(([k,v]) => !k.startsWith('_') && k !== 'custom' && typeof v === 'object' && v.selected)
            .map(([k]) => k);
          if (eng.compliance.custom) {
            state.customCompliance = eng.compliance.custom || [];
          }
        }
      }

      // ── Team Roles (Step 1) — includes AI Champion & Success Stories ──
      if (data.teamRoles) {
        const tr = data.teamRoles;
        // Roles are nested under teamRoles.roles
        if (tr.roles) {
          state.selectedRoles = Object.entries(tr.roles)
            .filter(([k,v]) => !k.startsWith('_') && typeof v === 'object' && v.selected)
            .map(([k]) => k);
        }
        // AI Champion
        if (tr.aiChampion) {
          state.aiChampion = tr.aiChampion.value || null; // "yes" or "no"
          state.aiChampions = tr.aiChampion.champions || [];
          state.aiFutureChampions = tr.aiChampion.futureChampions || [];
        }
        // Success Stories
        if (tr.successStories) {
          state.hasSuccessStories = tr.successStories.value || null; // "yes" or "no"
          state.successStories = tr.successStories.stories || [];
        }
      }

      // ── Client AI Landscape (Step 6) ──
      if (data.clientAILandscape) {
        const cl = data.clientAILandscape;
        // Maturity: { value: "piloting" }
        if (cl.maturity && cl.maturity.value) {
          state.clientAIMaturity = cl.maturity.value;
        }
        // Usage: multi-select { "off-the-shelf": { selected: true }, ... }
        if (cl.usage) {
          state.clientAIUsage = Object.entries(cl.usage)
            .filter(([k,v]) => !k.startsWith('_') && typeof v === 'object' && v.selected)
            .map(([k]) => k);
        }
        // Priority: { value: "high" }
        if (cl.priority && cl.priority.value) {
          state.clientAIPriority = cl.priority.value;
        }
        // Governance: { value: "developing" }
        if (cl.governance && cl.governance.value) {
          state.clientAIGovernance = cl.governance.value;
        }
        // Challenges: ranked { "data": { rank: 1 }, "unclear-roi": { rank: 2 }, ... }
        if (cl.challenges) {
          const ranked = [];
          Object.entries(cl.challenges).forEach(([id, val]) => {
            if (id.startsWith('_')) return;
            if (typeof val === 'object' && val.rank !== null && val.rank !== undefined) {
              ranked.push({ id, rank: val.rank });
            }
          });
          ranked.sort((a,b) => a.rank - b.rank);
          state.clientChallengeOrder = ranked.map(r => r.id);
          state.selectedChallenges = [...state.clientChallengeOrder];
        }
        // Approved Tools List
        if (cl.approvedToolsList) {
          state.clientApprovedTools = cl.approvedToolsList.value || null; // "yes", "no", "dont-know"
          if (cl.approvedToolsList.tools) {
            state.selectedApprovedTools = Object.entries(cl.approvedToolsList.tools)
              .filter(([k,v]) => !k.startsWith('_') && k !== 'custom' && typeof v === 'object' && v.selected)
              .map(([k]) => k);
            if (cl.approvedToolsList.tools.custom) {
              state.customApprovedTools = cl.approvedToolsList.tools.custom || [];
            }
          }
        }
      }

      // ── Tools & Infrastructure (Step 2) ──
      if (data.toolsAndInfrastructure) {
        const tools = data.toolsAndInfrastructure;
        Object.entries(tools).forEach(([catId, catVal]) => {
          if (catId.startsWith('_') || typeof catVal !== 'object') return;
          const selected = [];
          const customs = [];
          Object.entries(catVal).forEach(([toolId, toolVal]) => {
            if (toolId === '_meta' || toolId === 'custom' || toolId === 'visible') return;
            if (toolId.startsWith('_')) return;
            if (typeof toolVal === 'object' && toolVal.selected) {
              selected.push(toolId);
            }
          });
          if (catVal.custom) {
            catVal.custom.forEach(c => {
              if (typeof c === 'string') {
                customs.push({ id: c, name: c });
                selected.push(c);
              } else {
                customs.push({ id: c.id, name: c.name || c.label || c.id });
                if (c.selected) selected.push(c.id);
              }
            });
          }
          if (selected.length > 0) {
            state.selectedTools[catId] = selected;
          }
          if (customs.length > 0) {
            state.customTools[catId] = customs;
          }
        });
      }

      // ── Role-Tool Matrix (Step 4) ──
      // Schema 2.0.0: { "ba:copilot": true/false }
      // Schema 2.1.0: { "ba:copilot": { selected: true, _role, _tool } }
      if (data.roleToolMatrix && typeof data.roleToolMatrix === 'object') {
        Object.entries(data.roleToolMatrix).forEach(([key, val]) => {
          if (key.startsWith('_')) return;
          if (val === true) {
            state.roleToolMatrix[key] = true;
          } else if (typeof val === 'object' && val.selected) {
            state.roleToolMatrix[key] = true;
          }
        });
      }

      // ── Use Cases (Step 3) ──
      if (data.useCases) {
        const uc = {};
        Object.entries(data.useCases).forEach(([catId, catVal]) => {
          if (catId === '_meta' || catId.startsWith('_')) return;
          if (typeof catVal !== 'object') return;
          const need = [];
          const doing = [];
          const custom = [];
          Object.entries(catVal).forEach(([itemId, itemVal]) => {
            if (itemId === '_meta' || itemId.startsWith('_') || itemId === 'custom') return;
            if (typeof itemVal === 'object' && itemVal.status) {
              if (itemVal.status === 'need') need.push(itemId);
              else if (itemVal.status === 'doing') doing.push(itemId);
            }
          });
          if (catVal.custom) {
            catVal.custom.forEach(c => {
              custom.push({ id: c.id, label: c.label || c.name || c.id });
              if (c.status === 'need') need.push(c.id);
              else if (c.status === 'doing') doing.push(c.id);
            });
          }
          uc[catId] = { need, doing, custom };
        });
        state.useCaseData = uc;
      }

      // ── Workflow Maturity (Step 9) ──
      if (data.workflowMaturity) {
        Object.entries(data.workflowMaturity).forEach(([roleId, val]) => {
          if (roleId === '_meta' || roleId.startsWith('_')) return;
          if (typeof val === 'object' && val.stage !== null && val.stage !== undefined) {
            state.workflowMaturity[roleId] = val.stage;
          }
        });
      }

      // ── Limiting Factors (Step 7) ──
      if (data.limitingFactors) {
        const ranked = [];
        Object.entries(data.limitingFactors).forEach(([id, val]) => {
          if (id === '_meta' || id.startsWith('_')) return;
          if (typeof val === 'object' && val.rank !== null && val.rank !== undefined) {
            ranked.push({ id, rank: val.rank });
            if (id === 'other' && val.text) {
              state.limitingFactorOther = val.text;
            }
          }
        });
        ranked.sort((a,b) => a.rank - b.rank);
        state.limitingFactorsOrder = ranked.map(r => r.id);
        state.selectedLimitingFactors = ranked.map(r => r.id);
      }

      // ── Step Notes ──
      if (data.notes) {
        const noteMap = {
          engagement: '5', clientAILandscape: '6', teamRoles: '1',
          tools: '2', roleToolMatrix: '4', useCases: '3',
          workflowMaturity: '9', limitingFactors: '7'
        };
        Object.entries(data.notes).forEach(([key, val]) => {
          if (key === '_meta' || key.startsWith('_')) return;
          if (val && noteMap[key]) state.stepNotes[noteMap[key]] = val;
        });
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      loadFromLocalStorage();
      toolsRendered = false;
      useCasesInitialized = false;
      renderRoles();
      updateRoleUI();
      document.getElementById('accountNameInput').value = accountName;
      restoreAllNotesUI();
      goToStep(8); // Go to review
      updateSaveStatus('Survey restored', false);
    }

    async function openRestoreModal() {
      const overlay = document.getElementById('restoreModalOverlay');
      const list = document.getElementById('restoreSurveyList');
      list.innerHTML = '<div class="restore-empty">Loading surveys from dashboard...</div>';
      overlay.classList.add('open');

      const surveys = await getDashboardSurveys();

      // Update header with count
      const headerEl = overlay.querySelector('.restore-modal-header h2');
      headerEl.textContent = surveys.length > 0 ? `Saved Surveys (${surveys.length})` : 'Saved Surveys';

      if (surveys.length === 0) {
        list.innerHTML = '<div class="restore-empty">No surveys found in the dashboard database.<br>Import surveys in the Dashboard first, or use "From ZIP File" to restore directly.</div>';
      } else {
        list.innerHTML = surveys.map(s => {
          const d = new Date(s.exported_at);
          const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          return `
            <div class="restore-survey-item" data-survey-id="${s.id}">
              <div class="restore-survey-info">
                <div class="restore-survey-name">${(s.account_name || 'Unnamed').replace(/</g, '&lt;')}</div>
                <div class="restore-survey-date">${s.year} Q${s.quarter} &middot; ${dateStr}</div>
              </div>
              <div class="restore-survey-actions">
                <button class="btn-restore-load" data-action="load" data-id="${s.id}">Restore</button>
              </div>
            </div>
          `;
        }).join('');

        list.querySelectorAll('button[data-action="load"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const id = parseInt(btn.dataset.id);
            const survey = surveys.find(s => s.id === id);
            if (survey) {
              overlay.classList.remove('open');
              try {
                const data = JSON.parse(survey.raw_json);
                restoreSurveyFromExportedJSON(data);
                // Set dashboard source AFTER restore (which calls loadFromLocalStorage and resets it)
                dashboardSource = {
                  id: survey.id,
                  account_name: survey.account_name,
                  exported_at: survey.exported_at,
                  year: survey.year,
                  quarter: survey.quarter,
                  account_type: survey.account_type,
                  delivery_manager: survey.delivery_manager,
                  forecasted_service_revenue: survey.forecasted_service_revenue
                };
                saveToLocalStorage(); // persist dashboardSource
                updateDashboardButtons(); // show the Update button
              } catch (err) {
                console.error('Failed to parse survey JSON:', err);
                alert('Failed to restore this survey. The data may be corrupted.');
              }
            }
          });
        });
      }
    }

    // Initialize
    function init() {
      const hasExistingData = loadFromLocalStorage();
      renderRoles();
      setupEventListeners();
      setupStepNotes();
      
      if (hasExistingData) {
        updateRoleUI();
        // Restore account name
        document.getElementById('accountNameInput').value = accountName;
        // Restore to saved step
        goToStep(currentStep > 0 ? currentStep : 5);
      } else {
        goToStep(0); // Start at welcome page
      }
      
      // Add account name input handler
      document.getElementById('accountNameInput').addEventListener('input', (e) => {
        accountName = e.target.value;
        autoSave();
      });

      // Enable/disable start button based on account name
      const startBtn = document.getElementById('startAssessment');
      const updateStartBtn = () => {
        startBtn.disabled = !document.getElementById('accountNameInput').value.trim();
      };
      document.getElementById('accountNameInput').addEventListener('input', updateStartBtn);
      updateStartBtn();
      
      // Add clear progress handler
      document.getElementById('clearProgress').addEventListener('click', clearLocalStorage);

      // Restore survey handlers
      document.getElementById('restoreFromListBtn').addEventListener('click', openRestoreModal);
      document.getElementById('restoreFromFileBtn').addEventListener('click', () => {
        document.getElementById('restoreFileInput').click();
      });
      document.getElementById('restoreFileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (confirm('This will replace your current survey progress. Continue?')) {
            restoreSurveyFromZip(file);
          }
          e.target.value = ''; // reset so same file can be re-selected
        }
      });
      document.getElementById('restoreModalClose').addEventListener('click', () => {
        document.getElementById('restoreModalOverlay').classList.remove('open');
      });
      document.getElementById('restoreModalDone').addEventListener('click', () => {
        document.getElementById('restoreModalOverlay').classList.remove('open');
      });
      document.getElementById('restoreModalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
      });

      // Mobile sidebar toggle
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
          sidebar.classList.toggle('open');
          overlay.classList.toggle('open');
        });
      }
      if (overlay) {
        overlay.addEventListener('click', () => {
          sidebar.classList.remove('open');
          overlay.classList.remove('open');
        });
      }
    }

    function renderRoles() {
      const grid = document.getElementById('roleGrid');
      grid.innerHTML = roles.map(role => `
        <div class="role-card" data-role-id="${role.id}" role="checkbox" aria-checked="false" tabindex="0">
          <div class="checkmark">✓</div>
          <div class="role-icon">${role.icon}</div>
          <div class="role-name">${role.name}</div>
        </div>
      `).join('');

      // Add click handlers
      grid.querySelectorAll('.role-card').forEach(card => {
        card.addEventListener('click', () => toggleRole(card.dataset.roleId));
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleRole(card.dataset.roleId);
          }
        });
      });

      // Restore AI champion state
      document.querySelectorAll('#aiChampionOptions .option-card').forEach(c => {
        c.classList.toggle('selected', c.dataset.value === aiChampion);
      });
      document.getElementById('aiChampionNameSection').style.display = aiChampion === 'yes' ? 'block' : 'none';
      renderChampions();
      document.getElementById('aiFutureChampionSection').style.display = aiChampion === 'no' ? 'block' : 'none';
      renderFutureChampions();

      // Restore success stories state
      document.querySelectorAll('#aiSuccessStoryToggle .option-card').forEach(c => {
        c.classList.toggle('selected', c.dataset.value === hasSuccessStories);
      });
      document.getElementById('aiSuccessStoriesSection').style.display = hasSuccessStories === 'yes' ? 'block' : 'none';
      renderSuccessStories();
    }

    function renderSuccessStories() {
      const list = document.getElementById('aiSuccessStoriesList');
      if (successStories.length === 0) {
        list.innerHTML = '';
        return;
      }
      list.innerHTML = successStories.map((story, i) => `
        <div style="background:#F8FAFA;border:1px solid #E2E6E9;border-radius:8px;padding:0.75rem 1rem;margin-bottom:0.5rem;display:flex;align-items:flex-start;gap:0.75rem;">
          <div style="flex:1;font-size:0.9rem;color:#374151;white-space:pre-wrap;">${story.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <button class="remove-story-btn" data-index="${i}" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1.1rem;padding:0 0.25rem;" title="Remove story">✕</button>
        </div>
      `).join('');
      list.querySelectorAll('.remove-story-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          successStories.splice(parseInt(btn.dataset.index), 1);
          renderSuccessStories();
          autoSave();
        });
      });
    }

    function renderChampions() {
      const list = document.getElementById('aiChampionsList');
      if (aiChampions.length === 0) {
        list.innerHTML = '';
        return;
      }
      list.innerHTML = aiChampions.map((champ, i) => `
        <div style="background:#F8FAFA;border:1px solid #E2E6E9;border-radius:8px;padding:0.75rem 1rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.75rem;">
          <div style="flex:1;font-size:0.9rem;color:#374151;">${champ.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <button class="remove-champion-btn" data-index="${i}" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1.1rem;padding:0 0.25rem;" title="Remove champion">✕</button>
        </div>
      `).join('');
      list.querySelectorAll('.remove-champion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          aiChampions.splice(parseInt(btn.dataset.index), 1);
          renderChampions();
          autoSave();
        });
      });
    }

    function renderFutureChampions() {
      const list = document.getElementById('aiFutureChampionsList');
      if (aiFutureChampions.length === 0) {
        list.innerHTML = '';
        return;
      }
      list.innerHTML = aiFutureChampions.map((name, i) => `
        <div style="background:#F8FAFA;border:1px solid #E2E6E9;border-radius:8px;padding:0.75rem 1rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.75rem;">
          <div style="flex:1;font-size:0.9rem;color:#374151;">${name.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <button class="remove-future-champion-btn" data-index="${i}" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1.1rem;padding:0 0.25rem;" title="Remove nomination">✕</button>
        </div>
      `).join('');
      list.querySelectorAll('.remove-future-champion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          aiFutureChampions.splice(parseInt(btn.dataset.index), 1);
          renderFutureChampions();
          autoSave();
        });
      });
    }

    function toggleRole(roleId) {
      if (selectedRoles.has(roleId)) {
        selectedRoles.delete(roleId);
      } else {
        selectedRoles.add(roleId);
      }
      updateRoleUI();
      autoSave();
    }

    function updateRoleUI() {
      document.querySelectorAll('#roleGrid .role-card').forEach(card => {
        const isSelected = selectedRoles.has(card.dataset.roleId);
        card.classList.toggle('selected', isSelected);
        card.setAttribute('aria-checked', isSelected ? 'true' : 'false');
      });

      const count = selectedRoles.size;
      document.getElementById('roleCount').textContent = 
        `${count} roles selected`;
    }

    function renderTools() {
      const container = document.getElementById('toolsContainer');
      
      const visibleCategories = toolCategories.filter(cat => {
        if (cat.showAlways) return true;
        if (cat.showForRoles) {
          return cat.showForRoles.some(role => selectedRoles.has(role));
        }
        return false;
      });

      // Initialize empty sets for categories without any selection
      visibleCategories.forEach(cat => {
        if (!selectedTools[cat.id]) {
          selectedTools[cat.id] = new Set();
        }
      });

      container.innerHTML = visibleCategories.map(cat => {
        // Get custom tools for this category
        const customList = customTools[cat.id] || [];
        const allTools = [...cat.tools, ...customList];
        
        // Check special options
        const dontKnowSelected = selectedTools[cat.id]?.has('dont-know') || false;
        const notApplicableSelected = selectedTools[cat.id]?.has('not-applicable') || false;
        
        return `
          <div class="tool-category" data-category-id="${cat.id}">
            <div class="tool-category-header">
              <span class="tool-category-label">${cat.icon} ${cat.name}</span>
            </div>
            <div style="font-size:0.8rem;color:#6b7280;margin-bottom:0.5rem;">Select tools used, or choose "Don't know" / "Not Applicable"</div>
            <div class="tool-grid">
              <div class="tool-card special-option${dontKnowSelected ? ' selected' : ''}" data-category="${cat.id}" data-tool-id="dont-know">
                <span class="tool-card-name">Don't know</span>
              </div>
              <div class="tool-card special-option not-applicable${notApplicableSelected ? ' selected' : ''}" data-category="${cat.id}" data-tool-id="not-applicable">
                <span class="tool-card-name">Not Applicable</span>
              </div>
              ${allTools.map(tool => {
                const isSelected = selectedTools[cat.id]?.has(tool.id) || false;
                return `<div class="tool-card${isSelected ? ' selected' : ''}" data-category="${cat.id}" data-tool-id="${tool.id}">
                  <span class="tool-card-name">${tool.name}</span>
                </div>`;
              }).join('')}
            </div>
            <div class="tool-add-input">
              <input type="text" placeholder="Add custom tool..." data-category="${cat.id}">
              <button type="button" data-category="${cat.id}" class="add-tool-btn">Add</button>
            </div>
          </div>
        `;
      }).join('');

      // Setup direct event listeners for the rendered nodes
      container.querySelectorAll('.tool-card').forEach(card => {
        card.addEventListener('click', () => {
          const catId = card.dataset.category;
          const toolId = card.dataset.toolId;
          if (catId && toolId) {
            toggleTool(catId, toolId);
          }
        });
      });

      container.querySelectorAll('.add-tool-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.dataset.category;
          if (catId) {
            addCustomTool(catId);
          }
        });
      });

      container.querySelectorAll('.tool-add-input input').forEach(input => {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const catId = input.dataset.category;
            if (catId) {
              addCustomTool(catId);
            }
          }
        });
      });
    }

    function handleStep2Continue() {
      const visibleCategories = toolCategories.filter(cat => {
        if (cat.showAlways) return true;
        if (cat.showForRoles) {
          return cat.showForRoles.some(role => selectedRoles.has(role));
        }
        return false;
      });

      // Check for categories with no selection or "Don't know"
      const emptyCategories = visibleCategories.filter(cat =>
        !selectedTools[cat.id] || selectedTools[cat.id].size === 0
      );
      const dontKnowCategories = visibleCategories.filter(cat =>
        selectedTools[cat.id]?.has('dont-know')
      );

      const warnCategories = [...emptyCategories, ...dontKnowCategories];
      if (warnCategories.length > 0) {
        const lines = warnCategories.map(cat => {
          const reason = emptyCategories.includes(cat) ? 'no selection' : '"Don\'t know"';
          return `• ${cat.name} (${reason})`;
        }).join('\n');
        const confirmed = confirm(
          `The following sections are incomplete:\n\n${lines}\n\nAre you sure you want to continue?`
        );
        if (!confirmed) return;
      }

      // Skip Role-Tool Matrix if no AI tools are selected
      const aiTools = getSelectedAITools();
      if (aiTools.length === 0) {
        goToStep(3); // Skip to Use Cases
      } else {
        goToStep(4); // Go to Role-Tool Matrix
      }
    }

    function toggleTool(categoryId, toolId) {
      if (!selectedTools[categoryId]) {
        selectedTools[categoryId] = new Set();
      }
      
      const specialOptions = ['dont-know', 'not-applicable'];
      
      if (toolId === 'dont-know') {
        // Toggle "Don't know": clear all if selecting, or just deselect
        if (selectedTools[categoryId].has('dont-know')) {
          selectedTools[categoryId].delete('dont-know');
        } else {
          selectedTools[categoryId].clear();
          selectedTools[categoryId].add('dont-know');
        }
      } else if (toolId === 'not-applicable') {
        // Toggle "Not Applicable": clear all if selecting, or just deselect
        if (selectedTools[categoryId].has('not-applicable')) {
          selectedTools[categoryId].delete('not-applicable');
        } else {
          selectedTools[categoryId].clear();
          selectedTools[categoryId].add('not-applicable');
        }
      } else {
        // If clicking any regular tool
        if (selectedTools[categoryId].has(toolId)) {
          selectedTools[categoryId].delete(toolId);
        } else {
          // Selecting a tool - remove special options and add the tool
          selectedTools[categoryId].delete('dont-know');
          selectedTools[categoryId].delete('not-applicable');
          selectedTools[categoryId].add(toolId);
        }
      }
      
      updateToolUI();
      autoSave();
    }

    function updateToolUI() {
      const container = document.getElementById('toolsContainer');
      container.querySelectorAll('.tool-card').forEach(card => {
        const catId = card.dataset.category;
        const toolId = card.dataset.toolId;
        const isSelected = selectedTools[catId]?.has(toolId) || false;
        card.classList.toggle('selected', isSelected);
      });
    }

    function addCustomTool(categoryId) {
      const container = document.getElementById('toolsContainer');
      const input = container.querySelector(`input[data-category="${categoryId}"]`);
      const value = input.value.trim();
      
      if (!value) return;
      
      // Generate a unique ID for the custom tool
      const customId = `custom-${Date.now()}`;
      
      if (!customTools[categoryId]) {
        customTools[categoryId] = [];
      }
      
      customTools[categoryId].push({ id: customId, name: value });
      
      // Add the tool to selected tools
      if (!selectedTools[categoryId]) {
        selectedTools[categoryId] = new Set();
      }
      selectedTools[categoryId].add(customId);
      
      // Re-render tools to include the new custom tool
      renderTools();
      autoSave();
    }

    function removeCustomTool(categoryId, index) {
      customTools[categoryId].splice(index, 1);
      renderCustomTools(categoryId);
    }

    function renderCustomTools(categoryId) {
      // No longer needed - custom tools are now rendered as cards
    }

    const stepLabels = {0:'Welcome', 5:'Engagement Model', 6:'Client AI Landscape', 1:'Team Roles', 2:'Tools & Infrastructure', 4:'Role-Tool Matrix', 3:'AI Use Cases', 9:'AI Workflow Maturity', 7:'Limiting Factors', 8:'Review & Download'};
    const stepIcons = {0:'🏠', 5:'🤝', 6:'🏢', 1:'👥', 2:'🛠️', 4:'🔗', 3:'📋', 9:'🤖', 7:'🚧', 8:'📦'};
    const stepSubtitles = {0:'Get started with your assessment', 5:'Define ownership and compliance', 6:'Current client AI adoption state', 1:'Select your team composition', 2:'Select tools used by your team', 4:'Map which roles use which AI tools', 3:'Identify AI use case needs', 9:'Assess workflow maturity per role', 7:'What limits your AI adoption?', 8:'Check your answers before downloading'};

    function getActiveOrder() {
      const aiTools = getSelectedAITools();
      return aiTools.length > 0
        ? [5, 6, 1, 2, 4, 3, 9, 7, 8]
        : [5, 6, 1, 2, 3, 9, 7, 8];
    }

    function renderSidebar() {
      const nav = document.getElementById('sidebarNav');
      const activeOrder = getActiveOrder();
      const allSteps = [0, ...activeOrder];

      nav.innerHTML = allSteps.map((stepId, idx) => {
        const isActive = stepId === currentStep;
        const isCurrent = stepId === currentStep;
        // Steps before the current one in the flow are considered completed
        const currentIdx = allSteps.indexOf(currentStep);
        const isCompleted = idx < currentIdx && stepId !== 0;
        const label = stepLabels[stepId] || `Step ${stepId}`;
        const icon = stepIcons[stepId] || '📄';
        const statusIcon = isCompleted ? '✓' : '';

        return `<div class="sidebar-nav-item${isActive ? ' active' : ''}${isCompleted ? ' completed' : ''}" data-step="${stepId}">
          <div class="nav-icon">${isActive ? (idx === 0 ? '' : idx) : icon}</div>
          <span class="nav-label">${label}</span>
          ${statusIcon ? `<span class="nav-status">${statusIcon}</span>` : ''}
        </div>`;
      }).join('');

      // Click handlers for sidebar navigation
      nav.querySelectorAll('.sidebar-nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const targetStep = parseInt(item.dataset.step);
          const activeOrder = getActiveOrder();
          const currentIdx = activeOrder.indexOf(currentStep);
          const targetIdx = activeOrder.indexOf(targetStep);

          // If navigating forward, validate current step first
          if (targetIdx > currentIdx) {
            if (!validateStep(currentStep)) {
              return; // Block navigation if validation fails
            }
          }

          goToStep(targetStep);
          // Close mobile sidebar
          document.getElementById('sidebar').classList.remove('open');
          document.getElementById('sidebarOverlay').classList.remove('open');
        });
      });
    }

    function goToStep(step) {
      currentStep = step;

      const activeOrder = getActiveOrder();
      const totalDisplaySteps = activeOrder.length - 1; // exclude review from count

      // Update content header
      const pageTitle = document.getElementById('pageTitle');
      const pageSubtitle = document.getElementById('pageSubtitle');
      if (pageTitle) pageTitle.textContent = stepLabels[step] || 'Assessment';
      if (pageSubtitle) pageSubtitle.textContent = stepSubtitles[step] || '';

      // Update progress pill
      if (step === 0) {
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = '';
      } else {
        const displayIdx = activeOrder.indexOf(step);
        const displayNum = displayIdx + 1;
        const progress = step === 8 ? 100 : (displayNum / totalDisplaySteps) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        document.getElementById('progressText').textContent =
          step === 8 ? 'Complete' : `${displayNum} / ${totalDisplaySteps}`;
      }

      // Show/hide steps
      document.querySelectorAll('.step').forEach(el => el.classList.add('hidden'));
      document.getElementById(`step${step}`).classList.remove('hidden');

      // Update step indicator dynamically based on position in activeOrder
      const stepDiv = document.getElementById(`step${step}`);
      if (stepDiv) {
        const indicator = stepDiv.querySelector('.step-indicator');
        if (indicator) {
          const stepPosition = activeOrder.indexOf(step);
          indicator.textContent = step === 8 ? 'Review' : `Step ${stepPosition + 1}`;
        }
      }

      // Toggle expanded container for workflow maturity step
      const mainContainer = document.querySelector('.main-container');
      if (mainContainer) {
        mainContainer.classList.toggle('expanded', step === 9 || step === 4);
      }

      // Update sidebar
      renderSidebar();

      // Focus card header for accessibility
      const stepEl = document.getElementById(`step${step}`);
      const header = stepEl.querySelector('.card-header');
      if (header) {
        header.setAttribute('tabindex', '-1');
        header.focus();
      }

      // Scroll main content to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Render content for step
      if (step === 2) renderTools();
      if (step === 3) renderUseCases();
      if (step === 4) renderRoleToolMatrix();
      if (step === 5) renderEngagement();
      if (step === 6) renderClientAILandscape();
      if (step === 7) renderLimitingFactors();
      if (step === 9) renderWorkflowMaturity();
      if (step === 8) { renderReview(); updateDashboardButtons(); }

      autoSave();
    }

    function renderEngagement() {
      updateOwnershipUI();
      updatePaymentUI();
      updateComplianceUI();
      renderCustomComplianceChips();
    }

    function updateOwnershipUI() {
      document.querySelectorAll('#ownershipOptions .option-card').forEach(card => {
        card.classList.toggle('selected', selectedOwnership.has(card.dataset.value));
      });
    }


    function updatePaymentUI() {
      document.querySelectorAll('#paymentOptions .option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.value === aiToolPayment);
      });
    }

    function updateComplianceUI() {
      document.querySelectorAll('#complianceOptions .compliance-chip').forEach(chip => {
        chip.classList.toggle('selected', selectedCompliance.has(chip.dataset.value));
      });
    }

    function updateCustomComplianceUI() {
      document.querySelectorAll('#customComplianceChips .compliance-chip').forEach(chip => {
        chip.classList.toggle('selected', selectedCompliance.has(chip.dataset.value));
      });
    }

    function renderCustomComplianceChips() {
      const container = document.getElementById('customComplianceChips');
      container.innerHTML = customCompliance.map(c => `
        <div class="compliance-chip ${selectedCompliance.has(c.id) ? 'selected' : ''}" data-value="${c.id}">
          <span class="compliance-icon">📝</span>
          <span class="compliance-name">${c.name}</span>
          <span class="compliance-delete" title="Remove">×</span>
        </div>
      `).join('');
    }

    function addCustomCompliance() {
      const input = document.getElementById('customComplianceInput');
      const value = input.value.trim();
      
      if (!value) return;
      
      const id = `custom-compliance-${Date.now()}`;
      customCompliance.push({ id, name: value });
      selectedCompliance.add(id);
      input.value = '';
      
      renderCustomComplianceChips();
      autoSave();
    }

    // Client AI Landscape labels
    const clientAILabels = {
      maturity: {
        'not-started': 'Not Started',
        'exploring': 'Exploring',
        'piloting': 'Piloting',
        'scaling': 'Scaling',
        'optimizing': 'Optimizing',
        'dont-know': "I Don't Know"
      },
      usage: {
        'dont-know': "I Don't Know",
        'not-using': 'Not Using AI',
        'off-the-shelf': 'Off-the-Shelf Tools',
        'business-apps': 'AI in Business Apps',
        'custom-solutions': 'Custom AI Solutions',
        'business-processes': 'Process Automation',
        'customer-facing': 'Customer-Facing AI'
      },
      priority: {
        'not-priority': 'Not a Priority',
        'low': 'Low Priority',
        'medium': 'Medium Priority',
        'high': 'High Priority',
        'dont-know': "I Don't Know"
      },
      governance: {
        'none': 'No Governance',
        'informal': 'Informal',
        'developing': 'Developing',
        'established': 'Established',
        'dont-know': "I Don't Know"
      },
      challenge: {
        'unclear-roi': 'Unclear ROI',
        'skills': 'Skills Gap',
        'data': 'Data Issues',
        'security': 'Security/Compliance',
        'budget': 'Budget/Buy-in',
        'infrastructure': 'Infrastructure',
        'dont-know': "I Don't Know"
      }
    };

    function renderClientAILandscape() {
      updateClientAIMaturityUI();
      updateClientAIUsageUI();
      updateClientAIPriorityUI();
      updateClientAIGovernanceUI();
      updateChallengeUI();
      updateClientApprovedToolsUI();
    }

    function updateClientAIMaturityUI() {
      const maturityOrder = ['not-started', 'exploring', 'piloting', 'scaling', 'optimizing'];
      const selectedIdx = maturityOrder.indexOf(clientAIMaturity);

      // "I don't know" card
      document.querySelectorAll('#maturityStages .journey-idk .option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.value === clientAIMaturity);
      });

      // Journey pipeline stages
      document.querySelectorAll('#maturityStages .journey-stage').forEach(stage => {
        const stageIdx = maturityOrder.indexOf(stage.dataset.value);
        stage.classList.remove('active', 'passed');
        if (stage.dataset.value === clientAIMaturity) {
          stage.classList.add('active');
        } else if (selectedIdx > 0 && stageIdx < selectedIdx && stageIdx >= 0) {
          stage.classList.add('passed');
        }
      });
    }

    function updateClientAIUsageUI() {
      document.querySelectorAll('#clientUsageOptions .option-card').forEach(card => {
        card.classList.toggle('selected', clientAIUsage.has(card.dataset.value));
      });
    }

    function updateClientAIPriorityUI() {
      document.querySelectorAll('#clientPriorityOptions .option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.value === clientAIPriority);
      });
    }

    function updateClientAIGovernanceUI() {
      document.querySelectorAll('#clientGovernanceOptions .option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.value === clientAIGovernance);
      });
    }


    function updateClientApprovedToolsUI() {
      document.querySelectorAll('#clientApprovedToolsOptions .option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.value === clientApprovedTools);
      });
      document.getElementById('approvedToolsDetailSection').style.display = clientApprovedTools === 'yes' ? 'block' : 'none';
      if (clientApprovedTools === 'yes') {
        updateApprovedToolsChipsUI();
        renderCustomApprovedToolsChips();
      }
    }

    function updateApprovedToolsChipsUI() {
      document.querySelectorAll('#approvedToolsChips .compliance-chip').forEach(chip => {
        chip.classList.toggle('selected', selectedApprovedTools.has(chip.dataset.value));
      });
    }

    function updateCustomApprovedToolsChipUI() {
      document.querySelectorAll('#customApprovedToolsChips .compliance-chip').forEach(chip => {
        chip.classList.toggle('selected', selectedApprovedTools.has(chip.dataset.value));
      });
    }

    function renderCustomApprovedToolsChips() {
      const container = document.getElementById('customApprovedToolsChips');
      container.innerHTML = customApprovedTools.map(t => `
        <div class="compliance-chip ${selectedApprovedTools.has(t.id) ? 'selected' : ''}" data-value="${t.id}">
          <span class="compliance-name">${t.name}</span>
          <span class="compliance-delete" title="Remove">×</span>
        </div>
      `).join('');
    }

    const approvedToolLabels = {
      'github-copilot': 'GitHub Copilot',
      'chatgpt': 'ChatGPT / OpenAI',
      'claude': 'Claude / Anthropic',
      'gemini': 'Gemini / Google',
      'cursor': 'Cursor',
      'amazon-q-kiro': 'Amazon Q / Kiro',
      'ms-copilot': 'Microsoft Copilot',
      'atlassian-rovo': 'Atlassian Rovo'
    };

    function getApprovedToolNames() {
      return Array.from(selectedApprovedTools).map(id => {
        if (approvedToolLabels[id]) return approvedToolLabels[id];
        const custom = customApprovedTools.find(t => t.id === id);
        return custom?.name || id;
      });
    }

    function addCustomApprovedTool() {
      const input = document.getElementById('customApprovedToolInput');
      const name = input.value.trim();
      if (!name) return;
      const id = 'custom-' + Date.now();
      customApprovedTools.push({ id, name });
      selectedApprovedTools.add(id);
      input.value = '';
      renderCustomApprovedToolsChips();
      autoSave();
    }

    // Initialize use case data structure
    function initializeUseCaseData() {
      // Always check all categories to handle newly added ones even if data was restored
      useCaseCategories.forEach(cat => {
        if (!useCaseData[cat.id]) {
          useCaseData[cat.id] = {
            need: new Set(cat.items.map(i => i.id)),  // All items start in "Need" column (by ID)
            doing: new Set(),
            custom: []
          };
        }
      });
      useCasesInitialized = true;
    }

    function renderUseCases() {
      initializeUseCaseData();
      const container = document.getElementById('useCasesContainer');

      container.innerHTML = useCaseCategories.map(cat => {
        const catData = useCaseData[cat.id];
        const needItems = Array.from(catData.need);
        const doingItems = Array.from(catData.doing);
        const customItems = catData.custom || [];

        return `
          <div class="usecase-category" data-category-id="${cat.id}">
            <div class="usecase-category-header">
              <div class="usecase-category-icon">${cat.icon}</div>
              <div class="usecase-category-name">${cat.name}</div>
            </div>
            <div class="usecase-columns">
              <div class="usecase-column need">
                <div class="usecase-column-header">
                  <span>📋</span> Need
                </div>
                <div class="usecase-column-items" data-category="${cat.id}" data-column="need">
                  ${needItems.length > 0 ? needItems.map(item => `
                    <div class="usecase-card" data-item="${item.replace(/"/g, '&quot;')}">
                      <span class="usecase-delete-btn" title="Remove">×</span>
                      <span class="usecase-name">${getUseCaseLabel(cat.id, item)}</span>
                      <span class="usecase-move-btn" title="Move to Already Doing">→</span>
                    </div>
                  `).join('') : '<div class="usecase-empty">Move items here when needed</div>'}
                </div>
              </div>
              <div class="usecase-column doing">
                <div class="usecase-column-header">
                  <span>✅</span> Already Doing
                </div>
                <div class="usecase-column-items" data-category="${cat.id}" data-column="doing">
                  ${doingItems.length > 0 ? doingItems.map(item => `
                    <div class="usecase-card" data-item="${item.replace(/"/g, '&quot;')}">
                      <span class="usecase-move-btn" title="Move to Need">←</span>
                      <span class="usecase-name">${getUseCaseLabel(cat.id, item)}</span>
                      <span class="usecase-delete-btn" title="Remove">×</span>
                    </div>
                  `).join('') : '<div class="usecase-empty">Move items here when already addressed</div>'}
                </div>
              </div>
            </div>
            <div class="usecase-add-input">
              <input type="text" placeholder="Add use case..." data-category="${cat.id}">
              <button type="button" data-category="${cat.id}" class="add-usecase-btn">Add</button>
            </div>
          </div>
        `;
      }).join('');

      // Attach event listeners
      container.querySelectorAll('.usecase-card').forEach(card => {
        const moveBtn = card.querySelector('.usecase-move-btn');
        const deleteBtn = card.querySelector('.usecase-delete-btn');

        moveBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const columnEl = card.closest('.usecase-column-items');
          const catId = columnEl.dataset.category;
          const fromColumn = columnEl.dataset.column;
          const item = card.dataset.item;
          moveUseCaseItem(catId, item, fromColumn);
        });

        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const columnEl = card.closest('.usecase-column-items');
          const catId = columnEl.dataset.category;
          const fromColumn = columnEl.dataset.column;
          const item = card.dataset.item;
          removeUseCaseItem(catId, item, fromColumn);
        });
      });

      container.querySelectorAll('.add-usecase-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.dataset.category;
          addCustomUseCase(catId);
        });
      });

      container.querySelectorAll('.usecase-add-input input').forEach(input => {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const catId = input.dataset.category;
            addCustomUseCase(catId);
          }
        });
      });
    }

    function moveUseCaseItem(categoryId, item, fromColumn) {
      const catData = useCaseData[categoryId];
      const toColumn = fromColumn === 'need' ? 'doing' : 'need';

      catData[fromColumn].delete(item);
      catData[toColumn].add(item);

      renderUseCases();
      autoSave();
    }

    function removeUseCaseItem(categoryId, item, fromColumn) {
      const catData = useCaseData[categoryId];
      catData[fromColumn].delete(item);
      // Also remove from custom if it's a custom item
      catData.custom = catData.custom.filter(c => (typeof c === 'string' ? c : c.id) !== item);

      renderUseCases();
      autoSave();
    }

    function addCustomUseCase(categoryId) {
      const container = document.getElementById('useCasesContainer');
      const input = container.querySelector(`input[data-category="${categoryId}"]`);
      const value = input.value.trim();

      if (!value) return;

      const catData = useCaseData[categoryId];
      // Check for duplicates against labels
      const existingLabels = new Set([
        ...useCaseCategories.find(c => c.id === categoryId).items.map(i => i.label),
        ...catData.custom.map(c => typeof c === 'string' ? c : c.label)
      ]);
      if (existingLabels.has(value)) {
        alert('This use case already exists in this category.');
        return;
      }

      const customId = `custom-uc-${Date.now()}`;
      catData.need.add(customId);
      catData.custom.push({ id: customId, label: value });
      input.value = '';

      renderUseCases();
      autoSave();
    }

    // Role-Tool Matrix
    function getSelectedAITools() {
      const aiCategory = toolCategories.find(c => c.id === 'ai');
      if (!aiCategory) return [];
      const selected = selectedTools['ai'];
      if (!selected) return [];
      const toolIds = Array.from(selected).filter(id => id !== 'dont-know' && id !== 'not-applicable');
      return toolIds.map(id => {
        const tool = aiCategory.tools.find(t => t.id === id);
        if (tool) return { id, name: tool.name };
        const custom = customTools['ai']?.find(t => t.id === id);
        return { id, name: custom?.name || id };
      });
    }

    function getSelectedRolesOrdered() {
      return roles.filter(r => selectedRoles.has(r.id)).map(r => r.id);
    }

    function getSelectedRolesList() {
      return getSelectedRolesOrdered().map(id => {
        const role = roles.find(r => r.id === id);
        return { id, name: role?.name || id };
      });
    }

    function renderRoleToolMatrix() {
      const container = document.getElementById('roleToolMatrixContainer');
      const aiTools = getSelectedAITools();
      const rolesList = getSelectedRolesList();

      if (aiTools.length === 0 || rolesList.length === 0) {
        container.innerHTML = `<div class="matrix-empty">
          ${aiTools.length === 0 ? 'No AI tools were selected in the previous step.' : 'No roles were selected.'}
          <br>Please go back and select at least one AI tool and one role.
        </div>`;
        return;
      }

      let html = `<div class="matrix-container"><table class="role-tool-matrix">
        <thead>
          <tr>
            <th>Role</th>
            ${aiTools.map(t => `<th>${t.name}</th>`).join('')}
          </tr>
        </thead>
        <tbody>`;

      rolesList.forEach(role => {
        html += `<tr>
          <td>${role.name}</td>`;
        aiTools.forEach(tool => {
          const key = `${role.id}:${tool.id}`;
          const checked = roleToolMatrix[key] ? 'checked' : '';
          html += `<td><input type="checkbox" class="matrix-checkbox" data-role="${role.id}" data-tool="${tool.id}" ${checked}></td>`;
        });
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      container.innerHTML = html;

      // Attach event listeners
      container.querySelectorAll('.matrix-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const key = `${e.target.dataset.role}:${e.target.dataset.tool}`;
          if (e.target.checked) {
            roleToolMatrix[key] = true;
          } else {
            delete roleToolMatrix[key];
          }
          autoSave();
        });
      });
    }

    // AI Workflow Maturity render
    function getRoleShortName(roleId) {
      const map = { pm:'PM', swe:'Dev', qa:'QA', qaa:'QA Auto', ba:'BA', ux:'UX', devops:'DevOps', arch:'Arch', data:'Data' };
      return map[roleId] || roleId;
    }

    function getRoleFullName(roleId) {
      const map = { pm:'Project Manager', swe:'Developer', qa:'QA Manual', qaa:'QA Automation', ba:'Business Analyst', ux:'UX Designer', devops:'DevOps', arch:'Sol. Architect', data:'Data Engineer' };
      return map[roleId] || roleId;
    }

    function renderWorkflowMaturity() {
      const container = document.getElementById('workflowMaturityContainer');
      const activeRoles = getSelectedRolesOrdered().filter(id => wfmRoleDescriptions[id]);

      if (activeRoles.length === 0) {
        container.innerHTML = '<div class="matrix-empty">No applicable roles selected. Go back to Step 3 to select roles.</div>';
        return;
      }

      let html = '<div class="wfm-wrapper">';

      // Stage header row
      html += '<div class="wfm-stage-header">';
      html += '<div class="wfm-role-col"></div>';
      wfmStages.forEach(s => {
        html += `<div class="wfm-stage-tab">
          <span class="wfm-stage-num">${s.num}</span>
          <span class="wfm-stage-title">${s.title}</span>
          <span class="wfm-stage-sub">${s.sub}</span>
        </div>`;
      });
      html += '</div>';

      // Role rows — each cell has a radio circle + description
      html += '<div class="wfm-body">';
      activeRoles.forEach(roleId => {
        const descs = wfmRoleDescriptions[roleId];
        const selectedStage = workflowMaturity[roleId];
        html += '<div class="wfm-row">';
        html += `<div class="wfm-role-col">
          <div class="wfm-role-badge">
            <span class="wfm-role-badge-abbr">${getRoleShortName(roleId)}</span>
            <span class="wfm-role-badge-name">${getRoleFullName(roleId)}</span>
          </div>
        </div>`;
        descs.forEach((desc, stageIdx) => {
          const sel = selectedStage === stageIdx ? 'selected' : '';
          html += `<div class="wfm-cell ${sel}" data-role="${roleId}" data-stage="${stageIdx}">
            <div class="wfm-cell-radio"></div>
            <div class="wfm-cell-desc">${desc}</div>
          </div>`;
        });
        html += '</div>';
      });

      // Signals row
      html += '<div class="wfm-signals-row">';
      html += '<div class="wfm-role-col">Signals</div>';
      wfmSignals.forEach((signals, stageIdx) => {
        // Build tooltip with all expanded signals for this stage
        const expandedSignals = wfmSignalsExpanded[stageIdx] || signals;
        const tooltip = expandedSignals.map(exp => `• ${exp}`).join('\n');
        html += `<div class="wfm-cell" title="${tooltip}"><ul>` + signals.map(s => `<li>${s}</li>`).join('') + '</ul></div>';
      });
      html += '</div>';

      html += '</div></div>';
      container.innerHTML = html;

      // Attach click listeners — click a cell to select that stage for the role
      container.querySelectorAll('.wfm-cell[data-role]').forEach(cell => {
        cell.addEventListener('click', () => {
          const roleId = cell.dataset.role;
          const stageIdx = parseInt(cell.dataset.stage);
          if (workflowMaturity[roleId] === stageIdx) {
            delete workflowMaturity[roleId];
          } else {
            workflowMaturity[roleId] = stageIdx;
          }
          renderWorkflowMaturity();
          autoSave();
        });
      });
    }

    const LIMITING_FACTORS_MAX = 2;
    const limitingFactorLabels = {
      time: 'Lack of time / competing priorities',
      knowledge: 'Lack of knowledge or practical skills',
      'unclear-value': 'Unclear value or relevant use cases',
      client: 'Client or stakeholder not ready or supportive',
      access: 'Lack of access to tools, data, budget, or clear governance',
      other: 'Other (please specify)...'
    };

    function renderLimitingFactors() {
      updateLimitingFactorsUI();
    }

    function toggleLimitingFactor(value) {
      if (selectedLimitingFactors.has(value)) {
        selectedLimitingFactors.delete(value);
        limitingFactorsOrder = limitingFactorsOrder.filter(id => id !== value);
        if (value === 'other') limitingFactorOther = '';
      } else {
        if (selectedLimitingFactors.size >= LIMITING_FACTORS_MAX) {
          // Flash the hint to draw attention
          const hint = document.getElementById('limitingFactorsHint');
          hint.textContent = 'Deselect one to change your choice';
          hint.classList.add('at-max');
          clearTimeout(hint._flashTimeout);
          hint._flashTimeout = setTimeout(() => {
            hint.textContent = `Selected ${LIMITING_FACTORS_MAX} (max)`;
          }, 2000);
          return;
        }
        selectedLimitingFactors.add(value);
        if (!limitingFactorsOrder.includes(value)) {
          limitingFactorsOrder.push(value);
        }
      }
      updateLimitingFactorsUI();
      autoSave();
    }

    function updateLimitingFactorsUI() {
      // Normalize order list to selected items only
      limitingFactorsOrder = limitingFactorsOrder.filter(id => selectedLimitingFactors.has(id));
      if (limitingFactorsOrder.length < selectedLimitingFactors.size) {
        selectedLimitingFactors.forEach(id => {
          if (!limitingFactorsOrder.includes(id)) limitingFactorsOrder.push(id);
        });
      }

      document.querySelectorAll('#limitingFactorsOptions .option-card').forEach(card => {
        card.classList.toggle('selected', selectedLimitingFactors.has(card.dataset.value));
        card.removeAttribute('data-rank');
      });

      if (limitingFactorsOrder[0]) {
        const primary = document.querySelector(`#limitingFactorsOptions .option-card[data-value="${limitingFactorsOrder[0]}"]`);
        if (primary) primary.setAttribute('data-rank', 'Primary');
      }
      if (limitingFactorsOrder[1]) {
        const secondary = document.querySelector(`#limitingFactorsOptions .option-card[data-value="${limitingFactorsOrder[1]}"]`);
        if (secondary) secondary.setAttribute('data-rank', 'Secondary');
      }

      const hint = document.getElementById('limitingFactorsHint');
      const optionsContainer = document.getElementById('limitingFactorsOptions');
      const n = selectedLimitingFactors.size;
      const atMax = n >= LIMITING_FACTORS_MAX;
      hint.textContent = atMax ? `Selected ${LIMITING_FACTORS_MAX} (max)` : `Select up to ${LIMITING_FACTORS_MAX}`;
      hint.classList.toggle('at-max', atMax);
      optionsContainer.classList.toggle('at-max', atMax);
      const wrap = document.getElementById('limitingFactorOtherWrap');
      const otherInput = document.getElementById('limitingFactorOtherInput');
      if (selectedLimitingFactors.has('other')) {
        wrap.classList.remove('hidden');
        if (otherInput) otherInput.value = limitingFactorOther;
      } else {
        wrap.classList.add('hidden');
        if (otherInput) otherInput.value = '';
      }
    }

    const CHALLENGES_MAX = 2;

    function toggleChallenge(value) {
      // If "I don't know" is selected, make it exclusive
      if (value === 'dont-know') {
        selectedChallenges.clear();
        clientChallengeOrder = [];
        selectedChallenges.add(value);
        clientChallengeOrder.push(value);
      } else {
        // Remove "don't know" if selecting something else
        selectedChallenges.delete('dont-know');
        clientChallengeOrder = clientChallengeOrder.filter(id => id !== 'dont-know');

        if (selectedChallenges.has(value)) {
          selectedChallenges.delete(value);
          clientChallengeOrder = clientChallengeOrder.filter(id => id !== value);
        } else {
          if (selectedChallenges.size >= CHALLENGES_MAX) {
            // Flash the hint to draw attention
            const hint = document.getElementById('clientChallengesHint');
            if (hint) {
              hint.textContent = 'Deselect one to change your choice';
              hint.classList.add('at-max');
              clearTimeout(hint._flashTimeout);
              hint._flashTimeout = setTimeout(() => {
                hint.textContent = `Selected ${CHALLENGES_MAX} (max)`;
              }, 2000);
            }
            return;
          }
          selectedChallenges.add(value);
          clientChallengeOrder.push(value);
        }
      }
      updateChallengeUI();
      autoSave();
    }

    function updateChallengeUI() {
      // Normalize order
      clientChallengeOrder = clientChallengeOrder.filter(id => selectedChallenges.has(id));
      selectedChallenges.forEach(id => {
        if (!clientChallengeOrder.includes(id)) clientChallengeOrder.push(id);
      });

      // Update card selection state
      document.querySelectorAll('#clientChallengeOptions .option-card').forEach(card => {
        card.classList.toggle('selected', selectedChallenges.has(card.dataset.value));
        card.removeAttribute('data-rank');
      });

      // Add rank badges
      if (clientChallengeOrder[0] && clientChallengeOrder[0] !== 'dont-know') {
        const primary = document.querySelector(`#clientChallengeOptions .option-card[data-value="${clientChallengeOrder[0]}"]`);
        if (primary) primary.setAttribute('data-rank', 'Primary');
      }
      if (clientChallengeOrder[1]) {
        const secondary = document.querySelector(`#clientChallengeOptions .option-card[data-value="${clientChallengeOrder[1]}"]`);
        if (secondary) secondary.setAttribute('data-rank', 'Secondary');
      }

      // Update hint and at-max styling
      const hint = document.getElementById('clientChallengesHint');
      const optionsContainer = document.getElementById('clientChallengeOptions');
      if (!hint || !optionsContainer) return;

      const n = selectedChallenges.size;
      // "I Don't Know" counts as exclusive selection, not max
      const isDontKnow = selectedChallenges.has('dont-know');
      const atMax = !isDontKnow && n >= CHALLENGES_MAX;

      if (isDontKnow) {
        hint.textContent = 'Selected "I Don\'t Know"';
        hint.classList.remove('at-max');
        optionsContainer.classList.remove('at-max');
      } else {
        hint.textContent = atMax ? `Selected ${CHALLENGES_MAX} (max)` : `Select up to ${CHALLENGES_MAX} (Primary and Secondary)`;
        hint.classList.toggle('at-max', atMax);
        optionsContainer.classList.toggle('at-max', atMax);
      }
    }

    function getSelectedAITools() {
      const aiTools = [];

      // Get predefined AI tools
      const aiCategory = toolCategories.find(c => c.id === 'ai');
      if (selectedTools['ai']) {
        selectedTools['ai'].forEach(toolId => {
          const tool = aiCategory.tools.find(t => t.id === toolId);
          if (tool) {
            aiTools.push(tool);
          }
        });
      }
      
      // Get custom AI tools
      if (customTools['ai']) {
        customTools['ai'].forEach(tool => {
          aiTools.push(tool);
        });
      }
      
      return aiTools;
    }

    function validateStep(step) {
      // Hide all errors first
      document.querySelectorAll('.validation-error').forEach(el => {
        el.classList.remove('visible');
      });

      let errorDiv, message;

      switch(step) {
        case 0:
          errorDiv = document.getElementById('step0Error');
          if (!accountName.trim()) {
            message = 'Please enter an account or project name before starting.';
          }
          break;
        case 1:
          errorDiv = document.getElementById('step1Error');
          if (selectedRoles.size === 0) {
            message = 'Please select at least one team role to continue.';
          }
          break;
        case 5:
          errorDiv = document.getElementById('step5Error');
          if (selectedOwnership.size === 0 && !aiToolPayment) {
            message = 'Please select at least one ownership level and who pays for AI tools.';
          } else if (selectedOwnership.size === 0) {
            message = 'Please select at least one ownership level.';
          } else if (!aiToolPayment) {
            message = 'Please select who pays (or will pay) for AI tools.';
          }
          break;
        case 6:
          errorDiv = document.getElementById('step6Error');
          const missing = [];
          if (!clientAIMaturity) missing.push('AI maturity stage');
          if (!clientAIPriority) missing.push('strategic priority');
          if (!clientAIGovernance) missing.push('AI governance');
          if (selectedChallenges.size === 0) missing.push('AI challenge(s)');
          if (missing.length > 0) {
            message = 'Please select: ' + missing.join(', ') + '.';
          }
          break;
        case 7:
          errorDiv = document.getElementById('step7Error');
          if (selectedLimitingFactors.size === 0) {
            message = 'Please select at least one limiting factor.';
          } else if (selectedLimitingFactors.has('other') && !limitingFactorOther.trim()) {
            message = 'Please specify the "Other" limiting factor.';
          }
          break;
        case 9:
          errorDiv = document.getElementById('step9Error');
          const wfmRoles = getSelectedRolesOrdered().filter(id => wfmRoleDescriptions[id]);
          if (wfmRoles.length > 0 && Object.keys(workflowMaturity).length === 0) {
            message = 'Please select a workflow maturity stage for at least one role.';
          }
          break;
      }

      if (message && errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('visible');
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        return false;
      }
      return true;
    }

    function getReviewNotesHtml(stepId) {
      const note = (stepNotes[stepId] || '').trim();
      if (!note) return '';
      const escaped = note.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
      return '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #e5e7eb;"><strong>\u{1F4DD} Additional Notes:</strong><div style="margin-top: 0.25rem; color: #4b5563; white-space: pre-wrap;">' + escaped + '</div></div>';
    }

    function renderReview() {
      const container = document.getElementById('reviewContainer');
      let html = '';

      // Account Name
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(0)">
          <span class="review-section-title">📋 Account Name</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">${accountName || '<span class="review-empty">Not provided</span>'}</div>
      </div>`;

      // Roles
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(1)">
          <span class="review-section-title">👥 Team Roles</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      if (selectedRoles.size > 0) {
        html += '<ul>' + getSelectedRolesOrdered().map(id => {
          const role = roles.find(r => r.id === id);
          return `<li>${role?.name || id}</li>`;
        }).join('') + '</ul>';
      } else {
        html += '<span class="review-empty">No roles selected</span>';
      }
      if (aiChampion) {
        if (aiChampion === 'yes') {
          html += '<br><strong>AI Champion(s):</strong> Yes';
          if (aiChampions.length > 0) {
            html += '<ul>' + aiChampions.map(c => {
              return `<li>${c.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`;
            }).join('') + '</ul>';
          }
        } else {
          html += '<br><strong>AI Champion:</strong> No';
          if (aiFutureChampions.length > 0) {
            html += '<br><strong>Future Champion Nomination(s):</strong>';
            html += '<ul>' + aiFutureChampions.map(name => `<li>${name.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('') + '</ul>';
          }
        }
      }
      if (successStories.length > 0) {
        html += '<br><strong>AI Success Stories:</strong><ul>' + successStories.map(s => `<li>${s.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('') + '</ul>';
      }
      html += getReviewNotesHtml(1) + '</div></div>';

      // Tools
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(2)">
          <span class="review-section-title">🛠️ Tools & Infrastructure</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      let hasAnyTools = false;
      toolCategories.forEach(cat => {
        const selected = selectedTools[cat.id];
        if (selected && selected.size > 0) {
          const filtered = Array.from(selected).filter(id => id !== 'dont-know' && id !== 'not-applicable');
          if (filtered.length > 0) {
            hasAnyTools = true;
            html += `<strong>${cat.name}:</strong> `;
            html += filtered.map(toolId => {
              const tool = cat.tools.find(t => t.id === toolId);
              const custom = customTools[cat.id]?.find(t => t.id === toolId);
              return tool?.name || custom?.name || toolId;
            }).join(', ') + '<br>';
          }
        }
      });
      if (!hasAnyTools) html += '<span class="review-empty">No tools selected</span>';
      html += getReviewNotesHtml(2) + '</div></div>';

      // Role-Tool Matrix
      const matrixAITools = getSelectedAITools();
      const matrixRoles = getSelectedRolesList();
      const matrixEntries = Object.keys(roleToolMatrix).filter(k => roleToolMatrix[k]);
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(4)">
          <span class="review-section-title">🔗 Who Uses Which AI Tools</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      if (matrixEntries.length > 0 && matrixAITools.length > 0 && matrixRoles.length > 0) {
        matrixRoles.forEach(role => {
          const toolsForRole = matrixEntries
            .filter(k => k.startsWith(role.id + ':'))
            .map(k => {
              const toolId = k.split(':')[1];
              const tool = matrixAITools.find(t => t.id === toolId);
              return tool?.name || toolId;
            });
          if (toolsForRole.length > 0) {
            html += `<strong>${role.name}:</strong> ${toolsForRole.join(', ')}<br>`;
          }
        });
      } else {
        html += '<span class="review-empty">No role-tool mappings defined</span>';
      }
      html += getReviewNotesHtml(4) + '</div></div>';

      // Engagement
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(5)">
          <span class="review-section-title">🤝 Engagement Model</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      if (selectedOwnership.size > 0) {
        html += '<strong>Ownership:</strong> ' + Array.from(selectedOwnership).map(id => ownershipLabels[id]?.name || id).join(', ') + '<br>';
      }
      const payLabel = aiToolPayment === 'us' ? 'We Are/Will' : aiToolPayment === 'customer' ? 'Customer Is/Will' : aiToolPayment === 'mix' ? 'It Is a Mix' : aiToolPayment === 'tbd' ? 'To Be Determined' : 'Not selected';
      html += `<strong>AI Tool Payment:</strong> ${payLabel}<br>`;
      if (selectedCompliance.size > 0) {
        html += '<strong>Compliance:</strong> ' + Array.from(selectedCompliance).map(id => {
          const pre = complianceOptions.find(c => c.id === id);
          if (pre) return pre.name;
          const cust = customCompliance.find(c => c.id === id);
          return cust?.name || id;
        }).join(', ');
      }
      html += getReviewNotesHtml(5) + '</div></div>';

      // Client AI Landscape
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(6)">
          <span class="review-section-title">🏢 Client AI Adoption — As-Is State</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      if (clientAIMaturity) html += `<strong>Maturity:</strong> ${clientAILabels.maturity[clientAIMaturity]}<br>`;
      if (clientAIPriority) html += `<strong>Priority:</strong> ${clientAILabels.priority[clientAIPriority]}<br>`;
      if (clientAIGovernance) html += `<strong>Governance:</strong> ${clientAILabels.governance[clientAIGovernance]}<br>`;
      if (clientChallengeOrder.length > 0) {
        const primaryLabel = clientAILabels.challenge[clientChallengeOrder[0]];
        const secondaryLabel = clientChallengeOrder[1] ? clientAILabels.challenge[clientChallengeOrder[1]] : null;
        html += `<strong>Primary Challenge:</strong> ${primaryLabel}<br>`;
        if (secondaryLabel) html += `<strong>Secondary Challenge:</strong> ${secondaryLabel}<br>`;
      }
      if (clientApprovedTools) {
        let approvedLabel;
        if (clientApprovedTools === 'yes') {
          const toolNames = getApprovedToolNames();
          approvedLabel = 'Yes' + (toolNames.length > 0 ? ' — ' + toolNames.join(', ') : '');
        } else {
          approvedLabel = clientApprovedTools === 'no' ? 'No' : "I Don't Know";
        }
        html += `<strong>Approved AI Tools List:</strong> ${approvedLabel}<br>`;
      }
      const usageItems = Array.from(clientAIUsage).filter(id => id !== 'not-using' && id !== 'dont-know');
      if (usageItems.length > 0) {
        html += '<strong>Usage:</strong> ' + usageItems.map(id => clientAILabels.usage[id]).join(', ');
      } else if (clientAIUsage.has('dont-know')) {
        html += "<strong>Usage:</strong> I Don't Know";
      } else if (clientAIUsage.has('not-using')) {
        html += '<strong>Usage:</strong> Not using AI';
      }
      html += getReviewNotesHtml(6) + '</div></div>';

      // AI Use Cases
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(3)">
          <span class="review-section-title">📋 AI Use Case Needs</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      let hasUseCases = false;
      useCaseCategories.forEach(cat => {
        const catData = useCaseData[cat.id];
        if (!catData) return;
        const needItems = Array.from(catData.need || []);
        const doingItems = Array.from(catData.doing || []);
        if (needItems.length > 0 || doingItems.length > 0) {
          hasUseCases = true;
          html += `<strong>${cat.icon} ${cat.name}:</strong><br>`;
          if (needItems.length > 0) {
            html += `&nbsp;&nbsp;• Need: ${needItems.map(id => getUseCaseLabel(cat.id, id)).join(', ')}<br>`;
          }
          if (doingItems.length > 0) {
            html += `&nbsp;&nbsp;• Already Doing: ${doingItems.map(id => getUseCaseLabel(cat.id, id)).join(', ')}<br>`;
          }
        }
      });
      if (!hasUseCases) html += '<span class="review-empty">No use cases defined</span>';
      html += getReviewNotesHtml(3) + '</div></div>';

      // Limiting Factors
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(7)">
          <span class="review-section-title">🚧 Limiting Factors</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      const ordered = limitingFactorsOrder.length ? limitingFactorsOrder : Array.from(selectedLimitingFactors);
      if (ordered.length > 0) {
        html += '<ul>';
        ordered.forEach((id, i) => {
          const label = id === 'other' ? (limitingFactorOther || 'Other') : limitingFactorLabels[id];
          const rank = i === 0 ? ' (Primary)' : i === 1 ? ' (Secondary)' : '';
          html += `<li>${label}<strong>${rank}</strong></li>`;
        });
        html += '</ul>';
      } else {
        html += '<span class="review-empty">None selected</span>';
      }
      html += getReviewNotesHtml(7) + '</div></div>';

      // AI Workflow Maturity
      html += `<div class="review-section">
        <div class="review-section-header" onclick="goToStep(9)">
          <span class="review-section-title">🤖 AI Workflow Maturity</span>
          <button class="review-edit-btn">Edit</button>
        </div>
        <div class="review-content">`;
      const wfmActiveRoles = getSelectedRolesOrdered().filter(id => wfmRoleDescriptions[id]);
      if (wfmActiveRoles.length > 0 && Object.keys(workflowMaturity).length > 0) {
        html += '<ul>';
        wfmActiveRoles.forEach(roleId => {
          const stageIdx = workflowMaturity[roleId];
          if (stageIdx !== undefined && wfmStages[stageIdx]) {
            html += `<li><strong>${getRoleShortName(roleId)}:</strong> ${wfmStages[stageIdx].num} — ${wfmStages[stageIdx].title}</li>`;
          }
        });
        const unselected = wfmActiveRoles.filter(id => workflowMaturity[id] === undefined);
        if (unselected.length > 0) {
          unselected.forEach(roleId => {
            html += `<li><strong>${getRoleShortName(roleId)}:</strong> <em>Not assessed</em></li>`;
          });
        }
        html += '</ul>';
      } else {
        html += '<span class="review-empty">Not assessed yet</span>';
      }
      html += getReviewNotesHtml(9) + '</div></div>';

      container.innerHTML = html;
    }

    function setupEventListeners() {
      // Welcome page → Engagement (step5)
      document.getElementById('startAssessment').addEventListener('click', () => { if (validateStep(0)) goToStep(5); });

      // Step 5 (Engagement) — displayed as Step 1
      document.getElementById('step5Back').addEventListener('click', () => goToStep(0));
      document.getElementById('step5Next').addEventListener('click', () => { if (validateStep(5)) goToStep(6); });
      // Engagement — Ownership options (multi-select)
      document.getElementById('ownershipOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          const value = card.dataset.value;
          if (selectedOwnership.has(value)) {
            selectedOwnership.delete(value);
          } else {
            selectedOwnership.add(value);
          }
          updateOwnershipUI();
          autoSave();
        }
      });
      // Engagement — Payment options
      document.getElementById('paymentOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          aiToolPayment = card.dataset.value;
          updatePaymentUI();
          autoSave();
        }
      });
      // Engagement — Compliance options (predefined)
      document.getElementById('complianceOptions').addEventListener('click', (e) => {
        const chip = e.target.closest('.compliance-chip');
        if (chip) {
          const value = chip.dataset.value;
          if (selectedCompliance.has(value)) {
            selectedCompliance.delete(value);
          } else {
            selectedCompliance.add(value);
          }
          updateComplianceUI();
          autoSave();
        }
      });
      // Engagement — Custom compliance chips
      document.getElementById('customComplianceChips').addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.compliance-delete');
        if (deleteBtn) {
          const chip = deleteBtn.closest('.compliance-chip');
          const id = chip.dataset.value;
          selectedCompliance.delete(id);
          customCompliance = customCompliance.filter(c => c.id !== id);
          renderCustomComplianceChips();
          autoSave();
          return;
        }
        const chip = e.target.closest('.compliance-chip');
        if (chip) {
          const value = chip.dataset.value;
          if (selectedCompliance.has(value)) {
            selectedCompliance.delete(value);
          } else {
            selectedCompliance.add(value);
          }
          updateCustomComplianceUI();
          autoSave();
        }
      });
      // Engagement — Add custom compliance
      document.getElementById('addComplianceBtn').addEventListener('click', addCustomCompliance);
      document.getElementById('customComplianceInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addCustomCompliance();
      });

      // Step 6 (Client AI) — displayed as Step 2
      document.getElementById('step6Back').addEventListener('click', () => goToStep(5));
      document.getElementById('step6Next').addEventListener('click', () => { if (validateStep(6)) goToStep(1); });
      // Client AI Landscape — option card listeners
      document.getElementById('maturityStages').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card') || e.target.closest('.journey-stage');
        if (card && card.dataset.value) {
          clientAIMaturity = card.dataset.value;
          updateClientAIMaturityUI();
          autoSave();
        }
      });
      document.getElementById('clientUsageOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          const value = card.dataset.value;
          if (value === 'not-using' || value === 'dont-know') {
            const otherSelections = Array.from(clientAIUsage).filter(v => v !== 'not-using' && v !== 'dont-know');
            if (otherSelections.length > 0) {
              const label = value === 'dont-know' ? "I Don't Know" : "Not Using AI";
              if (!confirm(`Selecting "${label}" will clear your other selections. Continue?`)) return;
            }
            clientAIUsage.clear();
            clientAIUsage.add(value);
          } else {
            clientAIUsage.delete('not-using');
            clientAIUsage.delete('dont-know');
            if (clientAIUsage.has(value)) {
              clientAIUsage.delete(value);
            } else {
              clientAIUsage.add(value);
            }
          }
          updateClientAIUsageUI();
          autoSave();
        }
      });
      document.getElementById('clientPriorityOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          clientAIPriority = card.dataset.value;
          updateClientAIPriorityUI();
          autoSave();
        }
      });
      document.getElementById('clientGovernanceOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          clientAIGovernance = card.dataset.value;
          updateClientAIGovernanceUI();
          autoSave();
        }
      });
      document.getElementById('clientChallengeOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          toggleChallenge(card.dataset.value);
        }
      });
      document.getElementById('clientApprovedToolsOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          clientApprovedTools = card.dataset.value;
          updateClientApprovedToolsUI();
          autoSave();
        }
      });
      document.getElementById('approvedToolsChips').addEventListener('click', (e) => {
        const chip = e.target.closest('.compliance-chip');
        if (chip) {
          const value = chip.dataset.value;
          if (selectedApprovedTools.has(value)) {
            selectedApprovedTools.delete(value);
          } else {
            selectedApprovedTools.add(value);
          }
          updateApprovedToolsChipsUI();
          autoSave();
        }
      });
      document.getElementById('customApprovedToolsChips').addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.compliance-delete');
        if (deleteBtn) {
          const chip = deleteBtn.closest('.compliance-chip');
          const id = chip.dataset.value;
          selectedApprovedTools.delete(id);
          customApprovedTools = customApprovedTools.filter(t => t.id !== id);
          renderCustomApprovedToolsChips();
          autoSave();
          return;
        }
        const chip = e.target.closest('.compliance-chip');
        if (chip) {
          const value = chip.dataset.value;
          if (selectedApprovedTools.has(value)) {
            selectedApprovedTools.delete(value);
          } else {
            selectedApprovedTools.add(value);
          }
          updateCustomApprovedToolsChipUI();
          autoSave();
        }
      });
      document.getElementById('addApprovedToolBtn').addEventListener('click', addCustomApprovedTool);
      document.getElementById('customApprovedToolInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addCustomApprovedTool();
      });

      // Step 1 (Roles) — displayed as Step 3
      document.getElementById('step1Back').addEventListener('click', () => goToStep(6));
      document.getElementById('step1Next').addEventListener('click', () => { if (validateStep(1)) goToStep(2); });

      // AI Champion question
      document.getElementById('aiChampionOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          aiChampion = card.dataset.value;
          document.querySelectorAll('#aiChampionOptions .option-card').forEach(c => {
            c.classList.toggle('selected', c.dataset.value === aiChampion);
          });
          document.getElementById('aiChampionNameSection').style.display = aiChampion === 'yes' ? 'block' : 'none';
          document.getElementById('aiFutureChampionSection').style.display = aiChampion === 'no' ? 'block' : 'none';
          autoSave();
        }
      });
      document.getElementById('addChampionBtn').addEventListener('click', () => {
        const nameInput = document.getElementById('aiChampionInput');
        const name = nameInput.value.trim();
        if (name) {
          aiChampions.push(name);
          nameInput.value = '';
          renderChampions();
          autoSave();
        }
      });
      document.getElementById('aiChampionInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('addChampionBtn').click();
      });
      document.getElementById('addFutureChampionBtn').addEventListener('click', () => {
        const input = document.getElementById('aiFutureChampionInput');
        const name = input.value.trim();
        if (name) {
          aiFutureChampions.push(name);
          input.value = '';
          renderFutureChampions();
          autoSave();
        }
      });
      document.getElementById('aiFutureChampionInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('addFutureChampionBtn').click();
      });

      // AI Success Stories
      document.getElementById('aiSuccessStoryToggle').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (card) {
          hasSuccessStories = card.dataset.value;
          document.querySelectorAll('#aiSuccessStoryToggle .option-card').forEach(c => {
            c.classList.toggle('selected', c.dataset.value === hasSuccessStories);
          });
          document.getElementById('aiSuccessStoriesSection').style.display = hasSuccessStories === 'yes' ? 'block' : 'none';
          autoSave();
        }
      });
      document.getElementById('addSuccessStoryBtn').addEventListener('click', () => {
        const input = document.getElementById('aiSuccessStoryInput');
        const text = input.value.trim();
        if (text) {
          successStories.push(text);
          input.value = '';
          renderSuccessStories();
          autoSave();
        }
      });

      // Step 2 (Tools) — displayed as Step 4
      document.getElementById('step2Back').addEventListener('click', () => goToStep(1));
      document.getElementById('step2Next').addEventListener('click', () => handleStep2Continue());

      // Step 4 (Role-Tool Matrix) — displayed as Step 5
      document.getElementById('step4Back').addEventListener('click', () => goToStep(2));
      document.getElementById('step4Next').addEventListener('click', () => goToStep(3));

      // Step 3 (Use Cases) — displayed as Step 6 (or Step 5 when Role-Tool Matrix is skipped)
      document.getElementById('step3Back').addEventListener('click', () => {
        const aiTools = getSelectedAITools();
        goToStep(aiTools.length === 0 ? 2 : 4);
      });
      document.getElementById('step3Next').addEventListener('click', () => goToStep(9));

      // Step 9 (AI Workflow Maturity) — displayed as Step 7
      document.getElementById('step9Back').addEventListener('click', () => goToStep(3));
      document.getElementById('step9Next').addEventListener('click', () => goToStep(7));

      // Step 7 (Limiting Factors) — displayed as Step 8
      document.getElementById('step7Back').addEventListener('click', () => goToStep(9));
      document.getElementById('step7Next').addEventListener('click', () => { if (validateStep(7)) goToStep(8); });

      // Step 7: Limiting Factors click handler
      document.getElementById('limitingFactorsOptions').addEventListener('click', (e) => {
        const card = e.target.closest('.option-card');
        if (!card) return;
        toggleLimitingFactor(card.dataset.value);
      });
      document.getElementById('limitingFactorOtherInput').addEventListener('input', (e) => {
        limitingFactorOther = e.target.value;
        autoSave();
      });

      // Step 8 (Review)
      document.getElementById('step8Back').addEventListener('click', () => goToStep(7));
      document.getElementById('downloadAssessmentReview').addEventListener('click', () => downloadAssessment());

      document.getElementById('updateDashboardSurvey').addEventListener('click', async () => {
        const btn = document.getElementById('updateDashboardSurvey');
        btn.disabled = true;
        btn.textContent = '⏳ Updating...';
        const result = await saveToDashboardDB();
        btn.textContent = '🔄 Update in Dashboard';
        btn.disabled = false;
        if (result.success) {
          updateSaveStatus(result.message, false);
          updateDashboardButtons();
        } else {
          alert(result.message);
        }
      });

    }

    function generateJSON() {
      // Full-universe export: every question and option is always present
      // _meta, _label, _valueLabel fields provide human-readable context (strip with key.startsWith('_'))
      const paymentLabels = { us: 'We Are/Will', customer: 'Customer Is/Will', mix: 'It Is a Mix', tbd: 'To Be Determined' };
      const approvedToolsValueLabels = { 'dont-know': "I Don't Know", no: 'No', yes: 'Yes' };

      const results = {
        schemaVersion: '2.1.0',
        exportedAt: new Date().toISOString(),
        accountName: accountName || 'Unnamed Account',

        // --- Engagement Model ---
        engagement: {
          _meta: { step: 'Step 1', title: 'Engagement Model' },
          ownership: {
            _meta: { question: 'What level of ownership do you have on this project?', type: 'multi-select' },
            ...Object.fromEntries(
              Object.keys(ownershipLabels).map(id => [id, { selected: selectedOwnership.has(id), _label: ownershipLabels[id].name }])
            )
          },
          aiToolPayment: {
            _meta: { question: 'Who pays (or will pay) for AI tools?', type: 'single-select' },
            value: aiToolPayment,
            _valueLabel: aiToolPayment ? (paymentLabels[aiToolPayment] || aiToolPayment) : null
          },
          compliance: {
            _meta: { question: 'What compliance requirements apply to this project?', type: 'multi-select' },
            ...Object.fromEntries(
              complianceOptions.map(c => [c.id, { selected: selectedCompliance.has(c.id), _label: c.name }])
            ),
            custom: customCompliance.map(c => ({
              id: c.id, name: c.name, selected: selectedCompliance.has(c.id)
            }))
          }
        },

        // --- Client AI Landscape ---
        clientAILandscape: {
          _meta: { step: 'Step 2', title: 'Client AI Adoption — As-Is State' },
          maturity: {
            _meta: { question: 'At what stage is the client in their AI adoption journey?', type: 'single-select' },
            value: clientAIMaturity,
            _valueLabel: clientAIMaturity ? (clientAILabels.maturity[clientAIMaturity] || clientAIMaturity) : null
          },
          usage: {
            _meta: { question: 'How is the client currently using AI?', type: 'multi-select' },
            ...Object.fromEntries(
              Object.keys(clientAILabels.usage).map(id => [id, { selected: clientAIUsage.has(id), _label: clientAILabels.usage[id] }])
            )
          },
          priority: {
            _meta: { question: 'Is AI a strategic priority for the client?', type: 'single-select' },
            value: clientAIPriority,
            _valueLabel: clientAIPriority ? (clientAILabels.priority[clientAIPriority] || clientAIPriority) : null
          },
          governance: {
            _meta: { question: 'Does the client have AI governance in place?', type: 'single-select' },
            value: clientAIGovernance,
            _valueLabel: clientAIGovernance ? (clientAILabels.governance[clientAIGovernance] || clientAIGovernance) : null
          },
          challenges: {
            _meta: { question: "What are the client's biggest AI challenges?", type: 'ranked (max 2)' },
            ...Object.fromEntries(
              Object.keys(clientAILabels.challenge).map(id => {
                const idx = clientChallengeOrder.indexOf(id);
                return [id, { rank: idx >= 0 ? idx + 1 : null, _label: clientAILabels.challenge[id] }];
              })
            )
          },
          approvedToolsList: {
            _meta: { question: 'Is there an approved list of AI tools?', type: 'single-select + multi-select' },
            value: clientApprovedTools,
            _valueLabel: clientApprovedTools ? (approvedToolsValueLabels[clientApprovedTools] || clientApprovedTools) : null,
            tools: {
              ...Object.fromEntries(
                Object.keys(approvedToolLabels).map(id => [id, { selected: selectedApprovedTools.has(id), _label: approvedToolLabels[id] }])
              ),
              custom: customApprovedTools.map(t => ({
                id: t.id, name: t.name, selected: selectedApprovedTools.has(t.id)
              }))
            }
          }
        },

        // --- Team Roles ---
        teamRoles: {
          _meta: { step: 'Step 3', title: 'Team Roles & AI Champion' },
          roles: {
            _meta: { question: "Who's on your team?", type: 'multi-select' },
            ...Object.fromEntries(
              roles.map(r => [r.id, { selected: selectedRoles.has(r.id), _label: r.name }])
            )
          },
          aiChampion: {
            _meta: { question: 'Is there someone responsible for driving and championing AI adoption?', type: 'yes/no + names' },
            value: aiChampion,
            champions: aiChampion === 'yes' ? aiChampions : [],
            futureChampions: aiChampion === 'no' ? aiFutureChampions : []
          },
          successStories: {
            _meta: { question: 'Do you have an AI Success Story you\'d like to share?', type: 'yes/no + entries' },
            value: hasSuccessStories,
            stories: hasSuccessStories === 'yes' ? successStories : []
          }
        },

        // --- Tools & Infrastructure ---
        toolsAndInfrastructure: (() => {
          const section = {
            _meta: { step: 'Step 4', title: 'Tools & Infrastructure' }
          };
          toolCategories.forEach(cat => {
            const catSelected = selectedTools[cat.id] || new Set();
            const isVisible = cat.showAlways || (cat.showForRoles?.some(r => selectedRoles.has(r)) ?? false);
            const entry = {
              _meta: { question: 'What tools does your team use?', _categoryName: cat.name, type: 'multi-select' }
            };
            if (!cat.showAlways) entry.visible = isVisible;
            cat.tools.forEach(t => {
              entry[t.id] = { selected: catSelected.has(t.id), _label: t.name };
            });
            entry['dont-know'] = { selected: catSelected.has('dont-know'), _label: "Don't Know" };
            entry['not-applicable'] = { selected: catSelected.has('not-applicable'), _label: 'Not Applicable' };
            entry.custom = (customTools[cat.id] || []).map(t => ({
              id: t.id, name: t.name, selected: catSelected.has(t.id)
            }));
            section[cat.id] = entry;
          });
          return section;
        })(),

        // --- Role-Tool Matrix ---
        // Complete grid: every selectedRole × every selectedAITool
        roleToolMatrix: (() => {
          const selectedRoleIds = getSelectedRolesOrdered();
          const aiTools = getSelectedAITools();
          const matrix = {
            _meta: { step: 'Step 5', title: 'Who uses which AI tools?', type: 'checkbox-matrix' }
          };
          selectedRoleIds.forEach(roleId => {
            const role = roles.find(r => r.id === roleId);
            aiTools.forEach(tool => {
              const key = `${roleId}:${tool.id}`;
              matrix[key] = {
                selected: !!roleToolMatrix[key],
                _role: role?.name || roleId,
                _tool: tool.name || tool.id
              };
            });
          });
          return matrix;
        })(),

        // --- Use Cases ---
        useCases: (() => {
          const section = {
            _meta: { step: 'Step 6', title: 'AI Use Case Needs' }
          };
          useCaseCategories.forEach(cat => {
            const catData = useCaseData[cat.id] || { need: new Set(), doing: new Set(), custom: [] };
            const entry = {
              _meta: { _categoryName: cat.name, type: 'tri-state (need / doing / removed)' }
            };
            cat.items.forEach(item => {
              const status = (catData.doing && catData.doing.has(item.id)) ? 'doing' :
                             (catData.need && catData.need.has(item.id)) ? 'need' : 'removed';
              entry[item.id] = { status, _label: item.label };
            });
            entry.custom = (catData.custom || []).map(c => {
              const cId = typeof c === 'string' ? c : c.id;
              const cLabel = typeof c === 'string' ? c : c.label;
              const status = catData.doing?.has(cId) ? 'doing' :
                             catData.need?.has(cId) ? 'need' : 'removed';
              return { id: cId, label: cLabel, status };
            });
            section[cat.id] = entry;
          });
          return section;
        })(),

        // --- Workflow Maturity ---
        // All 9 roles; null means role was not selected / not assessed
        workflowMaturity: {
          _meta: { step: 'Step 7', title: 'AI Workflow Maturity', type: 'single-select per role (stage 0-5)' },
          ...Object.fromEntries(
            roles.map(r => {
              const stageIdx = workflowMaturity[r.id] !== undefined ? workflowMaturity[r.id] : null;
              const entry = {
                stage: stageIdx,
                _label: r.name
              };
              if (stageIdx !== null && wfmStages[stageIdx]) {
                entry._stageLabel = `${wfmStages[stageIdx].num} — ${wfmStages[stageIdx].title}`;
              }
              return [r.id, entry];
            })
          )
        },

        // --- Limiting Factors ---
        limitingFactors: {
          _meta: { step: 'Step 8', title: 'Factors Limiting AI Adoption', type: 'ranked (max 2)' },
          ...Object.fromEntries(
            Object.keys(limitingFactorLabels).map(id => {
              const idx = limitingFactorsOrder.indexOf(id);
              const entry = { rank: idx >= 0 ? idx + 1 : null, _label: limitingFactorLabels[id] };
              if (id === 'other') entry.text = limitingFactorOther || null;
              return [id, entry];
            })
          )
        },

        // --- Step Notes ---
        notes: {
          _meta: { description: 'Free-text notes added by the respondent for each survey step' },
          engagement: (stepNotes[5] || '').trim() || null,
          clientAILandscape: (stepNotes[6] || '').trim() || null,
          teamRoles: (stepNotes[1] || '').trim() || null,
          tools: (stepNotes[2] || '').trim() || null,
          roleToolMatrix: (stepNotes[4] || '').trim() || null,
          useCases: (stepNotes[3] || '').trim() || null,
          workflowMaturity: (stepNotes[9] || '').trim() || null,
          limitingFactors: (stepNotes[7] || '').trim() || null
        }
      };

      return JSON.stringify(results, null, 2);
    }

    function generateMarkdown() {
      const displayName = accountName || 'Unnamed Account';
      let md = `# AI Adoption Assessment Report\n\n`;
      md += `**Account:** ${displayName}\n\n`;
      md += `**Generated:** ${new Date().toLocaleString()}\n\n`;
      md += `---\n\n`;

      // Team Roles
      md += `## 👥 Team Roles\n\n`;
      if (selectedRoles.size > 0) {
        getSelectedRolesOrdered().forEach(roleId => {
          const role = roles.find(r => r.id === roleId);
          md += `- ${role?.name || roleId}\n`;
        });
      } else {
        md += `_No roles selected_\n`;
      }
      md += `\n`;
      if (aiChampion) {
        if (aiChampion === 'yes') {
          md += `**AI Champion(s):** Yes\n`;
          if (aiChampions.length > 0) {
            aiChampions.forEach((c, i) => {
              md += `${i + 1}. ${c}\n`;
            });
          }
          md += `\n`;
        } else {
          md += `**AI Champion:** No\n\n`;
          if (aiFutureChampions.length > 0) {
            md += `**Future Champion Nomination(s):**\n`;
            aiFutureChampions.forEach((name, i) => {
              md += `${i + 1}. ${name}\n`;
            });
            md += `\n`;
          }
        }
      }
      if (successStories.length > 0) {
        md += `**AI Success Stories:**\n`;
        successStories.forEach((story, i) => {
          md += `${i + 1}. ${story}\n`;
        });
        md += `\n`;
      }

      // Engagement Model
      md += `## 🤝 Engagement Model\n\n`;
      if (selectedOwnership.size > 0) {
        md += `**Ownership Level(s):**\n`;
        Array.from(selectedOwnership).forEach(id => {
          const label = ownershipLabels[id];
          md += `- ${label?.name || id}\n`;
        });
        md += `\n`;
      } else {
        md += `**Ownership Level:** _Not selected_\n\n`;
      }
      
      const paymentLabel = aiToolPayment === 'us' ? 'We Will Pay' : aiToolPayment === 'customer' ? 'Customer Will Pay' : aiToolPayment === 'mix' ? 'It Is a Mix' : aiToolPayment === 'tbd' ? 'To Be Determined' : '_Not selected_';
      md += `**AI Tool Payment:** ${paymentLabel}\n\n`;

      // Compliance Requirements
      md += `**Compliance Requirements:**\n`;
      if (selectedCompliance.size > 0) {
        Array.from(selectedCompliance).forEach(id => {
          const predefined = complianceOptions.find(c => c.id === id);
          if (predefined) {
            md += `- ${predefined.name}\n`;
          } else {
            const custom = customCompliance.find(c => c.id === id);
            md += `- ${custom?.name || id} *(custom)*\n`;
          }
        });
      } else {
        md += `_None selected_\n`;
      }
      md += `\n`;

      // Tools & Infrastructure
      md += `## 🛠️ Tools & Infrastructure\n\n`;
      let hasTools = false;
      toolCategories.forEach(cat => {
        const selected = selectedTools[cat.id];
        if (selected && selected.size > 0) {
          // Filter out special options
          const filteredTools = Array.from(selected).filter(toolId => toolId !== 'dont-know' && toolId !== 'not-applicable');
          if (filteredTools.length > 0) {
            hasTools = true;
            md += `### ${cat.icon} ${cat.name}\n\n`;
            filteredTools.forEach(toolId => {
              const tool = cat.tools.find(t => t.id === toolId);
              const customTool = customTools[cat.id]?.find(t => t.id === toolId);
              const name = tool?.name || customTool?.name || toolId;
              const isCustom = !tool && customTool;
              md += `- ${name}${isCustom ? ' *(custom)*' : ''}\n`;
            });
            md += `\n`;
          }
        }
      });
      if (!hasTools) {
        md += `_No tools selected_\n\n`;
      }

      // Role-Tool Matrix
      const mdMatrixKeys = Object.keys(roleToolMatrix).filter(k => roleToolMatrix[k]);
      if (mdMatrixKeys.length > 0) {
        md += `## 🔗 Who Uses Which AI Tools\n\n`;
        const matrixByRole = {};
        mdMatrixKeys.forEach(key => {
          const [roleId, toolId] = key.split(':');
          const role = roles.find(r => r.id === roleId);
          const aiCat = toolCategories.find(c => c.id === 'ai');
          const tool = aiCat?.tools.find(t => t.id === toolId) || customTools['ai']?.find(t => t.id === toolId);
          const roleName = role?.name || roleId;
          const toolName = tool?.name || toolId;
          if (!matrixByRole[roleName]) matrixByRole[roleName] = [];
          matrixByRole[roleName].push(toolName);
        });
        Object.entries(matrixByRole).forEach(([roleName, tools]) => {
          md += `**${roleName}:** ${tools.join(', ')}\n\n`;
        });
      }

      // Client AI Landscape
      md += `## 🏢 Client AI Adoption — As-Is State\n\n`;
      
      if (clientAIMaturity) {
        md += `**AI Maturity Stage:** ${clientAILabels.maturity[clientAIMaturity]}\n\n`;
      }
      
      const usageItems = Array.from(clientAIUsage).filter(id => id !== 'not-using' && id !== 'dont-know');
      if (usageItems.length > 0) {
        md += `**Current AI Usage:**\n`;
        usageItems.forEach(id => {
          md += `- ${clientAILabels.usage[id]}\n`;
        });
        md += `\n`;
      } else if (clientAIUsage.has('dont-know')) {
        md += `**Current AI Usage:** I Don't Know\n\n`;
      } else if (clientAIUsage.has('not-using')) {
        md += `**Current AI Usage:** Not using AI yet\n\n`;
      }
      
      if (clientAIPriority) {
        md += `**AI Strategic Priority:** ${clientAILabels.priority[clientAIPriority]}\n\n`;
      }
      
      if (clientAIGovernance) {
        md += `**AI Governance:** ${clientAILabels.governance[clientAIGovernance]}\n\n`;
      }
      
      if (clientChallengeOrder.length > 0) {
        md += `**Primary AI Challenge:** ${clientAILabels.challenge[clientChallengeOrder[0]]}\n\n`;
        if (clientChallengeOrder[1]) {
          md += `**Secondary AI Challenge:** ${clientAILabels.challenge[clientChallengeOrder[1]]}\n\n`;
        }
      }

      if (clientApprovedTools) {
        let approvedMdLabel;
        if (clientApprovedTools === 'yes') {
          const toolNames = getApprovedToolNames();
          approvedMdLabel = 'Yes' + (toolNames.length > 0 ? '\n' + toolNames.map(t => `- ${t}`).join('\n') : '');
        } else {
          approvedMdLabel = clientApprovedTools === 'no' ? 'No' : "I Don't Know";
        }
        md += `**Approved AI Tools List:** ${approvedMdLabel}\n\n`;
      }

      // AI Use Case Needs
      md += `## 📋 AI Use Case Needs\n\n`;
      let hasAnyUseCases = false;
      useCaseCategories.forEach(cat => {
        const catData = useCaseData[cat.id];
        if (!catData) return;
        const needItems = Array.from(catData.need || []);
        const doingItems = Array.from(catData.doing || []);
        if (needItems.length > 0 || doingItems.length > 0) {
          hasAnyUseCases = true;
          md += `### ${cat.icon} ${cat.name}\n\n`;
          if (needItems.length > 0) {
            md += `**Need:**\n`;
            needItems.forEach(item => {
              md += `- ${getUseCaseLabel(cat.id, item)}\n`;
            });
            md += `\n`;
          }
          if (doingItems.length > 0) {
            md += `**Already Doing:**\n`;
            doingItems.forEach(item => {
              md += `- ${getUseCaseLabel(cat.id, item)}\n`;
            });
            md += `\n`;
          }
        }
      });
      if (!hasAnyUseCases) {
        md += `_No use cases defined_\n\n`;
      }

      md += `## 🚧 Factors Limiting AI Adoption\n\n`;
      const orderedFactors = limitingFactorsOrder.length ? limitingFactorsOrder : Array.from(selectedLimitingFactors);
      if (orderedFactors.length > 0) {
        const primaryId = orderedFactors[0];
        const primaryLabel = primaryId === 'other' ? (limitingFactorOther || 'Other (please specify)...') : limitingFactorLabels[primaryId];
        md += `**Primary reason:** ${primaryLabel}\n\n`;
        if (orderedFactors[1]) {
          const secondaryId = orderedFactors[1];
          const secondaryLabel = secondaryId === 'other' ? (limitingFactorOther || 'Other (please specify)...') : limitingFactorLabels[secondaryId];
          md += `**Secondary reason:** ${secondaryLabel}\n\n`;
        }
      } else {
        md += `_None selected_\n\n`;
      }

      // AI Workflow Maturity
      const wfmMdEntries = Object.entries(workflowMaturity);
      if (wfmMdEntries.length > 0) {
        md += `## 🤖 AI Workflow Maturity\n\n`;
        const wfmMdActiveRoles = getSelectedRolesOrdered().filter(id => wfmRoleDescriptions[id]);
        wfmMdActiveRoles.forEach(roleId => {
          const stageIdx = workflowMaturity[roleId];
          if (stageIdx !== undefined && wfmStages[stageIdx]) {
            md += `**${getRoleShortName(roleId)}:** ${wfmStages[stageIdx].num} — ${wfmStages[stageIdx].title}\n\n`;
          } else {
            md += `**${getRoleShortName(roleId)}:** _Not assessed_\n\n`;
          }
        });
      }

      // Add step notes
      const mdNoteStepNames = {5: 'Engagement Model', 6: 'Client AI Landscape', 1: 'Team Roles', 2: 'Tools & Infrastructure', 4: 'Role-Tool Matrix', 3: 'AI Use Cases', 9: 'AI Workflow Maturity', 7: 'Limiting Factors'};
      const hasAnyStepNotes = Object.values(stepNotes).some(n => n && n.trim());
      if (hasAnyStepNotes) {
        md += `## \u{1F4DD} Additional Notes\n\n`;
        Object.entries(mdNoteStepNames).forEach(([stepId, name]) => {
          const note = (stepNotes[stepId] || '').trim();
          if (note) {
            md += `### ${name}\n\n${note}\n\n`;
          }
        });
      }

      md += `---\n\n`;
      md += `*Report generated by AI Adoption Assessment Tool*\n`;

      return md;
    }

    async function downloadAssessment() {
      const btn = document.getElementById('downloadAssessmentReview');
      const originalText = btn.textContent;
      btn.textContent = '⏳ Generating...';
      btn.disabled = true;

      try {
        // Generate content
        const jsonContent = generateJSON();
        const mdContent = generateMarkdown();

        // Create filename base — use custom name if provided
        const customName = (document.getElementById('downloadNameInput')?.value || '').trim();
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const dateStr = `${yyyy}_${mm}_${dd}`;
        const quarter = `Q${Math.ceil((now.getMonth() + 1) / 3)}`;

        let fileBaseName;
        if (customName) {
          fileBaseName = customName.replace(/[^a-zA-Z0-9-_ ]/g, '_');
        } else {
          const safeAccountName = (accountName || 'Project').replace(/[^a-zA-Z0-9-_]/g, '_');
          fileBaseName = `${dateStr}_AI_Adoption_Assessment_${yyyy}_${quarter}_${safeAccountName}`;
        }

        // Create zip
        const zip = new JSZip();
        zip.file(`${fileBaseName}.json`, jsonContent);
        zip.file(`${fileBaseName}.md`, mdContent);

        // Generate and download
        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileBaseName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Ensure latest state is persisted
        saveToLocalStorage();
      } catch (error) {
        console.error('Error generating download:', error);
        alert('Error generating download. Please try again.');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Step notes — toggle, save, restore
    function toggleStepNotes(stepId) {
      const container = document.querySelector(`.step-notes[data-step="${stepId}"]`);
      if (!container) return;
      const toggle = container.querySelector('.step-notes-toggle');
      const body = container.querySelector('.step-notes-body');
      const isOpen = body.classList.toggle('open');
      toggle.classList.toggle('open', isOpen);
    }

    // Maturity Info Modal
    function openMaturityInfoModal() {
      document.getElementById('maturityInfoModal').classList.add('open');
    }

    function closeMaturityInfoModal() {
      document.getElementById('maturityInfoModal').classList.remove('open');
    }

    // Close modal on overlay click (outside modal content)
    document.getElementById('maturityInfoModal').addEventListener('click', function(e) {
      if (e.target === this) closeMaturityInfoModal();
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('maturityInfoModal');
        if (modal && modal.classList.contains('open')) closeMaturityInfoModal();
      }
    });

    function setupStepNotes() {
      document.querySelectorAll('.step-notes-textarea').forEach(textarea => {
        const stepId = textarea.dataset.step;
        // Restore saved value
        if (stepNotes[stepId]) {
          textarea.value = stepNotes[stepId];
          updateNotesIndicator(stepId);
        }
        // Save on input
        textarea.addEventListener('input', () => {
          stepNotes[stepId] = textarea.value;
          updateNotesIndicator(stepId);
          autoSave();
        });
      });
    }

    function updateNotesIndicator(stepId) {
      const container = document.querySelector(`.step-notes[data-step="${stepId}"]`);
      if (!container) return;
      const toggle = container.querySelector('.step-notes-toggle');
      const hasContent = (stepNotes[stepId] || '').trim().length > 0;
      toggle.classList.toggle('has-content', hasContent);
    }

    function restoreAllNotesUI() {
      document.querySelectorAll('.step-notes-textarea').forEach(textarea => {
        const stepId = textarea.dataset.step;
        textarea.value = stepNotes[stepId] || '';
        updateNotesIndicator(stepId);
      });
    }

    // Start
    init();
  </script>


</body></html>